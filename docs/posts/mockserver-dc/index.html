<!doctype html>

<html lang="en">

<head>
  <title>Testing Microservices with Mockserver - tarquin-the-brave</title>
  <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="description" content="The HTML5 Herald" />
<meta name="author" content="Tom Steavenson" /><meta property="og:title" content="Testing Microservices with Mockserver" />
<meta property="og:description" content="Mockserver is a great piece of tooling that takes a huge amount of heavy lifting away from testing microservices.
There&rsquo;s no need to mock out downstream dependencies or client APIs. There&rsquo;s no need to write complex test code to synchronously handle the mechanics of requests going back and forward while also trying to embody some comprehensible declaration of the designed behaviour." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://tarquin-the-brave.github.io/blog/posts/mockserver-dc/" />
<meta property="article:published_time" content="2020-02-25T10:07:46+00:00" />
<meta property="article:modified_time" content="2020-02-25T10:07:46+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Testing Microservices with Mockserver"/>
<meta name="twitter:description" content="Mockserver is a great piece of tooling that takes a huge amount of heavy lifting away from testing microservices.
There&rsquo;s no need to mock out downstream dependencies or client APIs. There&rsquo;s no need to write complex test code to synchronously handle the mechanics of requests going back and forward while also trying to embody some comprehensible declaration of the designed behaviour."/>

<meta name="generator" content="Hugo 0.68.3" />
    

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://tarquin-the-brave.github.io/blog/fontawesome/css/all.min.css" />
  
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab|Ruda" />
  
  
  <link rel="stylesheet" type="text/css" href="https://tarquin-the-brave.github.io/blog/css/styles.css" /></head>

<body>
  <div id="container">
    <header>
      <h1>
                <a href="https://tarquin-the-brave.github.io/blog/">tarquin-the-brave</a>
            </h1>

      <ul id="social-media">
             <li>
               <a href="https://github.com/tarquin-the-brave" title="GitHub">
               <i class="fab fa-github fa-lg"></i>
               </a>
             </li>
             <li>
               <a href="https://stackoverflow.com/users/10132181/tom-steavenson" title="StackOverflow">
               <i class="fab fa-stack-overflow fa-lg"></i>
               </a>
             </li>
      </ul>
      
      <p><em><p>Some things I think.</p>
<p><a href="https://tarquin-the-brave.github.io/blog/posts/"><strong>&mdash; All Posts &mdash;</strong></a></p>
</em></p>
      
    </header>

    
<nav>
    <ul>
        
    </ul>
</nav>


    <main>




<article>

    <h1>Testing Microservices with Mockserver</h1>

    
      <aside>
    <ul>
        <li>
            <time class="post-date" datetime="2020-02-25T10:07:46Z">Feb 25, 2020</time>
        </li>
        
        

        

        <li>6 minutes read</li>
    </ul>
</aside>

    

    
<div class="featured_image">
    <a href="https://tarquin-the-brave.github.io/blog/posts/mockserver-dc/" title="Testing Microservices with Mockserver">
        <img src="">
    </a>
</div>



    <p><a href="http://www.mock-server.com/">Mockserver</a> is a great piece of tooling that takes a huge amount
of heavy lifting away from testing microservices.</p>
<p>There&rsquo;s no need to mock out downstream dependencies or client APIs.  There&rsquo;s no
need to write complex test code to synchronously handle the mechanics of
requests going back and forward while also trying to embody some comprehensible
declaration of the designed behaviour.  It does about as much of the mechanics
of testing for you as it&rsquo;s possible for it to do.</p>
<p>In all honesty, it was my favourite piece of technology I came across in 2019.</p>
<p>In this post I&rsquo;ll walk through a patten I&rsquo;ve used a few times to quickly get
rather effective testing of a microservice that drives its API.</p>
<h1 id="test-setup">Test Setup</h1>
<p>The test deployment has three elements:</p>
<ul>
<li>Your microservice,</li>
<li>A test driver containing/running your test code, and</li>
<li>A <a href="http://www.mock-server.com/">mockserver</a> instance.</li>
</ul>
<p>I&rsquo;ve used <a href="https://docs.docker.com/compose/">docker-compose</a> to run the containers and manage the routing
between them, but any container runtime<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup> would do the job.</p>
<p><a href="https://mermaid-js.github.io/mermaid-live-editor/#/edit/eyJjb2RlIjoiZ3JhcGggQlRcbnN1YmdyYXBoIGRvY2tlci1jb21wb3NlXG50ZXN0LXJ1bm5lci0tPnxcInRlc3QtcnVubmVycHJvZ3JhbXMgbW9ja3NlcnZlclwifG1vY2tzZXJ2ZXJcbm1vY2tzZXJ2ZXItLS18XCJtb2Nrc2VydmVyIG1vY2tzIG91dCB0aGUgbWljcm9zZXJ2aWNlIGRlcGVuZGVuY2llcyBhbmQgcmVjb3JkcyBtZXNzYWdlc1wifGEobWljcm9zZXJ2aWNlKVxudGVzdC1ydW5uZXItLT58XCJ0ZXN0LXJ1bm5lciBraWNrcyBtaWNyb3NlcnZpY2UgQVBJIHRvIHN0YXJ0IHRlc3RcInxhKG1pY3Jvc2VydmljZSlcbmVuZFxuXHRcdCIsIm1lcm1haWQiOnsidGhlbWUiOiJkZWZhdWx0In0sInVwZGF0ZUVkaXRvciI6ZmFsc2V9"><img src="https://mermaid.ink/img/eyJjb2RlIjoiZ3JhcGggQlRcbnN1YmdyYXBoIGRvY2tlci1jb21wb3NlXG50ZXN0LXJ1bm5lci0tPnxcInRlc3QtcnVubmVycHJvZ3JhbXMgbW9ja3NlcnZlclwifG1vY2tzZXJ2ZXJcbm1vY2tzZXJ2ZXItLS18XCJtb2Nrc2VydmVyIG1vY2tzIG91dCB0aGUgbWljcm9zZXJ2aWNlIGRlcGVuZGVuY2llcyBhbmQgcmVjb3JkcyBtZXNzYWdlc1wifGEobWljcm9zZXJ2aWNlKVxudGVzdC1ydW5uZXItLT58XCJ0ZXN0LXJ1bm5lciBraWNrcyBtaWNyb3NlcnZpY2UgQVBJIHRvIHN0YXJ0IHRlc3RcInxhKG1pY3Jvc2VydmljZSlcbmVuZFxuXHRcdCIsIm1lcm1haWQiOnsidGhlbWUiOiJkZWZhdWx0In0sInVwZGF0ZUVkaXRvciI6ZmFsc2V9" alt=""></a></p>
<h2 id="mockserver">Mockserver</h2>
<p>The key element here is <a href="http://www.mock-server.com/">mockserver</a>. It looks after the mechanics
of mocking out the dependencies of a service.  It&rsquo;s controlled by your test
code over its API. You tell it what messages to expect an how to respond to
them ahead of time. It records what messages have come and gone during the
test.  Your tests can send a request to verify the expectations have been met
or partially met.</p>
<p>The result is that each test case ends up looking like:</p>
<ul>
<li>A bunch of requests to <a href="http://www.mock-server.com/">mockserver</a>, via the client you&rsquo;ve
chosen, or generated from the <a href="https://app.swaggerhub.com/apis/jamesdbloom/mock-server-openapi/5.0.x">openAPI spec</a>, to establish the
requests that you expect to see and how to respond to each,</li>
<li>A call to an endpoint on your microservice&rsquo;s API, and</li>
<li>A call to <a href="http://www.mock-server.com/">mockserver</a> to verify that the expected messages were
received.</li>
</ul>
<p>Mockserver takes away the need to define in the test code all the mechanics
around what messages should be where, when. You define what to expect upfront,
<a href="http://www.mock-server.com/">mockserver</a> records if there&rsquo;s anything the matter with the
messages, and at the end, you can ask it whether the expectations were met.</p>
<h2 id="the-test-runner">The Test Runner</h2>
<p>We run the test code in its own container to make it easy to control the
environment and to make networking easier when we introduce
<a href="https://docs.docker.com/compose/">docker-compose</a> to manage the setup.</p>
<p>We define a <code>Dockerfile</code> for our test runner that builds a container with the
test code and its dependencies. docker-compose can then rebuild the test
container and run the tests in one <a href="#running-the-tests">command</a>.</p>
<p>A result of using <a href="http://www.mock-server.com/">mockserver</a>, and this test setup, is that the
test code is fairly minimal and there&rsquo;s no real &ldquo;test framework&rdquo; required.
Once you have a <a href="http://www.mock-server.com/">mockserver</a> client library<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>, and a client
library for your microservice (or decide that defining the requests to kick off
a test on the fly) there&rsquo;s not much more to the tests.</p>
<p>I&rsquo;ve written the code for this test runner in Python using <a href="https://docs.pytest.org/en/latest/">pytest</a>.
It worked quite well.  But, as the test code only makes a series of requests,
it&rsquo;s not important.</p>
<h2 id="your-microservice">Your Microservice</h2>
<p>Configure your microservice with <a href="http://www.mock-server.com/">mockserver</a> as the target for all
downstream traffic.</p>
<p>The URL of <a href="http://www.mock-server.com/">mockserver</a> corresponds to the service name and the
port it exposes, defined in the <a href="#docker-compose-example">docker-compose file</a>.</p>
<h1 id="docker-compose-example">Docker Compose Example</h1>
<p>We have a docker-compose file: <code>docker-compose.yml</code></p>
<script type="application/javascript" src="https://gist.github.com/tarquin-the-brave/7a2d813015d049fbe40e3723b0795be4.js?file=docker-compose.yml"></script>

<p>In this example, under <code>services:</code> there&rsquo;s an entry for each of the containers
in this setup.</p>
<p>Docker compose will route the containers together by giving them a domain name
for the name under <code>services:</code>, e.g. the microservice can route to the
<a href="http://www.mock-server.com/">mockserver</a> by sending requests to the domain name <code>mockdeps</code>. The
test runner routes to the microservice by sending requests to the domain name
<code>microservice</code>.</p>
<h2 id="the-test-runner-1">The Test Runner</h2>
<p><code>test:</code></p>
<p>In our example the <code>Dockerfile</code> defining the test runner container is found
under directory <code>fv/</code>, along with the test code and everything else needed to
build the test runner.</p>
<p>We define the command to run the tests and allow for arguments to the test
command with <code>${TEST_ARGS}</code>.</p>
<h2 id="your-microservice-1">Your Microservice</h2>
<p><code>microservice:</code></p>
<p>For this example:</p>
<ul>
<li>We allow the image to test to be configured by a variable, defaulting to
<code>x:latest</code>.</li>
<li>We set the <code>LOG_LEVEL</code> environment variable in the microservice container.</li>
<li>We mount in a config file with necessary config, listing the downstream
dependencies that we&rsquo;re mocking out with <a href="http://www.mock-server.com/">mockserver</a> as being at
<code>mockdeps:12345</code>.</li>
</ul>
<p>If we wanted to automate rebuilding the microservice for testing, we could
define a <code>Dockerfile</code> for the microservice that can build it from source,
perhaps using the <a href="https://docs.docker.com/develop/develop-images/multistage-build/">multistage builder pattern</a>, and include and entry
like the one for <a href="#the-test-runner-2">the test runner</a> rather than specifying a
tag for an already built image.</p>
<h2 id="mockserver-1">Mockserver</h2>
<p><code>mockdeps:</code></p>
<p>The <a href="http://www.mock-server.com/">mockserver</a> entry exposes a port and passes that as an
argument to <a href="http://www.mock-server.com/">mockserver</a>.</p>
<p>You can copy this section verbatim, updating the <a href="https://hub.docker.com/r/jamesdbloom/mockserver/tags">mockserver version</a>.</p>
<h1 id="running-the-tests">Running The Tests</h1>
<p>With this setup, and our microservice container built (and tagged as <code>x:test</code>),
we can spin up the microservice and the mockserver with:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ IMAGE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;x:test&#34;</span> docker-compose up -d mockdeps microservice
</code></pre></div><p>To run the tests:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ docker-compose up --build test
...
</code></pre></div><p>The <code>--build</code> parameter ensures <a href="#the-test-runner">the test runner</a> is rebuilt,
so if we&rsquo;ve edited our test code, the new test code will be run.</p>
<p>To pass arguments to our command that runs the tests, e.g. to only run a
specific test:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ TEST_ARGS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-t specific_test_1&#34;</span> docker-compose up --build test
</code></pre></div><p>Perhaps we&rsquo;ve forgotten the CLI of the tool that runs our tests:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ TEST_ARGS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;--help&#34;</span> docker-compose up --build test
</code></pre></div><p>To tear down the whole test setup:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ docker-compose down
</code></pre></div><h1 id="summary">Summary</h1>
<p>So it&rsquo;s as simple as that.  Don&rsquo;t write complicated request handling test code,
and code that painstakingly mocks out all downstream dependencies, let
<a href="http://www.mock-server.com/">mockserver</a> do that heavy lifting for you. Using
<a href="https://docs.docker.com/compose/">docker-compose</a> you can rebuild your tests (and perhaps also your
microservice) and run the tests with a couple of commands.  Iterate fast and
test your microservice by driving its API.  At the end of the day, it&rsquo;s the API
that matters.</p>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p>You could do this in <a href="https://kubernetes.io/">kubernetes</a>. There are
miniature kubernetes implementations that you can install on your dev machine
or run in CI: <a href="https://github.com/kubernetes/minikube">minikube</a>,
<a href="https://k3s.io/">k3s</a>, <a href="https://microk8s.io/">microk8s</a>. You could put the
<a href="#test-setup">elements</a> in
<a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/">Pods</a> or
<a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/">Deployments</a>
and route them to each other via
<a href="https://kubernetes.io/docs/concepts/services-networking/service/">Services</a>.
None of the test code would have to change. To me that seemed more effort
than writing a short docker-compose file for this small setup.  Mockserver
published <a href="http://www.mock-server.com/where/kubernetes.html">a helm chart</a>
which could be useful.  Mockserver could be used in a larger test setup on a
persistent kubernetes cluster. <a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2" role="doc-endnote">
<p>There&rsquo;s plenty of client libraries out there for mockserver.  <a href="https://pypi.org/search/?q=mockserver">Python has
a few</a>, I used a couple and they
didn&rsquo;t actually work, so I had to patch them.  I&rsquo;d recommending generating
you&rsquo;re own from mockserver&rsquo;s <a href="https://app.swaggerhub.com/apis/jamesdbloom/mock-server-openapi/5.0.x">openAPI
spec</a>
using <a href="https://github.com/OpenAPITools/openapi-generator">openAPI Generator</a>. <a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section>


</article>


<section class="post-nav">
    <ul>
        
        
        <li>
            <a href="https://tarquin-the-brave.github.io/blog/posts/ide-read-code/">You Shouldn&#39;t Need an IDE to Read Code <i class="fa fa-chevron-circle-right"></i> </a>
        </li>
        
    </ul>
</section>
  
    
        <section id="utterances"></section>

<script>
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        let s = document.createElement("script");
        s.setAttribute("repo", "tarquin-the-brave\/blog");
        s.src = "https://utteranc.es/client.js";
        
          s.setAttribute("issue-term", "pathname");
        
        
        document.getElementById("utterances").innerHTML = "";
        document.getElementById("utterances").appendChild(s);
    } else {
        let s = document.createElement("script");
        s.setAttribute("repo", "tarquin-the-brave\/blog");
        s.src = "https://utteranc.es/client.js";
        
          s.setAttribute("issue-term", "pathname");
        
        
        document.getElementById("utterances").innerHTML = "";
        document.getElementById("utterances").appendChild(s);
    }
</script>

    
    
  





</main>
    <footer>
        <h6>Copyright Â© 2020 - Tom Steavenson |
            Rendered by <a href="https://gohugo.io" title="Hugo">Hugo</a> |
            <a href="https://tarquin-the-brave.github.io/blog/index.xml">Subscribe </a></h6>
    </footer>
</div>
<script src="https://tarquin-the-brave.github.io/blog/js/scripts.js"></script>

  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-161243400-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



</body>

</html>

