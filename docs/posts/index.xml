<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Posts on tarquin-the-brave</title><link>https://tarquin-the-brave.github.io/blog/posts/</link><description>Recent content in Posts on tarquin-the-brave</description><generator>Hugo -- gohugo.io</generator><copyright>Copyright &amp;copy; 2020 - Tom Steavenson</copyright><lastBuildDate>Sat, 19 Feb 2022 15:00:48 +0000</lastBuildDate><atom:link href="https://tarquin-the-brave.github.io/blog/posts/index.xml" rel="self" type="application/rss+xml"/><item><title>yes, please clear my terminal</title><link>https://tarquin-the-brave.github.io/blog/posts/yes-please-clear-my-terminal/</link><pubDate>Sat, 19 Feb 2022 15:00:48 +0000</pubDate><guid>https://tarquin-the-brave.github.io/blog/posts/yes-please-clear-my-terminal/</guid><description>&lt;p>We&amp;rsquo;ve all been there. You&amp;rsquo;ve been running some commands. You switch focus
away from your terminal. You come back. And your terminal is full of crap
you&amp;rsquo;re not interested in anymore. “Get this out of my sight”, you think.
&lt;a href="https://man7.org/linux/man-pages/man1/clear.1.html">&lt;code>clear&lt;/code>&lt;/a> you type.&lt;/p>
&lt;p>Problem solved. Blog post over. Oh but wait! This doesn&amp;rsquo;t solve all my woes.&lt;/p>
&lt;p>There&amp;rsquo;s another time when the ghosts of a command past can muddy your view.
Say you&amp;rsquo;ve run some tests. There&amp;rsquo;s lots of output that you&amp;rsquo;ll need to scroll
back through in case of a failure. You find the failure. You make a fix. You
run the tests again. There&amp;rsquo;s another failure. So you scroll up, &lt;code>Ctrl A, [, PgUp&lt;/code> or however you do it. This second time it&amp;rsquo;s easy to miss where your most
recent test output starts and where the old one ends.&lt;/p>
&lt;p>I found &lt;a href="https://man7.org/linux/man-pages/man1/clear.1.html">&lt;code>clear&lt;/code>&lt;/a> doesn&amp;rsquo;t work for me this time. Running &lt;a href="https://man7.org/linux/man-pages/man1/clear.1.html">&lt;code>clear&lt;/code>&lt;/a>, then scrolling
up, I see no gap between the previous output and my prompt. Looking into &lt;a href="https://man7.org/linux/man-pages/man1/clear.1.html">the
man pages&lt;/a>, it says “clears
your screen if this is possible, including its scrollback buffer (if the
extended “E3” capability is defined).”. OK so this is probably a &lt;code>tmux&lt;/code> issue.
Exiting &lt;code>tmux&lt;/code> I find that &lt;a href="https://man7.org/linux/man-pages/man1/clear.1.html">&lt;code>clear&lt;/code>&lt;/a> does in fact clear the scroll history too.
Outside of &lt;code>tmux&lt;/code> , passing the &lt;code>-x&lt;/code> parameter to &lt;a href="https://man7.org/linux/man-pages/man1/clear.1.html">&lt;code>clear&lt;/code>&lt;/a> (to stop it clearing
scrollback buffer) give me the same effect as I saw in &lt;code>tmux&lt;/code> .&lt;/p>
&lt;p>So at this point I should probably give up on this blog post and go and work
out how to make &lt;a href="https://man7.org/linux/man-pages/man1/clear.1.html">&lt;code>clear&lt;/code>&lt;/a> work the same in &lt;code>tmux&lt;/code>. But wait, there might still
be a use case that &lt;a href="https://man7.org/linux/man-pages/man1/clear.1.html">&lt;code>clear&lt;/code>&lt;/a> can&amp;rsquo;t fulfil here. Suppose I want to not throw away
the old test output, but still have a clear point in the history where the old
test output ended and a new one begins.&lt;/p>
&lt;p>You could solve this problem by holding down the &lt;code>return&lt;/code> key for a few seconds
so there was an obvious band in the terminal history of just the prompt. But
there&amp;rsquo;s a slightly more inventive solution:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">yes &lt;span style="color:#e6db74">&amp;#34;&amp;#34;&lt;/span> | head -50
&lt;/code>&lt;/pre>&lt;/div>&lt;p>What&amp;rsquo;s going on here? &lt;a href="https://man7.org/linux/man-pages/man1/yes.1.html">&lt;code>yes&lt;/code>&lt;/a> is a
command that will repeatedly
output the string given (or &lt;code>y&lt;/code> if no string is given). So giving it the empty
string will make it produce newlines to stdout.&lt;/p>
&lt;p>The appearance of &lt;a href="https://man7.org/linux/man-pages/man1/yes.1.html">&lt;code>yes&lt;/code>&lt;/a> in script or a command line is almost always a sign
that you&amp;rsquo;re doing something wrong. It can be used as a hack to automate
interactive CLIs that you know you&amp;rsquo;re going to say “yes” to:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">yes | apt install foo
yes | rm -ir some_directory/
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Or even if you know you&amp;rsquo;re going to say “no”:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">yes no | &amp;lt;command&amp;gt;
&lt;/code>&lt;/pre>&lt;/div>&lt;p>I know, right.&lt;/p>
&lt;p>But CLI commands &lt;em>usually&lt;/em> have parameters that you can pass to achieve a
non-interactive mode:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">apt install -y foo
rm -rif some_directory/
&lt;/code>&lt;/pre>&lt;/div>&lt;p>It&amp;rsquo;s somewhat reminiscent of the &lt;a href="https://en.wikipedia.org/wiki/Cat_(Unix)#Useless_use_of_cat">“Useless Use of
&lt;code>cat&lt;/code>&amp;rdquo;.&lt;/a>&lt;/p>
&lt;p>Apart from my beautiful command above, I think I&amp;rsquo;ve only used &lt;a href="https://man7.org/linux/man-pages/man1/yes.1.html">&lt;code>yes&lt;/code>&lt;/a>
”legitimately” once: doing a quick test of a TCP connection by piping &lt;a href="https://man7.org/linux/man-pages/man1/yes.1.html">&lt;code>yes&lt;/code>&lt;/a>
into netcat&amp;hellip; maybe. What is “legitimate usage” anyway&amp;hellip;&lt;/p>
&lt;p>&lt;code>head -50&lt;/code> will take the first 50 lines of this. The &lt;code>-50&lt;/code> parameter is
&lt;em>actually an &lt;a href="https://man7.org/linux/man-pages/man1/head.1.html">undocumented&lt;/a>
archaic use&lt;/em> of &lt;code>head&lt;/code> (and &lt;code>tail&lt;/code>) which apparently is only supported for back
compatibility. It&amp;rsquo;s equivalent to &lt;code>-n 50&lt;/code>. You can change &lt;code>50&lt;/code> with any
number. Some experimentation is needed with your terminal and the size of text
you have.&lt;/p>
&lt;p>So there we have it. A slightly convoluted way of getting something you
probably don&amp;rsquo;t need, but seems to have always amused anyone I&amp;rsquo;m paring with
when I do it.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">yes &lt;span style="color:#e6db74">&amp;#34;&amp;#34;&lt;/span> | head -50
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;em>I&amp;rsquo;m hoping someone chimes in with a “why don&amp;rsquo;t you just do X” so I can
un-muscle-memory this one.&lt;/em>&lt;/p></description></item><item><title>Why I Found Microsoft Office So Jarring</title><link>https://tarquin-the-brave.github.io/blog/posts/a_thought_on_office_products/</link><pubDate>Sat, 19 Feb 2022 12:54:00 +0000</pubDate><guid>https://tarquin-the-brave.github.io/blog/posts/a_thought_on_office_products/</guid><description>&lt;p>Like a lot of people. I was brought up on Microsoft Office: Word, Powerpoint,
etc. You did what you needed to do, save it to your computer, and if you wanted
to take it elsewhere you copied it onto a pendrive or disc, and haphazardly
left it on a train for a journalist to find. But throughout the process your
files were very much &lt;em>in your possession&lt;/em>. I had a whole childhood and
adolescence where that was the model.&lt;/p>
&lt;p>Then at some point last decade the upgraded versions of the same office
products you&amp;rsquo;d been using starting taking your files from you, from your
computer that you were working on the in, and storing them off &amp;ldquo;somewhere in
the cloud&amp;rdquo;.&lt;/p>
&lt;p>Contrast this to Google&amp;rsquo;s equivalent products. I make casual use of them for
personal stuff: speadsheeting holiday expenses, etc. I&amp;rsquo;ve always used them
through the browser and the model is more like: I go to the cloud, work on my
files, then leave them there in my little bit of the cloud and they never leave
there.&lt;/p>
&lt;p>An analogy I find is: imagine that your doing an office job before we had all
these computery things. Say you had a workflow you were fairly content with:
You had your desk, you took your files out of a draw, worked on them, then put
them back in. Then one you&amp;rsquo;re sitting at your desk working on a file, but now
when you&amp;rsquo;re done someone comes along and says &amp;ldquo;I&amp;rsquo;ll put that away for you&amp;rdquo;.
&amp;ldquo;But where are you putting it?&amp;rdquo; you ask. &amp;ldquo;Oh don&amp;rsquo;t worry about that&amp;rdquo; they
reply, &amp;ldquo;just let me know when you want it back&amp;rdquo;. But then after they take it,
the file is still somehow there in your desk draw&amp;hellip;&lt;/p>
&lt;p>Confusion and fear would understandably ensue.&lt;/p>
&lt;p>My experience of Microsoft 365 (I think is what they call it when things are
stored off in the cloud) is continuous second guessing about what&amp;rsquo;s on my
computer, what&amp;rsquo;s in the cloud, or both. This is largely driven by the fact
we&amp;rsquo;re still using the same desktop applications that we were brought up with
and are built around the model that your files are on your computer. There are
other issues I&amp;rsquo;ve encountered around syncing, and locking which could be put
down to implementation quality. But I&amp;rsquo;ve never been that confident
conceptually with what&amp;rsquo;s going on.&lt;/p>
&lt;p>Good usable design of products, physical and software, helps the user to form a
good mental model of how it works that stays true to it&amp;rsquo;s behaviour. You don&amp;rsquo;t
have to know how it &lt;em>really&lt;/em> works, but you need a model which you base your
usage of the product on, and that needs to manifest the same outcomes and the
true implementation.&lt;/p>
&lt;p>With the Google office products the mental model is one of going &lt;em>to&lt;/em> your bit
of the cloud through your browser, doing what you need to do, then leaving your
bit of the cloud, happy that your files will be there when you come back. I
never find myself worrying.&lt;/p>
&lt;hr>
&lt;p>The good news is: I&amp;rsquo;m writing this blog post a few years too late. These days
I don&amp;rsquo;t have to deal with that many Word Documents or Powerpoints, and the
entirely online, in the browser, version of Microsoft Office is useable enough
for my purposes. I also don&amp;rsquo;t run Windows locally these days. But in the past
when I did, and the browser native version of office was fairly unusable, I
inevitably found myself using the desktop Office applications and was in this
constant state of unease.&lt;/p></description></item><item><title>A Thought on CLI Design</title><link>https://tarquin-the-brave.github.io/blog/posts/a_thought_on_cli_design/</link><pubDate>Sat, 27 Mar 2021 09:00:00 +0000</pubDate><guid>https://tarquin-the-brave.github.io/blog/posts/a_thought_on_cli_design/</guid><description>&lt;p>Recently I was using a wrapper around a CLI tool. It does what you might
expect a CLI wrapper to do: set up some peripheral things, environment
variables and such like, then runs the underlying CLI tool with some CLI
parameters set and passes argument given to the wrapper down to provide extra
parameters. This pattern can be pretty useful to make a particular use case of
a CLI tool easier to perform. E.g:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#75715e">#!/usr/bin/env sh
&lt;/span>&lt;span style="color:#75715e">&lt;/span>underlying-cli-tool --some-param foo --other-param bar $@
&lt;/code>&lt;/pre>&lt;/div>&lt;p>But there was a problem. One of the parameters I passed to the wrapper was
already being set by the wrapper. The underlying CLI tool then errored with
something to the effect of:&lt;/p>
&lt;blockquote>
&lt;p>&amp;ldquo;You&amp;rsquo;ve set the same parameter twice! 😱&amp;rdquo;&lt;/p>
&lt;/blockquote>
&lt;p>This was easy enough to work around. I had ownership of the wrapper and could
edit the source code to &lt;em>not&lt;/em> set that parameter explicitly, rebuild it and run
it as I&amp;rsquo;d initially intended. But I did think:&lt;/p>
&lt;blockquote>
&lt;p>&amp;ldquo;That was a bit annoying&amp;rdquo;&lt;/p>
&lt;/blockquote>
&lt;p>and had I not had ownership of the wrapper it could have been more annoying to
fork it, edit the source, then potentially deal with rebuilding it when I
haven&amp;rsquo;t got the build environment for it at my fingertips.&lt;/p>
&lt;hr>
&lt;p>This got me thinking:&lt;/p>
&lt;blockquote>
&lt;p>&amp;ldquo;How should have things worked here?&amp;rdquo;&lt;/p>
&lt;/blockquote>
&lt;p>I can see where the designers of the underlying CLI tool were coming from.&lt;/p>
&lt;blockquote>
&lt;p>&amp;ldquo;If a parameter is provided twice, when it makes no sense to provide it twice,
obviously it&amp;rsquo;s a user error and we should error on this.&amp;rdquo;&lt;/p>
&lt;/blockquote>
&lt;p>But this does mean that any wrappers written around the CLI tool have to deal
with the complexity of:&lt;/p>
&lt;ul>
&lt;li>Look at the extra parameters&lt;/li>
&lt;li>For any of them that conflict with ones already set:
&lt;ul>
&lt;li>Does the underlying CLI tool allow it to be set twice?&lt;/li>
&lt;li>If not: take that parameter out of the ones being set by default to allow
the user&amp;rsquo;s value to be set instead.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>And maybe it isn&amp;rsquo;t a user error. Imagine you&amp;rsquo;ve just run a big long command
then want to change the one of the earlier parameters you gave and run it again.
It would be more convenient to arrow up then put the parameter again at the
end to override it than to go back into the command line and edit the parameter.&lt;/p>
&lt;p>Wouldn&amp;rsquo;t this all be easier if the underlying CLI tool accepted a repeated
parameter, taking the latter as overriding the former?&lt;/p>
&lt;p>Ultimately there&amp;rsquo;s a trade off between a potential bit of robustness against an
error by a direct user of the CLI tool and the ability to write convenient
wrappers around it. I suspect in many cases the latter isn&amp;rsquo;t considered.&lt;/p>
&lt;hr>
&lt;p>In reality if you&amp;rsquo;re writing a CLI tool, you&amp;rsquo;re likely using a library to
do the heavy lifting, rather than hand rolling it yourself.&lt;/p>
&lt;p>Let&amp;rsquo;s have a look at a couple (using the basic mainline usage).&lt;/p>
&lt;p>Rust&amp;rsquo;s &lt;a href="https://docs.rs/structopt/0.3.21/structopt/">&lt;code>structopt&lt;/code>&lt;/a> (&lt;a href="https://docs.rs/clap/2.33.3/clap/index.html">&lt;code>clap&lt;/code>&lt;/a> under the covers):&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-rust" data-lang="rust">&lt;span style="color:#75715e">#[derive(Debug, structopt::StructOpt)]&lt;/span>
&lt;span style="color:#66d9ef">pub&lt;/span> &lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">Cli&lt;/span> {
&lt;span style="color:#75715e">#[structopt(long)]&lt;/span>
foo: String,
&lt;span style="color:#75715e">#[structopt(long)]&lt;/span>
bar: String,
}
&lt;span style="color:#66d9ef">fn&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>() {
&lt;span style="color:#66d9ef">use&lt;/span> structopt::StructOpt &lt;span style="color:#66d9ef">as&lt;/span> _;
&lt;span style="color:#66d9ef">let&lt;/span> cli &lt;span style="color:#f92672">=&lt;/span> Cli::from_args();
println&lt;span style="color:#f92672">!&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;Got: {:?}&amp;#34;&lt;/span>, cli);
}
&lt;/code>&lt;/pre>&lt;/div>&lt;pre>&lt;code>$ cargo run -q -- --foo foo --bar bar
Got: Cli { foo: &amp;quot;foo&amp;quot;, bar: &amp;quot;bar&amp;quot; }
$ cargo run -q -- --foo foo --bar bar --foo foo2
error: The argument '--foo &amp;lt;foo&amp;gt;' was provided more than once, but cannot be used multiple times
USAGE:
a-cli-tool --bar &amp;lt;bar&amp;gt; --foo &amp;lt;foo&amp;gt;
For more information try --help
$
&lt;/code>&lt;/pre>&lt;p>Python&amp;rsquo;s &lt;a href="https://click.palletsprojects.com/en/7.x/">&lt;code>click&lt;/code>&lt;/a>:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#f92672">import&lt;/span> click
&lt;span style="color:#a6e22e">@click.command&lt;/span>()
&lt;span style="color:#a6e22e">@click.option&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;--foo&amp;#39;&lt;/span>, required&lt;span style="color:#f92672">=&lt;/span>True)
&lt;span style="color:#a6e22e">@click.option&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;--bar&amp;#39;&lt;/span>, required&lt;span style="color:#f92672">=&lt;/span>True)
&lt;span style="color:#66d9ef">def&lt;/span> &lt;span style="color:#a6e22e">hello&lt;/span>(foo, bar):
&lt;span style="color:#66d9ef">print&lt;/span>(f&lt;span style="color:#e6db74">&amp;#34;Got: foo={foo}, bar={bar}&amp;#34;&lt;/span>)
&lt;span style="color:#66d9ef">if&lt;/span> __name__ &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#e6db74">&amp;#39;__main__&amp;#39;&lt;/span>:
hello()
&lt;/code>&lt;/pre>&lt;/div>&lt;pre>&lt;code>$ python3 some-tool.py --foo foo --bar bar
Got: foo=foo, bar=bar
$ python3 some-tool.py --foo foo --bar bar --foo foo2
Got: foo=foo2, bar=bar
$
&lt;/code>&lt;/pre>&lt;p>Reading the docs for &lt;a href="https://docs.rs/clap/2.33.3/clap/index.html">&lt;code>clap&lt;/code>&lt;/a> I can get it to allow this overriding
behaviour:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-rust" data-lang="rust">&lt;span style="color:#75715e">#[derive(Debug, structopt::StructOpt)]&lt;/span>
&lt;span style="color:#66d9ef">pub&lt;/span> &lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">Cli&lt;/span> {
&lt;span style="color:#75715e">#[structopt(long, multiple = true, required = true)]&lt;/span>
foo: Vec&lt;span style="color:#f92672">&amp;lt;&lt;/span>String&lt;span style="color:#f92672">&amp;gt;&lt;/span>,
&lt;span style="color:#75715e">#[structopt(long)]&lt;/span>
bar: String,
}
&lt;span style="color:#66d9ef">fn&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>() {
&lt;span style="color:#66d9ef">use&lt;/span> structopt::StructOpt &lt;span style="color:#66d9ef">as&lt;/span> _;
&lt;span style="color:#66d9ef">let&lt;/span> &lt;span style="color:#66d9ef">mut&lt;/span> cli &lt;span style="color:#f92672">=&lt;/span> Cli::from_args();
&lt;span style="color:#66d9ef">let&lt;/span> foo &lt;span style="color:#f92672">=&lt;/span> cli.foo.pop().unwrap();
&lt;span style="color:#66d9ef">let&lt;/span> bar &lt;span style="color:#f92672">=&lt;/span> cli.bar.clone();
println&lt;span style="color:#f92672">!&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;Got: foo={}, bar={}&amp;#34;&lt;/span>, foo, bar);
}
&lt;/code>&lt;/pre>&lt;/div>&lt;pre>&lt;code>$ cargo run -q -- --foo foo --bar bar --foo foo2
Got: foo=foo2, bar=bar
&lt;/code>&lt;/pre>&lt;p>But handling that &lt;code>Vec&lt;/code> of values for the parameter is a pain when we want the
last to override what&amp;rsquo;s come before. Really we want to discard earlier values
of the parameter before parsing.&lt;/p>
&lt;p>&lt;a href="https://docs.rs/structopt/0.3.21/structopt/">&lt;code>structopt&lt;/code>&lt;/a> is a library that lets you define your CLI as
structured data, adding annotations to specify behaviours of the
arguments/parameters. It in turn calls down to the &lt;a href="https://docs.rs/clap/2.33.3/clap/index.html">&lt;code>clap&lt;/code>&lt;/a> library to
parse the CLI into structured data. Using &lt;a href="https://docs.rs/clap/2.33.3/clap/index.html">&lt;code>clap&lt;/code>&lt;/a> directly we can
achieve the override behaviour I&amp;rsquo;m looking for:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-rust" data-lang="rust">&lt;span style="color:#66d9ef">fn&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>() {
&lt;span style="color:#66d9ef">let&lt;/span> matches &lt;span style="color:#f92672">=&lt;/span> clap::App::new(&lt;span style="color:#e6db74">&amp;#34;Some CLI Tool&amp;#34;&lt;/span>)
.global_setting(clap::AppSettings::AllArgsOverrideSelf)
.arg(
clap::Arg::with_name(&lt;span style="color:#e6db74">&amp;#34;foo&amp;#34;&lt;/span>)
.takes_value(&lt;span style="color:#66d9ef">true&lt;/span>)
.required(&lt;span style="color:#66d9ef">true&lt;/span>)
.long(&lt;span style="color:#e6db74">&amp;#34;foo&amp;#34;&lt;/span>),
)
.arg(
clap::Arg::with_name(&lt;span style="color:#e6db74">&amp;#34;bar&amp;#34;&lt;/span>)
.takes_value(&lt;span style="color:#66d9ef">true&lt;/span>)
.required(&lt;span style="color:#66d9ef">true&lt;/span>)
.long(&lt;span style="color:#e6db74">&amp;#34;bar&amp;#34;&lt;/span>),
)
.get_matches();
&lt;span style="color:#66d9ef">let&lt;/span> foo &lt;span style="color:#f92672">=&lt;/span> matches.value_of(&lt;span style="color:#e6db74">&amp;#34;foo&amp;#34;&lt;/span>).unwrap();
&lt;span style="color:#66d9ef">let&lt;/span> bar &lt;span style="color:#f92672">=&lt;/span> matches.value_of(&lt;span style="color:#e6db74">&amp;#34;bar&amp;#34;&lt;/span>).unwrap();
println&lt;span style="color:#f92672">!&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;Got: foo={}, bar={}&amp;#34;&lt;/span>, foo, bar);
}
&lt;/code>&lt;/pre>&lt;/div>&lt;pre>&lt;code>$ cargo run -q -- --foo foo --bar bar
Got: foo=foo, bar=bar
$ cargo run -q -- --foo foo --bar bar --foo foo2
Got: foo=foo2, bar=bar
&lt;/code>&lt;/pre>&lt;p>There might be a way to set the &lt;code>AppSettings::AllArgsOverrideSelf&lt;/code> via
&lt;a href="https://docs.rs/structopt/0.3.21/structopt/">&lt;code>structopt&lt;/code>&lt;/a>, but from a quick skim of the docs and a little
playing around I didn&amp;rsquo;t spot it.&lt;/p>
&lt;p>The fact you &lt;em>can&lt;/em> get this overriding behaviour from
&lt;a href="https://docs.rs/clap/2.33.3/clap/index.html">&lt;code>clap&lt;/code>&lt;/a>/&lt;a href="https://docs.rs/structopt/0.3.21/structopt/">&lt;code>structopt&lt;/code>&lt;/a> is somewhat beside the point, it&amp;rsquo;s not
the default, and writing the CLI tool you&amp;rsquo;d explicitly have to go to the effort
of enabling it.&lt;/p>
&lt;p>Without exhaustively going through every CLI building library in every
language, I can&amp;rsquo;t say too much about whether there&amp;rsquo;s a trend either way. It&amp;rsquo;s
probably safe to assume that some libraries allow you to repeat and override
parameters by default, some don&amp;rsquo;t. And it&amp;rsquo;s also probably a safe assumption
that a lot of CLI tools will have adopted the default from the library their
using.&lt;/p>
&lt;hr>
&lt;p>So what does some unix tooling have to say about all this?&lt;/p>
&lt;p>Take &lt;a href="https://linux.die.net/man/8/tcpdump">&lt;code>tcpdump&lt;/code>&lt;/a>. When we give it two
&lt;code>-w&lt;/code> parameters like so:&lt;/p>
&lt;pre>&lt;code>tcpdump port 8000 -w foo.pcap -w -
&lt;/code>&lt;/pre>&lt;p>it writes the capture to the second &lt;code>-w&lt;/code> parameter (&lt;code>-w -&lt;/code> means &amp;ldquo;write to
stdout&amp;rdquo;). Sending some traffic into port 8000 I saw the capture appear in
stdout but no &lt;code>foo.pcap&lt;/code> was created when I cancelled the command. Swapping
the parameters around, and the opposite was true.&lt;/p>
&lt;p>Running &lt;a href="https://linux.die.net/man/8/useradd">&lt;code>useradd&lt;/code>&lt;/a>, specifying the home directory to create twice:&lt;/p>
&lt;pre>&lt;code>useradd foo --home-dir /home/foo/ --home-dir /home/foo2/
&lt;/code>&lt;/pre>&lt;p>User &lt;code>foo&lt;/code> is created with home directory &lt;code>/home/foo2/&lt;/code>.&lt;/p>
&lt;p>One could imagine having wrapper scripts for these that set a value then
include extra parameters to allow them to be overridden.&lt;/p>
&lt;hr>
&lt;p>With the very small sample set of the tools/frameworks I&amp;rsquo;ve looked at above it
wouldn&amp;rsquo;t be right to say there&amp;rsquo;s definitely a trend here, but if we assume
there is, have CLI tools potentially lost something? In attempting to catch a
possible error by a direct user have they lost something in terms of how easy
it is to write wrappers around them?&lt;/p>
&lt;p>Maybe.&lt;/p>
&lt;p>Next time I&amp;rsquo;m making a CLI tool, I&amp;rsquo;ll consider this.&lt;/p></description></item><item><title>Generating a Config File Reference for a CLI Tool in Rust</title><link>https://tarquin-the-brave.github.io/blog/posts/generating-config-reference-rust-cli/</link><pubDate>Tue, 17 Nov 2020 21:00:00 +0000</pubDate><guid>https://tarquin-the-brave.github.io/blog/posts/generating-config-reference-rust-cli/</guid><description>&lt;p>There&amp;rsquo;s something missing from the documentation of CLI tools.&lt;/p>
&lt;p>They often have home pages that do a great job of explaining the core concepts,
giving a &amp;ldquo;Quick Start&amp;rdquo; guide, and demonstrating some use cases.&lt;/p>
&lt;p>Where I find tools&amp;rsquo; documentation is missing something, is when you&amp;rsquo;re already
well acquainted with the tool, and you want to know some specific detail about
a single field like what possible values it can have or exactly where it sits
in the structure of the config. I find myself really in need of a &amp;ldquo;config file
reference&amp;rdquo; akin to the ones you see for APIs which get generated from API Specs
or code.&lt;/p>
&lt;p>Having worked with the Kubernetes API a fair bit over the last few years I find
myself going straight to &lt;a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/">the API reference&lt;/a> whenever I need to look
something up, as I&amp;rsquo;m normally looking up the specifics of where a field lives
or what it does. Having documentation that allows you to follow links to
navigate through the structure of the API objects is really helpful. Kubernetes
also has a load of concept guides and walkthroughs in &lt;a href="https://kubernetes.io/docs/home/">its
documentation&lt;/a>. It&amp;rsquo;s something I&amp;rsquo;d hold up as a generally well
documented thing.&lt;/p>
&lt;p>It&amp;rsquo;s often hard to find out the specifics of a config field if it doesn&amp;rsquo;t
appear in examples or some explanation. Projects that make an attempt to
provide a reference for config seem to follow the same pattern. For relatively
simple config files they provide an example with all the fields, optional and
not, provided, and then comment the example to say what&amp;rsquo;s optional and what the
possible values are.&lt;/p>
&lt;p>&lt;img src="https://tarquin-the-brave.github.io/blog/images/rust-docs-config-ref/helm-chart-file.png" alt="">&lt;/p>
&lt;p>This works OK while the config is small and simple. But as config grows in
size and becomes more complex in terms of what fields are needed, where
sections of config could have alternatives, or be required only if some other
config is set, it starts to get out of hand. That example above is the
documentation for &lt;a href="https://helm.sh/docs/topics/charts/#the-chartyaml-file">Helm charts&amp;rsquo; &lt;code>Chart.yaml&lt;/code>
file&lt;/a>.&lt;/p>
&lt;p>It seems beyond a certain point projects that do provide a config reference
resort to a more protracted form of a web page that lists each field and
provides the information on it. This produces something that is complete, but
isn&amp;rsquo;t always that easy to navigate, scrolling is often your only resort, and I
find I lose track of where a field is nested within the structure.&lt;/p>
&lt;p>In both approaches mentioned there, there is the problem that the config file
reference is maintained separately from the code that defines it. For
maintainability and correctness&amp;rsquo; sake, we really want the code that defines
config, and the documentation that attempts to provide a complete and correct
reference for it, to be together.&lt;/p>
&lt;p>I&amp;rsquo;ve written a few CLI tool in Rust. I&amp;rsquo;m not sure I fully understand why, but
Rust is a excellent language for writing CLI tools in. I don&amp;rsquo;t think there&amp;rsquo;s
much about the core tenets of the language that necessarily make that so. The
representation of errors in sum types, &lt;code>Result&amp;lt;T, E&amp;gt;&lt;/code>, does strongly encourage
the errors to be handled right back to &lt;code>main&lt;/code> and the user, but the &lt;code>?&lt;/code>
operator makes it all to easy to throw out a cryptic error message from a
library you&amp;rsquo;ve called with no context relevant to your application. I think
really it&amp;rsquo;s just that there&amp;rsquo;s some really well designed libraries to make CLI
tools with: &lt;a href="https://docs.rs/clap/2.33.3/clap/">&lt;code>clap&lt;/code>&lt;/a>, &lt;a href="https://docs.rs/structopt/0.3.20">&lt;code>structopt&lt;/code>&lt;/a>, and &lt;a href="https://serde.rs/">&lt;code>serde&lt;/code>&lt;/a> (for
parsing config files).&lt;/p>
&lt;p>So what I&amp;rsquo;m looking for is config file documentation that:&lt;/p>
&lt;ul>
&lt;li>Reflects the structure of the config,&lt;/li>
&lt;li>Is navigable by following links into and back out of config substructure, and&lt;/li>
&lt;li>Is defined in code.&lt;/li>
&lt;/ul>
&lt;p>🔍&lt;/p>
&lt;h1 id="rust-docs">Rust Docs&lt;/h1>
&lt;p>I&amp;rsquo;ve noticed Rust docs going largely unused in binary crates.&lt;/p>
&lt;p>Perhaps they could fulfil what I&amp;rsquo;m looking for. Rust docs reflect the
structure of structures. Rust docs are navigable by following links. The
source for them is defined in code. It&amp;rsquo;s sounding like a strong candidate, on
paper at least&amp;hellip;&lt;/p>
&lt;p>I&amp;rsquo;ve made a dummy CLI tool to see how this looks.&lt;/p>
&lt;p>Defining a reasonably simplistic config structure:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-rust" data-lang="rust">&lt;span style="color:#75715e">#[derive(serde::Deserialize)]&lt;/span>
&lt;span style="color:#66d9ef">pub&lt;/span> &lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">Config&lt;/span> {
name: String,
version: &lt;span style="color:#a6e22e">semver&lt;/span>::Version,
description: String,
source: &lt;span style="color:#a6e22e">Source&lt;/span>,
target: &lt;span style="color:#a6e22e">std&lt;/span>::path::PathBuf,
}
&lt;span style="color:#75715e">#[derive(serde::Deserialize)]&lt;/span>
&lt;span style="color:#75715e">#[serde(rename_all = &lt;/span>&lt;span style="color:#e6db74">&amp;#34;snake_case&amp;#34;&lt;/span>&lt;span style="color:#75715e">)]&lt;/span>
&lt;span style="color:#66d9ef">pub&lt;/span> &lt;span style="color:#66d9ef">enum&lt;/span> &lt;span style="color:#a6e22e">Source&lt;/span> {
File(std::path::PathBuf),
Url(String),
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>The Rust docs looks like:&lt;/p>
&lt;p>&lt;img src="https://tarquin-the-brave.github.io/blog/images/rust-docs-config-ref/config1.png" alt="">&lt;/p>
&lt;p>We can see the fields and their types. Not all the types are types in the
format language of the config file, but with a comment we can clarify that.
Where the type doesn&amp;rsquo;t map to a type of the config file format people can
follow the link to see what it is.&lt;/p>
&lt;p>This is in keeping with API documentations that may show a field&amp;rsquo;s type to be
another object. Take the documentation for a &lt;a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#pod-v1-core">Kubernetes
Pod&lt;/a>
for example:&lt;/p>
&lt;p>&lt;img src="https://tarquin-the-brave.github.io/blog/images/rust-docs-config-ref/k8s1.png" alt="">&lt;/p>
&lt;p>&lt;code>ObjectMeta&lt;/code> &amp;amp; &lt;code>PodSpec&lt;/code> aren&amp;rsquo;t JSON types, but you follow the link to see
what JSON they&amp;rsquo;re made of.&lt;/p>
&lt;p>We can follow the link to &lt;code>Source&lt;/code> to see what that is:&lt;/p>
&lt;p>&lt;img src="https://tarquin-the-brave.github.io/blog/images/rust-docs-config-ref/source1.png" alt="">&lt;/p>
&lt;p>Granted, there&amp;rsquo;s some obvious problems emerging already.&lt;/p>
&lt;p>If a reader follows a link to a foreign type there&amp;rsquo;s no guarantee that that
type&amp;rsquo;s documentation will helpfully portray how that type is serialized in our
chosen config file format.&lt;/p>
&lt;p>For the enum above, the representation in the Rust docs is quite diverged from
how it would appear in the config file. And perhaps some Rust literacy is
going to be needed to know that an enum is something that could be one variant,
or another.&lt;/p>
&lt;p>Any difference between the Rust structure and config file representation that&amp;rsquo;s
given by attributes, e.g. the:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-rust" data-lang="rust">&lt;span style="color:#75715e">#[serde(rename_all = &lt;/span>&lt;span style="color:#e6db74">&amp;#34;snake_case&amp;#34;&lt;/span>&lt;span style="color:#75715e">)]&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>isn&amp;rsquo;t accounted for.&lt;/p>
&lt;p>But maybe these are things we can fix up with comments. Let&amp;rsquo;s assume for now
the config file format is YAML.&lt;/p>
&lt;p>&lt;img src="https://tarquin-the-brave.github.io/blog/images/rust-docs-config-ref/config2.png" alt="">&lt;/p>
&lt;p>Following the link to &lt;code>Source&lt;/code> again:&lt;/p>
&lt;p>&lt;img src="https://tarquin-the-brave.github.io/blog/images/rust-docs-config-ref/source2.png" alt="">&lt;/p>
&lt;p>This doesn&amp;rsquo;t look so bad now. There&amp;rsquo;s even a nice link to go back up to top
level config, which when you follow it, takes you to the field this data is
under in the parent.&lt;/p>
&lt;p>&lt;img src="https://tarquin-the-brave.github.io/blog/images/rust-docs-config-ref/config2source.png" alt="">&lt;/p>
&lt;p>You can also expand and collapse the descriptions of each field as you browse
around.&lt;/p>
&lt;p>I admit, I am massively skimming over the fact that in both cases of &lt;code>Source&lt;/code>
and &lt;code>Config&lt;/code> what I&amp;rsquo;m showing above &lt;a href="https://tarquin-the-brave.github.io/a-cli-tool/rust-docs/a_cli_tool/config2/struct.Config.html">isn&amp;rsquo;t all that appears on the
page&lt;/a>. There&amp;rsquo;s methods and trait implementations below and a sidebar
that links you to them with a big Rust symbol in it. This is definitely a
problem, but one that I&amp;rsquo;m going to come back to. 🙈 🙉&lt;/p>
&lt;p>Let&amp;rsquo;s make this config more complex and see what happens! 😼&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-rust" data-lang="rust">&lt;span style="color:#75715e">#[derive(serde::Deserialize)]&lt;/span>
&lt;span style="color:#66d9ef">pub&lt;/span> &lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">Config&lt;/span> {
name: String,
version: &lt;span style="color:#a6e22e">semver&lt;/span>::Version,
description: Option&lt;span style="color:#f92672">&amp;lt;&lt;/span>String&lt;span style="color:#f92672">&amp;gt;&lt;/span>,
&lt;span style="color:#75715e">#[serde(flatten)]&lt;/span>
data: &lt;span style="color:#a6e22e">AppData&lt;/span>,
}
&lt;span style="color:#75715e">#[derive(serde::Deserialize)]&lt;/span>
&lt;span style="color:#66d9ef">pub&lt;/span> &lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">AppData&lt;/span> {
source: &lt;span style="color:#a6e22e">Source&lt;/span>,
target: &lt;span style="color:#a6e22e">std&lt;/span>::path::PathBuf,
actions: Vec&lt;span style="color:#f92672">&amp;lt;&lt;/span>Actions&lt;span style="color:#f92672">&amp;gt;&lt;/span>,
}
&lt;span style="color:#75715e">#[derive(serde::Deserialize)]&lt;/span>
&lt;span style="color:#75715e">#[serde(rename_all = &lt;/span>&lt;span style="color:#e6db74">&amp;#34;snake_case&amp;#34;&lt;/span>&lt;span style="color:#75715e">)]&lt;/span>
&lt;span style="color:#66d9ef">pub&lt;/span> &lt;span style="color:#66d9ef">enum&lt;/span> &lt;span style="color:#a6e22e">Source&lt;/span> {
File(std::path::PathBuf),
Url(String),
}
&lt;span style="color:#75715e">#[derive(serde::Deserialize)]&lt;/span>
&lt;span style="color:#75715e">#[serde(rename_all = &lt;/span>&lt;span style="color:#e6db74">&amp;#34;snake_case&amp;#34;&lt;/span>&lt;span style="color:#75715e">)]&lt;/span>
&lt;span style="color:#66d9ef">pub&lt;/span> &lt;span style="color:#66d9ef">enum&lt;/span> &lt;span style="color:#a6e22e">Actions&lt;/span> {
Foo,
Bar,
Baz,
FooBar,
BarBaz,
&lt;span style="color:#75715e">#[serde(rename = &lt;/span>&lt;span style="color:#e6db74">&amp;#34;fbb&amp;#34;&lt;/span>&lt;span style="color:#75715e">)]&lt;/span>
FooBarBaz,
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>So now our top level &lt;code>Config&lt;/code> object defines some metadata fields: &lt;code>name&lt;/code>,
&lt;code>version&lt;/code>, and a now optional &lt;code>description&lt;/code>, and flattens in the configuration
data for the application. This is going to take a bit more explaining in the
comments&amp;hellip; 😰&lt;/p>
&lt;p>&lt;img src="https://tarquin-the-brave.github.io/blog/images/rust-docs-config-ref/config4.png" alt="">&lt;/p>
&lt;p>The &lt;code>Option&lt;/code> in the &lt;code>description&lt;/code> field looks OK. With the accompanying
&amp;ldquo;&lt;em>Optional&lt;/em>:&amp;rdquo; added to the field description it gets across the field is
optional without too much confusion.&lt;/p>
&lt;p>The flattened fields under &lt;code>data&lt;/code> are less ideal. An explanation and an
example can &amp;ldquo;set the record straight&amp;rdquo; but we&amp;rsquo;re starting to have the docs
deviate from our goal of representing the structure of the config data.&lt;/p>
&lt;p>The docs that come from the &lt;code>AppData&lt;/code> have come out OK as it&amp;rsquo;s a structure that
we&amp;rsquo;re not changing field names of structure of with the serde representation.&lt;/p>
&lt;p>&lt;img src="https://tarquin-the-brave.github.io/blog/images/rust-docs-config-ref/appdata4.png" alt="">&lt;/p>
&lt;p>We&amp;rsquo;re even able to link to the &amp;ldquo;possible operations&amp;rdquo; from the &lt;code>actions&lt;/code> field.&lt;/p>
&lt;p>&lt;img src="https://tarquin-the-brave.github.io/blog/images/rust-docs-config-ref/actions4.png" alt="">&lt;/p>
&lt;p>As with the &lt;code>Sources&lt;/code> enum and the flattening of the &lt;code>AppData&lt;/code> into the top
level config we&amp;rsquo;re having the problem of:&lt;/p>
&lt;blockquote>
&lt;p>Every time the Rust code doesn&amp;rsquo;t match the representation in a config file
we need to compensate with a comment that explains things.&lt;/p>
&lt;/blockquote>
&lt;p>This is going to happen every time we do anything like:&lt;/p>
&lt;ul>
&lt;li>renaming fields,&lt;/li>
&lt;li>flattening structures,&lt;/li>
&lt;li>making enum variants be represented by lowercase versions of themselves,&lt;/li>
&lt;li>&lt;a href="https://serde.rs/container-attrs.html#untagged">&amp;ldquo;un-tag&amp;rdquo; an enum&lt;/a>, or&lt;/li>
&lt;li>any other &lt;a href="https://serde.rs/enum-representations.html">alternative way of representing
enums&lt;/a>.&lt;/li>
&lt;/ul>
&lt;p>There&amp;rsquo;s other things we might want to do to the Rust code that would cause
further explaining and back tracking in the comments. We might find the top
level encapsulating structure of the config is something we want to reuse
throughout the codebase and make it generic over the data the user provides and
what we transform that data into:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-rust" data-lang="rust">&lt;span style="color:#75715e">#[derive(serde::Deserialize)]&lt;/span>
&lt;span style="color:#66d9ef">pub&lt;/span> &lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">Config&lt;/span>&lt;span style="color:#f92672">&amp;lt;&lt;/span>T&lt;span style="color:#f92672">&amp;gt;&lt;/span> {
name: String,
version: &lt;span style="color:#a6e22e">semver&lt;/span>::Version,
description: Option&lt;span style="color:#f92672">&amp;lt;&lt;/span>String&lt;span style="color:#f92672">&amp;gt;&lt;/span>,
&lt;span style="color:#75715e">#[serde(flatten)]&lt;/span>
data: &lt;span style="color:#a6e22e">T&lt;/span>,
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Parsing &lt;code>Config&amp;lt;AppData&amp;gt;&lt;/code> when we read the config file, but later transform the
data under &lt;code>data&lt;/code> into another type.&lt;/p>
&lt;p>Finally the problem I&amp;rsquo;ve been ignoring so far:&lt;/p>
&lt;blockquote>
&lt;p>These are Rust docs and have a load of other stuff in them that aren&amp;rsquo;t relevant
to someone writing the config file.&lt;/p>
&lt;/blockquote>
&lt;p>&lt;img src="https://tarquin-the-brave.github.io/blog/images/rust-docs-config-ref/config4wide.png" alt="">&lt;/p>
&lt;p>This could cause some confusion for the reader. 😵&lt;/p>
&lt;p>So can you use Rust docs to generate a config file reference to supplement the
main docs for a tool? Probably not for a tool with a public user base. But if
you&amp;rsquo;re developing a tool internally in an organisation that are predominately
Rust literate, the downsides may not be too bad for you, and you could benefit
from the completeness and navigability.&lt;/p>
&lt;p>Obviously it&amp;rsquo;s not what Rust docs were made to do, but it&amp;rsquo;s been interesting to
see how far I can get.&lt;/p>
&lt;p>My example project has &lt;a href="https://tarquin-the-brave.github.io/a-cli-tool/rust-docs/a_cli_tool/config5/struct.Config.html">published these docs&lt;/a> so you can take a look
for yourself.&lt;/p>
&lt;h1 id="via-a-generated-schema">Via A Generated Schema&lt;/h1>
&lt;p>For this blog post I was looking around at &amp;ldquo;what APIs do&amp;rdquo; to provide this
navigable reference. It seems a lot of them don&amp;rsquo;t, providing only an OpenAPI
specification instead. There seems to be a few tools out there that turn
OpenAPI specs into an HTML page. I wonder if something similar can be done for
config files.&lt;/p>
&lt;p>&amp;ldquo;Something similar&amp;rdquo; in this case being:&lt;/p>
&lt;blockquote>
&lt;p>Have a description of the config file in a well known schema language and
find a tool to turn that into HTML.&lt;/p>
&lt;/blockquote>
&lt;p>My initial thought about this was that I didn&amp;rsquo;t really fancy mastering the
description of config in a schema language rather than in in code.&lt;/p>
&lt;p>But take &lt;a href="https://json-schema.org/">JSON Schema&lt;/a> as an example, the &lt;a href="https://docs.rs/schemars/0.8.0/schemars/">&lt;code>schemars&lt;/code>&lt;/a> crate
lets you generate schemas from structures. So I stuck
&lt;code>#[derive(schemars::JsonSchema)]&lt;/code> to all my config structures and got the tool
to output a JSON Schema:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-json" data-lang="json">{
&lt;span style="color:#f92672">&amp;#34;$schema&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;http://json-schema.org/draft-07/schema#&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;title&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;Config Reference&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;description&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;Config file reference for `a_cli_tool`.\n\nBy default `a_cli_tool` looks for configuration in `./config.yaml`, unless another path is specified with the `-c/--config` parameter.\n\n`Config` details the structure of the configuration.&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;type&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;object&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;required&amp;#34;&lt;/span>: [
&lt;span style="color:#e6db74">&amp;#34;actions&amp;#34;&lt;/span>,
&lt;span style="color:#e6db74">&amp;#34;name&amp;#34;&lt;/span>,
&lt;span style="color:#e6db74">&amp;#34;source&amp;#34;&lt;/span>,
&lt;span style="color:#e6db74">&amp;#34;target&amp;#34;&lt;/span>,
&lt;span style="color:#e6db74">&amp;#34;version&amp;#34;&lt;/span>
],
&lt;span style="color:#f92672">&amp;#34;properties&amp;#34;&lt;/span>: {
&lt;span style="color:#f92672">&amp;#34;name&amp;#34;&lt;/span>: {
&lt;span style="color:#f92672">&amp;#34;description&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;The name of the thing this CLI tool is building for you.&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;type&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;string&amp;#34;&lt;/span>
},
&lt;span style="color:#f92672">&amp;#34;version&amp;#34;&lt;/span>: {
&lt;span style="color:#f92672">&amp;#34;description&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;The version of the thing this CLI tool will build for you.\n\nThis is a [SemVer][semver] version, e.g:\n\n```yaml version: 1.2.3 ```\n\n[semver]: https://semver.org/&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;type&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;string&amp;#34;&lt;/span>
},
&lt;span style="color:#f92672">&amp;#34;description&amp;#34;&lt;/span>: {
&lt;span style="color:#f92672">&amp;#34;description&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;_Optional:_ A description of the thing this CLI tool is building for you.&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;type&amp;#34;&lt;/span>: [
&lt;span style="color:#e6db74">&amp;#34;string&amp;#34;&lt;/span>,
&lt;span style="color:#e6db74">&amp;#34;null&amp;#34;&lt;/span>
]
},
&lt;span style="color:#f92672">&amp;#34;source&amp;#34;&lt;/span>: {
&lt;span style="color:#f92672">&amp;#34;description&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;The configuration for the source of data for this tool.&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;allOf&amp;#34;&lt;/span>: [
{
&lt;span style="color:#f92672">&amp;#34;$ref&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;#/definitions/Source&amp;#34;&lt;/span>
}
]
},
&lt;span style="color:#f92672">&amp;#34;target&amp;#34;&lt;/span>: {
&lt;span style="color:#f92672">&amp;#34;description&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;A path to write the created thing to.&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;type&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;string&amp;#34;&lt;/span>
},
&lt;span style="color:#f92672">&amp;#34;actions&amp;#34;&lt;/span>: {
&lt;span style="color:#f92672">&amp;#34;description&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;The operations to perform on the data this tool manipulates.\n\nThis array of operations will be performed in order and an operation may appear more than once.\n\nE.g:\n\n```yaml actions: [ foo, bar, baz, bar ] ```&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;type&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;array&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;items&amp;#34;&lt;/span>: {
&lt;span style="color:#f92672">&amp;#34;$ref&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;#/definitions/Actions&amp;#34;&lt;/span>
}
}
},
&lt;span style="color:#f92672">&amp;#34;definitions&amp;#34;&lt;/span>: {
&lt;span style="color:#f92672">&amp;#34;Source&amp;#34;&lt;/span>: {
&lt;span style="color:#f92672">&amp;#34;description&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;The configuration for the source of data for this tool.\n\nThis can either be set to a local file:\n\n```yaml source: file: path/to/file.yaml ```\n\nOr a URL:\n\n```yaml source: url: https://urlofsource.com/sourcedata/ ```\n\n---\n\nBack to:\n\n- [App Configuration](./struct.AppData.html#structfield.source) - [Configuration Reference](./struct.Config.html#structfield.data)&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;anyOf&amp;#34;&lt;/span>: [
{
&lt;span style="color:#f92672">&amp;#34;type&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;object&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;required&amp;#34;&lt;/span>: [
&lt;span style="color:#e6db74">&amp;#34;file&amp;#34;&lt;/span>
],
&lt;span style="color:#f92672">&amp;#34;properties&amp;#34;&lt;/span>: {
&lt;span style="color:#f92672">&amp;#34;file&amp;#34;&lt;/span>: {
&lt;span style="color:#f92672">&amp;#34;type&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;string&amp;#34;&lt;/span>
}
}
},
{
&lt;span style="color:#f92672">&amp;#34;type&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;object&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;required&amp;#34;&lt;/span>: [
&lt;span style="color:#e6db74">&amp;#34;url&amp;#34;&lt;/span>
],
&lt;span style="color:#f92672">&amp;#34;properties&amp;#34;&lt;/span>: {
&lt;span style="color:#f92672">&amp;#34;url&amp;#34;&lt;/span>: {
&lt;span style="color:#f92672">&amp;#34;type&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;string&amp;#34;&lt;/span>
}
}
}
]
},
&lt;span style="color:#f92672">&amp;#34;Actions&amp;#34;&lt;/span>: {
&lt;span style="color:#f92672">&amp;#34;description&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;The possible operations to perform on the data this tool manipulates.\n\nSee each option below for what it does and how it&amp;#39;s referenced in config.&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;type&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;string&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;enum&amp;#34;&lt;/span>: [
&lt;span style="color:#e6db74">&amp;#34;foo&amp;#34;&lt;/span>,
&lt;span style="color:#e6db74">&amp;#34;bar&amp;#34;&lt;/span>,
&lt;span style="color:#e6db74">&amp;#34;baz&amp;#34;&lt;/span>,
&lt;span style="color:#e6db74">&amp;#34;foo_bar&amp;#34;&lt;/span>,
&lt;span style="color:#e6db74">&amp;#34;bar_baz&amp;#34;&lt;/span>,
&lt;span style="color:#e6db74">&amp;#34;fbb&amp;#34;&lt;/span>
]
}
}
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>There was one change I had to make. Where previously I had the &lt;code>version&lt;/code> field
typed as:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-rust" data-lang="rust"> version: &lt;span style="color:#a6e22e">sever&lt;/span>::Version,
&lt;/code>&lt;/pre>&lt;/div>&lt;p>This gave me error:&lt;/p>
&lt;pre>&lt;code>error[E0277]: the trait bound `semver::Version: schemars::JsonSchema` is not satisfied
--&amp;gt; src/config5.rs:29:14
|
29 | version: semver::Version,
| ^^^^^^ the trait `schemars::JsonSchema` is not implemented for `semver::Version`
|
= note: required by `schemars::JsonSchema::add_schema_as_property`
&lt;/code>&lt;/pre>&lt;p>I could have tried to implement the trait for a newtype wrapper around
&lt;code>semver::Version&lt;/code> but for now I just changed that to be a &lt;code>String&lt;/code>. If using
this approach on a real tool, where there may be a few foreign types that don&amp;rsquo;t
implement &lt;code>JsonSchema&lt;/code> included in the tool&amp;rsquo;s config, it might end up more
practical to parse the config first in terms of types that &lt;code>JsonSchema&lt;/code> &lt;em>is&lt;/em>
implemented for then perform a 2nd parsing stage.&lt;/p>
&lt;p>In this example we could do:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-rust" data-lang="rust">&lt;span style="color:#75715e">#[derive(serde::Deserialize, schemars::JsonSchema)]&lt;/span>
&lt;span style="color:#66d9ef">pub&lt;/span> &lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">Config&lt;/span>&lt;span style="color:#f92672">&amp;lt;&lt;/span>V &lt;span style="color:#f92672">=&lt;/span> String&lt;span style="color:#f92672">&amp;gt;&lt;/span> {
name: String,
version: &lt;span style="color:#a6e22e">V&lt;/span>,
description: Option&lt;span style="color:#f92672">&amp;lt;&lt;/span>String&lt;span style="color:#f92672">&amp;gt;&lt;/span>,
&lt;span style="color:#75715e">#[serde(flatten)]&lt;/span>
data: &lt;span style="color:#a6e22e">AppData&lt;/span>,
}
&lt;span style="color:#66d9ef">impl&lt;/span> Config&lt;span style="color:#f92672">&amp;lt;&lt;/span>String&lt;span style="color:#f92672">&amp;gt;&lt;/span> {
&lt;span style="color:#66d9ef">pub&lt;/span> &lt;span style="color:#66d9ef">fn&lt;/span> &lt;span style="color:#a6e22e">parse&lt;/span>(self) -&amp;gt; &lt;span style="color:#a6e22e">anyhow&lt;/span>::Result&lt;span style="color:#f92672">&amp;lt;&lt;/span>Config&lt;span style="color:#f92672">&amp;lt;&lt;/span>semver::Version&lt;span style="color:#f92672">&amp;gt;&amp;gt;&lt;/span> {
Ok(Config {
name: &lt;span style="color:#a6e22e">self&lt;/span>.name,
description: &lt;span style="color:#a6e22e">self&lt;/span>.description,
data: &lt;span style="color:#a6e22e">self&lt;/span>.data,
version: &lt;span style="color:#a6e22e">semver&lt;/span>::Version::parse(&lt;span style="color:#f92672">&amp;amp;&lt;/span>self.version)&lt;span style="color:#f92672">?&lt;/span>,
})
}
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>and generate the JSON Schema for &lt;code>Config&amp;lt;String&amp;gt;&lt;/code>.&lt;/p>
&lt;p>Although as the number of foreign types, or types not implementing
&lt;code>JsonSchema&lt;/code>, grows this might produce an unwieldy number of type parameters.&lt;/p>
&lt;p>So after a quick look on the internet I found &lt;a href="https://coveooss.github.io/json-schema-for-humans/">a tool to turn a JSON Schema
into an HTML page&lt;/a>. The
result &lt;a href="https://tarquin-the-brave.github.io/a-cli-tool/schema-ref/config/schema_doc.html">looks rather smart&lt;/a>.&lt;/p>
&lt;p>Recall the config structures (with comments and derive attributes removed) are:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-rust" data-lang="rust">&lt;span style="color:#66d9ef">pub&lt;/span> &lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">Config&lt;/span>&lt;span style="color:#f92672">&amp;lt;&lt;/span>V &lt;span style="color:#f92672">=&lt;/span> String&lt;span style="color:#f92672">&amp;gt;&lt;/span> {
name: String,
version: &lt;span style="color:#a6e22e">V&lt;/span>,
description: Option&lt;span style="color:#f92672">&amp;lt;&lt;/span>String&lt;span style="color:#f92672">&amp;gt;&lt;/span>,
&lt;span style="color:#75715e">#[serde(flatten)]&lt;/span>
data: &lt;span style="color:#a6e22e">AppData&lt;/span>,
}
&lt;span style="color:#66d9ef">pub&lt;/span> &lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">AppData&lt;/span> {
source: &lt;span style="color:#a6e22e">Source&lt;/span>,
target: &lt;span style="color:#a6e22e">std&lt;/span>::path::PathBuf,
actions: Vec&lt;span style="color:#f92672">&amp;lt;&lt;/span>Actions&lt;span style="color:#f92672">&amp;gt;&lt;/span>,
}
&lt;span style="color:#66d9ef">pub&lt;/span> &lt;span style="color:#66d9ef">enum&lt;/span> &lt;span style="color:#a6e22e">Source&lt;/span> {
File(std::path::PathBuf),
Url(String),
}
&lt;span style="color:#75715e">#[serde(rename_all = &lt;/span>&lt;span style="color:#e6db74">&amp;#34;snake_case&amp;#34;&lt;/span>&lt;span style="color:#75715e">)]&lt;/span>
&lt;span style="color:#66d9ef">pub&lt;/span> &lt;span style="color:#66d9ef">enum&lt;/span> &lt;span style="color:#a6e22e">Actions&lt;/span> {
Foo,
Bar,
Baz,
FooBar,
BarBaz,
&lt;span style="color:#75715e">#[serde(rename = &lt;/span>&lt;span style="color:#e6db74">&amp;#34;fbb&amp;#34;&lt;/span>&lt;span style="color:#75715e">)]&lt;/span>
FooBarBaz,
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>The HTML document looks like:&lt;/p>
&lt;p>&lt;img src="https://tarquin-the-brave.github.io/blog/images/rust-docs-config-ref/config6.png" alt="">&lt;/p>
&lt;p>This time I&amp;rsquo;m not cropping anything out! This is all that appears. The fields
from &lt;code>AppData&lt;/code> have been nicely flattened into the top level.&lt;/p>
&lt;p>We can click on the fields to expand them:&lt;/p>
&lt;p>&lt;img src="https://tarquin-the-brave.github.io/blog/images/rust-docs-config-ref/config6meta.png" alt="">&lt;/p>
&lt;p>It&amp;rsquo;s even tried to render the markdown in the fields&amp;rsquo; doc comments.
Unfortunately it hasn&amp;rsquo;t rendered the syntax highlighting hint properly. But
this was the first tool I found from searching on the internet so I&amp;rsquo;ll not let
small formatting details put a downer on things for now. 🌞&lt;/p>
&lt;p>What it&amp;rsquo;s done for our enums is nice:&lt;/p>
&lt;p>&lt;img src="https://tarquin-the-brave.github.io/blog/images/rust-docs-config-ref/config6source1.png" alt="">&lt;/p>
&lt;p>Clicking on &lt;code>Option 2&lt;/code> we see:&lt;/p>
&lt;p>&lt;img src="https://tarquin-the-brave.github.io/blog/images/rust-docs-config-ref/config6source2.png" alt="">&lt;/p>
&lt;p>Here I put the doc comments on the enum rather than individual variants. Had I
done that instead there&amp;rsquo;d be a description of &lt;code>url&lt;/code> and &lt;code>file&lt;/code> available.&lt;/p>
&lt;p>I really like how the &lt;code>actions&lt;/code> field has rendered:&lt;/p>
&lt;p>&lt;img src="https://tarquin-the-brave.github.io/blog/images/rust-docs-config-ref/config6actions.png" alt="">&lt;/p>
&lt;p>This is all looking quite good. As config grows in complexity it looks like
this format will naturally extend and be navigable and readable.&lt;/p>
&lt;p>The &lt;code>schemars::Schema&lt;/code> trait seems to generate a good JSON Schema, and once you
have your JSON Schema you can make your choice of JSON Schema -&amp;gt; HTML renderer.&lt;/p>
&lt;p>What could be a problem with this approach is generating that Schema. In this
example I went for a workaround to &lt;code>JsonSchema&lt;/code> not being implemented for a
foreign type by parsing config in two steps, but looking at &lt;a href="https://docs.rs/schemars/0.8.0/src/schemars/json_schema_impls/serdejson.rs.html#7-17">some of the
implementations&lt;/a>
of the trait, it&amp;rsquo;s not too hard to implement it for a newtype wrapper around a
foreign type.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-rust" data-lang="rust">&lt;span style="color:#75715e">#[derive(serde::Deserialize)]&lt;/span>
&lt;span style="color:#66d9ef">pub&lt;/span> &lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">Version&lt;/span>(semver::Version);
&lt;span style="color:#66d9ef">impl&lt;/span> schemars::JsonSchema &lt;span style="color:#66d9ef">for&lt;/span> Version {
&lt;span style="color:#66d9ef">fn&lt;/span> &lt;span style="color:#a6e22e">is_referenceable&lt;/span>() -&amp;gt; &lt;span style="color:#66d9ef">bool&lt;/span> {
&lt;span style="color:#66d9ef">false&lt;/span>
}
&lt;span style="color:#66d9ef">fn&lt;/span> &lt;span style="color:#a6e22e">schema_name&lt;/span>() -&amp;gt; String {
&lt;span style="color:#e6db74">&amp;#34;Version&amp;#34;&lt;/span>.to_string()
}
&lt;span style="color:#66d9ef">fn&lt;/span> &lt;span style="color:#a6e22e">json_schema&lt;/span>(_: &lt;span style="color:#66d9ef">&amp;amp;&lt;/span>&lt;span style="color:#a6e22e">mut&lt;/span> schemars::gen::SchemaGenerator) -&amp;gt; &lt;span style="color:#a6e22e">schemars&lt;/span>::schema::Schema {
schemars::schema::SchemaObject {
instance_type: Some(schemars::schema::InstanceType::String.into()),
..Default::default()
}
.into()
}
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>So maybe there&amp;rsquo;s a bit of work to get the JSON Schema for your config, but once
you&amp;rsquo;ve generated it, you can choose what you use to render it into HTML.&lt;/p>
&lt;p>It might be a good thing on its own, for a tool to be able to produce a JSON
Schema for its config file.&lt;/p>
&lt;h1 id="what-about-clis">What About CLIs?&lt;/h1>
&lt;p>CLIs have a structure. If you use &lt;a href="https://docs.rs/structopt/0.3.20">&lt;code>structopt&lt;/code>&lt;/a> to define your CLI
you define a Rust structure with annotations on the fields.&lt;/p>
&lt;p>The CLI help text
you get from &lt;a href="https://docs.rs/clap/2.33.3/clap/">&lt;code>clap&lt;/code>&lt;/a> (the crate &lt;code>structopt&lt;/code> calls) is pretty good, but
if we&amp;rsquo;re creating a navigable HTML reference for our config, why not for our
CLI too?&lt;/p>
&lt;p>I gave this a quick go, trying both of the approaches above. Defining a dummy
CLI with:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-rust" data-lang="rust">&lt;span style="color:#75715e">#[derive(structopt::StructOpt, schemars::JsonSchema)]&lt;/span>
&lt;span style="color:#66d9ef">pub&lt;/span> &lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">Cli&lt;/span> {
&lt;span style="color:#75715e">#[structopt(short, long)]&lt;/span>
config: &lt;span style="color:#a6e22e">std&lt;/span>::path::PathBuf,
&lt;span style="color:#75715e">#[structopt(long)]&lt;/span>
dry_run: &lt;span style="color:#66d9ef">bool&lt;/span>,
&lt;span style="color:#75715e">#[structopt(subcommand)]&lt;/span>
subcommand: &lt;span style="color:#a6e22e">Subcommands&lt;/span>,
}
&lt;span style="color:#75715e">#[derive(structopt::StructOpt, schemars::JsonSchema)]&lt;/span>
&lt;span style="color:#66d9ef">pub&lt;/span> &lt;span style="color:#66d9ef">enum&lt;/span> &lt;span style="color:#a6e22e">Subcommands&lt;/span> {
Foo,
Bar,
Baz,
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Without adding any comments: the Rust docs look like:&lt;/p>
&lt;p>&lt;img src="https://tarquin-the-brave.github.io/blog/images/rust-docs-config-ref/cli1.png" alt="">&lt;/p>
&lt;p>&lt;img src="https://tarquin-the-brave.github.io/blog/images/rust-docs-config-ref/subcommands1.png" alt="">&lt;/p>
&lt;p>And rendering a generated JSON Schema looks like:&lt;/p>
&lt;p>&lt;img src="https://tarquin-the-brave.github.io/blog/images/rust-docs-config-ref/cli1html.png" alt="">&lt;/p>
&lt;p>When generating a reference for the config file, the &amp;ldquo;rendered JSON Schema&amp;rdquo;
approach had an advantage over the &amp;ldquo;Rust docs&amp;rdquo; approach as the &lt;code>serde&lt;/code>
annotations that mapped the Rust representation to the representation the user
sees were taken account of. In this case, neither approach gets the &lt;code>structopt&lt;/code>
annotations taken account of and both would require commenting to explain which
fields are arguments, parameters, subcommands and how they&amp;rsquo;re represented on
the CLI.&lt;/p>
&lt;p>An alternative approach here could be to generate man pages, then use something
like &lt;a href="https://pandoc.org/">Pandoc&lt;/a> to convert them to HTML.&lt;/p>
&lt;p>I wanted to give this a go, but &lt;a href="https://rust-cli.github.io/book/in-depth/docs.html">the approach the &amp;ldquo;Rust CLI&amp;rdquo; book&lt;/a>
suggests for generating man pages tells you to use the
&lt;code>clap_generate::gen_manuals&lt;/code> function, which I can&amp;rsquo;t find in the
&lt;a href="https://docs.rs/clap_generate/3.0.0-beta.2/clap_generate/">&lt;code>clap_generate&lt;/code> documentation&lt;/a>&amp;hellip; That might require waiting for
&lt;code>clap&lt;/code> V3.&lt;/p>
&lt;h1 id="these-examples">These Examples&lt;/h1>
&lt;p>I&amp;rsquo;ve published the examples from this blog on Github Pages. Take a look around.&lt;/p>
&lt;ul>
&lt;li>Rust Docs
&lt;ul>
&lt;li>&lt;a href="https://tarquin-the-brave.github.io/a-cli-tool/rust-docs/a_cli_tool/config7/struct.Config.html">Config File Reference&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://tarquin-the-brave.github.io/a-cli-tool/rust-docs/a_cli_tool/cli/struct.Cli.html">CLI Reference (uncommented)&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://tarquin-the-brave.github.io/a-cli-tool/rust-docs/a_cli_tool/">All Rust Docs&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Generated from JSON Schema
&lt;ul>
&lt;li>&lt;a href="https://tarquin-the-brave.github.io/a-cli-tool/schema-ref/config/schema_doc.html">Config File Reference&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://tarquin-the-brave.github.io/a-cli-tool/schema-ref/cli/schema_doc.html">CLI Reference (uncommented)&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h1 id="potential-project">Potential Project?&lt;/h1>
&lt;p>I wonder, and please do comment, if there&amp;rsquo;s anything I&amp;rsquo;ve missed that can do a
better job of generating a reference to supplement user docs.&lt;/p>
&lt;p>If I was making a new CLI tool today that took a config file, I think I&amp;rsquo;d take
&lt;a href="#via-a-generated-schema">the JSON Schema approach&lt;/a>, and shop around a bit for
the &amp;ldquo;JSON Schema -&amp;gt; HTML&amp;rdquo; renderer.&lt;/p>
&lt;p>But that approach still requires going to the effort of producing the JSON
Schema. I&amp;rsquo;m also not sure that every config file format, that have crates that
implement deserializers for &lt;code>serde&lt;/code>, can have what you&amp;rsquo;d reasonably express in
it described by JSON Schema. I say &amp;ldquo;reasonably&amp;rdquo;, because I know of examples
like in YAML where you can have non-strings as keys to objects, but when you&amp;rsquo;re
defining structured config, I don&amp;rsquo;t know that you would expect to do that.&lt;/p>
&lt;p>Wouldn&amp;rsquo;t it be nice if there was a &lt;code>cargo&lt;/code> subcommand that could generate these
navigable, complete, reference docs for both config files and CLIs?&lt;/p>
&lt;p>Perhaps you could give it a structure, tell it whether it it&amp;rsquo;s config or a CLI,
and get some HTML generated.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">cargo user-docs config config::MyAppConfig
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">cargo user-docs cli cli::MyAppCli
&lt;/code>&lt;/pre>&lt;/div>&lt;p>My guess on how to start looking into how to do this would be to read though
the &lt;code>cargo-doc&lt;/code> source code and see what it does, and whether it&amp;rsquo;s possible to
use some of it.&lt;/p>
&lt;p>At some point it&amp;rsquo;ll have to spot the existence or expansion of the annotations
given that describe how the Rust structures are represented in config or as CLI
commands. This might be problematic as it would probably have to have
knowledge of or assume particular crates have been used for each purpose.&lt;/p>
&lt;p>Please do comment if you have any thoughts: knowing of a project like this,
advise on how one might go about doing this, or experience from other
languages.&lt;/p></description></item><item><title>Why I Scatter Use Statements Throughout My Rust</title><link>https://tarquin-the-brave.github.io/blog/posts/rust_use_statements/</link><pubDate>Mon, 05 Oct 2020 20:30:00 +0100</pubDate><guid>https://tarquin-the-brave.github.io/blog/posts/rust_use_statements/</guid><description>&lt;p>A standard pattern across pretty much every language I&amp;rsquo;ve worked with at least,
is to stick statements that import modules and libraries at the top of the
page. Some languages make you do this. In Rust I don&amp;rsquo;t do this for
everything, &lt;em>here&amp;rsquo;s why&lt;/em>.&lt;/p>
&lt;p>I started to think more and more about what code is like to read rather than
write. I for one was reading code far more often than I was writing, and the
code I was writing would, over its lifetime, be read far more often than
written or edited.&lt;/p>
&lt;p>To set the scene, take the following code for a fairly pointless CLI tool
to echo some data or give you a JSON Schema, in a variety of formats:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-rust" data-lang="rust">&lt;span style="color:#66d9ef">use&lt;/span> anyhow::{anyhow, Context, Result};
&lt;span style="color:#66d9ef">use&lt;/span> itertools::Itertools;
&lt;span style="color:#66d9ef">use&lt;/span> schemars::{schema_for, JsonSchema};
&lt;span style="color:#66d9ef">use&lt;/span> serde::{Deserialize, Serialize};
&lt;span style="color:#66d9ef">use&lt;/span> serde_json::{to_value &lt;span style="color:#66d9ef">as&lt;/span> to_json_value, Value};
&lt;span style="color:#66d9ef">use&lt;/span> serde_yaml::{from_reader, to_vec};
&lt;span style="color:#66d9ef">use&lt;/span> std::collections::HashSet;
&lt;span style="color:#66d9ef">use&lt;/span> std::io::{stdin, stdout, Write};
&lt;span style="color:#66d9ef">use&lt;/span> structopt::StructOpt;
&lt;span style="color:#75715e">#[derive(Debug, StructOpt)]&lt;/span>
&lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">Cli&lt;/span> {
output: String,
format: String,
}
&lt;span style="color:#75715e">#[derive(Deserialize, Serialize, JsonSchema)]&lt;/span>
&lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">Data&lt;/span> {
name: String,
data: &lt;span style="color:#a6e22e">Value&lt;/span>,
aliases: &lt;span style="color:#a6e22e">HashSet&lt;/span>&lt;span style="color:#f92672">&amp;lt;&lt;/span>String&lt;span style="color:#f92672">&amp;gt;&lt;/span>,
}
&lt;span style="color:#66d9ef">fn&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>() -&amp;gt; Result&lt;span style="color:#f92672">&amp;lt;&lt;/span>()&lt;span style="color:#f92672">&amp;gt;&lt;/span> {
&lt;span style="color:#66d9ef">let&lt;/span> args &lt;span style="color:#f92672">=&lt;/span> Cli::from_args();
&lt;span style="color:#66d9ef">let&lt;/span> input: &lt;span style="color:#a6e22e">Data&lt;/span> &lt;span style="color:#f92672">=&lt;/span> from_reader(stdin()).context(&lt;span style="color:#e6db74">&amp;#34;couldn&amp;#39;t read stdin&amp;#34;&lt;/span>)&lt;span style="color:#f92672">?&lt;/span>;
&lt;span style="color:#66d9ef">let&lt;/span> output &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">if&lt;/span> args.output &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#e6db74">&amp;#34;data&amp;#34;&lt;/span> {
val_to_vec(input.data, &lt;span style="color:#f92672">&amp;amp;&lt;/span>args.format)&lt;span style="color:#f92672">?&lt;/span>
} &lt;span style="color:#66d9ef">else&lt;/span> &lt;span style="color:#66d9ef">if&lt;/span> args.output &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#e6db74">&amp;#34;schema&amp;#34;&lt;/span> {
&lt;span style="color:#66d9ef">let&lt;/span> &lt;span style="color:#66d9ef">mut&lt;/span> schema &lt;span style="color:#f92672">=&lt;/span> schema_for&lt;span style="color:#f92672">!&lt;/span>(Data);
schema.schema.metadata().description &lt;span style="color:#f92672">=&lt;/span> Some(format&lt;span style="color:#f92672">!&lt;/span>(
&lt;span style="color:#e6db74">&amp;#34;aliases can be {}&amp;#34;&lt;/span>,
input.aliases.into_iter().format(&lt;span style="color:#e6db74">&amp;#34;, &amp;#34;&lt;/span>)
));
val_to_vec(to_json_value(schema)&lt;span style="color:#f92672">?&lt;/span>, &lt;span style="color:#f92672">&amp;amp;&lt;/span>args.format)&lt;span style="color:#f92672">?&lt;/span>
} &lt;span style="color:#66d9ef">else&lt;/span> {
&lt;span style="color:#66d9ef">return&lt;/span> Err(anyhow&lt;span style="color:#f92672">!&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;Unknown output type&amp;#34;&lt;/span>));
};
stdout().write_all(&lt;span style="color:#f92672">&amp;amp;&lt;/span>output)&lt;span style="color:#f92672">?&lt;/span>;
Ok(())
}
&lt;span style="color:#66d9ef">fn&lt;/span> &lt;span style="color:#a6e22e">val_to_vec&lt;/span>(value: &lt;span style="color:#a6e22e">Value&lt;/span>, form: &lt;span style="color:#66d9ef">&amp;amp;&lt;/span>&lt;span style="color:#66d9ef">str&lt;/span>) -&amp;gt; Result&lt;span style="color:#f92672">&amp;lt;&lt;/span>Vec&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">u8&lt;/span>&lt;span style="color:#f92672">&amp;gt;&amp;gt;&lt;/span> {
&lt;span style="color:#66d9ef">if&lt;/span> form &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#e6db74">&amp;#34;yaml&amp;#34;&lt;/span> {
to_vec(&lt;span style="color:#f92672">&amp;amp;&lt;/span>value).map_err(Into::into)
} &lt;span style="color:#66d9ef">else&lt;/span> &lt;span style="color:#66d9ef">if&lt;/span> form &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#e6db74">&amp;#34;json&amp;#34;&lt;/span> {
serde_json::to_vec(&lt;span style="color:#f92672">&amp;amp;&lt;/span>value).map_err(Into::into)
} &lt;span style="color:#66d9ef">else&lt;/span> &lt;span style="color:#66d9ef">if&lt;/span> form &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#e6db74">&amp;#34;toml&amp;#34;&lt;/span> {
toml::to_vec(&lt;span style="color:#f92672">&amp;amp;&lt;/span>value).map_err(Into::into)
} &lt;span style="color:#66d9ef">else&lt;/span> {
Err(anyhow&lt;span style="color:#f92672">!&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;Unknown output format&amp;#34;&lt;/span>))
}
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>While this example is quite small, and uses mostly well heard of crates, you
can imagine a longer file with longer functions, that might be somewhere deep
in a codebase that uses more obscure crates that you may not be familiar with.
Suddenly your eyes are jumping up and down the page trying to cross reference
types you&amp;rsquo;re not familiar with. Next you see a method call you&amp;rsquo;re not familiar
with on a type that you are. You go to the type&amp;rsquo;s documentation and the method
is nowhere to be seen.&lt;/p>
&lt;p>Suppose I re-wrote this code to:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-rust" data-lang="rust">&lt;span style="color:#75715e">#[derive(Debug, structopt::StructOpt)]&lt;/span>
&lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">Cli&lt;/span> {
output: String,
format: String,
}
&lt;span style="color:#75715e">#[derive(serde::Deserialize, serde::Serialize, schemars::JsonSchema)]&lt;/span>
&lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">Data&lt;/span> {
name: String,
data: &lt;span style="color:#a6e22e">serde_json&lt;/span>::Value,
aliases: &lt;span style="color:#a6e22e">std&lt;/span>::collections::HashSet&lt;span style="color:#f92672">&amp;lt;&lt;/span>String&lt;span style="color:#f92672">&amp;gt;&lt;/span>,
}
&lt;span style="color:#66d9ef">fn&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>() -&amp;gt; &lt;span style="color:#a6e22e">anyhow&lt;/span>::Result&lt;span style="color:#f92672">&amp;lt;&lt;/span>()&lt;span style="color:#f92672">&amp;gt;&lt;/span> {
&lt;span style="color:#66d9ef">let&lt;/span> args &lt;span style="color:#f92672">=&lt;/span> {
&lt;span style="color:#66d9ef">use&lt;/span> structopt::StructOpt &lt;span style="color:#66d9ef">as&lt;/span> _;
Cli::from_args()
};
&lt;span style="color:#66d9ef">let&lt;/span> input: &lt;span style="color:#a6e22e">Data&lt;/span> &lt;span style="color:#f92672">=&lt;/span> {
&lt;span style="color:#66d9ef">use&lt;/span> anyhow::Context &lt;span style="color:#66d9ef">as&lt;/span> _;
serde_yaml::from_reader(std::io::stdin()).context(&lt;span style="color:#e6db74">&amp;#34;couldn&amp;#39;t read stdin&amp;#34;&lt;/span>)&lt;span style="color:#f92672">?&lt;/span>
};
&lt;span style="color:#66d9ef">let&lt;/span> output &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">if&lt;/span> args.output &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#e6db74">&amp;#34;data&amp;#34;&lt;/span> {
val_to_vec(input.data, &lt;span style="color:#f92672">&amp;amp;&lt;/span>args.format)&lt;span style="color:#f92672">?&lt;/span>
} &lt;span style="color:#66d9ef">else&lt;/span> &lt;span style="color:#66d9ef">if&lt;/span> args.output &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#e6db74">&amp;#34;schema&amp;#34;&lt;/span> {
&lt;span style="color:#66d9ef">let&lt;/span> &lt;span style="color:#66d9ef">mut&lt;/span> schema &lt;span style="color:#f92672">=&lt;/span> schemars::schema_for&lt;span style="color:#f92672">!&lt;/span>(Data);
schema.schema.metadata().description &lt;span style="color:#f92672">=&lt;/span> Some({
&lt;span style="color:#66d9ef">use&lt;/span> itertools::Itertools &lt;span style="color:#66d9ef">as&lt;/span> _;
format&lt;span style="color:#f92672">!&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;aliases can be {}&amp;#34;&lt;/span>, input.aliases.into_iter().format(&lt;span style="color:#e6db74">&amp;#34;, &amp;#34;&lt;/span>))
});
val_to_vec(serde_json::to_value(schema)&lt;span style="color:#f92672">?&lt;/span>, &lt;span style="color:#f92672">&amp;amp;&lt;/span>args.format)&lt;span style="color:#f92672">?&lt;/span>
} &lt;span style="color:#66d9ef">else&lt;/span> {
&lt;span style="color:#66d9ef">return&lt;/span> Err(anyhow::anyhow&lt;span style="color:#f92672">!&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;Unknown output type&amp;#34;&lt;/span>));
};
{
&lt;span style="color:#66d9ef">use&lt;/span> std::io::Write &lt;span style="color:#66d9ef">as&lt;/span> _;
std::io::stdout().write_all(&lt;span style="color:#f92672">&amp;amp;&lt;/span>output)&lt;span style="color:#f92672">?&lt;/span>;
}
Ok(())
}
&lt;span style="color:#66d9ef">fn&lt;/span> &lt;span style="color:#a6e22e">val_to_vec&lt;/span>(value: &lt;span style="color:#a6e22e">serde_json&lt;/span>::Value, form: &lt;span style="color:#66d9ef">&amp;amp;&lt;/span>&lt;span style="color:#66d9ef">str&lt;/span>) -&amp;gt; &lt;span style="color:#a6e22e">anyhow&lt;/span>::Result&lt;span style="color:#f92672">&amp;lt;&lt;/span>Vec&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">u8&lt;/span>&lt;span style="color:#f92672">&amp;gt;&amp;gt;&lt;/span> {
&lt;span style="color:#66d9ef">if&lt;/span> form &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#e6db74">&amp;#34;yaml&amp;#34;&lt;/span> {
serde_yaml::to_vec(&lt;span style="color:#f92672">&amp;amp;&lt;/span>value).map_err(Into::into)
} &lt;span style="color:#66d9ef">else&lt;/span> &lt;span style="color:#66d9ef">if&lt;/span> form &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#e6db74">&amp;#34;json&amp;#34;&lt;/span> {
serde_json::to_vec(&lt;span style="color:#f92672">&amp;amp;&lt;/span>value).map_err(Into::into)
} &lt;span style="color:#66d9ef">else&lt;/span> &lt;span style="color:#66d9ef">if&lt;/span> form &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#e6db74">&amp;#34;toml&amp;#34;&lt;/span> {
toml::to_vec(&lt;span style="color:#f92672">&amp;amp;&lt;/span>value).map_err(Into::into)
} &lt;span style="color:#66d9ef">else&lt;/span> {
Err(anyhow::anyhow&lt;span style="color:#f92672">!&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;Unknown output format&amp;#34;&lt;/span>))
}
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Granted: these are two opposite extremes, but hopefully their comparison helps
to make my point. I might not write code exactly like the latter, but I&amp;rsquo;d lean
more towards it than the former. I&amp;rsquo;d keep the &lt;code>use&lt;/code> statements of the things
that are ubiquitously known across rust: the derive macros &lt;code>Serialize&lt;/code> &amp;amp;
&lt;code>Deserialize&lt;/code>, and &lt;code>HashSet&lt;/code> at the top. I won&amp;rsquo;t always create a little scope
to wrap when a method from a trait is used with a &lt;code>use&lt;/code> of the trait, but I try
to keep them close.&lt;/p>
&lt;p>Below I expand on some of my justifications for employing this pattern.&lt;/p>
&lt;p>&lt;em>NOTE: I wrote the examples after writing the sections below, so I&amp;rsquo;ll not
be referring to them any further.&lt;/em>&lt;/p>
&lt;h1 id="namespace-hygiene">Namespace Hygiene&lt;/h1>
&lt;p>This started for me with &lt;code>main.rs&lt;/code>. It&amp;rsquo;s a first port of call for someone
reading application code for the first time and I decided I wanted readers
to find &lt;code>fn main()&lt;/code> and have what they need in front of them. As I was pulling
the &lt;code>use&lt;/code> statements for the things used inside &lt;code>main&lt;/code> into &lt;code>main&lt;/code> it would
be silly and confusing to have any other functions not do the same and take from
the top level namespace. The result of this exercise is that each function in
&lt;code>main.rs&lt;/code> serves as its own little island that can be visited without hopping
around the page to cross reference imported things, and the top level namespace
is clean.&lt;/p>
&lt;p>While for code in &lt;code>main.rs&lt;/code> I was playing with creating little islands to try
out the idea, without worrying too much about having a sound justification to
do so, when this idea of &amp;ldquo;namespace hygiene&amp;rdquo; is extended to the rest of your
code: it can have some quite profound implications on the simplicity and
robustness of the code.&lt;/p>
&lt;p>When I think about complexity of code I try to look at things like: how many
moving parts are at play, how many different logical outcomes there are, how
many different paths of code flow go through the code (I believe that last one
is referred to as &amp;ldquo;cyclomatic complexity&amp;rdquo;). These are all things that we can
quantify and through which can have a meaningful discussion about complexity,
without conflating complexity with subjective judgements of how easy or hard
it is for any one individual to read or follow, given their unique life up to
that point. That&amp;rsquo;s not to say that metrics of complexity should be the only
guiding principle to how we write code. There&amp;rsquo;s are elements of style, personal
expression, and story telling that go into code to communicate ideas. But
when complexity is what&amp;rsquo;s being discussed, it serves to have things that can
be measured.&lt;/p>
&lt;p>Possibly the main huge benefit of namespace hygiene is refactoring. You want to
move some code around, how nice it is when your code blocks are &lt;strong>portable&lt;/strong>.
Being minimally dependent on a higher namespace makes moving code so much
easier.&lt;/p>
&lt;h1 id="where-did-that-function-come-from">Where Did That Function Come From?&lt;/h1>
&lt;p>For me, this is the one pet peeve I have with Rust&amp;rsquo;s syntax/semantics.&lt;/p>
&lt;blockquote>
&lt;p>It&amp;rsquo;s too easy to magically import methods via traits in a way that
makes tracking down the documentation for them very hard.&lt;/p>
&lt;/blockquote>
&lt;p>In the above example I covered the case where you see a type you know and love,
but then see a method call on it that you&amp;rsquo;re not so familiar with. You go the
that type&amp;rsquo;s documentation, and this mysterious method is nowhere to be seen.
Where do you go from there? You search the &lt;code>use&lt;/code> statements at the top of the
page for anything that isn&amp;rsquo;t reference below, hoping that the writer of the
code has fixed build warnings about unused imports: you can take this as a sign
it&amp;rsquo;s a trait. You then exhaustively search the documentation of each trait
until you find a method of that name. Unfortunately a method of that name
appears under two of the traits you&amp;rsquo;ve looked up. Thankfully the orphan rule
can help you out here. If the crate defining the type had implemented a trait,
the method would have appeared in the type&amp;rsquo;s documentation. If not, the crate
defining the trait must have implemented it for the type, and the fact it was
implemented for the type will appear in its documentation. So you scroll down
to search of an implementation on your type in each trait&amp;rsquo;s documentation and
finally you find the documentation you were looking for. Whilst sitting back
in you chair to take a moment to admire your detective skills you realise it&amp;rsquo;s
half an hour later, your tea&amp;rsquo;s gone cold, and all you wanted to do was read a
line of code.&lt;/p>
&lt;p>So this happened to me a few times. While I wax and wane on how much I stick
to keeping imports of functions, macro, and types close to where they&amp;rsquo;re called
vs. just putting them at the top like everyone else, I do make sure to put
&lt;code>use&lt;/code>s of traits as tightly scoped to their usage as possible. While it
doesn&amp;rsquo;t fully prevent the above scenarios it does really help.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-rust" data-lang="rust">&lt;span style="color:#66d9ef">let&lt;/span> input: &lt;span style="color:#a6e22e">Data&lt;/span> &lt;span style="color:#f92672">=&lt;/span> {
&lt;span style="color:#66d9ef">use&lt;/span> anyhow::Context &lt;span style="color:#66d9ef">as&lt;/span> _;
serde_yaml::from_reader(std::io::stdin()).context(&lt;span style="color:#e6db74">&amp;#34;couldn&amp;#39;t read stdin&amp;#34;&lt;/span>)&lt;span style="color:#f92672">?&lt;/span>
};
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Above you have a pretty clear indication of where &lt;code>context()&lt;/code> came from.&lt;/p>
&lt;p>It&amp;rsquo;s also very helpful to mark an import as a trait by importing it to a hole.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-rust" data-lang="rust">&lt;span style="color:#66d9ef">use&lt;/span> anyhow::Context &lt;span style="color:#66d9ef">as&lt;/span> _;
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Given that you&amp;rsquo;re not going to do this for anything that isn&amp;rsquo;t a trait, it
serves as a pretty strong indicator.&lt;/p>
&lt;p>When you see a method you don&amp;rsquo;t recognise and just above it an import of a
trait, it&amp;rsquo;s a pretty good indication of where the method came from.&lt;/p>
&lt;p>If playing around with clearing out the top level namespace in &lt;code>main.rs&lt;/code> was
what got me started with moving &lt;code>use&lt;/code> statements around, this issue is what
really convinced me it was a good idea.&lt;/p>
&lt;h1 id="code-is-text">Code Is Text&lt;/h1>
&lt;blockquote>
&lt;p>&amp;ldquo;Is the answer not to just bring up the code in you IDE and hover your mouse
over it&amp;rdquo;?&lt;/p>
&lt;/blockquote>
&lt;p>I&amp;rsquo;ve already had a rant about this in &lt;a href="./ide-read-code.md">a previous post&lt;/a>, so I&amp;rsquo;ll not
launch into this one again. Essentially IDEs are there to make code easier to
write and can make code completely unreadable through a web GUI or a vanilla
text editor. And code is mostly read through a web GUI whether that be in the
form of pull requests or visiting the source control of a library or
application.&lt;/p>
&lt;h1 id="taking-this-further">Taking This Further&lt;/h1>
&lt;p>Rust lets you define scopes within functions. This gives us the opportunity to
make the things we import only be accessible in the tightest scope possible.&lt;/p>
&lt;p>In practice I tend to do this only for traits and only when it make sense to
isolate the expression. I might if it&amp;rsquo;s an especially large function where a
bunch of imports are only relevant to a small section, but generally Rust
doesn&amp;rsquo;t need yet another reason to have yet another level of indentation.&lt;/p>
&lt;h1 id="not-importing-at-all">Not Importing At All&lt;/h1>
&lt;p>For one off uses of things, especially for less often used parts of the
standard library or crates that no-one&amp;rsquo;s ever heard of, I tend not to use a
&lt;code>use&lt;/code> at all.&lt;/p>
&lt;p>If it&amp;rsquo;s a one-off use, then why pollute your namespace with it? If reader
immediately break their flow of reading through your code to lookup where an
unfamiliar thing comes from, why not detail where that came from inline to not
break the reader&amp;rsquo;s flow?&lt;/p>
&lt;p>There are also lots of cases where the path to the thing you&amp;rsquo;re importing
provide vital context for what that thing represents. Take &lt;code>semver::Version&lt;/code>
for example: the fact that it&amp;rsquo;s &amp;ldquo;semver&amp;rdquo; is what&amp;rsquo;s important. Being semver is
what gives it all the properties of semver versioning. Without semver, or an
alternative versioning scheme, a version is no more than an arbitrary text
field. Basically mentioning that it&amp;rsquo;s semver is important. For things like
these I never use a &lt;code>use&lt;/code> statement.&lt;/p>
&lt;p>There &lt;a href="https://rust-lang.github.io/rust-clippy/master/#module_name_repetitions">a clippy lint&lt;/a> in the pedantic group, for not repeating module
names in names of things. That idea doesn&amp;rsquo;t appear to have caught on that well
in most crates as the path to things can usually be thrown away. If more
crates did this we&amp;rsquo;d probably find cases like &lt;code>semver::Version&lt;/code> more often.&lt;/p>
&lt;p>In fact, putting the full paths to things is where I tend to start, only later
employing &lt;code>use&lt;/code> statements.&lt;/p>
&lt;h1 id="when-i-dont-do-this">When I Don&amp;rsquo;t Do This&lt;/h1>
&lt;p>For small, truly single purpose modules, I pop all the &lt;code>use&lt;/code> statements at the
top of the page. If all the code in the file is performing roughly the same
role, and you can see it all on a page, the same concepts are going to be
familiar to all the code and there&amp;rsquo;s not any overhead of context switching.&lt;/p>
&lt;p>For very commonly used and widely recognised things, like
&lt;code>std::collections::HashMap&lt;/code> I tend to just put a use for at the top of the
file. No-one who&amp;rsquo;s vaguely Rust literate is going to see &lt;code>HashMap&lt;/code> and wonder
what it is. &lt;code>std::collections::VecDeque&lt;/code> however, I might not put a &lt;code>use&lt;/code> for
at the top of file.&lt;/p>
&lt;h1 id="only-doing-this-in-some-places">Only Doing This In Some Places&lt;/h1>
&lt;p>It&amp;rsquo;s all well and good when writing a new module for the first time to adopt
this style, or any other style you want. But when you come to working on
existing code, it often serves to stick with the style of the code already
there.&lt;/p>
&lt;p>I&amp;rsquo;ve found this isn&amp;rsquo;t so true with this issue of moving &lt;code>use&lt;/code> statements away
from the top or not using them at all. When you start doing this in code that
defines all its imports at the top, it doesn&amp;rsquo;t wreck the consistency or create
confusion. I&amp;rsquo;ve found it&amp;rsquo;s just one less place where the reader has to jump
around and cross reference as they&amp;rsquo;re reading.&lt;/p>
&lt;h1 id="a-word-on-dry">A Word On DRY&lt;/h1>
&lt;p>&lt;a href="./dry-not-a-goal.md">I&amp;rsquo;ve blogged before about how the pursuit of DRY above all other things can
lead to bad software&lt;/a>. I&amp;rsquo;d anticipate a counter argument
to moving imports closer their use or calling things by their full path is that
it&amp;rsquo;s repetition. Putting &lt;code>use&lt;/code> statements at the top of the file means you
only write them once. But you can take that argument to absurdity. Why not
then have everything in the same namespace with all you code in one &lt;code>main.rs&lt;/code>
file, then you only every have to import things once? Even without that, I
think this serves as a good example of where DRY isn&amp;rsquo;t the be all and end all.&lt;/p>
&lt;hr>
&lt;p>I don&amp;rsquo;t have the strongest of convictions about all of this, except &lt;a href="#where-did-that-function-come-from%3F">importing
traits&lt;/a>, but overall it&amp;rsquo;s a pattern I&amp;rsquo;ve
found useful. And the portability really helps. It won&amp;rsquo;t change the world, but
hopefully makes someone&amp;rsquo;s life just a little bit better when they come across
some of my code years down the line.&lt;/p></description></item><item><title>Re-Learning Haskell with Advent of Code - Part 3</title><link>https://tarquin-the-brave.github.io/blog/posts/re-learning-haskell-3/</link><pubDate>Sun, 14 Jun 2020 12:35:26 +0100</pubDate><guid>https://tarquin-the-brave.github.io/blog/posts/re-learning-haskell-3/</guid><description>&lt;p>After &lt;a href="https://tarquin-the-brave.github.io/blog/posts/re-learning-haskell-2/">Part 2&lt;/a>, I wanted to go and do some reading. I felt like I could
crack on with the Advent of Code problems with the tools I had at my disposal,
but felt if I learned more Haskell I could be doing better. I wanted to learn
some more about monad transformers and anything else that could improve my
solutions.&lt;/p>
&lt;p>So I started search around to see what resources I could find.&lt;/p>
&lt;h1 id="re-relearning-haskell-without-advent-of-code">(Re-)&lt;sup id="fnref:1">&lt;a href="#fn:1" class="footnote-ref" role="doc-noteref">1&lt;/a>&lt;/sup>Learning Haskell with(out) Advent of Code&lt;/h1>
&lt;p>After looking around a little, I stumbled upon &lt;a href="https://tech.fpcomplete.com/haskell/learn">the Haskell learning
resources shared by FP Complete&lt;/a>. There&amp;rsquo;s so many goodies here!&lt;/p>
&lt;p>I ran through tutorials on:&lt;/p>
&lt;ul>
&lt;li>Applicative Syntax,&lt;/li>
&lt;li>String Types,&lt;/li>
&lt;li>Strictness,&lt;/li>
&lt;li>lenses,&lt;/li>
&lt;li>The RIO library,&lt;/li>
&lt;li>Monad Transformers, and&lt;/li>
&lt;li>Vectors&lt;/li>
&lt;/ul>
&lt;p>This only scratched the surface of what&amp;rsquo;s available there. It&amp;rsquo;s definitely a
resource I will be revisiting.&lt;/p>
&lt;p>Armed with these newly learnt learnings, I went back to my Advent of Code
solutions to see how I could improve them. 👷 🔧&lt;/p>
&lt;hr>
&lt;h1 id="small-improvements">Small Improvements&lt;/h1>
&lt;p>Some small improvements I picked up as handy tips or on a 2nd look saw as
obvious and trivial.&lt;/p>
&lt;h2 id="writing-stack-scripts">Writing Stack Scripts&lt;/h2>
&lt;p>For the simpler problems, I didn&amp;rsquo;t need the overhead of generating a full
project with &lt;code>stack new&lt;/code> and opted to replace that with a single &lt;code>dayX.hs&lt;/code>
script which starts like:&lt;/p>
&lt;pre>&lt;code>#!/usr/bin/env stack
-- stack --resovler lts-15.4 script
&lt;/code>&lt;/pre>&lt;p>I&amp;rsquo;d gone with the full project structure, given by the default template used by
&lt;code>stack new&lt;/code>, to get used to importing and exporting and to find the namespacing
control I was happy with. I&amp;rsquo;ve done that now, so I can reduce some of the
problems to simple scripts and &amp;ldquo;get things done!&amp;quot;.&lt;/p>
&lt;h2 id="using-where-more">Using &lt;code>where&lt;/code> More&lt;/h2>
&lt;p>As I elucidated on in &lt;a href="https://tarquin-the-brave.github.io/blog/posts/re-learning-haskell-2/">Part 2&lt;/a>, my earlier solutions were plagued with
the proliferation of small functions that don&amp;rsquo;t really mean a huge amount on
their own and are only called as part of another function. &lt;code>where&lt;/code> helps to
clean this up by putting them inside the namespace of the function they&amp;rsquo;re
really part of and de-cluttering the namespace of the module.&lt;/p>
&lt;h2 id="use-foldl-over-foldl">Use &lt;code>foldl'&lt;/code> Over &lt;code>foldl&lt;/code>&lt;/h2>
&lt;p>&amp;ldquo;For strict application of the operator&amp;rdquo; - &lt;a href="https://hackage.haskell.org/package/base-4.14.0.0/docs/Data-Foldable.html#v:foldl-39-">the docs say&lt;/a>.&lt;/p>
&lt;p>As I understand it, a lazy fold would build up a giant chain of thunks which,
if the folding operation were cheap, would be more costly than strict
evaluation.&lt;/p>
&lt;h2 id="where-a-list-was-very-slow">Where a List Was Very Slow&lt;/h2>
&lt;p>&lt;a href="https://adventofcode.com/2019/day/3">Day 3&lt;/a>, which was the first real problem I tackled in this exercise to
re-learn Haskell, has you drawing wires on a grid and finding where they cross.&lt;/p>
&lt;p>I was using a long &lt;code>List&lt;/code> for each &amp;ldquo;wire&amp;rdquo; to store the coordinates it passed
through, then finding where two wires had crossed by putting a function that
matches the coordinates in an applicative functor across the two lists. This
ends up scaling with order &lt;code>m * n&lt;/code> as the wires get longer.&lt;/p>
&lt;p>Essentially &lt;code>List&lt;/code> was a terrible choice of data structure for this. Lists
provide an ordering of their data, and allow you to express duplicates. We
want the answer to the question: &amp;ldquo;what points has a path visited?&amp;quot;, we don&amp;rsquo;t
care about the answers to &amp;ldquo;what order did the path visit those points in?&amp;quot;, and
&amp;ldquo;were any points visited more than once?&amp;quot;. But by choosing &lt;code>List&lt;/code>, or any
other ordered collection that allows duplicates, we pay for the answers to
those questions.&lt;/p>
&lt;p>A simple refactor to store this data in &lt;a href="https://hackage.haskell.org/package/unordered-containers-0.2.10.0/docs/Data-HashSet.html#t:HashSet">&lt;code>HashSet&lt;/code>s&lt;/a>, and finding the
&lt;a href="https://hackage.haskell.org/package/unordered-containers-0.2.10.0/docs/Data-HashSet.html#v:intersection">intersection&lt;/a> to get the points where the wires crossed reduced the
runtime of my solution from over 8 minutes, to 0.8 seconds.&lt;/p>
&lt;h2 id="deriving-instances">Deriving Instances&lt;/h2>
&lt;p>In Rust, I use the &lt;a href="https://doc.rust-lang.org/reference/attributes/derive.html">&lt;code>#[derive()]&lt;/code>&lt;/a> attribute &lt;em>a lot&lt;/em>. More often
than not, defining some &lt;code>struct&lt;/code>s and &lt;code>emun&lt;/code>s to declare what aggregates of
data matter becomes the cornerstone of any program I write. Derive macros, via
&lt;a href="https://serde.rs/">&lt;code>serde&lt;/code>&lt;/a> and &lt;a href="https://docs.rs/structopt/0.3.14/structopt/">&lt;code>structopt&lt;/code>&lt;/a>, are &amp;ldquo;how we do&amp;rdquo; serializing and
deserializing data, and building CLIs. I&amp;rsquo;ve even written my own derive macros
recently. It&amp;rsquo;s fair to say: Rust would be a very different language without
derive macros. I was going to say &amp;ldquo;completely fucking unusable&amp;rdquo;, but I started
to imagine a world where defining your own types was significantly more
expensive, where people defined their data aggregates in a more anonymous, ad
hoc manner, using generally available collection types, with a smattering of
type aliases. Perhaps there&amp;rsquo;s some advantages to that style. At least it
would stop people writing reams of code to build spaghetti-like systems of
entirely entangled &amp;ldquo;objects&amp;rdquo; that go right round the houses, dig holes, fill
them back up again, pull in some state from who knows where or when, all just
to &amp;ldquo;do a thing&amp;rdquo;, espousing virtues of &amp;ldquo;encapsulation&amp;rdquo; and &lt;a href="https://tarquin-the-brave.github.io/blog/posts/dry-not-a-goal/">&amp;ldquo;DRY&amp;rdquo; (at all
costs)&lt;/a>. I&amp;rsquo;ve seen code like that in Rust. Defining your own types
provides a lot of control and correctness to your program, as you can lean hard
on the type system, but as with anything, there are costs as well.&lt;/p>
&lt;p>Anyway, while writing Haskell I&amp;rsquo;ve been trying to use &lt;code>deriving&lt;/code> as much as
possible. One thing I picked up from &lt;a href="https://tech.fpcomplete.com/haskell/learn">FP Complete&amp;rsquo;s tutorials&lt;/a> was the
&lt;code>DeriveFunctor&lt;/code> language extension. In &lt;a href="https://tarquin-the-brave.github.io/blog/posts/re-learning-haskell-2/">Part 2&lt;/a> I refactored my Intcode
Computer solution to define and use my own Monad instance. It was good to go
back and delete the 5 lines of code that defined the Functor instance.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#66d9ef">data&lt;/span> &lt;span style="color:#66d9ef">Prog&lt;/span> a &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">Running&lt;/span> a &lt;span style="color:#f92672">|&lt;/span> &lt;span style="color:#66d9ef">AwaitInput&lt;/span> a &lt;span style="color:#f92672">|&lt;/span> &lt;span style="color:#66d9ef">End&lt;/span> a &lt;span style="color:#f92672">|&lt;/span> &lt;span style="color:#66d9ef">Crashed&lt;/span> &lt;span style="color:#66d9ef">String&lt;/span> &lt;span style="color:#66d9ef">deriving&lt;/span>(&lt;span style="color:#66d9ef">Show&lt;/span>, &lt;span style="color:#66d9ef">Eq&lt;/span>)
&lt;span style="color:#66d9ef">instance&lt;/span> &lt;span style="color:#66d9ef">Functor&lt;/span> &lt;span style="color:#66d9ef">Prog&lt;/span> &lt;span style="color:#66d9ef">where&lt;/span>
fmap &lt;span style="color:#66d9ef">_&lt;/span> (&lt;span style="color:#66d9ef">Crashed&lt;/span> e) &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">Crashed&lt;/span> e
fmap f (&lt;span style="color:#66d9ef">End&lt;/span> a) &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">End&lt;/span> (f a)
fmap f (&lt;span style="color:#66d9ef">Running&lt;/span> a) &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">Running&lt;/span> (f a)
fmap f (&lt;span style="color:#66d9ef">AwaitInput&lt;/span> a) &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">AwaitInput&lt;/span> (f a)
&lt;/code>&lt;/pre>&lt;/div>&lt;p>became:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#75715e">{-# LANGUAGE DerivingFunctor #-}&lt;/span>
&lt;span style="color:#66d9ef">data&lt;/span> &lt;span style="color:#66d9ef">Prog&lt;/span> a &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">Running&lt;/span> a &lt;span style="color:#f92672">|&lt;/span> &lt;span style="color:#66d9ef">AwaitInput&lt;/span> a &lt;span style="color:#f92672">|&lt;/span> &lt;span style="color:#66d9ef">End&lt;/span> a &lt;span style="color:#f92672">|&lt;/span> &lt;span style="color:#66d9ef">Crashed&lt;/span> &lt;span style="color:#66d9ef">String&lt;/span> &lt;span style="color:#66d9ef">deriving&lt;/span>(&lt;span style="color:#66d9ef">Show&lt;/span>, &lt;span style="color:#66d9ef">Eq&lt;/span>, &lt;span style="color:#66d9ef">Functor&lt;/span>)
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Little victories. No code, no bugs. 🐛&lt;/p>
&lt;h2 id="using-git-dependencies-with-stack">Using Git Dependencies with Stack&lt;/h2>
&lt;p>As part of my refactored Intcode Computer solution in &lt;a href="https://tarquin-the-brave.github.io/blog/posts/re-learning-haskell-2/">Part 2&lt;/a> I had to
fork and update the &lt;code>base&lt;/code> version in &lt;a href="http://hackage.haskell.org/package/tasty-laws">a library that provided testing of
Monad, Applicative, Functor, and Monoid Laws&lt;/a>. I then included my
fork as a &lt;a href="https://git-scm.com/book/en/v2/Git-Tools-Submodules">git submodule&lt;/a> and pointed Stack at the dependency in the
local file system. This was a good bit of practice with git submodules. I&amp;rsquo;ve
found git submodules to be something that you never use, until you have to, and
then you get it all spectacularly wrong and end up very confused. But as the
theme of this post is about tidying up and refactoring, I changed this to tell
stack to get my fork &lt;a href="https://docs.haskellstack.org/en/stable/yaml_configuration/#extra-deps">from git&lt;/a>.&lt;/p>
&lt;hr>
&lt;h1 id="big-changes">Big Changes&lt;/h1>
&lt;p>For me, the biggest difference coming back to my solutions was more down to
having more experience and confidence in the language, and coming at the code,
with a view to cleaning up the expressions and abstractions rather than wanting
to get the answer to plug into Advent of Code so it&amp;rsquo;ll give me a gold star.
⭐&lt;/p>
&lt;p>Looking past the general code tidying, there were some specific things I&amp;rsquo;d
learned from doing some of &lt;a href="https://tech.fpcomplete.com/haskell/learn">FP Complete&amp;rsquo;s tutorials&lt;/a> that I was able to apply to
my refactored solutions.&lt;/p>
&lt;h2 id="stop-matching-maybes---more-monad-transformers">Stop Matching Maybes - More Monad Transformers&lt;/h2>
&lt;p>&lt;em>Not a great first example, as it&amp;rsquo;s very much a &amp;ldquo;Big Not-Change&amp;rdquo;, but I thought
it was worth a mention.&lt;/em>&lt;/p>
&lt;p>After going through some of FP Complete&amp;rsquo;s tutorials on monad transformers, I
thought that I&amp;rsquo;d go back to my solutions finding vast swathes of code, matching
on &lt;code>Maybe&lt;/code>s and rip it all out in favour of monad transformer stacks.&lt;/p>
&lt;p>That didn&amp;rsquo;t actually happen. There was actually relatively few cases where I
was matching &lt;code>Maybe&lt;/code>s and they were quite tidily cleaned up by making the
function generic over &lt;code>MonadFail&lt;/code> in stead, see below.&lt;/p>
&lt;p>It could be that there weren&amp;rsquo;t lots places where monad transformers could have
been used to really clean up my code. Or perhaps the concept hasn&amp;rsquo;t sunk in
enough for me to spot those places. I had used &lt;code>StateT&lt;/code> in one of my solutions
already so I could print out the state to terminal as it was evolving (covered
in &lt;a href="https://tarquin-the-brave.github.io/blog/posts/re-learning-haskell-2/">Part 2&lt;/a>). It might be easier to spot where they could be used when
I&amp;rsquo;m writing something fresh, rather than revisiting and refactoring code that
was to some extent written around not knowing to use them.&lt;/p>
&lt;h2 id="alternatively-use-monadfail">Alternatively, Use MonadFail&lt;/h2>
&lt;p>In &lt;a href="https://tarquin-the-brave.github.io/blog/posts/re-learning-haskell-2/">Part 2&lt;/a> I discussed a pattern I found of defining functions who&amp;rsquo;s
result could represent a failure, as being generic over &lt;a href="https://hackage.haskell.org/package/base-4.14.0.0/docs/Prelude.html#t:MonadFail">&lt;code>MonadFail&lt;/code>&lt;/a>
and allowing the calling code to choose the instance of &lt;a href="https://hackage.haskell.org/package/base-4.14.0.0/docs/Prelude.html#t:MonadFail">&lt;code>MonadFail&lt;/code>&lt;/a> to
represent the failure.&lt;/p>
&lt;p>My solution to &lt;a href="https://adventofcode.com/2019/day/6">day 6&lt;/a> involved loading some data into a Tree, and at a
one point, finding the path to a given node. Trouble was, the code assumed the
given node existed in the tree, and if it didn&amp;rsquo;t, the code didn&amp;rsquo;t crash, it
gave a nonsensical answer. 😟&lt;/p>
&lt;p>Using this pattern, this code was surprisingly easy to fix. My function
&lt;code>orbitalHops&lt;/code> which told you how many hops there were between two nodes of a
tree was fixed up to look like:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#66d9ef">import&lt;/span> &lt;span style="color:#66d9ef">qualified&lt;/span> Data.Tree &lt;span style="color:#66d9ef">as&lt;/span> T
&lt;span style="color:#a6e22e">orbitalHops&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">MonadFail&lt;/span> m &lt;span style="color:#f92672">=&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">T&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#66d9ef">Tree&lt;/span> &lt;span style="color:#66d9ef">String&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">String&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">String&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> m &lt;span style="color:#66d9ef">Int&lt;/span>
&lt;span style="color:#a6e22e">orbitalHops&lt;/span> orbs node1 node2 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">do&lt;/span>
&lt;span style="color:#66d9ef">_&lt;/span> &lt;span style="color:#f92672">&amp;lt;-&lt;/span> orbs `contains` node1
&lt;span style="color:#66d9ef">_&lt;/span> &lt;span style="color:#f92672">&amp;lt;-&lt;/span> orbs `contains` node2
return &lt;span style="color:#f92672">$&lt;/span> &lt;span style="color:#75715e">-- previous logic that assumed nodes were in tree&lt;/span>
&lt;span style="color:#66d9ef">where&lt;/span>
contains &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">MonadFail&lt;/span> m &lt;span style="color:#f92672">=&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">T&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#66d9ef">Tree&lt;/span> &lt;span style="color:#66d9ef">String&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">String&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> m ()
contains tree node &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">if&lt;/span> node `elem` &lt;span style="color:#66d9ef">T&lt;/span>&lt;span style="color:#f92672">.&lt;/span>flatten tree &lt;span style="color:#66d9ef">then&lt;/span> return () &lt;span style="color:#66d9ef">else&lt;/span> fail &lt;span style="color:#f92672">$&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Could not find element: &amp;#34;&lt;/span> &lt;span style="color:#f92672">++&lt;/span> node
&lt;/code>&lt;/pre>&lt;/div>&lt;p>In my example of using this pattern with &lt;code>MonadFail&lt;/code> in &lt;a href="https://tarquin-the-brave.github.io/blog/posts/re-learning-haskell-2/">Part 2&lt;/a>, there
was a top level function who&amp;rsquo;s type gave &lt;code>m&lt;/code> a concrete type. This time, I
used the fact that &lt;code>IO&lt;/code> implements &lt;code>MonadFail&lt;/code> and passed the non-concrete &lt;code>m&lt;/code>
up to &lt;code>main&lt;/code> to let the script fail with the error above if a node given was
not in the data.&lt;/p>
&lt;p>In &lt;code>main&lt;/code> I had:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#a6e22e">orbitalHops&lt;/span> orbitTree &lt;span style="color:#e6db74">&amp;#34;YOU&amp;#34;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;SAN&amp;#34;&lt;/span> &lt;span style="color:#f92672">&amp;gt;&amp;gt;=&lt;/span> print
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Causing the script to either print the number of orbital hops between &lt;code>&amp;quot;YOU&amp;quot;&lt;/code> &amp;amp;
&lt;code>&amp;quot;SAN&amp;quot;&lt;/code> or fail with the error above, provided by the call to &lt;code>fail&lt;/code>.&lt;/p>
&lt;h2 id="no-more-strings">No More Strings&lt;/h2>
&lt;p>The wisdom appears to be:&lt;/p>
&lt;blockquote>
&lt;p>Don&amp;rsquo;t use &lt;code>String&lt;/code>, use &lt;code>Text&lt;/code> (or &lt;code>ByteString&lt;/code> for raw data)&lt;/p>
&lt;/blockquote>
&lt;p>which a quick google will provide pretty solid justification for, so I&amp;rsquo;ll not
repeat it here.&lt;/p>
&lt;p>&lt;a href="https://adventofcode.com/2019/day/6">Day 6&lt;/a> was also the first problem where the input data remained as a
string throughout the program and some string manipulation was performed.&lt;/p>
&lt;p>I was bracing myself for a bit of a fight to update the solution from using
&lt;code>String&lt;/code> to using &lt;code>Text&lt;/code>, but actually found I could do an almost like for like
replacement.&lt;/p>
&lt;p>I made some new imports:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#66d9ef">import&lt;/span> &lt;span style="color:#66d9ef">qualified&lt;/span> Data.Text &lt;span style="color:#66d9ef">as&lt;/span> Txt &lt;span style="color:#f92672">//&lt;/span> &lt;span style="color:#66d9ef">I&lt;/span> was already importing &lt;span style="color:#66d9ef">Data&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#66d9ef">Tree&lt;/span> as &lt;span style="color:#66d9ef">T&lt;/span>, so went with &lt;span style="color:#66d9ef">Txt&lt;/span>
&lt;span style="color:#66d9ef">import&lt;/span> &lt;span style="color:#66d9ef">qualified&lt;/span> Data.Text.Encoding &lt;span style="color:#66d9ef">as&lt;/span> TE
&lt;span style="color:#66d9ef">import&lt;/span> &lt;span style="color:#66d9ef">qualified&lt;/span> Data.ByteString &lt;span style="color:#66d9ef">as&lt;/span> B
&lt;span style="color:#66d9ef">import&lt;/span> Data.Monoid ((&lt;span style="color:#f92672">&amp;lt;&amp;gt;&lt;/span>))
&lt;/code>&lt;/pre>&lt;/div>&lt;p>and removed another: &lt;code>import Data.List.Split (splitOn)&lt;/code>, then:&lt;/p>
&lt;p>Swapped &lt;code>String&lt;/code> for &lt;code>Txt.Text&lt;/code> where it appeared in type statements.&lt;/p>
&lt;p>Prepended &lt;code>Txt.&lt;/code> to all the functions acting on strings.&lt;/p>
&lt;p>Swapped the use of Prelude&amp;rsquo;s &lt;code>readFile&lt;/code> with &lt;code>fmap TE.decodeUtf8 . B.readFile&lt;/code>&lt;/p>
&lt;p>And Replaced usages of &lt;code>++&lt;/code> with &lt;code>&amp;lt;&amp;gt;&lt;/code>.&lt;/p>
&lt;p>The compiler picked up a couple of places I&amp;rsquo;d missed and voilà, the script ran
as it did before.&lt;/p>
&lt;p>I was able to completely remove &lt;code>String&lt;/code> from the program, with one exception:
the &lt;a href="https://hackage.haskell.org/package/base-4.14.0.0/docs/Prelude.html#v:fail">&lt;code>fail&lt;/code>&lt;/a> function from &lt;a href="https://hackage.haskell.org/package/base-4.14.0.0/docs/Prelude.html#t:MonadFail">&lt;code>MonadFail&lt;/code>&lt;/a> takes a &lt;code>String&lt;/code>. This
required a call to &lt;a href="https://hackage.haskell.org/package/text-1.2.4.0/docs/Data-Text.html#v:unpack">&lt;code>unpack&lt;/code>&lt;/a> to turn &lt;code>Text&lt;/code> into &lt;code>String&lt;/code>. So:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#a6e22e">fail&lt;/span> &lt;span style="color:#f92672">$&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Could not find element: &amp;#34;&lt;/span> &lt;span style="color:#f92672">++&lt;/span> node
&lt;/code>&lt;/pre>&lt;/div>&lt;p>became:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#a6e22e">fail&lt;/span> &lt;span style="color:#f92672">.&lt;/span> &lt;span style="color:#66d9ef">Txt&lt;/span>&lt;span style="color:#f92672">.&lt;/span>unpack &lt;span style="color:#f92672">$&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Could not find element: &amp;#34;&lt;/span> &lt;span style="color:#f92672">&amp;lt;&amp;gt;&lt;/span> node
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="strictness">Strictness&lt;/h3>
&lt;p>One of the reasons touted for &lt;code>String&lt;/code>, a singly linked lazy list of &lt;code>Char&lt;/code>s,
being a bad representation of textual data is that it&amp;rsquo;s lazy.&lt;/p>
&lt;p>&lt;a href="https://adventofcode.com/2019/day/8">Day 8&lt;/a> was a good problem to experiment with as my solution involved
manipulating lists of characters, &lt;code>[Char]&lt;/code>, a.k.a: &lt;code>String&lt;/code>.&lt;/p>
&lt;p>After refactoring the solution into a once page script and having a bit of a
tidy up, but otherwise leaving the substance of the code the same, I built
and ran the solution, in file &lt;code>day8string.hs&lt;/code>, like so:&lt;/p>
&lt;pre>&lt;code>$ stack --resolver lts-15.4 ghc -- day8string.hs -O2 &amp;amp;&amp;amp; ./day8string +RTS -s
[1 of 1] Compiling Main ( day8string.hs, day8string.o )
Linking day8string ...
...
[solution output]
...
4,892,080 bytes allocated in the heap
848,552 bytes copied during GC
394,736 bytes maximum residency (2 sample(s))
36,256 bytes maximum slop
0 MB total memory in use (0 MB lost due to fragmentation)
Tot time (elapsed) Avg pause Max pause
Gen 0 3 colls, 0 par 0.000s 0.001s 0.0002s 0.0002s
Gen 1 2 colls, 0 par 0.000s 0.000s 0.0002s 0.0003s
INIT time 0.000s ( 0.000s elapsed)
MUT time 0.000s ( 0.001s elapsed)
GC time 0.000s ( 0.001s elapsed)
EXIT time 0.000s ( 0.000s elapsed)
Total time 0.000s ( 0.002s elapsed)
%GC time 0.0% (0.0% elapsed)
Alloc rate 0 bytes per MUT second
Productivity 100.0% of total user, 55.5% of total elapsed
&lt;/code>&lt;/pre>&lt;p>This gets some statistics out of the garbage collector. &lt;a href="https://downloads.haskell.org/~ghc/8.4.2/docs/html/users_guide/runtime_control.html#rts-flag--s%20%5B%E2%9F%A8file%E2%9F%A9%5D">These docs&lt;/a>
tells you what they all mean. The memory usage stats at the top are what&amp;rsquo;s
interesting to us here.&lt;/p>
&lt;p>&lt;a href="#no-more-strings">As with my Day 6 solution&lt;/a>, I went through and replaced all the
usages of &lt;code>[Char]&lt;/code> with &lt;code>Text&lt;/code>, and functions acting on them with their
counterparts from &lt;a href="https://hackage.haskell.org/package/text-1.2.4.0/docs/Data-Text.html">Data.Text&lt;/a>, using
&lt;a href="https://hackage.haskell.org/package/bytestring-0.10.10.0/docs/Data-ByteString.html#v:readFile">&lt;code>Data.ByteString.readFile&lt;/code>&lt;/a> to read the data from file.&lt;/p>
&lt;pre>&lt;code>$ stack --resolver lts-15.4 ghc -- day8.hs -O2 &amp;amp;&amp;amp; ./day8 +RTS -s
...
1,464,056 bytes allocated in the heap
10,264 bytes copied during GC
44,512 bytes maximum residency (1 sample(s))
29,216 bytes maximum slop
0 MB total memory in use (0 MB lost due to fragmentation)
&lt;/code>&lt;/pre>&lt;p>These numbers appear to significantly reduced, which is good. I was interest
how much of this was attributable to laziness alone and not other reasons why
&lt;code>Text&lt;/code> might be more efficient than &lt;code>String&lt;/code>. I made another copy of the
script, this time using the lazy counterparts of the &lt;code>Text&lt;/code> libraries:
&lt;a href="https://hackage.haskell.org/package/text-1.2.4.0/docs/Data-Text-Lazy.html">Data.Text.Lazy&lt;/a>, and &lt;a href="https://hackage.haskell.org/package/text-1.2.4.0/docs/Data-Text-Lazy-IO.html">Data.Text.Lazy.IO&lt;/a>.&lt;/p>
&lt;pre>&lt;code>$ stack --resolver lts-15.4 ghc -- day8lazy.hs -O2 &amp;amp;&amp;amp; ./day8lazy +RTS -s
...
3,566,680 bytes allocated in the heap
34,224 bytes copied during GC
86,824 bytes maximum residency (2 sample(s))
36,056 bytes maximum slop
0 MB total memory in use (0 MB lost due to fragmentation)
&lt;/code>&lt;/pre>&lt;p>The numbers went back up a bit, but nowhere near the level of the solution
using &lt;code>String&lt;/code> and the &lt;a href="https://hackage.haskell.org/package/base-4.14.0.0/docs/Prelude.html#v:readFile">&lt;code>readFile&lt;/code> from Prelude&lt;/a>.&lt;/p>
&lt;p>I imagine there&amp;rsquo;s a few ways in which &lt;code>Text&lt;/code> has been made to be more efficient
than &lt;code>String&lt;/code>. It&amp;rsquo;s good to know that in the rarer case where you might want
to evaluate text lazily, lazy &lt;code>Text&lt;/code> is still &lt;em>that much more efficient&lt;/em> than
&lt;code>String&lt;/code>.&lt;/p>
&lt;h2 id="lenses">Lenses&lt;/h2>
&lt;p>&lt;em>Lenses are awesome.&lt;/em>&lt;/p>
&lt;p>In my intcode computer code, which the building of and using was the focus of
&lt;a href="https://tarquin-the-brave.github.io/blog/posts/re-learning-haskell-2/">Part 2&lt;/a>, I had defined the core &amp;ldquo;intcode data&amp;rdquo; in its own module, that
consisted of an &lt;code>Intcode&lt;/code> type:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#66d9ef">data&lt;/span> &lt;span style="color:#66d9ef">Intcode&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">Intcode&lt;/span> {
input&lt;span style="color:#f92672">::&lt;/span>[&lt;span style="color:#66d9ef">Int&lt;/span>],
code&lt;span style="color:#f92672">::&lt;/span>[&lt;span style="color:#66d9ef">Int&lt;/span>],
&lt;span style="color:#75715e">-- ip: Instruction Pointer&lt;/span>
ip&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#66d9ef">Int&lt;/span>,
&lt;span style="color:#75715e">-- rb: Relative Base&lt;/span>
rb&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#66d9ef">Int&lt;/span>,
output&lt;span style="color:#f92672">::&lt;/span>[&lt;span style="color:#66d9ef">Int&lt;/span>]
} &lt;span style="color:#66d9ef">deriving&lt;/span>(&lt;span style="color:#66d9ef">Show&lt;/span>, &lt;span style="color:#66d9ef">Eq&lt;/span>)
&lt;/code>&lt;/pre>&lt;/div>&lt;p>and some functions that edit the subfields, such as:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#a6e22e">moveIp&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">Int&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Intcode&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Intcode&lt;/span>
&lt;span style="color:#a6e22e">moveIp&lt;/span> i ic &lt;span style="color:#f92672">=&lt;/span> setIp (i &lt;span style="color:#f92672">+&lt;/span> ip ic) ic
&lt;span style="color:#a6e22e">setIp&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">Int&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Intcode&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Intcode&lt;/span>
&lt;span style="color:#a6e22e">setIp&lt;/span> i ic &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">Intcode&lt;/span>{
input &lt;span style="color:#f92672">=&lt;/span> input ic,
code &lt;span style="color:#f92672">=&lt;/span> code ic,
ip &lt;span style="color:#f92672">=&lt;/span> i,
rb &lt;span style="color:#f92672">=&lt;/span> rb ic,
output &lt;span style="color:#f92672">=&lt;/span> output ic
}
&lt;span style="color:#a6e22e">changeRb&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">Int&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Intcode&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Intcode&lt;/span>
&lt;span style="color:#a6e22e">changeRb&lt;/span> b ic &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">Intcode&lt;/span>{
input &lt;span style="color:#f92672">=&lt;/span> input ic,
code &lt;span style="color:#f92672">=&lt;/span> code ic,
ip &lt;span style="color:#f92672">=&lt;/span> ip ic,
rb &lt;span style="color:#f92672">=&lt;/span> (rb ic) &lt;span style="color:#f92672">+&lt;/span> b,
output &lt;span style="color:#f92672">=&lt;/span> output ic
}
&lt;span style="color:#a6e22e">consOutput&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">Int&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Intcode&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Intcode&lt;/span>
&lt;span style="color:#a6e22e">consOutput&lt;/span> o ic &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">Intcode&lt;/span>{
input &lt;span style="color:#f92672">=&lt;/span> input ic,
code &lt;span style="color:#f92672">=&lt;/span> code ic,
ip &lt;span style="color:#f92672">=&lt;/span> ip ic,
rb &lt;span style="color:#f92672">=&lt;/span> rb ic,
output &lt;span style="color:#f92672">=&lt;/span> o&lt;span style="color:#66d9ef">:&lt;/span>(output ic)
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>With the exception of some like &lt;code>moveIp&lt;/code> that called other functions,
they all followed the same pattern of &amp;ldquo;make a new &lt;code>Intcode&lt;/code> with one
field different.&lt;/p>
&lt;p>The full list of them could be seen in export statement of the module:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#66d9ef">module&lt;/span> Intcode.Data
( &lt;span style="color:#66d9ef">Intcode&lt;/span> (&lt;span style="color:#f92672">..&lt;/span>)
, &lt;span style="color:#a6e22e">newIC&lt;/span>
, &lt;span style="color:#a6e22e">moveIp&lt;/span>
, &lt;span style="color:#a6e22e">setIp&lt;/span>
, &lt;span style="color:#a6e22e">changeRb&lt;/span>
, &lt;span style="color:#a6e22e">updateCode&lt;/span>
, &lt;span style="color:#a6e22e">tailInput&lt;/span>
, &lt;span style="color:#a6e22e">setInput&lt;/span>
, &lt;span style="color:#a6e22e">consInput&lt;/span>
, &lt;span style="color:#a6e22e">appendInput&lt;/span>
, &lt;span style="color:#a6e22e">setOutput&lt;/span>
, &lt;span style="color:#a6e22e">consOutput&lt;/span>
, &lt;span style="color:#a6e22e">scrubOutput&lt;/span>
) &lt;span style="color:#66d9ef">where&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;em>A lot of copy pasting and Vim macros were used when I first wrote this out.&lt;/em>&lt;/p>
&lt;p>I did later find out that Haskell has a built-in way for dealing with this
boiler plate as an instance of a record type can be referred to with respect to another,
only mentioning the records that change. E.g. &lt;code>consOutput&lt;/code> from above could have been
written:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#a6e22e">consOutput&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">Int&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Intcode&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Intcode&lt;/span>
&lt;span style="color:#a6e22e">consOutput&lt;/span> o ic &lt;span style="color:#f92672">=&lt;/span> ic { output &lt;span style="color:#f92672">=&lt;/span> o&lt;span style="color:#66d9ef">:&lt;/span>(output ic) }
&lt;/code>&lt;/pre>&lt;/div>&lt;p>And these can be chained, so you could have something like:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#a6e22e">ic&lt;/span> { output &lt;span style="color:#f92672">=&lt;/span> o&lt;span style="color:#66d9ef">:&lt;/span>(output ic) } { ip &lt;span style="color:#f92672">=&lt;/span> ip ic &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span> }
&lt;/code>&lt;/pre>&lt;/div>&lt;p>This would have massively reduced the boilerplate in this module on its own. But
we can go one better with lenses.&lt;/p>
&lt;p>Using the &lt;a href="http://hackage.haskell.org/package/microlens-platform">&lt;code>microlens-platform&lt;/code>&lt;/a> package, to also get auto generation
of lenses with Template Haskell as well as the functions from &lt;code>microlens&lt;/code>, I was
able to refactor these functions to simple single liners such as:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#a6e22e">consInput&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">Int&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Intcode&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Intcode&lt;/span>
&lt;span style="color:#a6e22e">consInput&lt;/span> i &lt;span style="color:#f92672">=&lt;/span> over input (&lt;span style="color:#a6e22e">\&lt;/span>inp &lt;span style="color:#f92672">-&amp;gt;&lt;/span> i&lt;span style="color:#66d9ef">:&lt;/span>inp)
&lt;/code>&lt;/pre>&lt;/div>&lt;p>And the &amp;ldquo;set&amp;rdquo; functions became entirely trivial:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#a6e22e">setIp&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">Int&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Intcode&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Intcode&lt;/span>
&lt;span style="color:#a6e22e">setIp&lt;/span> &lt;span style="color:#f92672">=&lt;/span> set ip
&lt;/code>&lt;/pre>&lt;/div>&lt;p>As the functions had become so trivial I decided to remove them entirely and in stead
export the lenses for calling code to use.&lt;/p>
&lt;p>The previously 130+ lines of code module became:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#75715e">{-# LANGUAGE TemplateHaskell #-}&lt;/span>
&lt;span style="color:#66d9ef">module&lt;/span> Intcode.Data
( &lt;span style="color:#66d9ef">Intcode&lt;/span>
&lt;span style="color:#75715e">-- Intcode Lenses&lt;/span>
, &lt;span style="color:#a6e22e">input&lt;/span>
, &lt;span style="color:#a6e22e">code&lt;/span>
, &lt;span style="color:#a6e22e">ip&lt;/span>
, &lt;span style="color:#a6e22e">rb&lt;/span>
, &lt;span style="color:#a6e22e">output&lt;/span>
&lt;span style="color:#75715e">-- init&lt;/span>
, &lt;span style="color:#a6e22e">newIC&lt;/span>
) &lt;span style="color:#66d9ef">where&lt;/span>
&lt;span style="color:#66d9ef">import&lt;/span> Lens.Micro.Platform (&lt;span style="color:#a6e22e">makeLenses&lt;/span>, &lt;span style="color:#a6e22e">over&lt;/span>, &lt;span style="color:#a6e22e">set&lt;/span>)
&lt;span style="color:#66d9ef">import&lt;/span> &lt;span style="color:#66d9ef">qualified&lt;/span> Data.Sequence &lt;span style="color:#66d9ef">as&lt;/span> S
&lt;span style="color:#75715e">--&lt;/span>
&lt;span style="color:#75715e">-- Intcode data&lt;/span>
&lt;span style="color:#75715e">--&lt;/span>
&lt;span style="color:#66d9ef">data&lt;/span> &lt;span style="color:#66d9ef">Intcode&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">Intcode&lt;/span>
{ _input&lt;span style="color:#f92672">::&lt;/span>[&lt;span style="color:#66d9ef">Int&lt;/span>]
, _code &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">S&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#66d9ef">Seq&lt;/span> &lt;span style="color:#66d9ef">Int&lt;/span>
&lt;span style="color:#75715e">-- ip: Instruction Pointer&lt;/span>
, _ip&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#66d9ef">Int&lt;/span>
&lt;span style="color:#75715e">-- rb: Relative Base&lt;/span>
, _rb&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#66d9ef">Int&lt;/span>
, _output&lt;span style="color:#f92672">::&lt;/span>[&lt;span style="color:#66d9ef">Int&lt;/span>]
} &lt;span style="color:#66d9ef">deriving&lt;/span>(&lt;span style="color:#66d9ef">Show&lt;/span>, &lt;span style="color:#66d9ef">Eq&lt;/span>)
&lt;span style="color:#a6e22e">makeLenses&lt;/span> &lt;span style="color:#66d9ef">&amp;#39;&amp;#39;Intcode&lt;/span>
&lt;span style="color:#a6e22e">newIC&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">S&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#66d9ef">Seq&lt;/span> &lt;span style="color:#66d9ef">Int&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> [&lt;span style="color:#66d9ef">Int&lt;/span>] &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Intcode&lt;/span>
&lt;span style="color:#a6e22e">newIC&lt;/span> newCode newInput &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">Intcode&lt;/span>{
_input &lt;span style="color:#f92672">=&lt;/span> newInput,
_code &lt;span style="color:#f92672">=&lt;/span> newCode,
_ip &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>,
_rb &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>,
_output &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">[]&lt;/span>
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>(I also &lt;a href="#using-sequence-to-model-intcode">refactored the intcode data to be held in a Sequence&lt;/a>).&lt;/p>
&lt;p>This basic use of lenses with: auto-generation, getting, setting, and modifying
seems an obvious win for whenever I&amp;rsquo;m defining my own data aggregate like this.
When I have types nested inside types, lenses&amp;rsquo; composability will come in
handy. I think it&amp;rsquo;s going to be my default approach in future.&lt;/p>
&lt;p>I looked through a couple of my other solutions to see where I had defined some
non-trivial aggregation of data where I could clean up the code with lenses.
My solutions to &lt;a href="https://adventofcode.com/2019/day/11">Day 11&lt;/a> and &lt;a href="https://adventofcode.com/2019/day/13">Day 13&lt;/a> both followed the same
pattern:&lt;/p>
&lt;ul>
&lt;li>Defined the state that matters in a type, &lt;code>s&lt;/code>,&lt;/li>
&lt;li>Write a &amp;ldquo;step function&amp;rdquo; to progress that state, of the form &lt;code>s -&amp;gt; (a, s)&lt;/code>,
where &lt;code>a&lt;/code> is some output of the computation,&lt;/li>
&lt;li>Wrap that in &lt;a href="https://hackage.haskell.org/package/mtl-2.2.2/docs/Control-Monad-State-Lazy.html">the State Monad&lt;/a>,&lt;/li>
&lt;li>And recurse, until some condition is met.&lt;/li>
&lt;/ul>
&lt;p>&lt;a href="https://tarquin-the-brave.github.io/blog/posts/re-learning-haskell-2/">Part 2&lt;/a> covers these solutions in more detail.&lt;/p>
&lt;p>I started to look at refactoring these solutions to use lenses. But the &amp;ldquo;step
functions&amp;rdquo; were pretty much the only places lenses could be applied, and these
functions did a &amp;ldquo;bulk update&amp;rdquo; of the state where every record is being changed.
In this cases, I think the record syntax looked clearer than a long chain of
lenses.&lt;/p>
&lt;h2 id="deriving-default">Deriving Default&lt;/h2>
&lt;p>While I was &lt;a href="#lenses">refactoring the intcode solution to use lenses&lt;/a> to
access fields in the &lt;code>Intcode&lt;/code> type, I also wanted to refactor the &amp;ldquo;new&amp;rdquo;
function, so it wasn&amp;rsquo;t calling the record functions, now prepended with an
underscore, directly.&lt;/p>
&lt;p>In Rust I&amp;rsquo;d do:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-rust" data-lang="rust">&lt;span style="color:#75715e">#[derive(Default)]&lt;/span>
&lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">SomeData&lt;/span> {
foo: &lt;span style="color:#66d9ef">usize&lt;/span>,
bar: String,
baz: Vec&lt;span style="color:#f92672">&amp;lt;&lt;/span>String&lt;span style="color:#f92672">&amp;gt;&lt;/span>,
}
&lt;span style="color:#66d9ef">impl&lt;/span> SomeData {
&lt;span style="color:#66d9ef">fn&lt;/span> &lt;span style="color:#a6e22e">new&lt;/span>(bar: String) -&amp;gt; &lt;span style="color:#a6e22e">Self&lt;/span> {
Self {
bar,
..Default::default()
}
}
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>(&lt;a href="https://play.rust-lang.org/?version=stable&amp;amp;mode=debug&amp;amp;edition=2018&amp;amp;gist=b15e306d979834af9ca6fe13d48aacc4">This code in Rust playground&lt;/a>).&lt;/p>
&lt;p>I was hoping to achieve this for my &lt;code>Intcode&lt;/code> type, with something similar in
Haskell like:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#75715e">--&lt;/span>
&lt;span style="color:#75715e">-- DOES NOT COMPILE&lt;/span>
&lt;span style="color:#75715e">--&lt;/span>
&lt;span style="color:#75715e">{-# LANGUAGE TemplateHaskell #-}&lt;/span>
&lt;span style="color:#66d9ef">import&lt;/span> Lens.Micro.Platform (&lt;span style="color:#a6e22e">makeLenses&lt;/span>, &lt;span style="color:#a6e22e">set&lt;/span>)
&lt;span style="color:#66d9ef">import&lt;/span> &lt;span style="color:#66d9ef">qualified&lt;/span> Data.Sequence &lt;span style="color:#66d9ef">as&lt;/span> S
&lt;span style="color:#66d9ef">import&lt;/span> Data.Default
&lt;span style="color:#66d9ef">data&lt;/span> &lt;span style="color:#66d9ef">Intcode&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">Intcode&lt;/span>
{ _input&lt;span style="color:#f92672">::&lt;/span>[&lt;span style="color:#66d9ef">Int&lt;/span>]
, _code &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">S&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#66d9ef">Seq&lt;/span> &lt;span style="color:#66d9ef">Int&lt;/span>
, _ip&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#66d9ef">Int&lt;/span>
, _rb&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#66d9ef">Int&lt;/span>
, _output&lt;span style="color:#f92672">::&lt;/span>[&lt;span style="color:#66d9ef">Int&lt;/span>]
} &lt;span style="color:#66d9ef">deriving&lt;/span>(&lt;span style="color:#66d9ef">Show&lt;/span>, &lt;span style="color:#66d9ef">Eq&lt;/span>, &lt;span style="color:#66d9ef">Default&lt;/span>)
&lt;span style="color:#a6e22e">makeLenses&lt;/span> &lt;span style="color:#66d9ef">&amp;#39;&amp;#39;Intcode&lt;/span>
&lt;span style="color:#a6e22e">newIC&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">S&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#66d9ef">Seq&lt;/span> &lt;span style="color:#66d9ef">Int&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> [&lt;span style="color:#66d9ef">Int&lt;/span>] &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Intcode&lt;/span>
&lt;span style="color:#a6e22e">newIC&lt;/span> c i &lt;span style="color:#f92672">=&lt;/span> set code c &lt;span style="color:#f92672">.&lt;/span> set input i &lt;span style="color:#f92672">$&lt;/span> def
&lt;/code>&lt;/pre>&lt;/div>&lt;p>This failed to compile with:&lt;/p>
&lt;pre>&lt;code>error:
• Can't make a derived instance of ‘Default Intcode’:
‘Default’ is not a stock derivable class (Eq, Show, etc.)
Try enabling DeriveAnyClass
• In the data declaration for ‘Intcode’
|
29 | } deriving(Show, Eq, Default)
| ^^^^^^^
&lt;/code>&lt;/pre>&lt;p>So I included the &lt;code>DeriveAnyClass&lt;/code> language extension, then:&lt;/p>
&lt;pre>&lt;code> error:
• No instance for (GHC.Generics.Generic Intcode)
arising from the 'deriving' clause of a data type declaration
Possible fix:
use a standalone 'deriving instance' declaration,
so you can specify the instance context yourself
• When deriving the instance for (Default Intcode)
|
29 | } deriving(Show, Eq, Default)
| ^^^^^^^
&lt;/code>&lt;/pre>&lt;p>&lt;code>GHC.Generics.Generic&lt;/code>, I can &amp;ldquo;hoogle&amp;rdquo; that. Following a few links lead me to
the &lt;a href="http://hackage.haskell.org/package/generic-deriving-1.13.1/docs/Generics-Deriving-Default.html">Generics.Deriving.Default&lt;/a> module.&lt;/p>
&lt;p>After some fighting with the compiler and adding a bunch of language extensions
that it was asking me to, one by one, I realised this isn&amp;rsquo;t what I want. This
module appears to be a way to derive a default implementation of some class
instances rather than deriving the ability to default the value of type
&lt;code>Intcode&lt;/code>.&lt;/p>
&lt;p>Going back to the last error I tried also deriving &lt;code>Generic&lt;/code>, as that was shown
in the examples in &lt;a href="http://hackage.haskell.org/package/generic-deriving-1.13.1/docs/Generics-Deriving-Default.html">Generics.Deriving.Default&lt;/a>, and examples on the
homepage of the &lt;a href="https://hackage.haskell.org/package/data-default-extra">data-default-extra&lt;/a> which I also looked at while
googling around.&lt;/p>
&lt;pre>&lt;code>error:
• Can't make a derived instance of ‘Generic Intcode’:
You need DeriveGeneric to derive an instance for this class
• In the data declaration for ‘Intcode’
|
32 | deriving(Generic, Default, Show, Eq)
|
&lt;/code>&lt;/pre>&lt;p>I was anticipating another merry-go-round of the compiler telling me to add
language extensions one by one, but adding &lt;code>DeriveGeneric&lt;/code> made this work.&lt;/p>
&lt;p>The finished article looks like:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#75715e">{-# LANGUAGE TemplateHaskell #-}&lt;/span>
&lt;span style="color:#75715e">{-# LANGUAGE DeriveGeneric, DeriveAnyClass #-}&lt;/span>
&lt;span style="color:#66d9ef">import&lt;/span> Lens.Micro.Platform (&lt;span style="color:#a6e22e">makeLenses&lt;/span>, &lt;span style="color:#a6e22e">set&lt;/span>)
&lt;span style="color:#66d9ef">import&lt;/span> &lt;span style="color:#66d9ef">qualified&lt;/span> Data.Sequence &lt;span style="color:#66d9ef">as&lt;/span> S
&lt;span style="color:#66d9ef">import&lt;/span> GHC.Generics (&lt;span style="color:#66d9ef">Generic&lt;/span>)
&lt;span style="color:#66d9ef">import&lt;/span> Data.Default (&lt;span style="color:#66d9ef">Default&lt;/span>, &lt;span style="color:#a6e22e">def&lt;/span>)
&lt;span style="color:#66d9ef">data&lt;/span> &lt;span style="color:#66d9ef">Intcode&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">Intcode&lt;/span>
{ _input&lt;span style="color:#f92672">::&lt;/span>[&lt;span style="color:#66d9ef">Int&lt;/span>]
, _code &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">S&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#66d9ef">Seq&lt;/span> &lt;span style="color:#66d9ef">Int&lt;/span>
&lt;span style="color:#75715e">-- ip: Instruction Pointer&lt;/span>
, _ip&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#66d9ef">Int&lt;/span>
&lt;span style="color:#75715e">-- rb: Relative Base&lt;/span>
, _rb&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#66d9ef">Int&lt;/span>
, _output&lt;span style="color:#f92672">::&lt;/span>[&lt;span style="color:#66d9ef">Int&lt;/span>]
}
&lt;span style="color:#66d9ef">deriving&lt;/span>(&lt;span style="color:#66d9ef">Generic&lt;/span>, &lt;span style="color:#66d9ef">Default&lt;/span>, &lt;span style="color:#66d9ef">Show&lt;/span>, &lt;span style="color:#66d9ef">Eq&lt;/span>)
&lt;span style="color:#a6e22e">makeLenses&lt;/span> &lt;span style="color:#66d9ef">&amp;#39;&amp;#39;Intcode&lt;/span>
&lt;span style="color:#a6e22e">newIC&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">S&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#66d9ef">Seq&lt;/span> &lt;span style="color:#66d9ef">Int&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> [&lt;span style="color:#66d9ef">Int&lt;/span>] &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Intcode&lt;/span>
&lt;span style="color:#a6e22e">newIC&lt;/span> c i &lt;span style="color:#f92672">=&lt;/span> set code c &lt;span style="color:#f92672">.&lt;/span> set input i &lt;span style="color:#f92672">$&lt;/span> def
&lt;/code>&lt;/pre>&lt;/div>&lt;p>So deriving a &lt;code>Default&lt;/code> instance isn&amp;rsquo;t quite as easy as in Rust, and took a bit
of playing around, but I&amp;rsquo;m happy that it was reasonably simple once I worked it
out.&lt;/p>
&lt;h2 id="replacing-lists-with-vectors">Replacing Lists with Vectors&lt;/h2>
&lt;p>My solution to &lt;a href="https://adventofcode.com/2019/day/10">Day 10&lt;/a> involved &lt;em>a lot&lt;/em> of manipulating lists. There
were &lt;code>fmap&lt;/code>s, zips, folds, concats, all over the place. Chances are, as with
the rest of the solutions I&amp;rsquo;ve revisited, this logic could be simplified
somewhat. But with it as it was, I saw it as a good exercise to convert to
using Vectors and see what the result was.&lt;/p>
&lt;p>Firstly: which Vector? The elements are of type:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#66d9ef">data&lt;/span> &lt;span style="color:#66d9ef">Point&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">Point&lt;/span>
{ px &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#f92672">!&lt;/span>&lt;span style="color:#66d9ef">Int&lt;/span>
, py &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#f92672">!&lt;/span>&lt;span style="color:#66d9ef">Int&lt;/span>
, pAst &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#f92672">!&lt;/span>&lt;span style="color:#66d9ef">Bool&lt;/span>
}
&lt;span style="color:#66d9ef">deriving&lt;/span>(&lt;span style="color:#66d9ef">Show&lt;/span>, &lt;span style="color:#66d9ef">Eq&lt;/span>, &lt;span style="color:#66d9ef">Ord&lt;/span>)
&lt;/code>&lt;/pre>&lt;/div>&lt;p>which isn&amp;rsquo;t a member of &lt;code>Prim&lt;/code> or &lt;code>Storable&lt;/code>, so we need a &lt;a href="https://hackage.haskell.org/package/vector-0.12.1.2/docs/Data-Vector.html">boxed Vector&lt;/a>.&lt;/p>
&lt;p>Importing boxed vectors:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#66d9ef">import&lt;/span> &lt;span style="color:#66d9ef">qualified&lt;/span> Data.Vector &lt;span style="color:#66d9ef">as&lt;/span> V
&lt;/code>&lt;/pre>&lt;/div>&lt;p>I set out making a copy of each function, &lt;code>functionName'&lt;/code>, which worked on
Vectors instead of Lists. Once they all compiled, I switched &lt;code>main&lt;/code> over to
using Vectors.&lt;/p>
&lt;p>As the boxed &lt;code>Vector&lt;/code> is a member of a lot of the same typeclasses, &lt;code>Funtor&lt;/code>,
&lt;code>Monad&lt;/code>, &lt;code>Foldable&lt;/code>, etc, a fair amount of the code could stay the same.&lt;/p>
&lt;p>For the cases where it couldn&amp;rsquo;t, there was generally a function from
&lt;a href="https://hackage.haskell.org/package/vector-0.12.1.2/docs/Data-Vector.html">Data.Vector&lt;/a> that did the job.&lt;/p>
&lt;p>Where I was previously providing some data with coordinates by zipping the List
with integers:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#a6e22e">zip&lt;/span> [&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#f92672">..&lt;/span>]
&lt;/code>&lt;/pre>&lt;/div>&lt;p>I was able to instead call &lt;a href="https://hackage.haskell.org/package/vector-0.12.1.2/docs/Data-Vector.html#v:indexed">&lt;code>indexed&lt;/code>&lt;/a>:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#66d9ef">V&lt;/span>&lt;span style="color:#f92672">.&lt;/span>indexed
&lt;/code>&lt;/pre>&lt;/div>&lt;p>There was another place where I was putting a single value, &lt;code>p&lt;/code>, in a List:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">[p]
&lt;/code>&lt;/pre>&lt;/div>&lt;p>I went with &lt;a href="https://hackage.haskell.org/package/vector-0.12.1.2/docs/Data-Vector.html#v:singleton">&lt;code>singleton&lt;/code>&lt;/a> for the vector case:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#66d9ef">V&lt;/span>&lt;span style="color:#f92672">.&lt;/span>singleton p
&lt;/code>&lt;/pre>&lt;/div>&lt;p>I could have also leveraged &lt;code>Vector&lt;/code>'s &lt;code>Applicative&lt;/code> or &lt;code>Monad&lt;/code> instances with
&lt;code>pure p&lt;/code> or &lt;code>return p&lt;/code> respectively.&lt;/p>
&lt;p>There were a few places where I&amp;rsquo;d made use of &lt;a href="https://wiki.haskell.org/List_comprehension">List comprehensions&lt;/a>.
Replacing their usage with &lt;code>fmap&lt;/code> and &lt;code>filter&lt;/code> was fairly straight forward. In
once case it made the code much simpler. I had a function:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">(&lt;span style="color:#a6e22e">\&lt;/span>ps &lt;span style="color:#f92672">-&amp;gt;&lt;/span> [p&lt;span style="color:#f92672">|&lt;/span>p&lt;span style="color:#f92672">&amp;lt;-&lt;/span>ps, pAst p])
&lt;/code>&lt;/pre>&lt;/div>&lt;p>which instead could be:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">(filter pAst)
&lt;/code>&lt;/pre>&lt;/div>&lt;p>When I learned a bit of Haskell a few years ago I absolutely lived off List
comprehensions. Perhaps because I was coming from Python at the time, and it
was a point of familiarity. These days Rust is my primary language and I&amp;rsquo;m
much more comfortable with maps and filters and the like. I&amp;rsquo;ve hardly used
List comprehensions this time around and I haven&amp;rsquo;t really missed them. In fact
when I first started writing Rust I came across the &lt;a href="https://crates.io/crates/cute">cute&lt;/a> crate that
lets you write Python style list comprehensions in Rust via a macro. I liked
this, but after some code review feedback saying &amp;ldquo;just get good at the Rust way
of doing it&amp;rdquo;, I realised I was only holding onto this as a safety blanket,
so let it go.&lt;/p>
&lt;p>I was thinking that I was mostly over List comprehensions and wouldn&amp;rsquo;t use them
a huge amount going forward. But then I found this on the internet: &lt;a href="https://gitlab.haskell.org/ghc/ghc/-/wikis/monad-comprehensions">Monad
comprehensions&lt;/a>! I&amp;rsquo;ve got to give these a spin at some point!&lt;/p>
&lt;p>As with &lt;a href="#no-more-strings">converting usages of &lt;code>String&lt;/code> to &lt;code>Text&lt;/code>&lt;/a>, this went fairly
smoothly. A lot of things work the same and for what isn&amp;rsquo;t the same &lt;a href="https://hackage.haskell.org/package/vector-0.12.1.2/docs/Data-Vector.html">the
documentation&lt;/a> is pretty good. My one complaint with the docs are that I
wish related modules&amp;rsquo; docs linked to each other by default. I found myself
re-finding the package page on &lt;a href="https://hackage.haskell.org/">Hackage&lt;/a> and following the link to the
other module&amp;rsquo;s docs from there.&lt;/p>
&lt;h3 id="performance">Performance&lt;/h3>
&lt;p>Let&amp;rsquo;s see what effect this change had on memory usage. Running the solution
using Lists:&lt;/p>
&lt;pre>&lt;code>$ stack --resolver lts-15.4 ghc --package diagrams-lib --package statistics -- day10.hs -O2 &amp;amp;&amp;amp; ./day10 +RTS -s
...
problem output
...
344,585,704 bytes allocated in the heap
22,319,112 bytes copied during GC
333,584 bytes maximum residency (2 sample(s))
29,216 bytes maximum slop
0 MB total memory in use (0 MB lost due to fragmentation)
Tot time (elapsed) Avg pause Max pause
Gen 0 329 colls, 0 par 0.015s 0.015s 0.0000s 0.0002s
Gen 1 2 colls, 0 par 0.000s 0.000s 0.0002s 0.0002s
INIT time 0.000s ( 0.000s elapsed)
MUT time 0.121s ( 0.121s elapsed)
GC time 0.015s ( 0.015s elapsed)
EXIT time 0.000s ( 0.000s elapsed)
Total time 0.136s ( 0.136s elapsed)
%GC time 0.0% (0.0% elapsed)
Alloc rate 2,849,888,381 bytes per MUT second
Productivity 88.8% of total user, 88.9% of total elapsed
&lt;/code>&lt;/pre>&lt;p>And then the solution refactored to use Vectors:&lt;/p>
&lt;pre>&lt;code>$ stack --resolver lts-15.4 ghc --package diagrams-lib --package statistics -- day10vec.hs -O2 &amp;amp;&amp;amp; ./day10vec +RTS -s
...
problem output
...
509,421,528 bytes allocated in the heap
38,949,152 bytes copied during GC
298,760 bytes maximum residency (4 sample(s))
29,320 bytes maximum slop
0 MB total memory in use (0 MB lost due to fragmentation)
Tot time (elapsed) Avg pause Max pause
Gen 0 487 colls, 0 par 0.027s 0.029s 0.0001s 0.0008s
Gen 1 4 colls, 0 par 0.001s 0.001s 0.0003s 0.0008s
INIT time 0.000s ( 0.000s elapsed)
MUT time 0.166s ( 0.172s elapsed)
GC time 0.028s ( 0.030s elapsed)
EXIT time 0.000s ( 0.000s elapsed)
Total time 0.195s ( 0.203s elapsed)
%GC time 0.0% (0.0% elapsed)
Alloc rate 3,065,812,448 bytes per MUT second
Productivity 85.3% of total user, 84.9% of total elapsed
&lt;/code>&lt;/pre>&lt;p>So it performed worse with Vectors. Taking a look at the code, I saw two
reasons why this might be.&lt;/p>
&lt;p>&lt;a href="https://adventofcode.com/2019/day/10">The problem&lt;/a> deals with line of sight between points on a
grid. Part of my solution sorted the points of interest into the rays they
are on from a certain point, defined by their angle from the vertical. It
did this by folding over a &lt;code>Set&lt;/code> of the points of interest to construct
a &lt;code>Map&lt;/code> of points on each ray.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#a6e22e">raysFromPoint&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">Point&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Set&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#66d9ef">Set&lt;/span> &lt;span style="color:#66d9ef">Point&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Rays&lt;/span>
&lt;span style="color:#a6e22e">raysFromPoint&lt;/span> p0 &lt;span style="color:#f92672">=&lt;/span> foldl (&lt;span style="color:#a6e22e">\&lt;/span>rays p &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Map&lt;/span>&lt;span style="color:#f92672">.&lt;/span>insertWith (&lt;span style="color:#f92672">++&lt;/span>) (angleFromPoints p0 p) [p] rays) &lt;span style="color:#66d9ef">Map&lt;/span>&lt;span style="color:#f92672">.&lt;/span>empty
&lt;/code>&lt;/pre>&lt;/div>&lt;p>and in the Vector implementation:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#a6e22e">raysFromPoint&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">Point&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Set&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#66d9ef">Set&lt;/span> &lt;span style="color:#66d9ef">Point&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Rays&lt;/span>
&lt;span style="color:#a6e22e">raysFromPoint&lt;/span> p0 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">Set&lt;/span>&lt;span style="color:#f92672">.&lt;/span>foldl (&lt;span style="color:#a6e22e">\&lt;/span>rays p &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Map&lt;/span>&lt;span style="color:#f92672">.&lt;/span>insertWith (&lt;span style="color:#66d9ef">V&lt;/span>&lt;span style="color:#f92672">.++&lt;/span>) (angleFromPoints p0 p) (&lt;span style="color:#66d9ef">V&lt;/span>&lt;span style="color:#f92672">.&lt;/span>singleton p) rays) &lt;span style="color:#66d9ef">Map&lt;/span>&lt;span style="color:#f92672">.&lt;/span>empty
&lt;/code>&lt;/pre>&lt;/div>&lt;p>where &lt;code>angleFromPoints&lt;/code> gives the angle between the vertical and the line between
two points.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#a6e22e">angleFromPoints&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">Point&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Point&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Angle&lt;/span> &lt;span style="color:#66d9ef">Float&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>In the List case the &lt;code>(++)&lt;/code> is quite efficient. The left hand side is always a
list with a single element, so Haskell only needs to allocate a new element
which points to the existing list as its tail.&lt;/p>
&lt;p>For Vectors, &lt;code>(++)&lt;/code> is &lt;a href="https://hackage.haskell.org/package/vector-0.12.1.2/docs/Data-Vector.html#v:-43--43-">of order O(m + n)&lt;/a> as the whole new combined
vector has to be allocated. Granted, &lt;code>m&lt;/code> is &lt;code>1&lt;/code> in this case, but that leaves
us with an operation of order &lt;code>n&lt;/code> where previously it was constant complexity.&lt;/p>
&lt;p>I also had to convert the Vector to a List in two places using &lt;a href="https://hackage.haskell.org/package/vector-0.12.1.2/docs/Data-Vector.html#v:toList">&lt;code>toList&lt;/code>&lt;/a>.&lt;/p>
&lt;p>I couldn&amp;rsquo;t see a way to directly turn a Vector into a Set so resorted to:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#66d9ef">Set&lt;/span>&lt;span style="color:#f92672">.&lt;/span>fromList &lt;span style="color:#66d9ef">V&lt;/span>&lt;span style="color:#f92672">.&lt;/span>toList
&lt;/code>&lt;/pre>&lt;/div>&lt;p>I wanted to flatten a &lt;code>Vector Vector Points&lt;/code> to &lt;code>Vector Points&lt;/code>, but
&lt;a href="https://hackage.haskell.org/package/vector-0.12.1.2/docs/Data-Vector.html#v:concat">&lt;code>V.concat&lt;/code>&lt;/a> has signature &lt;code>[ Vector a ] =&amp;gt; Vector a&lt;/code>. I couldn&amp;rsquo;t
find another way of doing that so went with:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#66d9ef">V&lt;/span>&lt;span style="color:#f92672">.&lt;/span>concat &lt;span style="color:#66d9ef">V&lt;/span>&lt;span style="color:#f92672">.&lt;/span>toList
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;em>UPDATE: It looks as if using &lt;a href="https://hackage.haskell.org/package/vector-0.12.1.2/docs/Data-Vector.html#v:concatMap">&lt;code>V.concatMap&lt;/code>&lt;/a> would have avoided the
need to use the second of these &lt;code>V.formList&lt;/code>s. What effect that would have on
performance, I don&amp;rsquo;t know.&lt;/em>&lt;/p>
&lt;p>Looking at the input data, non of the rays are going to have more than around
10 points on them, so these Vectors aren&amp;rsquo;t going to ever be that large, but
both of these things are work that isn&amp;rsquo;t being done in the solution with Lists
and will come at a cost.&lt;/p>
&lt;p>Are there any real savings? There might be some savings from Vector&amp;rsquo;s
strictness, but from what I can tell, Vector&amp;rsquo;s really out perform Lists when
they&amp;rsquo;re being indexed. This solution wasn&amp;rsquo;t doing any indexing.&lt;/p>
&lt;h2 id="using-sequence-to-model-intcode">Using Sequence to Model Intcode&lt;/h2>
&lt;p>From the offset, when I first implemented a solution to &lt;a href="https://adventofcode.com/2019/day/2">Day 2&lt;/a>, which
introduces the problem of implementing an intcode computer, I knew storing the
intcode data in a List was going to be bad for performance as the intcode data
needed to be reference by index &lt;em>a lot&lt;/em> and have values at specific indices
updated.&lt;/p>
&lt;p>I made a note to come back to it later, figuring that as the intcode computer
implementation is built up over days 2, 5, 7, and 9, after implementing them
I know all the things I need to do with the data, and choose a replacement for
List then. This did mean that I&amp;rsquo;d built up a solution around using Lists,
but I backed myself to keeps things modular.&lt;/p>
&lt;p>After considering a few options, I decided I liked what I saw in &lt;a href="https://hackage.haskell.org/package/containers-0.6.2.1/docs/Data-Sequence.html">&lt;code>Data.Sequence&lt;/code>&lt;/a>:&lt;/p>
&lt;ul>
&lt;li>&amp;ldquo;Logarithmic-time access to any element&amp;rdquo;,&lt;/li>
&lt;li>&amp;ldquo;Logarithmic-time concatenation&amp;rdquo;,&lt;/li>
&lt;li>&amp;ldquo;Constant-time access to both the front and the rear&amp;rdquo; - appending and prepending,&lt;/li>
&lt;li>The ability to change a value at an index with &lt;code>update&lt;/code>, and&lt;/li>
&lt;li>A List-like interface.&lt;/li>
&lt;/ul>
&lt;p>The refactor went pretty smoothly. The List-like interface meant a lot of
functions could be replaced like-for-like and those that couldn&amp;rsquo;t had a fairly
obvious replacement found in &lt;a href="https://hackage.haskell.org/package/containers-0.6.2.1/docs/Data-Sequence.html">the docs&lt;/a>. It having instances of
&lt;code>Functor&lt;/code>, &lt;code>Foldable&lt;/code>, and &lt;code>Monad&lt;/code> meant a lot of the code could stay the same.&lt;/p>
&lt;p>The part of the code that looked after updating values in the intcode,
according to the rules set in the problem, ended up looking a lot cleaner.&lt;/p>
&lt;p>Where in the implementation with lists we had:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#a6e22e">replaceNth&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">Integral&lt;/span> a &lt;span style="color:#f92672">=&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">MonadFail&lt;/span> m &lt;span style="color:#f92672">=&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Int&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> a &lt;span style="color:#f92672">-&amp;gt;&lt;/span> [a] &lt;span style="color:#f92672">-&amp;gt;&lt;/span> m [a]
&lt;span style="color:#a6e22e">replaceNth&lt;/span> n newVal xs
&lt;span style="color:#f92672">|&lt;/span> n &lt;span style="color:#f92672">&amp;lt;&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span> &lt;span style="color:#f92672">=&lt;/span> fail &lt;span style="color:#e6db74">&amp;#34;Cannot replace element with negative index&amp;#34;&lt;/span>
&lt;span style="color:#f92672">|&lt;/span> n &lt;span style="color:#f92672">&amp;lt;&lt;/span> length xs &lt;span style="color:#f92672">=&lt;/span> return &lt;span style="color:#f92672">$&lt;/span> replaceNthInner n newVal xs
&lt;span style="color:#f92672">|&lt;/span> n &lt;span style="color:#f92672">==&lt;/span> length xs &lt;span style="color:#f92672">=&lt;/span> return &lt;span style="color:#f92672">$&lt;/span> xs &lt;span style="color:#f92672">++&lt;/span> [newVal]
&lt;span style="color:#f92672">|&lt;/span> n &lt;span style="color:#f92672">&amp;gt;&lt;/span> length xs &lt;span style="color:#f92672">=&lt;/span> return &lt;span style="color:#f92672">$&lt;/span> xs &lt;span style="color:#f92672">++&lt;/span> [&lt;span style="color:#ae81ff">0&lt;/span> &lt;span style="color:#f92672">|&lt;/span> &lt;span style="color:#66d9ef">_&lt;/span> &lt;span style="color:#f92672">&amp;lt;-&lt;/span> [&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#f92672">..&lt;/span>(n &lt;span style="color:#f92672">-&lt;/span> length xs)]] &lt;span style="color:#f92672">++&lt;/span> [newVal]
&lt;span style="color:#a6e22e">replaceNthInner&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">Int&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> a &lt;span style="color:#f92672">-&amp;gt;&lt;/span> [a] &lt;span style="color:#f92672">-&amp;gt;&lt;/span> [a]
&lt;span style="color:#a6e22e">replaceNthInner&lt;/span> &lt;span style="color:#66d9ef">_&lt;/span> &lt;span style="color:#66d9ef">_&lt;/span> &lt;span style="color:#66d9ef">[]&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">[]&lt;/span>
&lt;span style="color:#a6e22e">replaceNthInner&lt;/span> n newVal (x&lt;span style="color:#66d9ef">:&lt;/span>xs)
&lt;span style="color:#f92672">|&lt;/span> n &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span> &lt;span style="color:#f92672">=&lt;/span> newVal&lt;span style="color:#66d9ef">:&lt;/span>xs
&lt;span style="color:#f92672">|&lt;/span> otherwise &lt;span style="color:#f92672">=&lt;/span> x&lt;span style="color:#66d9ef">:&lt;/span>replaceNthInner (n&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>) newVal xs
&lt;/code>&lt;/pre>&lt;/div>&lt;p>This was cleaned up, and made to match the sequence nomenclature:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#a6e22e">update&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">Integral&lt;/span> a &lt;span style="color:#f92672">=&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">MonadFail&lt;/span> m &lt;span style="color:#f92672">=&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Int&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> a &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">S&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#66d9ef">Seq&lt;/span> a &lt;span style="color:#f92672">-&amp;gt;&lt;/span> m (&lt;span style="color:#66d9ef">S&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#66d9ef">Seq&lt;/span> a)
&lt;span style="color:#a6e22e">update&lt;/span> n newVal xs
&lt;span style="color:#f92672">|&lt;/span> n &lt;span style="color:#f92672">&amp;lt;&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span> &lt;span style="color:#f92672">=&lt;/span> fail &lt;span style="color:#e6db74">&amp;#34;Cannot replace element with negative index&amp;#34;&lt;/span>
&lt;span style="color:#f92672">|&lt;/span> n &lt;span style="color:#f92672">&amp;lt;&lt;/span> &lt;span style="color:#66d9ef">S&lt;/span>&lt;span style="color:#f92672">.&lt;/span>length xs &lt;span style="color:#f92672">=&lt;/span> return &lt;span style="color:#f92672">$&lt;/span> &lt;span style="color:#66d9ef">S&lt;/span>&lt;span style="color:#f92672">.&lt;/span>update n newVal xs
&lt;span style="color:#f92672">|&lt;/span> n &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#66d9ef">S&lt;/span>&lt;span style="color:#f92672">.&lt;/span>length xs &lt;span style="color:#f92672">=&lt;/span> return &lt;span style="color:#f92672">$&lt;/span> xs &lt;span style="color:#66d9ef">S&lt;/span>&lt;span style="color:#f92672">.|&amp;gt;&lt;/span> newVal
&lt;span style="color:#f92672">|&lt;/span> n &lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">S&lt;/span>&lt;span style="color:#f92672">.&lt;/span>length xs &lt;span style="color:#f92672">=&lt;/span> return &lt;span style="color:#f92672">.&lt;/span> flip (&lt;span style="color:#66d9ef">S&lt;/span>&lt;span style="color:#f92672">.|&amp;gt;&lt;/span>) newVal &lt;span style="color:#f92672">$&lt;/span> xs &lt;span style="color:#66d9ef">S&lt;/span>&lt;span style="color:#f92672">.&amp;gt;&amp;lt;&lt;/span> (&lt;span style="color:#66d9ef">S&lt;/span>&lt;span style="color:#f92672">.&lt;/span>replicate (n &lt;span style="color:#f92672">-&lt;/span> &lt;span style="color:#66d9ef">S&lt;/span>&lt;span style="color:#f92672">.&lt;/span>length xs) &lt;span style="color:#ae81ff">0&lt;/span>)
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>S.update&lt;/code> brought a lot of this clean up as it removed the need for
&lt;code>replaceNthInner&lt;/code>. The first class ability to append, with &lt;code>S.|&amp;gt;&lt;/code>, also got
rid of the &lt;code>++ [newVal]&lt;/code> which I&amp;rsquo;ve always found a bit nasty.&lt;/p>
&lt;p>I didn&amp;rsquo;t examine what the performance effect was of this refactor. It&amp;rsquo;s on
my bucket list to read up on proper performance profiling. When I do, this
would be a good test case to come back to and benchmark.&lt;/p>
&lt;hr>
&lt;h1 id="some-failed-attempts">Some Failed Attempts&lt;/h1>
&lt;p>There were some things that I had a go at, but after realising I&amp;rsquo;d bitten off
more than I wanted to chew at that moment, left them as something to come back
to, or tried something else.&lt;/p>
&lt;h2 id="generalising-over-vectors">Generalising over Vectors&lt;/h2>
&lt;p>After converting my &lt;a href="https://adventofcode.com/2019/day/10">Day 10&lt;/a> solution from using Lists to boxed Vectors,
and finding the &lt;a href="#performance">performance to be worse&lt;/a>, I was going to see
what the effect of refactoring the solution to use &lt;a href="https://hackage.haskell.org/package/vector-0.12.1.2/docs/Data-Vector-Unboxed.html">unboxed Vectors&lt;/a>
would be.&lt;/p>
&lt;p>My plan for this was to refactor the solution to be generic over vector types
by writing it in terms of &lt;a href="https://hackage.haskell.org/package/vector-0.12.1.2/docs/Data-Vector-Generic.html">Data.Vector.Generic&lt;/a>, and then swapping
the concrete vector type used, at (hopefully) the single point where that was
defined.&lt;/p>
&lt;p>I made a start on this, and I&amp;rsquo;m reasonably happy with a process of swapping out
the module behind the qualified import, and where there are compile errors,
using &lt;a href="https://hackage.haskell.org/package/vector-0.12.1.2/docs/Data-Vector-Generic.html">the documentation&lt;/a> to find an equivalent function. The
only issue was there was a lot of this to do, and I lost the will to do it somewhat.
I think a better approach will be: next time I&amp;rsquo;m writing something to use
Vectors, try to write it with generic Vectors and see where that leads.&lt;/p>
&lt;p>There was one specific thing I hit, that I fixed, but didn&amp;rsquo;t fully
understand. In the boxed Vector solution I defined the &amp;ldquo;rays&amp;rdquo; that different
grid points lived on with a map of angle from the vertical to a Vector of
grid points (&lt;code>Point&lt;/code>). I had the type alias:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#66d9ef">type&lt;/span> &lt;span style="color:#66d9ef">Rays&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">Map&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#66d9ef">Map&lt;/span> (&lt;span style="color:#66d9ef">Angle&lt;/span> &lt;span style="color:#66d9ef">Float&lt;/span>) (&lt;span style="color:#66d9ef">V&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#66d9ef">Vector&lt;/span> &lt;span style="color:#66d9ef">Point&lt;/span>)
&lt;/code>&lt;/pre>&lt;/div>&lt;p>In making this generic over vectors, I changed this to:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#66d9ef">type&lt;/span> &lt;span style="color:#66d9ef">Rays&lt;/span> v &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">V&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#66d9ef">Vector&lt;/span> v &lt;span style="color:#66d9ef">Point&lt;/span> &lt;span style="color:#f92672">=&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Map&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#66d9ef">Map&lt;/span> (&lt;span style="color:#66d9ef">Angle&lt;/span> &lt;span style="color:#66d9ef">Float&lt;/span>) (v &lt;span style="color:#66d9ef">Point&lt;/span>)
&lt;/code>&lt;/pre>&lt;/div>&lt;p>which worked just fine in all but 3 functions&amp;rsquo; type signatures. I had some functions
to wrap these &amp;ldquo;rays&amp;rdquo; in the &lt;a href="https://hackage.haskell.org/package/mtl-2.2.2/docs/Control-Monad-State-Lazy.html">State monad&lt;/a>, with one function providing
the &lt;code>s -&amp;gt; (a, s)&lt;/code>, where &lt;code>s&lt;/code> is &amp;ldquo;the rays&amp;rdquo; and another to wrap that in &lt;code>state&lt;/code>,
and a third to recursively evolve the state until a condition is met.&lt;/p>
&lt;p>Taking a look at the &amp;ldquo;&lt;code>s -&amp;gt; (a, s)&lt;/code> function&amp;rdquo;, called &lt;code>shootInner&lt;/code>, the compiler
complained about the type signature:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#a6e22e">shootInner&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">V&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#66d9ef">Vector&lt;/span> v &lt;span style="color:#66d9ef">Point&lt;/span> &lt;span style="color:#f92672">=&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Int&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Rays&lt;/span> v &lt;span style="color:#f92672">-&amp;gt;&lt;/span> ((&lt;span style="color:#66d9ef">Point&lt;/span>, &lt;span style="color:#66d9ef">Int&lt;/span>), &lt;span style="color:#66d9ef">Rays&lt;/span> v)
&lt;/code>&lt;/pre>&lt;/div>&lt;pre>&lt;code>error:
• Illegal qualified type:
V.Vector v Point =&amp;gt; Map.Map (Angle Float) (v Point)
GHC doesn't yet support impredicative polymorphism
• In the expansion of type synonym ‘Rays’
In the type signature:
shootInner :: V.Vector v Point =&amp;gt;
Int -&amp;gt; Rays v -&amp;gt; ((Point, Int), Rays v)
|
66 | shootInner :: V.Vector v Point =&amp;gt; Int -&amp;gt; Rays v -&amp;gt; ((Point, Int), Rays v)
| ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
&lt;/code>&lt;/pre>&lt;p>The same complaint was levied against the other two functions with signatures:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#a6e22e">shoot&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">V&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#66d9ef">Vector&lt;/span> v &lt;span style="color:#66d9ef">Point&lt;/span> &lt;span style="color:#f92672">=&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Int&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">State&lt;/span> (&lt;span style="color:#66d9ef">Rays&lt;/span> v) (&lt;span style="color:#66d9ef">Point&lt;/span>, &lt;span style="color:#66d9ef">Int&lt;/span>)
&lt;span style="color:#a6e22e">shootUntil&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">V&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#66d9ef">Vector&lt;/span> v &lt;span style="color:#66d9ef">Point&lt;/span> &lt;span style="color:#f92672">=&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Int&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Int&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">State&lt;/span> (&lt;span style="color:#66d9ef">Rays&lt;/span> v) &lt;span style="color:#66d9ef">Point&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>(you can read &lt;a href="https://adventofcode.com/2019/day/10">the problem description&lt;/a> for the context behind the names,
basically you spin round and shoot asteroids that are located on the rays).&lt;/p>
&lt;p>I reduced the script around the error to it&amp;rsquo;s simplest form to try and
isolate the source of the error:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#f92672">#!/&lt;/span>usr&lt;span style="color:#f92672">/&lt;/span>bin&lt;span style="color:#f92672">/&lt;/span>env stack
&lt;span style="color:#75715e">-- stack --resolver lts-15.4 script --package containers --package vector&lt;/span>
&lt;span style="color:#75715e">{-# LANGUAGE RankNTypes #-}&lt;/span>
&lt;span style="color:#75715e">{-# LANGUAGE FlexibleContexts #-}&lt;/span>
&lt;span style="color:#66d9ef">import&lt;/span> &lt;span style="color:#66d9ef">qualified&lt;/span> Data.Map.Strict &lt;span style="color:#66d9ef">as&lt;/span> Map
&lt;span style="color:#66d9ef">import&lt;/span> &lt;span style="color:#66d9ef">qualified&lt;/span> Data.Vector.Generic &lt;span style="color:#66d9ef">as&lt;/span> V
&lt;span style="color:#a6e22e">main&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">IO&lt;/span> ()
&lt;span style="color:#a6e22e">main&lt;/span> &lt;span style="color:#f92672">=&lt;/span> print &lt;span style="color:#e6db74">&amp;#34;Hello&amp;#34;&lt;/span>
&lt;span style="color:#66d9ef">type&lt;/span> &lt;span style="color:#66d9ef">Foo&lt;/span> v &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">V&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#66d9ef">Vector&lt;/span> v &lt;span style="color:#66d9ef">Int&lt;/span> &lt;span style="color:#f92672">=&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Map&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#66d9ef">Map&lt;/span> &lt;span style="color:#66d9ef">Int&lt;/span> (v &lt;span style="color:#66d9ef">Int&lt;/span>)
&lt;span style="color:#a6e22e">bar&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">V&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#66d9ef">Vector&lt;/span> v &lt;span style="color:#66d9ef">Int&lt;/span> &lt;span style="color:#f92672">=&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Int&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Foo&lt;/span> v &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Foo&lt;/span> v
&lt;span style="color:#a6e22e">bar&lt;/span> &lt;span style="color:#f92672">=&lt;/span> undefined
&lt;span style="color:#a6e22e">baz&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">V&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#66d9ef">Vector&lt;/span> v &lt;span style="color:#66d9ef">Int&lt;/span> &lt;span style="color:#f92672">=&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Int&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Foo&lt;/span> v &lt;span style="color:#f92672">-&amp;gt;&lt;/span> ((&lt;span style="color:#66d9ef">Int&lt;/span>, &lt;span style="color:#66d9ef">Int&lt;/span>), &lt;span style="color:#66d9ef">Foo&lt;/span> v)
&lt;span style="color:#a6e22e">baz&lt;/span> &lt;span style="color:#f92672">=&lt;/span> undefined
&lt;/code>&lt;/pre>&lt;/div>&lt;p>I hit the same error about &amp;ldquo;impredicative polymorphism&amp;rdquo; here a well.&lt;/p>
&lt;p>After a bit of changing things to see what happens, I found that removing
the constraint from the type alias allowed this to compile:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#66d9ef">type&lt;/span> &lt;span style="color:#66d9ef">Foo&lt;/span> v &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">Map&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#66d9ef">Map&lt;/span> &lt;span style="color:#66d9ef">Int&lt;/span> (v &lt;span style="color:#66d9ef">Int&lt;/span>)
&lt;/code>&lt;/pre>&lt;/div>&lt;p>I did a bit of googling around &amp;ldquo;&lt;a href="https://gitlab.haskell.org/ghc/ghc/-/wikis/impredicative-polymorphism">impredicative polymorphism&lt;/a>&amp;rdquo; and it looks like
I&amp;rsquo;ve got a bit of reading to do before I understand this one, and why it was
hit for these functions but not others that both take and return &lt;code>Rays v&lt;/code>.&lt;/p>
&lt;p>For now my take away is: &amp;ldquo;don&amp;rsquo;t put constraints in type aliases&amp;rdquo;.&lt;/p>
&lt;h2 id="mutable-vector-to-model-intcode">Mutable Vector to Model Intcode&lt;/h2>
&lt;p>Before I settled on &lt;a href="#using-sequence-to-model-intcode">choosing a Sequence to represent the intcode
program&lt;/a>, I was looking into representing it in a &lt;a href="https://hackage.haskell.org/package/vector-0.12.1.2/docs/Data-Vector-Mutable.html">mutable Vector&lt;/a>
as elements have to be changed a lot, I thought that might be more efficient.&lt;/p>
&lt;p>But unlike with Sequence, where I was able to pretty much swap out Lists for
Sequences, changing a few function calls, but otherwise hardly changing the
surrounding functions or structure of the program, with mutable Vectors I&amp;rsquo;d
need a fair amount of refactoring. The &lt;a href="https://hackage.haskell.org/package/vector-0.12.1.2/docs/Data-Vector-Mutable.html#g:10">functions that access
elements&lt;/a> all return a monad that would need handling.&lt;/p>
&lt;p>In this case as well I thought a better approach would be to earmark mutable
vectors as something to try when attempting a future problem, rather than
trying to do a big refactor of an existing solution.&lt;/p>
&lt;hr>
&lt;h1 id="future-improvements">Future Improvements&lt;/h1>
&lt;h2 id="no-prelude-and-rio">No Prelude and RIO&lt;/h2>
&lt;p>Now that I&amp;rsquo;ve refactored a fair few of my solutions to not use &lt;code>String&lt;/code> and
&lt;code>List&lt;/code>, I&amp;rsquo;m hardly using Prelude at all in some of them.&lt;/p>
&lt;p>I think in next Advent of Code problem I attempt, I&amp;rsquo;ll start by putting&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#75715e">{-# LANGUAGE NoImplicitPrelude #-}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>at the top of the file and using &lt;a href="https://hackage.haskell.org/package/rio">RIO&lt;/a> as a Prelude replacement and
build the solution inside the RIO monad.&lt;/p>
&lt;hr>
&lt;h1 id="what-next">What Next?&lt;/h1>
&lt;p>More Advent of Code I guess&amp;hellip;&lt;/p>
&lt;p>Now I&amp;rsquo;ve done a &amp;ldquo;big refactor&amp;rdquo; of my existing solutions, the next thing to do
would be to crack on with some new Advent of Code problems. I&amp;rsquo;m not in any
particular rush to get through them. I&amp;rsquo;m finding them a decent backdrop to
learn things with, and the sooner I finish them, the sooner I have to look
elsewhere for fresh problems. I&amp;rsquo;m definitely in the state of mind of seeing
how much I can learn from doing a solution before moving onto the next one.&lt;/p>
&lt;p>In the process of attempting more problems I&amp;rsquo;m definitely going to return to &lt;a href="https://tech.fpcomplete.com/haskell/learn">FP
Complete&amp;rsquo;s Tutorials&lt;/a>, both for when I&amp;rsquo;m looking to learn something
specific that they cover, and for when I&amp;rsquo;m speculating on what might be useful
for an Advent of Code problem. I see they have a tutorial on performance
profiling which I&amp;rsquo;m keen to look into. In this blog post I&amp;rsquo;ve not been
particularly rigorous when commenting on performance, and at some point I&amp;rsquo;d
like to do some proper benchmarking on the choice of types in some solutions.&lt;/p>
&lt;p>&lt;em>All the changes I&amp;rsquo;ve made are recorded in &lt;a href="https://github.com/tarquin-the-brave/aoc-19-haskell/pull/1/files">this monster pull request&lt;/a>
(which seems to have done a decent job of following when I changed entire Stack
project directories into single page scripts).&lt;/em> 💃&lt;/p>
&lt;section class="footnotes" role="doc-endnotes">
&lt;hr>
&lt;ol>
&lt;li id="fn:1" role="doc-endnote">
&lt;p>By this stage, and really by the time I got to &lt;a href="https://tarquin-the-brave.github.io/blog/posts/re-learning-haskell-2/">Part 2&lt;/a>, I&amp;rsquo;m no
longer &amp;ldquo;Re-learning&amp;rdquo; Haskell as I&amp;rsquo;ve gone far beyond the level I got to when I
learned some Haskell a few years ago. I started this blog series with
&amp;ldquo;re-learning&amp;rdquo;, so for continuity&amp;rsquo;s sake I&amp;rsquo;ll keep the title as it is. &lt;a href="#fnref:1" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/section></description></item><item><title>Collecting All the Errors - Rust</title><link>https://tarquin-the-brave.github.io/blog/posts/collecting-all-the-errors/</link><pubDate>Sat, 09 May 2020 19:00:00 +0100</pubDate><guid>https://tarquin-the-brave.github.io/blog/posts/collecting-all-the-errors/</guid><description>&lt;p>A common way to handle iterating over results, &lt;code>Result&amp;lt;T, E&amp;gt;&lt;/code>, in Rust is to
use &lt;code>collect()&lt;/code> to collect an iterator of results into a result. To borrow the
&lt;a href="https://doc.rust-lang.org/stable/rust-by-example/error/iter_result.html#fail-the-entire-operation-with-collect">example from Rust by Example&lt;/a>:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-rust" data-lang="rust">&lt;span style="color:#66d9ef">let&lt;/span> strings &lt;span style="color:#f92672">=&lt;/span> vec&lt;span style="color:#f92672">!&lt;/span>[&lt;span style="color:#e6db74">&amp;#34;7&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;42&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;one&amp;#34;&lt;/span>];
&lt;span style="color:#66d9ef">let&lt;/span> numbers: Result&lt;span style="color:#f92672">&amp;lt;&lt;/span>Vec&lt;span style="color:#f92672">&amp;lt;&lt;/span>_&lt;span style="color:#f92672">&amp;gt;&lt;/span>,_&lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#f92672">=&lt;/span> string
.into_iter()
.map(&lt;span style="color:#f92672">|&lt;/span>s&lt;span style="color:#f92672">|&lt;/span> s.parse::&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">i32&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span>())
.collect::&lt;span style="color:#f92672">&amp;lt;&lt;/span>Result&lt;span style="color:#f92672">&amp;lt;&lt;/span>Vec&lt;span style="color:#f92672">&amp;lt;&lt;/span>_&lt;span style="color:#f92672">&amp;gt;&lt;/span>,_&lt;span style="color:#f92672">&amp;gt;&amp;gt;&lt;/span>();
&lt;/code>&lt;/pre>&lt;/div>&lt;p>You only need either the type hint on &lt;code>numbers&lt;/code> or the turbofish on &lt;code>collect&lt;/code>
to coerce the iterator of results into a result. I prefer the turbofish on
&lt;code>collect&lt;/code> as I feel it makes the code flow better when reading, and is what you
would do when chaining further computations. In fact, if you&amp;rsquo;re going to use
&lt;code>?&lt;/code> on the collected result, you wouldn&amp;rsquo;t &lt;em>need&lt;/em>&lt;sup id="fnref:1">&lt;a href="#fn:1" class="footnote-ref" role="doc-noteref">1&lt;/a>&lt;/sup> either.&lt;/p>
&lt;p>I use this pattern a lot, and it&amp;rsquo;s great. It makes mapping over collections
with operations that can fail as ergonomic as applying that operation to a
single value.&lt;/p>
&lt;ul>
&lt;li>You can use the &lt;code>?&lt;/code> operator to make the error handling almost automatic.&lt;/li>
&lt;li>You can use any of the other result combinators like &lt;a href="https://doc.rust-lang.org/std/result/enum.Result.html#method.and_then">&lt;code>and_then&lt;/code>&lt;/a>,
and &lt;a href="https://doc.rust-lang.org/std/result/enum.Result.html#method.map">&lt;code>map&lt;/code>&lt;/a>.&lt;/li>
&lt;li>You can chain further computations on the end of the expression. In the
above example we could have done:&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-rust" data-lang="rust"> .collect()&lt;span style="color:#f92672">?&lt;/span>
.into_iter()
.map(&lt;span style="color:#f92672">|&lt;/span>n&lt;span style="color:#f92672">|&lt;/span> n &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>)
.collect()
&lt;/code>&lt;/pre>&lt;/div>&lt;p>This pattern basically says:&lt;/p>
&lt;blockquote>
&lt;p>Go try these things, if one of them fails we&amp;rsquo;ll fail ourselves,
reporting the first error that we encounter.&lt;/p>
&lt;/blockquote>
&lt;p>Which, most of the time, is all you need.&lt;/p>
&lt;p>But what about when it&amp;rsquo;s not? What about when you want to collect all of the
errors when there are some?&lt;/p>
&lt;p>The &lt;a href="https://github.com/rust-lang/rust-by-example/blob/master/src/error/iter_result.md#collect-all-valid-values-and-failures-with-partition">very next section of Rust by Example&lt;/a> shows how you can use
&lt;code>partition(Result::is_ok)&lt;/code> to separate the &lt;code>Ok&lt;/code> &amp;amp; &lt;code>Err&lt;/code> variants in your
iterator of results. You could then go onto write some logic so your function
tests that the collection of errors is empty, and if not returns a result with
a collection of errors in its &lt;code>Err&lt;/code> variant: &lt;code>Result&amp;lt;Vec&amp;lt;T&amp;gt;, Vec&amp;lt;E&amp;gt;&amp;gt;&lt;/code>.&lt;/p>
&lt;p>But then your entire function stack up to the point where you terminate the
need for expressing a collection of errors has to deal with returning a
collection of errors. If you&amp;rsquo;re writing a CLI tool, that termination point
would be the point where you write all the error messages to stderr and exit,
so your whole program is likely to need this error handling. This ruins a lot
of the ergonomics of &lt;code>?&lt;/code> for dealing with calls to foreign methods that return
a normal &lt;code>Result&amp;lt;T, E&amp;gt;&lt;/code> (&lt;code>where E: std::err::Error&lt;/code>). Ok, you could replace all
&lt;code>?&lt;/code> with &lt;code>.map_err(|e| vec![e])?&lt;/code>, but that&amp;rsquo;s still clunky to deal with.&lt;/p>
&lt;p>An alternative could be to use an error type such as
&lt;a href="https://docs.rs/valid/0.3.0/valid/struct.ValidationError.html">&lt;code>valid::ValidationError&lt;/code>&lt;/a> that can model a collection of errors,
or build your own. This is probably a better approach, but is still going to
be a bit of work to define your own error type, or integrate another crates&amp;rsquo;
error type into your application.&lt;/p>
&lt;p>If you&amp;rsquo;re building a library, this alternative is probably the right way to go
as your library will be able to return a well-typed expression of &amp;ldquo;many
errors&amp;rdquo;.&lt;/p>
&lt;p>With both of these, you&amp;rsquo;re still going to be missing the ergonomics of
&lt;code>collect()&lt;/code>.&lt;/p>
&lt;p>In much the same way as when building a library you might use
&lt;a href="https://docs.rs/thiserror/1.0.16/thiserror/">&lt;code>thiserror&lt;/code>&lt;/a> to define your own error types, whereas in an
application you&amp;rsquo;d be happy raising add-hoc errors with
&lt;a href="https://docs.rs/anyhow/1.0.28/anyhow/macro.anyhow.html">&lt;code>anyhow::anyhow&lt;/code>&lt;/a>: if you&amp;rsquo;re writing an application you might find
defining your own error type(s) to handle &amp;ldquo;many errors&amp;rdquo; a bit heavy weight.&lt;/p>
&lt;p>I&amp;rsquo;ve recently found myself in this exact situation while writing a CLI tool.
The tool needs to tell the user all the errors they&amp;rsquo;ve made in the file they&amp;rsquo;ve
provided, rather than just one at a time&amp;hellip; as that would be super annoying.
It doesn&amp;rsquo;t need to do any real processing of the collected errors, it only
needs to print them all to the terminal in a way that&amp;rsquo;s reasonably readable to
the user, ideally with writing as little special code as possible.&lt;/p>
&lt;p>To keep things as simple as possible: I wanted the ergonomics of &lt;code>collect()&lt;/code>;
and for my representation of &amp;ldquo;many errors&amp;rdquo; to be &amp;ldquo;nothing special&amp;rdquo;, so I can
use all the existing error handling goodies out of the box.&lt;/p>
&lt;p>Enter &lt;a href="https://docs.rs/beau_collector/0.2.1/beau_collector/index.html">&lt;code>BeauCollector&lt;/code>&lt;/a>. Trait &lt;code>BeauCollector&lt;/code> provides method
&lt;code>bcollect&lt;/code> which will collect an iterator of errors into an
&lt;a href="https://docs.rs/anyhow/1.0.28/anyhow/type.Result.html">&lt;code>anyhow::Result&lt;/code>&lt;/a> with an &lt;code>Err&lt;/code> variant containing an ad-hoc
&lt;a href="https://docs.rs/anyhow/1.0.28/anyhow/struct.Error.html">&lt;code>anyhow::Error&lt;/code>&lt;/a> with the messages from each error in the
collection of results on a new line in the error message.&lt;/p>
&lt;p>Looking at our example above:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-rust" data-lang="rust">&lt;span style="color:#66d9ef">use&lt;/span> beau_collector::BeauCollector &lt;span style="color:#66d9ef">as&lt;/span> _;
&lt;span style="color:#66d9ef">let&lt;/span> strings &lt;span style="color:#f92672">=&lt;/span> vec&lt;span style="color:#f92672">!&lt;/span>[&lt;span style="color:#e6db74">&amp;#34;7&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;42&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;one&amp;#34;&lt;/span>];
&lt;span style="color:#66d9ef">let&lt;/span> numbers &lt;span style="color:#f92672">=&lt;/span> string
.into_iter()
.map(&lt;span style="color:#f92672">|&lt;/span>s&lt;span style="color:#f92672">|&lt;/span> s.parse::&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">i32&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span>())
.bcollect::&lt;span style="color:#f92672">&amp;lt;&lt;/span>Vec&lt;span style="color:#f92672">&amp;lt;&lt;/span>_&lt;span style="color:#f92672">&amp;gt;&amp;gt;&lt;/span>()&lt;span style="color:#f92672">?&lt;/span>;
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Errors with chains of causes, have their causal chains retained by being
formatted with the &lt;a href="https://docs.rs/anyhow/1.0.28/anyhow/struct.Error.html#display-representations">inline representation&lt;/a> where causes are separated
by &lt;code>:&lt;/code>.&lt;/p>
&lt;p>One of the results you&amp;rsquo;re iterating over might have been the result of running
&lt;code>bcollect&lt;/code>. As string concatenation is basically what we&amp;rsquo;re doing here,
&lt;code>bcollect&lt;/code> will represent them alongside any new errors from this layer in the
error message. You can collect errors with &lt;code>bcollect&lt;/code> at various layers within
you application and they&amp;rsquo;ll all be represented in one large error at the top
level.&lt;/p>
&lt;p>Using &lt;code>bcollect&lt;/code> at multiple levels and having a &lt;code>main&lt;/code> that returns a result:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-rust" data-lang="rust">&lt;span style="color:#66d9ef">fn&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>() -&amp;gt; &lt;span style="color:#a6e22e">anyhow&lt;/span>::Result&lt;span style="color:#f92672">&amp;lt;&lt;/span>()&lt;span style="color:#f92672">&amp;gt;&lt;/span> {
&lt;span style="color:#66d9ef">use&lt;/span> anyhow::Context &lt;span style="color:#66d9ef">as&lt;/span> _;
input_file &lt;span style="color:#f92672">=&lt;/span> ...;
some_data &lt;span style="color:#f92672">=&lt;/span> process_input(input_file)
.with_context(&lt;span style="color:#f92672">||&lt;/span> format&lt;span style="color:#f92672">!&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;Errors found while processing {}&amp;#34;&lt;/span>, input_file))&lt;span style="color:#f92672">?&lt;/span>;
run_application(some_data)
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Can have an error output that looks like:&lt;/p>
&lt;pre>&lt;code>$ ./my-cli-tool input_file.yaml
Errors found while processing input_file.yaml
Caused by:
&amp;quot;foo_bar&amp;quot; is not a valid name for X: underscores are not permitted
field &amp;quot;baz&amp;quot; is missing from input data
errors processing scale data
:
54 is too high for field_y
values must be positive: value -3 given for field_z is negative.
some other error because of: another error because of: specific problem.
&lt;/code>&lt;/pre>&lt;p>The error in the &lt;code>Err&lt;/code> variant of the result returned by &lt;code>main&lt;/code> is an
&lt;a href="https://docs.rs/anyhow/1.0.28/anyhow/struct.Error.html">&lt;code>anyhow::Error&lt;/code>&lt;/a> with a message being the block seen below &amp;ldquo;Caused
by:&amp;rdquo; and a context of &amp;ldquo;Errors found while&amp;hellip;&amp;quot;.&lt;/p>
&lt;p>Using &lt;a href="https://docs.rs/beau_collector/0.2.1/beau_collector/index.html">&lt;code>BeauCollector&lt;/code>&lt;/a> in this way has the advantages that:&lt;/p>
&lt;ul>
&lt;li>Functions can return a &lt;a href="https://docs.rs/anyhow/1.0.28/anyhow/type.Result.html">normal &lt;code>Result&lt;/code>&lt;/a>,&lt;/li>
&lt;li>&lt;code>?&lt;/code> can be used normally on all other &lt;code>Results&lt;/code> in functions,&lt;/li>
&lt;li>If &lt;code>main&lt;/code> returns &lt;code>Result&lt;/code>, no special error handling is needed and the full
collection of results will appear in stderr.&lt;/li>
&lt;/ul>
&lt;p>There are some limitations too:&lt;/p>
&lt;ul>
&lt;li>Beyond placing each collected error on a newline, &lt;code>bcollect&lt;/code> doesn&amp;rsquo;t do any
further formatting, or reformatting when different layers&amp;rsquo; errors are
combined. It&amp;rsquo;s left up to the error messages raised to add in some
whitespace to appear more readable than a solid block of text.&lt;/li>
&lt;li>While the messages from the causal chain of an error are retained you loose
some other error handling like getting the backtrace or downcasting to get
the original error back.&lt;/li>
&lt;/ul>
&lt;p>These are currently the price you pay for the ergonomics of &lt;code>bcollect&lt;/code>.&lt;/p>
&lt;p>For writing applications, you&amp;rsquo;re likely to be happy with this trade off and
find the limitations of &lt;code>bcollect&lt;/code> a small price to pay.&lt;/p>
&lt;p>For a library you might want the caller to have more options on what to do with
the many errors than building up an error message, maybe not. Perhaps
&lt;code>bcollect&lt;/code> could be enhanced to return an error type that can represent a tree
of errors that can be added to as errors propagate back up the stack. By all
means &lt;a href="https://github.com/tarquin-the-brave/beau-collector/">send in a pull request or raise an issue&lt;/a>.&lt;/p>
&lt;section class="footnotes" role="doc-endnotes">
&lt;hr>
&lt;ol>
&lt;li id="fn:1" role="doc-endnote">
&lt;p>When I say you don&amp;rsquo;t &lt;em>need&lt;/em> the type hints, that is to say that the
compiler won&amp;rsquo;t need them to infer the type. HUman readers of the code
might prefer it is there so they can more easily infer the type. Type
hinting is also helpful when refactoring as it can catch errors. &lt;a href="#fnref:1" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/section></description></item><item><title>We All Write Monads, Whether We Know It or Not</title><link>https://tarquin-the-brave.github.io/blog/posts/we-all-write-monads/</link><pubDate>Mon, 04 May 2020 04:46:31 +0100</pubDate><guid>https://tarquin-the-brave.github.io/blog/posts/we-all-write-monads/</guid><description>&lt;p>Recently I&amp;rsquo;ve been rebooting my Haskell by working through &lt;a href="https://adventofcode.com/2019/">Advent of
Code&lt;/a>, and bogging about it:&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://tarquin-the-brave.github.io/blog/posts/re-learning-haskell/">Re-learning Haskell with Advent of Code - Part 1&lt;/a>,&lt;/li>
&lt;li>&lt;a href="https://tarquin-the-brave.github.io/blog/posts/re-learning-haskell-2/">Re-learning Haskell with Advent of Code - Part 2&lt;/a>,&lt;/li>
&lt;/ul>
&lt;p>and it&amp;rsquo;s got me thinking. I was quickly re-introduced to the concepts of:
Functors, Applicative Functors, Monoids, Monads, a strong type system, higher
kinded types, and functional purity, and straight away, started spotting these
patterns in the code I write every day at work (predominantly Rust with some
Bash, Python, and C++ thrown in for good measure).&lt;/p>
&lt;p>I find myself thinking about code I&amp;rsquo;m working with, and saying to myself, or
anyone who will listen, things like:&lt;/p>
&lt;blockquote>
&lt;p>&amp;ldquo;Ah well, this works because string concatenation behaves monoidally&amp;hellip;&amp;rdquo;&lt;/p>
&lt;/blockquote>
&lt;p>or:&lt;/p>
&lt;blockquote>
&lt;p>&amp;ldquo;What we&amp;rsquo;ve got here is a computational context for our data that we want to
map over&amp;hellip;&amp;rdquo;&lt;/p>
&lt;/blockquote>
&lt;p>What this has made me realise is there&amp;rsquo;s nothing special about Haskell that
means these concepts exist where they don&amp;rsquo;t exist in other languages.&lt;/p>
&lt;blockquote>
&lt;p>Haskell formalises data manipulation patterns that exist wherever there is
data to manipulate.&lt;/p>
&lt;/blockquote>
&lt;p>Have you ever had a &amp;ldquo;container type&amp;rdquo; for your data that you&amp;rsquo;ve iterated over?
You&amp;rsquo;ve used a functor.&lt;/p>
&lt;p>Have you ever encoded error handling in the data you&amp;rsquo;re using? You&amp;rsquo;ve used
something resembling a monad.&lt;/p>
&lt;p>Rust&amp;rsquo;s ownership model is a formalisation of a set of memory management
patterns that a C developer might employ to attempt to write memory safe and
thread safe code.&lt;/p>
&lt;p>Regardless of the language we&amp;rsquo;re writing in, these data manipulation patterns
are there. The language may formalise them, it may not. By formalising data
manipulation patterns in a language, there&amp;rsquo;s the opportunity for the compiler
to tell you if you&amp;rsquo;re using them right, otherwise you&amp;rsquo;re performing these
patterns by hand.&lt;/p>
&lt;p>What it comes down to is:
&lt;a href="https://mermaid-js.github.io/mermaid-live-editor/#/edit/eyJjb2RlIjoiZ3JhcGggVERcbiAgQVtEb2VzIHlvdXIgbGFuZ3VhZ2UgZm9ybWFsaXNlIHRoZXNlIHBhdHRlcm5zP11cbiAgQyhbVGhlIGNvbXBpbGVyIGtlZXBzIHlvdSByaWdodCBmYTpmYS10aHVtYnMtdXBdKVxuICBCW0FyZSB5b3UgYXdhcmUgeW91J3JlIHdyaXRpbmcgdGhlbSBieSBoYW5kP11cbiAgRChbWW91J2xsIHdyaXRlIG1vcmUgY29uc2lzdGVudCwgY29ycmVjdCwgYW5kIG1haW50aW5hYmxlIGNvZGUgZmE6ZmEtdGh1bWJzLXVwXSlcbiAgRShbQnVncyB3aWxsIGhhcHBlbiBmYTpmYS1idWddKVxuICBBIC0tPnxZZXN8IENcbiAgQSAtLT58Tm98IEJcbiAgQiAtLT58WWVzfCBEXG4gIEIgLS0-IHxOb3wgRVxuXHRcdCIsIm1lcm1haWQiOnsidGhlbWUiOiJkZWZhdWx0IiwidGhlbWVWYXJpYWJsZXMiOnsiYmFja2dyb3VuZCI6IndoaXRlIiwicHJpbWFyeUNvbG9yIjoiI0VDRUNGRiIsInNlY29uZGFyeUNvbG9yIjoiI2ZmZmZkZSIsInRlcnRpYXJ5Q29sb3IiOiJoc2woODAsIDEwMCUsIDk2LjI3NDUwOTgwMzklKSIsInByaW1hcnlCb3JkZXJDb2xvciI6ImhzbCgyNDAsIDYwJSwgODYuMjc0NTA5ODAzOSUpIiwic2Vjb25kYXJ5Qm9yZGVyQ29sb3IiOiJoc2woNjAsIDYwJSwgODMuNTI5NDExNzY0NyUpIiwidGVydGlhcnlCb3JkZXJDb2xvciI6ImhzbCg4MCwgNjAlLCA4Ni4yNzQ1MDk4MDM5JSkiLCJwcmltYXJ5VGV4dENvbG9yIjoiIzEzMTMwMCIsInNlY29uZGFyeVRleHRDb2xvciI6IiMwMDAwMjEiLCJ0ZXJ0aWFyeVRleHRDb2xvciI6InJnYig5LjUwMDAwMDAwMDEsIDkuNTAwMDAwMDAwMSwgOS41MDAwMDAwMDAxKSIsImxpbmVDb2xvciI6IiMzMzMzMzMiLCJ0ZXh0Q29sb3IiOiIjMzMzIiwibWFpbkJrZyI6IiNFQ0VDRkYiLCJzZWNvbmRCa2ciOiIjZmZmZmRlIiwiYm9yZGVyMSI6IiM5MzcwREIiLCJib3JkZXIyIjoiI2FhYWEzMyIsImFycm93aGVhZENvbG9yIjoiIzMzMzMzMyIsImZvbnRGYW1pbHkiOiJcInRyZWJ1Y2hldCBtc1wiLCB2ZXJkYW5hLCBhcmlhbCIsImZvbnRTaXplIjoiMTZweCIsImxhYmVsQmFja2dyb3VuZCI6IiNlOGU4ZTgiLCJub2RlQmtnIjoiI0VDRUNGRiIsIm5vZGVCb3JkZXIiOiIjOTM3MERCIiwiY2x1c3RlckJrZyI6IiNmZmZmZGUiLCJjbHVzdGVyQm9yZGVyIjoiI2FhYWEzMyIsImRlZmF1bHRMaW5rQ29sb3IiOiIjMzMzMzMzIiwidGl0bGVDb2xvciI6IiMzMzMiLCJlZGdlTGFiZWxCYWNrZ3JvdW5kIjoiI2U4ZThlOCIsImFjdG9yQm9yZGVyIjoiaHNsKDI1OS42MjYxNjgyMjQzLCA1OS43NzY1MzYzMTI4JSwgODcuOTAxOTYwNzg0MyUpIiwiYWN0b3JCa2ciOiIjRUNFQ0ZGIiwiYWN0b3JUZXh0Q29sb3IiOiJibGFjayIsImFjdG9yTGluZUNvbG9yIjoiZ3JleSIsInNpZ25hbENvbG9yIjoiIzMzMyIsInNpZ25hbFRleHRDb2xvciI6IiMzMzMiLCJsYWJlbEJveEJrZ0NvbG9yIjoiI0VDRUNGRiIsImxhYmVsQm94Qm9yZGVyQ29sb3IiOiJoc2woMjU5LjYyNjE2ODIyNDMsIDU5Ljc3NjUzNjMxMjglLCA4Ny45MDE5NjA3ODQzJSkiLCJsYWJlbFRleHRDb2xvciI6ImJsYWNrIiwibG9vcFRleHRDb2xvciI6ImJsYWNrIiwibm90ZUJvcmRlckNvbG9yIjoiI2FhYWEzMyIsIm5vdGVCa2dDb2xvciI6IiNmZmY1YWQiLCJub3RlVGV4dENvbG9yIjoiYmxhY2siLCJhY3RpdmF0aW9uQm9yZGVyQ29sb3IiOiIjNjY2IiwiYWN0aXZhdGlvbkJrZ0NvbG9yIjoiI2Y0ZjRmNCIsInNlcXVlbmNlTnVtYmVyQ29sb3IiOiJ3aGl0ZSIsInNlY3Rpb25Ca2dDb2xvciI6InJnYmEoMTAyLCAxMDIsIDI1NSwgMC40OSkiLCJhbHRTZWN0aW9uQmtnQ29sb3IiOiJ3aGl0ZSIsInNlY3Rpb25Ca2dDb2xvcjIiOiIjZmZmNDAwIiwidGFza0JvcmRlckNvbG9yIjoiIzUzNGZiYyIsInRhc2tCa2dDb2xvciI6IiM4YTkwZGQiLCJ0YXNrVGV4dExpZ2h0Q29sb3IiOiJ3aGl0ZSIsInRhc2tUZXh0Q29sb3IiOiJ3aGl0ZSIsInRhc2tUZXh0RGFya0NvbG9yIjoiYmxhY2siLCJ0YXNrVGV4dE91dHNpZGVDb2xvciI6ImJsYWNrIiwidGFza1RleHRDbGlja2FibGVDb2xvciI6IiMwMDMxNjMiLCJhY3RpdmVUYXNrQm9yZGVyQ29sb3IiOiIjNTM0ZmJjIiwiYWN0aXZlVGFza0JrZ0NvbG9yIjoiI2JmYzdmZiIsImdyaWRDb2xvciI6ImxpZ2h0Z3JleSIsImRvbmVUYXNrQmtnQ29sb3IiOiJsaWdodGdyZXkiLCJkb25lVGFza0JvcmRlckNvbG9yIjoiZ3JleSIsImNyaXRCb3JkZXJDb2xvciI6IiNmZjg4ODgiLCJjcml0QmtnQ29sb3IiOiJyZWQiLCJ0b2RheUxpbmVDb2xvciI6InJlZCIsImxhYmVsQ29sb3IiOiJibGFjayIsImVycm9yQmtnQ29sb3IiOiIjNTUyMjIyIiwiZXJyb3JUZXh0Q29sb3IiOiIjNTUyMjIyIiwiY2xhc3NUZXh0IjoiIzEzMTMwMCIsImZpbGxUeXBlMCI6IiNFQ0VDRkYiLCJmaWxsVHlwZTEiOiIjZmZmZmRlIiwiZmlsbFR5cGUyIjoiaHNsKDMwNCwgMTAwJSwgOTYuMjc0NTA5ODAzOSUpIiwiZmlsbFR5cGUzIjoiaHNsKDEyNCwgMTAwJSwgOTMuNTI5NDExNzY0NyUpIiwiZmlsbFR5cGU0IjoiaHNsKDE3NiwgMTAwJSwgOTYuMjc0NTA5ODAzOSUpIiwiZmlsbFR5cGU1IjoiaHNsKC00LCAxMDAlLCA5My41Mjk0MTE3NjQ3JSkiLCJmaWxsVHlwZTYiOiJoc2woOCwgMTAwJSwgOTYuMjc0NTA5ODAzOSUpIiwiZmlsbFR5cGU3IjoiaHNsKDE4OCwgMTAwJSwgOTMuNTI5NDExNzY0NyUpIn19LCJ1cGRhdGVFZGl0b3IiOmZhbHNlfQ">&lt;img src="https://mermaid.ink/img/eyJjb2RlIjoiZ3JhcGggVERcbiAgQVtEb2VzIHlvdXIgbGFuZ3VhZ2UgZm9ybWFsaXNlIHRoZXNlIHBhdHRlcm5zP11cbiAgQyhbVGhlIGNvbXBpbGVyIGtlZXBzIHlvdSByaWdodCBmYTpmYS10aHVtYnMtdXBdKVxuICBCW0FyZSB5b3UgYXdhcmUgeW91J3JlIHdyaXRpbmcgdGhlbSBieSBoYW5kP11cbiAgRChbWW91J2xsIHdyaXRlIG1vcmUgY29uc2lzdGVudCwgY29ycmVjdCwgYW5kIG1haW50aW5hYmxlIGNvZGUgZmE6ZmEtdGh1bWJzLXVwXSlcbiAgRShbQnVncyB3aWxsIGhhcHBlbiBmYTpmYS1idWddKVxuICBBIC0tPnxZZXN8IENcbiAgQSAtLT58Tm98IEJcbiAgQiAtLT58WWVzfCBEXG4gIEIgLS0-IHxOb3wgRVxuXHRcdCIsIm1lcm1haWQiOnsidGhlbWUiOiJkZWZhdWx0IiwidGhlbWVWYXJpYWJsZXMiOnsiYmFja2dyb3VuZCI6IndoaXRlIiwicHJpbWFyeUNvbG9yIjoiI0VDRUNGRiIsInNlY29uZGFyeUNvbG9yIjoiI2ZmZmZkZSIsInRlcnRpYXJ5Q29sb3IiOiJoc2woODAsIDEwMCUsIDk2LjI3NDUwOTgwMzklKSIsInByaW1hcnlCb3JkZXJDb2xvciI6ImhzbCgyNDAsIDYwJSwgODYuMjc0NTA5ODAzOSUpIiwic2Vjb25kYXJ5Qm9yZGVyQ29sb3IiOiJoc2woNjAsIDYwJSwgODMuNTI5NDExNzY0NyUpIiwidGVydGlhcnlCb3JkZXJDb2xvciI6ImhzbCg4MCwgNjAlLCA4Ni4yNzQ1MDk4MDM5JSkiLCJwcmltYXJ5VGV4dENvbG9yIjoiIzEzMTMwMCIsInNlY29uZGFyeVRleHRDb2xvciI6IiMwMDAwMjEiLCJ0ZXJ0aWFyeVRleHRDb2xvciI6InJnYig5LjUwMDAwMDAwMDEsIDkuNTAwMDAwMDAwMSwgOS41MDAwMDAwMDAxKSIsImxpbmVDb2xvciI6IiMzMzMzMzMiLCJ0ZXh0Q29sb3IiOiIjMzMzIiwibWFpbkJrZyI6IiNFQ0VDRkYiLCJzZWNvbmRCa2ciOiIjZmZmZmRlIiwiYm9yZGVyMSI6IiM5MzcwREIiLCJib3JkZXIyIjoiI2FhYWEzMyIsImFycm93aGVhZENvbG9yIjoiIzMzMzMzMyIsImZvbnRGYW1pbHkiOiJcInRyZWJ1Y2hldCBtc1wiLCB2ZXJkYW5hLCBhcmlhbCIsImZvbnRTaXplIjoiMTZweCIsImxhYmVsQmFja2dyb3VuZCI6IiNlOGU4ZTgiLCJub2RlQmtnIjoiI0VDRUNGRiIsIm5vZGVCb3JkZXIiOiIjOTM3MERCIiwiY2x1c3RlckJrZyI6IiNmZmZmZGUiLCJjbHVzdGVyQm9yZGVyIjoiI2FhYWEzMyIsImRlZmF1bHRMaW5rQ29sb3IiOiIjMzMzMzMzIiwidGl0bGVDb2xvciI6IiMzMzMiLCJlZGdlTGFiZWxCYWNrZ3JvdW5kIjoiI2U4ZThlOCIsImFjdG9yQm9yZGVyIjoiaHNsKDI1OS42MjYxNjgyMjQzLCA1OS43NzY1MzYzMTI4JSwgODcuOTAxOTYwNzg0MyUpIiwiYWN0b3JCa2ciOiIjRUNFQ0ZGIiwiYWN0b3JUZXh0Q29sb3IiOiJibGFjayIsImFjdG9yTGluZUNvbG9yIjoiZ3JleSIsInNpZ25hbENvbG9yIjoiIzMzMyIsInNpZ25hbFRleHRDb2xvciI6IiMzMzMiLCJsYWJlbEJveEJrZ0NvbG9yIjoiI0VDRUNGRiIsImxhYmVsQm94Qm9yZGVyQ29sb3IiOiJoc2woMjU5LjYyNjE2ODIyNDMsIDU5Ljc3NjUzNjMxMjglLCA4Ny45MDE5NjA3ODQzJSkiLCJsYWJlbFRleHRDb2xvciI6ImJsYWNrIiwibG9vcFRleHRDb2xvciI6ImJsYWNrIiwibm90ZUJvcmRlckNvbG9yIjoiI2FhYWEzMyIsIm5vdGVCa2dDb2xvciI6IiNmZmY1YWQiLCJub3RlVGV4dENvbG9yIjoiYmxhY2siLCJhY3RpdmF0aW9uQm9yZGVyQ29sb3IiOiIjNjY2IiwiYWN0aXZhdGlvbkJrZ0NvbG9yIjoiI2Y0ZjRmNCIsInNlcXVlbmNlTnVtYmVyQ29sb3IiOiJ3aGl0ZSIsInNlY3Rpb25Ca2dDb2xvciI6InJnYmEoMTAyLCAxMDIsIDI1NSwgMC40OSkiLCJhbHRTZWN0aW9uQmtnQ29sb3IiOiJ3aGl0ZSIsInNlY3Rpb25Ca2dDb2xvcjIiOiIjZmZmNDAwIiwidGFza0JvcmRlckNvbG9yIjoiIzUzNGZiYyIsInRhc2tCa2dDb2xvciI6IiM4YTkwZGQiLCJ0YXNrVGV4dExpZ2h0Q29sb3IiOiJ3aGl0ZSIsInRhc2tUZXh0Q29sb3IiOiJ3aGl0ZSIsInRhc2tUZXh0RGFya0NvbG9yIjoiYmxhY2siLCJ0YXNrVGV4dE91dHNpZGVDb2xvciI6ImJsYWNrIiwidGFza1RleHRDbGlja2FibGVDb2xvciI6IiMwMDMxNjMiLCJhY3RpdmVUYXNrQm9yZGVyQ29sb3IiOiIjNTM0ZmJjIiwiYWN0aXZlVGFza0JrZ0NvbG9yIjoiI2JmYzdmZiIsImdyaWRDb2xvciI6ImxpZ2h0Z3JleSIsImRvbmVUYXNrQmtnQ29sb3IiOiJsaWdodGdyZXkiLCJkb25lVGFza0JvcmRlckNvbG9yIjoiZ3JleSIsImNyaXRCb3JkZXJDb2xvciI6IiNmZjg4ODgiLCJjcml0QmtnQ29sb3IiOiJyZWQiLCJ0b2RheUxpbmVDb2xvciI6InJlZCIsImxhYmVsQ29sb3IiOiJibGFjayIsImVycm9yQmtnQ29sb3IiOiIjNTUyMjIyIiwiZXJyb3JUZXh0Q29sb3IiOiIjNTUyMjIyIiwiY2xhc3NUZXh0IjoiIzEzMTMwMCIsImZpbGxUeXBlMCI6IiNFQ0VDRkYiLCJmaWxsVHlwZTEiOiIjZmZmZmRlIiwiZmlsbFR5cGUyIjoiaHNsKDMwNCwgMTAwJSwgOTYuMjc0NTA5ODAzOSUpIiwiZmlsbFR5cGUzIjoiaHNsKDEyNCwgMTAwJSwgOTMuNTI5NDExNzY0NyUpIiwiZmlsbFR5cGU0IjoiaHNsKDE3NiwgMTAwJSwgOTYuMjc0NTA5ODAzOSUpIiwiZmlsbFR5cGU1IjoiaHNsKC00LCAxMDAlLCA5My41Mjk0MTE3NjQ3JSkiLCJmaWxsVHlwZTYiOiJoc2woOCwgMTAwJSwgOTYuMjc0NTA5ODAzOSUpIiwiZmlsbFR5cGU3IjoiaHNsKDE4OCwgMTAwJSwgOTMuNTI5NDExNzY0NyUpIn19LCJ1cGRhdGVFZGl0b3IiOmZhbHNlfQ" alt="">&lt;/a>&lt;/p>
&lt;p>When I first learned some Haskell a few years ago, the idea of spending my free
time doing that was sold to me as &amp;ldquo;it&amp;rsquo;ll make you better at every other
language&amp;rdquo;. That was enough to sell it to me at the time, and I believe it had
that effect. It&amp;rsquo;s true of every language to some extent. Every language
formalises some number of data manipulation patterns, the question is: to what
extent? And are they good patterns to be using to get correct and maintainable
code?&lt;/p>
&lt;p>There is the argument I&amp;rsquo;ve seen where someone might answer &amp;ldquo;No&amp;rdquo; to both of the
above, adding &amp;ldquo;and it doesn&amp;rsquo;t matter&amp;rdquo;. I&amp;rsquo;ve seen claims that learning the
concepts that formalise patterns of data manipulation is overly esoteric and
not pragmatic. To try to understand these things makes you a &amp;ldquo;purist&amp;rdquo;, and
gets in the way of &amp;ldquo;getting things done&amp;rdquo;. I think the reality is that
software, in general, has had growth as a higher priority than quality and
correctness for some amount of time. A lot of code can have quite a short shelf
life so preference is given to being able to produce code quickly and the
negative side effects of that aren&amp;rsquo;t felt so much. I&amp;rsquo;m not totally convinced by
this position. There&amp;rsquo;s potential for a feedback loop where the consequences of
trying to produce things quickly drive the short shelf lives. And I&amp;rsquo;m not
entirely convinced that languages that do formalize a lot of these patterns and
have a compiler that keeps you right on them is generally slower to produce
things. There&amp;rsquo;s learning time that you have to put in, but once you&amp;rsquo;ve learned
to satiate the compiler on your first try, you don&amp;rsquo;t tend to spend that much
time fighting it. There are specific problems that are going to be slower to
develop solutions to, but I don&amp;rsquo;t thing it&amp;rsquo;s necessarily true generally. There
a counter argument that to produce anything of a meaningful size you can
produce things faster because the compiler has stopped you hitting things that
you would hit and have to address before you were able to ship something. This
one probably depends on the problem you&amp;rsquo;re trying to build a solution to.&lt;/p>
&lt;p>Regardless of the relative strengths of those arguments, it&amp;rsquo;s certainly true
that developers have been able to &amp;ldquo;get away with&amp;rdquo; not having these patterns
formalised and not necessarily knowing they&amp;rsquo;re hand rolling them. Whether that
continues into the future is going to be interesting.&lt;/p>
&lt;p>As software becomes more prevalent in all industries, every professional is
writing code, and every child learns coding in school (which they already are):
I&amp;rsquo;d wager we&amp;rsquo;ll see the general quality bar expected by users/consumers to go
up, as they&amp;rsquo;ll have greater visibility into how unnecessary a lot of broken and
slow software is. As the systems we&amp;rsquo;re building are getting more interconnected
and complex, is correctness going to become more of a priority?&lt;/p>
&lt;p>This isn&amp;rsquo;t to say that there won&amp;rsquo;t always be bugs in software. No matter how
solid the tools you use are, you could have just missed the mark on
requirements and built the wrong thing. But there are whole classes of bugs
and errors that can be eliminated by formalising these patterns and encoding
them into the fundamental tools with which we build things.&lt;/p>
&lt;p>I work with Rust most working days. While it&amp;rsquo;s missing higher kinded types,
it&amp;rsquo;s got a lot going for it with its strong type system, its ownership model,
and generally how it makes you be explicit about what you&amp;rsquo;re doing. People say
with Rust that &amp;ldquo;if it compiles it works&amp;rdquo;, and provided you&amp;rsquo;ve written code that
leverages the type system, there&amp;rsquo;s some truth to that. I might re-phrase that
to &amp;ldquo;if it compiles then what you&amp;rsquo;ve asked for is guaranteed to be consistent in
various ways, but you might still have asked for the wrong thing&amp;rdquo;, but that&amp;rsquo;s a
little less catchy. It makes me hopeful for the future, and I believe that Rust
will stand as one of the cornerstones of a new generation of software that
works.&lt;/p></description></item><item><title>Re-Learning Haskell with Advent of Code - Part 2</title><link>https://tarquin-the-brave.github.io/blog/posts/re-learning-haskell-2/</link><pubDate>Wed, 29 Apr 2020 20:36:28 +0100</pubDate><guid>https://tarquin-the-brave.github.io/blog/posts/re-learning-haskell-2/</guid><description>&lt;p>&lt;em>In &lt;a href="https://tarquin-the-brave.github.io/blog/posts/re-learning-haskell/">Part 1&lt;/a>, I skipped the day 2, 5, &amp;amp; 7 problems that get you to build
and use a Intcode computer. Each problem provides an Intcode program to run: A
series of integers that can each either represent an instruction or data, and
can mutate itself. Looking forward, every odd number day from day 5 onwards
uses the Intcode program. So I decided to come back to them, and make a
concerted effort at a few of them in a row.&lt;/em>&lt;/p>
&lt;h1 id="intcode-computer---stateful-computation">Intcode computer - Stateful Computation&lt;/h1>
&lt;h2 id="an-intcode-program">An Intcode Program&lt;/h2>
&lt;p>&lt;a href="https://adventofcode.com/2019/day/2">Day 2&lt;/a> introduces an intcode program that&amp;rsquo;s essentially a series of
integers where you start at the beginning and perform some operation depending
on the integer (instruction) you find which may read or write another element
in the list, take an input, or produce an output, and you then move along the
sequence to the next instruction, which is a number of elements along depending
on the instruction you just ran. Eventually you reach an instruction to
terminate the intcode program, or the program crashes from some operation failing,
finding an unrecognised instruction, or reaching the end without terminating.
The explanation in &lt;a href="https://adventofcode.com/2019/day/2">the problem description&lt;/a> goes into more detail with
examples.&lt;/p>
&lt;p>It looks like the general problem here is we&amp;rsquo;ve got some state that mutates
during computation (a run of the program) and we may need to keep the current
state around while we do some other calculation (calculating the next input
of the program).&lt;/p>
&lt;p>With mutation not really being a feature in functional languages I looked
around for how this can be modelled in Haskell. From the looks of it, it
sounded like the &lt;a href="https://wiki.haskell.org/State_Monad">State Monad&lt;/a> would be needed at some point.&lt;/p>
&lt;h3 id="initial-implementation">Initial Implementation&lt;/h3>
&lt;p>The &lt;a href="https://adventofcode.com/2019/day/2">day 2 problem&lt;/a> asks you to build something that will run a simple
intcode program with instructions &lt;code>1&lt;/code> &amp;amp; &lt;code>2&lt;/code> that each take the next three
integers as parameters and mutate an element of the intcode, and &lt;code>99&lt;/code> that
terminates the program. The problem asks you to run the intcode it gives &amp;lsquo;til
it terminates and give the first value in the intcode.&lt;/p>
&lt;p>For this simple case, we&amp;rsquo;re not concerned about inputs or outputs of the
intcode program and we can run in once and throw it away.&lt;/p>
&lt;p>Roughly following the approach I used in the problems tackled in &lt;a href="https://tarquin-the-brave.github.io/blog/posts/re-learning-haskell/">Part 1&lt;/a>,
I started by thinking about what data matters.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#66d9ef">data&lt;/span> &lt;span style="color:#66d9ef">Program&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">Program&lt;/span> {
intCode&lt;span style="color:#f92672">::&lt;/span>[&lt;span style="color:#66d9ef">Int&lt;/span>],
status&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#66d9ef">Status&lt;/span>,
&lt;span style="color:#75715e">-- Instruction Pointer: ip&lt;/span>
ip&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#66d9ef">Int&lt;/span>
} &lt;span style="color:#66d9ef">deriving&lt;/span>(&lt;span style="color:#66d9ef">Show&lt;/span>)
&lt;span style="color:#66d9ef">data&lt;/span> &lt;span style="color:#66d9ef">Status&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">Running&lt;/span> &lt;span style="color:#f92672">|&lt;/span> &lt;span style="color:#66d9ef">Terminated&lt;/span> &lt;span style="color:#f92672">|&lt;/span> &lt;span style="color:#66d9ef">Crashed&lt;/span> &lt;span style="color:#66d9ef">deriving&lt;/span>(&lt;span style="color:#66d9ef">Show&lt;/span>)
&lt;/code>&lt;/pre>&lt;/div>&lt;p>So we&amp;rsquo;ve got: the index that the current instruction is at, &lt;code>ip&lt;/code>; the status of
the program, whether it&amp;rsquo;s &lt;code>Running&lt;/code>, &lt;code>Terminated&lt;/code> (by a &lt;code>99&lt;/code>), or &lt;code>Crashed&lt;/code> for
some reason; and the &lt;code>intCode&lt;/code> itself.&lt;/p>
&lt;p>I could have done less than this on a first pass, only modelling the &lt;code>intCode&lt;/code>
and &lt;code>ip&lt;/code>, and letting the code crash if an operation failed, but I was keen
write safe code by using safe operations, such as those from
&lt;a href="http://hackage.haskell.org/package/listsafe-0.1.0.1/docs/Data-List-Safe.html">&lt;code>Data.List.Safe&lt;/code>&lt;/a> handling errors, hence the &lt;code>Crashed&lt;/code> variant of
&lt;code>Status&lt;/code>.&lt;/p>
&lt;p>I&amp;rsquo;ve modelled the intcode as a list, &lt;code>[Int]&lt;/code>. lists aren&amp;rsquo;t efficient for
looking up values by index, which is done a lot in the solution, but for now,
I&amp;rsquo;m not hugely worried about performance at this stage. If it becomes an issue
in later problems, I can look into alternative representations. If not, I&amp;rsquo;ll
cycle back through at some point and try to optimise performance as an
exercise.&lt;/p>
&lt;p>From here I was able to write a function that takes the above state and evolves
it by one instruction, and running an entire intcode program by recursing until
the status is no longer &lt;code>Running&lt;/code>.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#a6e22e">runProgram&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">Program&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Program&lt;/span>
&lt;span style="color:#a6e22e">runProgram&lt;/span> prog &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">case&lt;/span> status prog &lt;span style="color:#66d9ef">of&lt;/span>
&lt;span style="color:#66d9ef">Running&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> runProgram &lt;span style="color:#f92672">.&lt;/span> runStep &lt;span style="color:#f92672">$&lt;/span> prog
&lt;span style="color:#66d9ef">_&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> prog
&lt;span style="color:#a6e22e">runStep&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">Program&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Program&lt;/span>
&lt;span style="color:#a6e22e">runStep&lt;/span> prog &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">...&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>runStep&lt;/code> matches the instruction found at the instruction pointer index in the
intcode and runs the appropriate operation to produce a new &lt;code>Program&lt;/code>, with a
mutated intcode and the instruction pointer moved along.&lt;/p>
&lt;h3 id="introducing-the-state-monad">Introducing the State Monad&lt;/h3>
&lt;p>The above recursive function proved to be enough to get the answers to both
parts of &lt;a href="https://adventofcode.com/2019/day/2">day 2&lt;/a>. As I didn&amp;rsquo;t need to keep track of the program state,
the State Monad wasn&amp;rsquo;t needed.&lt;/p>
&lt;p>Anticipating I&amp;rsquo;d need it later, I tried wrapping the computation in the State
Monad to see how it works.&lt;/p>
&lt;p>From reading the &lt;a href="https://hackage.haskell.org/package/mtl-2.2.2/docs/Control-Monad-State-Lazy.html">State Monad docs&lt;/a>, and with some help for the
&lt;a href="http://learnyouahaskell.com/for-a-few-monads-more#state">chapter in Learn You a Haskell&lt;/a>, I&amp;rsquo;ve understood it as: you have
your state, &lt;code>s&lt;/code>; the output of a computation on that state, &lt;code>a&lt;/code>; and a function
that takes the state and returns the output and the state evolved, &lt;code>s -&amp;gt; (a, s)&lt;/code>. You then use &lt;code>state&lt;/code> to put the function into the State Monad, denoted
&lt;code>State s a&lt;/code>. Then it can be manipulated with functions &lt;a href="https://hackage.haskell.org/package/mtl-2.2.2/docs/Control-Monad-State-Lazy.html">that act upon the State
Monad&lt;/a>, and inside &lt;code>do&lt;/code> notation.&lt;/p>
&lt;p>In this case the state type, &lt;code>s&lt;/code>, is &lt;code>Program&lt;/code>, and the output type, &lt;code>a&lt;/code>, is
&lt;code>()&lt;/code>, as we&amp;rsquo;re not concerned about the output.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#a6e22e">runProgram&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">State&lt;/span> &lt;span style="color:#66d9ef">Program&lt;/span> ()
&lt;span style="color:#a6e22e">runProgram&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">do&lt;/span>
prog &lt;span style="color:#f92672">&amp;lt;-&lt;/span> get
&lt;span style="color:#66d9ef">case&lt;/span> programState prog &lt;span style="color:#66d9ef">of&lt;/span>
&lt;span style="color:#66d9ef">Running&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">do&lt;/span>
runStep&amp;#39;
runProgram
&lt;span style="color:#66d9ef">_&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> return ()
&lt;span style="color:#a6e22e">runStep&amp;#39;&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">State&lt;/span> &lt;span style="color:#66d9ef">Program&lt;/span> ()
&lt;span style="color:#a6e22e">runStep&amp;#39;&lt;/span> &lt;span style="color:#f92672">=&lt;/span> state runStep
&lt;span style="color:#a6e22e">runStep&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">Program&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> ((), &lt;span style="color:#66d9ef">Program&lt;/span>)
&lt;span style="color:#a6e22e">runStep&lt;/span> prog
&lt;/code>&lt;/pre>&lt;/div>&lt;p>I was then able to create a &lt;code>Program&lt;/code> with the intcode provided, pass it to
&lt;code>runProgram&lt;/code> and use &lt;a href="https://hackage.haskell.org/package/mtl-2.2.2/docs/Control-Monad-State-Lazy.html">&lt;code>execState&lt;/code>&lt;/a> to get the final &lt;code>Program&lt;/code> state.&lt;/p>
&lt;p>The fact that I&amp;rsquo;ve used &lt;code>()&lt;/code> for the output type is a sign that the State Monad
was not required here, a function of &lt;code>s -&amp;gt; s&lt;/code> would suffice, but it was good
to do as an exercise.&lt;/p>
&lt;h3 id="expanding-the-intcode-computer">Expanding the Intcode Computer&lt;/h3>
&lt;p>Over days &lt;a href="https://adventofcode.com/2019/day/5">5&lt;/a>, &lt;a href="https://adventofcode.com/2019/day/7">7&lt;/a>, &amp;amp; &lt;a href="https://adventofcode.com/2019/day/9">9&lt;/a> you&amp;rsquo;re asked to build up the
intcode computer with a host of new instructions and the ability to take inputs
and give outputs.&lt;/p>
&lt;p>Now there was a potential opportunity to use the State Monad in the intcode
computer, changing the output type and having the functions that return the
State Monad take a parameter. E.g. if our input and output were both &lt;code>Int&lt;/code> we
might have:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#a6e22e">runProgram&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">Int&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">State&lt;/span> &lt;span style="color:#66d9ef">Program&lt;/span> &lt;span style="color:#66d9ef">Int&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>In the case of these problems we need:&lt;/p>
&lt;ul>
&lt;li>A list of inputs, &lt;code>[Int]&lt;/code>,&lt;/li>
&lt;li>A list of outputs, &lt;code>[Int]&lt;/code>,&lt;/li>
&lt;li>Inputs are called one by one, not necessarily by the first instruction in the
program,&lt;/li>
&lt;li>Outputs build up over the course of the program running.&lt;/li>
&lt;/ul>
&lt;p>As the program runs each instruction, we want to keep track of the remaining
inputs and the outputs thus far. So I decided to include input and output in
the &lt;code>Program&lt;/code> type, and not use my State Monad implementation.&lt;/p>
&lt;p>Including these in the type that tracks the state, along with a &amp;ldquo;Relative Base&amp;rdquo;
which the Instruction Pointer is taken as being relative to, we get:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#66d9ef">data&lt;/span> &lt;span style="color:#66d9ef">Program&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">Program&lt;/span> {
input&lt;span style="color:#f92672">::&lt;/span>[&lt;span style="color:#66d9ef">Int&lt;/span>],
intCode&lt;span style="color:#f92672">::&lt;/span>[&lt;span style="color:#66d9ef">Int&lt;/span>],
status&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#66d9ef">Status&lt;/span>,
&lt;span style="color:#75715e">-- ip: Instruction Pointer&lt;/span>
ip&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#66d9ef">Int&lt;/span>,
&lt;span style="color:#75715e">-- rb: Relative Base&lt;/span>
rb&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#66d9ef">Int&lt;/span>,
output&lt;span style="color:#f92672">::&lt;/span>[&lt;span style="color:#66d9ef">Int&lt;/span>]
} &lt;span style="color:#66d9ef">deriving&lt;/span>(&lt;span style="color:#66d9ef">Show&lt;/span>, &lt;span style="color:#66d9ef">Eq&lt;/span>)
&lt;span style="color:#66d9ef">data&lt;/span> &lt;span style="color:#66d9ef">Status&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">Running&lt;/span> &lt;span style="color:#f92672">|&lt;/span> &lt;span style="color:#66d9ef">AwaitInput&lt;/span> &lt;span style="color:#f92672">|&lt;/span> &lt;span style="color:#66d9ef">Terminated&lt;/span> &lt;span style="color:#f92672">|&lt;/span> &lt;span style="color:#66d9ef">Crashed&lt;/span> &lt;span style="color:#66d9ef">deriving&lt;/span>(&lt;span style="color:#66d9ef">Show&lt;/span>, &lt;span style="color:#66d9ef">Eq&lt;/span>)
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>runProgram&lt;/code> mostly stayed the same, with the case statement adding a match
for the &lt;code>AwaitInput&lt;/code> variant of &lt;code>Status&lt;/code>.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#a6e22e">runProgram&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">Program&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Program&lt;/span>
&lt;span style="color:#a6e22e">runProgram&lt;/span> prog &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">case&lt;/span> status prog &lt;span style="color:#66d9ef">of&lt;/span>
&lt;span style="color:#66d9ef">Running&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> runProg &lt;span style="color:#f92672">.&lt;/span> runStep &lt;span style="color:#f92672">$&lt;/span> prog
&lt;span style="color:#66d9ef">AwaitInput&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">if&lt;/span> (length &lt;span style="color:#f92672">.&lt;/span> input &lt;span style="color:#f92672">$&lt;/span> prog) &lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>
&lt;span style="color:#66d9ef">then&lt;/span> runProg &lt;span style="color:#f92672">.&lt;/span> runStep &lt;span style="color:#f92672">$&lt;/span> prog
&lt;span style="color:#66d9ef">else&lt;/span> prog
&lt;span style="color:#66d9ef">_&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> prog
&lt;span style="color:#a6e22e">runStep&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">Program&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Program&lt;/span>
&lt;span style="color:#a6e22e">runStep&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">...&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="adding-tests">Adding Tests&lt;/h3>
&lt;p>As every odd day from 5 onwards uses this intcode computer, I defined it in
it&amp;rsquo;s own module in a different directory and wrote some tests for it.&lt;/p>
&lt;p>Looking around I found all sorts of testing libraries with different goals:
&lt;a href="https://hackage.haskell.org/package/HUnit">hUnit&lt;/a> for unit testing, &lt;a href="https://hackage.haskell.org/package/smallcheck">SmallCheck&lt;/a> &amp;amp;
&lt;a href="http://hackage.haskell.org/package/QuickCheck">QuickCheck&lt;/a> for property based testing, to name a few. The
&lt;a href="https://hackage.haskell.org/package/tasty">tasty&lt;/a> library attempts to pull them all together so I went with that.&lt;/p>
&lt;p>Property based testing looks quite interesting and I plan to look into it. For
my intcode I added a bunch of &lt;code>assert F(X) == Y&lt;/code> style tests to ensure the
operations perform as expected in the mainline cases.&lt;/p>
&lt;p>With &lt;a href="https://hackage.haskell.org/package/tasty">tasty&lt;/a> you create a &amp;ldquo;test tree&amp;rdquo;. I added all the examples from
explanations of the intcode features from each of the days that introduces
them. The output looks quite good in the terminal.&lt;/p>
&lt;pre>&lt;code>$ stack test
...
intcode&amp;gt; test (suite: intcode-test)
Tests
Unit tests
Test progressing the program by one instruction
tests for op codes 1 &amp;amp; 2
Day 2 example 1 step 1: OK
Day 2 example 1 step 2: OK
Day 2 example 1 step 3 - finish: OK
Day 2 example 1 - try step finished prog: OK
Some testing of Opcodes 5 &amp;amp; 6
op code 6 - test 1: OK
test 203 op code
simple case: OK
Test runnning the program til it stops
Test examples from day 2 of AOC
Day 2 example 2 - (1 + 1 = 2): OK
Day 2 example 3 (3 * 2 = 6): OK
Day 2 example 4 (99 * 99 = 9801): OK
Day 2 example 5: OK
Test examples from day 5 of AOC
Day 5 example 1 - echo: OK
Day 5 example 2 - immediate mode: OK
Day 5 example 3 - input equal to 8? yes: OK
Day 5 example 3 - input equal to 8? no: OK
... (etc)
Test examples from day 9 of AOC
Day 9 example 1 - copy of self: OK
Day 9 example 2 - output 16 digit number: OK
... (etc)
All 33 tests passed (0.01s)
intcode&amp;gt; Test suite intcode-test passed
Completed 2 action(s).
&lt;/code>&lt;/pre>&lt;h2 id="using-the-intcode-computer">Using the Intcode Computer&lt;/h2>
&lt;p>&lt;a href="https://adventofcode.com/2019/day/7">Day 7&lt;/a> asks you to create a series of intcode computers, each running an
&amp;ldquo;amplifier program&amp;rdquo; provided, where the output of one becomes the input of the
next.&lt;/p>
&lt;p>The first part of the problem requires you to run these in series to get an
output at the end. &lt;em>Taking the ascii diagrams from the &lt;a href="https://adventofcode.com/2019/day/7">day 7&lt;/a> problem
description:&lt;/em>&lt;/p>
&lt;pre>&lt;code> O-------O O-------O O-------O O-------O O-------O
0 -&amp;gt;| Amp A |-&amp;gt;| Amp B |-&amp;gt;| Amp C |-&amp;gt;| Amp D |-&amp;gt;| Amp E |-&amp;gt; (to thrusters)
O-------O O-------O O-------O O-------O O-------O
&lt;/code>&lt;/pre>&lt;p>A simple fold over a list of intcodes sufficed here. I was happy for each
intcode state to be thrown away as the calculation moved to the next. No need
for the State Monad yet!&lt;/p>
&lt;p>The second half of the problem then asks you to run the intcode computers, the
&amp;ldquo;amplifiers&amp;rdquo;, in a loop, until they exit.&lt;/p>
&lt;pre>&lt;code> O-------O O-------O O-------O O-------O O-------O
0 -+-&amp;gt;| Amp A |-&amp;gt;| Amp B |-&amp;gt;| Amp C |-&amp;gt;| Amp D |-&amp;gt;| Amp E |-.
| O-------O O-------O O-------O O-------O O-------O |
| |
'--------------------------------------------------------+
|
v
(to thrusters)
&lt;/code>&lt;/pre>&lt;p>Now we care about keeping the intcode state around, and we have an output we
want to take from the stateful computation, we have a good reason to use the
State Monad.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#66d9ef">import&lt;/span> Intcode (
&lt;span style="color:#66d9ef">Status&lt;/span>,
&lt;span style="color:#66d9ef">Program&lt;/span>
)
&lt;span style="color:#66d9ef">data&lt;/span> &lt;span style="color:#66d9ef">Amps&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">Amps&lt;/span> {
ampsOf&lt;span style="color:#f92672">::&lt;/span>[&lt;span style="color:#66d9ef">Program&lt;/span>],
activeAmp&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#66d9ef">Int&lt;/span>
} &lt;span style="color:#66d9ef">deriving&lt;/span>(&lt;span style="color:#66d9ef">Show&lt;/span>)
&lt;span style="color:#a6e22e">runAmpsLoop&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">State&lt;/span> &lt;span style="color:#66d9ef">Amps&lt;/span> (&lt;span style="color:#66d9ef">Maybe&lt;/span> &lt;span style="color:#66d9ef">Int&lt;/span>)
&lt;span style="color:#a6e22e">runAmpsLoop&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">do&lt;/span>
out &lt;span style="color:#f92672">&amp;lt;-&lt;/span> runActiveAmpOutput&amp;#39;
amps &lt;span style="color:#f92672">&amp;lt;-&lt;/span> get
&lt;span style="color:#66d9ef">case&lt;/span> (atFinalAmp amps, activeAmpStatus amps) &lt;span style="color:#66d9ef">of&lt;/span>
(&lt;span style="color:#66d9ef">_&lt;/span>, &lt;span style="color:#66d9ef">Crashed&lt;/span>) &lt;span style="color:#f92672">-&amp;gt;&lt;/span> return &lt;span style="color:#66d9ef">Nothing&lt;/span>
(&lt;span style="color:#66d9ef">_&lt;/span>, &lt;span style="color:#66d9ef">Running&lt;/span>) &lt;span style="color:#f92672">-&amp;gt;&lt;/span> return &lt;span style="color:#66d9ef">Nothing&lt;/span>
(&lt;span style="color:#66d9ef">True&lt;/span>, &lt;span style="color:#66d9ef">Terminated&lt;/span>) &lt;span style="color:#f92672">-&amp;gt;&lt;/span> return (&lt;span style="color:#66d9ef">Just&lt;/span> out)
(&lt;span style="color:#66d9ef">False&lt;/span>, &lt;span style="color:#66d9ef">Terminated&lt;/span>) &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">do&lt;/span>
modify nextAmp
modify (activeAmpAppendInput out)
runAmpsLoop
(&lt;span style="color:#66d9ef">_&lt;/span>, &lt;span style="color:#66d9ef">AwaitInput&lt;/span>) &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">do&lt;/span>
modify nextAmp
modify (activeAmpAppendInput out)
runAmpsLoop
&lt;span style="color:#75715e">--&lt;/span>
&lt;span style="color:#75715e">-- The types of the functions called above,&lt;/span>
&lt;span style="color:#75715e">-- in order of appearence.&lt;/span>
&lt;span style="color:#75715e">--&lt;/span>
&lt;span style="color:#a6e22e">runActiveAmpOutput&amp;#39;&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">State&lt;/span> &lt;span style="color:#66d9ef">Amps&lt;/span> &lt;span style="color:#66d9ef">Int&lt;/span>
&lt;span style="color:#a6e22e">runActiveAmpOutput&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">Amps&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> (&lt;span style="color:#66d9ef">Int&lt;/span>, &lt;span style="color:#66d9ef">Amps&lt;/span>)
&lt;span style="color:#a6e22e">atFinalAmp&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">Amps&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Bool&lt;/span>
&lt;span style="color:#a6e22e">activeAmpStatus&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">Amps&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">ProgState&lt;/span>
&lt;span style="color:#a6e22e">nextAmp&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">Amps&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Amps&lt;/span>
&lt;span style="color:#a6e22e">activeAmpAppendInput&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">Int&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Amps&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Amps&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Following the same pattern applied when I tried wrapping the intcode in a State
Monad &lt;a href="#introducing-the-state-monad">above&lt;/a>:&lt;/p>
&lt;ul>
&lt;li>&lt;code>runActiveAmpOutput&lt;/code> evolves the state and provides an output, our &lt;code>s -&amp;gt; (a, s)&lt;/code>;&lt;/li>
&lt;li>&lt;code>runActiveAmpOutput'&lt;/code> wraps that in the State Monad with &lt;code>state&lt;/code>; and&lt;/li>
&lt;li>&lt;code>runAmpsLoop&lt;/code>:
&lt;ul>
&lt;li>runs the current amplifier (intcode program),&lt;/li>
&lt;li>gets the new overall state with &lt;code>get&lt;/code>, and&lt;/li>
&lt;li>only if we&amp;rsquo;ve just run the final amplifier in the loop, and it has &lt;code>Terminated&lt;/code>,
return the output.&lt;/li>
&lt;li>Otherwise, if we haven&amp;rsquo;t crashed, use &lt;code>modify&lt;/code> to edit the overall state by
moving to the next amplifier in the loop, &lt;code>nextAmp&lt;/code>, and passing the output
from the last amplifier to new one, &lt;code>activeAmpAppendInput&lt;/code>.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>I also defined a function &lt;code>newAmps&lt;/code> which, given an intcode program and a list
of &amp;ldquo;phases&amp;rdquo; (tuning parameters for the amplifiers), produces the initial &lt;code>Amps&lt;/code>
state.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#a6e22e">newAmps&lt;/span> &lt;span style="color:#f92672">::&lt;/span> [&lt;span style="color:#66d9ef">Int&lt;/span>] &lt;span style="color:#f92672">-&amp;gt;&lt;/span> [&lt;span style="color:#66d9ef">Int&lt;/span>] &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Amps&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>I could then find the output of running the amplifiers in a loop with the
expression:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#a6e22e">evalState&lt;/span> runAmpsLoop &lt;span style="color:#f92672">$&lt;/span> newAmps intCode phases
&lt;/code>&lt;/pre>&lt;/div>&lt;p>The problem itself asks you to find the combination of phases that gives the
greatest output once the amplifier loop has ran its course. This could be
found by selecting the permutation of phases that the above expression evaluates
to the greatest value.&lt;/p>
&lt;h2 id="introducing-monad-transformers">Introducing Monad Transformers&lt;/h2>
&lt;p>&lt;a href="https://adventofcode.com/2019/day/13">Day 13&lt;/a> has a fun problem. You&amp;rsquo;re given an intcode program that outputs
the data (triplets of: x coordinate, y coordinate, and a &amp;ldquo;tile id&amp;rdquo; that determines
which character exists at that position) for the display of a game where you
destroy all the bricks with a ball that you keep in play with a paddle you move
side to side.&lt;/p>
&lt;p>You&amp;rsquo;re asked to write a program that will finish the game by destroying all the
bricks.&lt;/p>
&lt;p>I had a solution that would start with a state like this:&lt;/p>
&lt;pre>&lt;code>&amp;quot;Z|||||||||||||||||||||||||||||||||||||||||||&amp;quot;
&amp;quot; | # # ## #### ## # #### ##### ##### |&amp;quot;
&amp;quot; | #### # # # # ## # # ## # |&amp;quot;
&amp;quot; | # ## ## # ## ## ### ###### # ##### # |&amp;quot;
&amp;quot; | # # ## #### ##### # ###### ###### |&amp;quot;
&amp;quot; | ## ##### # # # ## # # ### ## ### ## # |&amp;quot;
&amp;quot; | #### ## # # ## # # ## # ###### # |&amp;quot;
&amp;quot; | ## ####### #### # ## # # ## # #### |&amp;quot;
&amp;quot; | # # ## #### ## # #### ##### ##### |&amp;quot;
&amp;quot; | # ##### # ## ### #### # #### # |&amp;quot;
&amp;quot; | ## # # # # # # ## # # # ### |&amp;quot;
&amp;quot; | ## ## # # # ## # ## ### ## #### |&amp;quot;
&amp;quot; | ### ###### ## ## ## ### ## |&amp;quot;
&amp;quot; | # ## ## ## ## ### # ## ## |&amp;quot;
&amp;quot; | ## ## # # ### # ## # ## ### # ## |&amp;quot;
&amp;quot; | |&amp;quot;
&amp;quot; | |&amp;quot;
&amp;quot; | o |&amp;quot;
&amp;quot; | |&amp;quot;
&amp;quot; | = |&amp;quot;
&amp;quot; | |&amp;quot;
&lt;/code>&lt;/pre>&lt;p>and would whirr away for a short while until it was finished and my &lt;code>main&lt;/code>
could print the game state:&lt;/p>
&lt;pre>&lt;code>&amp;quot;Z|||||||||||||||||||||||||||||||||||||||||||&amp;quot;
&amp;quot; | |&amp;quot;
&amp;quot; | |&amp;quot;
&amp;quot; | o |&amp;quot;
&amp;quot; | |&amp;quot;
&amp;quot; | |&amp;quot;
&amp;quot; | |&amp;quot;
&amp;quot; | |&amp;quot;
&amp;quot; | |&amp;quot;
&amp;quot; | |&amp;quot;
&amp;quot; | |&amp;quot;
&amp;quot; | |&amp;quot;
&amp;quot; | |&amp;quot;
&amp;quot; | |&amp;quot;
&amp;quot; | |&amp;quot;
&amp;quot; | |&amp;quot;
&amp;quot; | |&amp;quot;
&amp;quot; | |&amp;quot;
&amp;quot; | |&amp;quot;
&amp;quot; | = |&amp;quot;
&amp;quot; | |&amp;quot;
&amp;quot;your score: 13581&amp;quot;
&lt;/code>&lt;/pre>&lt;p>To achieve this I followed the same pattern as I did &lt;a href="#using-the-intcode-computer">in the day 7
solution&lt;/a> we saw in the last section:&lt;/p>
&lt;ul>
&lt;li>Define the state,&lt;/li>
&lt;li>Wrap that in the State Monad, and&lt;/li>
&lt;li>Define a recursive function to keep running the intcode
computer and evolving the state until done.&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#66d9ef">import&lt;/span> &lt;span style="color:#66d9ef">qualified&lt;/span> Intcode &lt;span style="color:#66d9ef">as&lt;/span> IC
&lt;span style="color:#66d9ef">import&lt;/span> &lt;span style="color:#66d9ef">qualified&lt;/span> Data.HashMap.Strict &lt;span style="color:#66d9ef">as&lt;/span> HM
&lt;span style="color:#66d9ef">data&lt;/span> &lt;span style="color:#66d9ef">Game&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">Game&lt;/span> {
gameProg &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">IC&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#66d9ef">Program&lt;/span>,
gameDisplay &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">Displ&lt;/span>
} &lt;span style="color:#66d9ef">deriving&lt;/span>(&lt;span style="color:#66d9ef">Show&lt;/span>)
&lt;span style="color:#66d9ef">type&lt;/span> &lt;span style="color:#66d9ef">Displ&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">HM&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#66d9ef">HashMap&lt;/span> &lt;span style="color:#66d9ef">Tile&lt;/span> &lt;span style="color:#66d9ef">Tid&lt;/span>
&lt;span style="color:#66d9ef">type&lt;/span> &lt;span style="color:#66d9ef">Tile&lt;/span> &lt;span style="color:#f92672">=&lt;/span> (&lt;span style="color:#66d9ef">Int&lt;/span>, &lt;span style="color:#66d9ef">Int&lt;/span>)
&lt;span style="color:#66d9ef">data&lt;/span> &lt;span style="color:#66d9ef">Tid&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">Empty&lt;/span> &lt;span style="color:#f92672">|&lt;/span> &lt;span style="color:#66d9ef">Wall&lt;/span> &lt;span style="color:#f92672">|&lt;/span> &lt;span style="color:#66d9ef">Block&lt;/span> &lt;span style="color:#f92672">|&lt;/span> &lt;span style="color:#66d9ef">Paddle&lt;/span> &lt;span style="color:#f92672">|&lt;/span> &lt;span style="color:#66d9ef">Ball&lt;/span> &lt;span style="color:#f92672">|&lt;/span> &lt;span style="color:#66d9ef">BadTid&lt;/span> &lt;span style="color:#f92672">|&lt;/span> &lt;span style="color:#66d9ef">Score&lt;/span>{theScore&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#66d9ef">Int&lt;/span>} &lt;span style="color:#66d9ef">deriving&lt;/span>(&lt;span style="color:#66d9ef">Show&lt;/span>, &lt;span style="color:#66d9ef">Eq&lt;/span>)
&lt;/code>&lt;/pre>&lt;/div>&lt;p>This time &lt;code>Game&lt;/code> is the state, containing an intcode program and a
&lt;a href="https://hackage.haskell.org/package/unordered-containers-0.2.10.0/docs/Data-HashMap-Strict.html">HashMap&lt;/a> to record the &amp;ldquo;tiles&amp;rdquo; in the display, keyed by their
coordinates.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#66d9ef">data&lt;/span> &lt;span style="color:#66d9ef">LiveData&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">LiveData&lt;/span> {
&lt;span style="color:#75715e">-- x-coordinate of the ball - xb&lt;/span>
xb&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#66d9ef">Int&lt;/span>,
&lt;span style="color:#75715e">-- x-coordinate of the paddle - xp&lt;/span>
xp&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#66d9ef">Int&lt;/span>,
&lt;span style="color:#75715e">-- Game score - sc&lt;/span>
sc&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#66d9ef">Int&lt;/span>
} &lt;span style="color:#66d9ef">deriving&lt;/span>(&lt;span style="color:#66d9ef">Show&lt;/span>)
&lt;span style="color:#a6e22e">stepGame&amp;#39;&lt;/span> &lt;span style="color:#f92672">::&lt;/span> [&lt;span style="color:#66d9ef">Int&lt;/span>] &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Game&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> (&lt;span style="color:#66d9ef">LiveData&lt;/span>, &lt;span style="color:#66d9ef">Game&lt;/span>)
&lt;span style="color:#a6e22e">stepGame&lt;/span> &lt;span style="color:#f92672">::&lt;/span> [&lt;span style="color:#66d9ef">Int&lt;/span>] &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">State&lt;/span> &lt;span style="color:#66d9ef">Game&lt;/span> &lt;span style="color:#66d9ef">LiveData&lt;/span>
&lt;span style="color:#a6e22e">stepGame&lt;/span> &lt;span style="color:#f92672">=&lt;/span> state &lt;span style="color:#f92672">.&lt;/span> stepGame&amp;#39;
&lt;span style="color:#a6e22e">playGame&lt;/span> &lt;span style="color:#f92672">::&lt;/span> [&lt;span style="color:#66d9ef">Int&lt;/span>] &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">State&lt;/span> &lt;span style="color:#66d9ef">Game&lt;/span> &lt;span style="color:#66d9ef">Int&lt;/span>
&lt;span style="color:#a6e22e">playGame&lt;/span> inp &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">do&lt;/span>
liveData &lt;span style="color:#f92672">&amp;lt;-&lt;/span> stepGame inp
game &lt;span style="color:#f92672">&amp;lt;-&lt;/span> get
&lt;span style="color:#66d9ef">case&lt;/span> &lt;span style="color:#66d9ef">IC&lt;/span>&lt;span style="color:#f92672">.&lt;/span>progState (gameProg game) &lt;span style="color:#66d9ef">of&lt;/span>
&lt;span style="color:#66d9ef">IC&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#66d9ef">AwaitInput&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> playGame [joystick (xb liveData) (xp liveData)]
&lt;span style="color:#66d9ef">_&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> return &lt;span style="color:#f92672">$&lt;/span> sc liveData
&lt;span style="color:#a6e22e">joystick&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">Int&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Int&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Int&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>LiveData&lt;/code> is the data we pass on from step to step: the x coordinates of the
ball and paddle and the running score. The intcode program given can take &lt;code>1&lt;/code>,
&lt;code>-1&lt;/code>, or &lt;code>0&lt;/code> as an input to move the paddle right, left, or nowhere. &lt;code>joystick&lt;/code>
returns &lt;code>1&lt;/code>, &lt;code>-1&lt;/code>, or &lt;code>0&lt;/code> depending on whether the ball is ahead, behind, or in
line with the paddle.&lt;/p>
&lt;p>This was all well and good, and I could complete the problem by giving my end
score, but I wanted to watch my program as it took out all the bricks.&lt;/p>
&lt;p>Basically I wanted to be able to call &lt;code>print&lt;/code> inside the &lt;code>playGame&lt;/code> function.
I had a function that would turn the HashMap display into a 2D grid of characters:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#a6e22e">gridDisplay&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">Displ&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> [[&lt;span style="color:#66d9ef">Char&lt;/span>]]
&lt;/code>&lt;/pre>&lt;/div>&lt;p>, and could print a game&amp;rsquo;s display to screen with an expressions like:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#a6e22e">mapM&lt;/span> print &lt;span style="color:#f92672">$&lt;/span> gridDisplay displ
&lt;/code>&lt;/pre>&lt;/div>&lt;p>that maps &lt;code>print&lt;/code> across a &lt;code>[[Char]]&lt;/code> (i.e. &lt;code>[String]&lt;/code>) to display the
grid in &lt;code>stdout&lt;/code>.&lt;/p>
&lt;p>To be able to perform an IO action within &lt;code>playGame&lt;/code> we need to be able
to include a line of code that returns the IO Monad inside our State Monad.&lt;/p>
&lt;p>To achieve &amp;ldquo;Monads inside Monads&amp;rdquo; we use &lt;a href="https://wiki.haskell.org/Monad_Transformers">monad transformers&lt;/a>,
and for the State Monad we can use the &lt;a href="https://hackage.haskell.org/package/mtl-2.2.2/docs/Control-Monad-State-Lazy.html#t:StateT">&lt;code>StateT&lt;/code>&lt;/a> monad transformer.&lt;/p>
&lt;p>Editing the &lt;code>playGame&lt;/code> function in my solution:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#66d9ef">import&lt;/span> Control.Monad.State.Lazy (&lt;span style="color:#a6e22e">state&lt;/span>, &lt;span style="color:#66d9ef">StateT&lt;/span>)
&lt;span style="color:#66d9ef">import&lt;/span> Control.Monad.IO.Class (&lt;span style="color:#a6e22e">liftIO&lt;/span>)
&lt;span style="color:#66d9ef">import&lt;/span> System.Console.ANSI (&lt;span style="color:#a6e22e">cursorUp&lt;/span>)
&lt;span style="color:#a6e22e">playGame&lt;/span> &lt;span style="color:#f92672">::&lt;/span> [&lt;span style="color:#66d9ef">Int&lt;/span>] &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">StateT&lt;/span> &lt;span style="color:#66d9ef">Game&lt;/span> &lt;span style="color:#66d9ef">IO&lt;/span> &lt;span style="color:#66d9ef">Int&lt;/span>
&lt;span style="color:#a6e22e">playGame&lt;/span> inp &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">do&lt;/span>
liveData &lt;span style="color:#f92672">&amp;lt;-&lt;/span> stepGame inp
game &lt;span style="color:#f92672">&amp;lt;-&lt;/span> get
&lt;span style="color:#75715e">--&lt;/span>
&lt;span style="color:#75715e">-- Display the game state in a grid to stdout&lt;/span>
&lt;span style="color:#75715e">--&lt;/span>
&lt;span style="color:#66d9ef">let&lt;/span> grid &lt;span style="color:#f92672">=&lt;/span> gridDisplay &lt;span style="color:#f92672">$&lt;/span> gameDisplay game
&lt;span style="color:#66d9ef">_&lt;/span> &lt;span style="color:#f92672">&amp;lt;-&lt;/span> liftIO &lt;span style="color:#f92672">$&lt;/span> mapM print grid
liftIO &lt;span style="color:#f92672">.&lt;/span> print &lt;span style="color:#f92672">$&lt;/span> (&lt;span style="color:#e6db74">&amp;#34;Your score: &amp;#34;&lt;/span> &lt;span style="color:#f92672">++&lt;/span> show (sc liveData))
liftIO &lt;span style="color:#f92672">.&lt;/span> cursorUp &lt;span style="color:#f92672">$&lt;/span> (length grid) &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>
&lt;span style="color:#66d9ef">case&lt;/span> &lt;span style="color:#66d9ef">IC&lt;/span>&lt;span style="color:#f92672">.&lt;/span>progState (gameProg game) &lt;span style="color:#66d9ef">of&lt;/span>
&lt;span style="color:#66d9ef">IC&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#66d9ef">AwaitInput&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> playGame [joystick (xb liveData) (xp liveData)]
&lt;span style="color:#66d9ef">_&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> return &lt;span style="color:#f92672">$&lt;/span> sc liveData
&lt;span style="color:#a6e22e">stepGame&lt;/span> &lt;span style="color:#f92672">::&lt;/span> [&lt;span style="color:#66d9ef">Int&lt;/span>] &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">StateT&lt;/span> &lt;span style="color:#66d9ef">Game&lt;/span> &lt;span style="color:#66d9ef">IO&lt;/span> &lt;span style="color:#66d9ef">LiveData&lt;/span>
&lt;span style="color:#a6e22e">stepGame&lt;/span> &lt;span style="color:#f92672">=&lt;/span> state &lt;span style="color:#f92672">.&lt;/span> stepGame&amp;#39;
&lt;/code>&lt;/pre>&lt;/div>&lt;p>As &lt;code>State&lt;/code> is only a type alias for &lt;code>StateT&lt;/code> applied to the &lt;a href="https://hackage.haskell.org/package/base-4.11.0.0/docs/Data-Functor-Identity.html#t:Identity">Identity Monad&lt;/a>, I&amp;rsquo;ve really
changed the type of &lt;code>playGame&lt;/code> from:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#a6e22e">playGame&lt;/span> &lt;span style="color:#f92672">::&lt;/span> [&lt;span style="color:#66d9ef">Int&lt;/span>] &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">StateT&lt;/span> &lt;span style="color:#66d9ef">Game&lt;/span> &lt;span style="color:#66d9ef">Identity&lt;/span> &lt;span style="color:#66d9ef">Int&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>to:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#a6e22e">playGame&lt;/span> &lt;span style="color:#f92672">::&lt;/span> [&lt;span style="color:#66d9ef">Int&lt;/span>] &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">StateT&lt;/span> &lt;span style="color:#66d9ef">Game&lt;/span> &lt;span style="color:#66d9ef">IO&lt;/span> &lt;span style="color:#66d9ef">Int&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>to provide a non-trivial &amp;ldquo;inner monad&amp;rdquo;.&lt;/p>
&lt;p>The other key ingredients here are: &lt;code>liftIO&lt;/code>, which allows us to perform
actions within the inner IO Monad; and &lt;code>cursorUp&lt;/code>, to move the stdout cursor up
so we refresh the screen rather than printing a new grid below.&lt;/p>
&lt;p>While I got a monad transformer to work for me in this instance, I need to go
and spend a bit more time to understand how they work in general, hence the
reasonable brief explanation here.&lt;/p>
&lt;p>The result of this is that I could sit and watch my program destroy all the
bricks! 🎉&lt;/p>
&lt;pre>&lt;code>&amp;quot;Z|||||||||||||||||||||||||||||||||||||||||||&amp;quot;
&amp;quot; | |&amp;quot;
&amp;quot; | #### # # # # # # # ## # |&amp;quot;
&amp;quot; | # ## ## # ## ## ### ## # # ##### # |&amp;quot;
&amp;quot; | # # ## ### ##### # ### ###### |&amp;quot;
&amp;quot; | ## ##### # # ## # # # # ### ## # |&amp;quot;
&amp;quot; | #### ## # ## # # ##### # |&amp;quot;
&amp;quot; | ## ####### # # ## # #### |&amp;quot;
&amp;quot; | # # ## #### ### # ##### |&amp;quot;
&amp;quot; | # ##### # ### # # ## |&amp;quot;
&amp;quot; | ## # # # # # # ### |&amp;quot;
&amp;quot; | ## ## # # # # ## ### # |&amp;quot;
&amp;quot; | ### ###### # ## # |&amp;quot;
&amp;quot; | # # ## # |&amp;quot;
&amp;quot; | ## ## # # # ## |&amp;quot;
&amp;quot; | |&amp;quot;
&amp;quot; | o |&amp;quot;
&amp;quot; | |&amp;quot;
&amp;quot; | |&amp;quot;
&amp;quot; | = |&amp;quot;
&amp;quot; | |&amp;quot;
&amp;quot;Your score: 3939&amp;quot;
&lt;/code>&lt;/pre>&lt;pre>&lt;code>&amp;quot;Z|||||||||||||||||||||||||||||||||||||||||||&amp;quot;
&amp;quot; | |&amp;quot;
&amp;quot; | ## # # |&amp;quot;
&amp;quot; | # # ## #### # |&amp;quot;
&amp;quot; | # # # # # # ###### |&amp;quot;
&amp;quot; | ## ## # # ### ## # |&amp;quot;
&amp;quot; | #### ## # ### # |&amp;quot;
&amp;quot; | ## # # # #### |&amp;quot;
&amp;quot; | # # # ### ### |&amp;quot;
&amp;quot; | # # ### # o ## |&amp;quot;
&amp;quot; | # # # # # |&amp;quot;
&amp;quot; | # ## ### |&amp;quot;
&amp;quot; | ## # ## |&amp;quot;
&amp;quot; | # |&amp;quot;
&amp;quot; | |&amp;quot;
&amp;quot; | |&amp;quot;
&amp;quot; | |&amp;quot;
&amp;quot; | |&amp;quot;
&amp;quot; | |&amp;quot;
&amp;quot; | = |&amp;quot;
&amp;quot; | |&amp;quot;
&amp;quot;Your score: 9021&amp;quot;
&lt;/code>&lt;/pre>&lt;p>It does get a bit boring watch it spend ages trying to get
the last few bricks.&lt;/p>
&lt;h2 id="making-a-monad">Making a Monad&lt;/h2>
&lt;p>In my intcode computer, there was lots of opportunity for various
operations to fail if the intcode was bugged or an input was bad.
I was modelling these with &lt;a href="http://hackage.haskell.org/package/base-4.12.0.0/docs/Data-Maybe.html">&lt;code>Maybe&lt;/code>&lt;/a>, matching on &lt;code>Nothing&lt;/code>, and
setting the program status to the &lt;code>Crashed&lt;/code> variant of &lt;code>Status&lt;/code>.&lt;/p>
&lt;p>I was doing this &lt;em>a lot&lt;/em>, essentially writing the same 3 lines of code
over and over. This indicated to me that there was an abstraction
to be made&lt;sup id="fnref:1">&lt;a href="#fn:1" class="footnote-ref" role="doc-noteref">1&lt;/a>&lt;/sup>.&lt;/p>
&lt;h3 id="failing-functions-being-generic-over-monadfail">Failing Functions being Generic over MonadFail&lt;/h3>
&lt;p>The general case of this is where we have a type
that can represent failure, and if an operation fails we want
to return that type representing failure.&lt;/p>
&lt;p>As an example, say we want to return a list where an empty list
represents failure. In this simple example a negative input
results in failure.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#a6e22e">maybePos&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">Int&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Maybe&lt;/span> &lt;span style="color:#66d9ef">Int&lt;/span>
&lt;span style="color:#a6e22e">maybePos&lt;/span> x
&lt;span style="color:#f92672">|&lt;/span> x &lt;span style="color:#f92672">&amp;lt;&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">Nothing&lt;/span>
&lt;span style="color:#f92672">|&lt;/span> otherwise &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">Just&lt;/span> x
&lt;span style="color:#a6e22e">thing&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">Int&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> [&lt;span style="color:#66d9ef">Int&lt;/span>]
&lt;span style="color:#a6e22e">thing&lt;/span> x &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">case&lt;/span> maybePos x &lt;span style="color:#66d9ef">of&lt;/span>
&lt;span style="color:#66d9ef">Nothing&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">[]&lt;/span>
&lt;span style="color:#66d9ef">Just&lt;/span> posX &lt;span style="color:#f92672">-&amp;gt;&lt;/span> [posX]
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>thing&lt;/code> has to match on the &lt;code>Maybe Int&lt;/code> given by &lt;code>maybePos&lt;/code> and
return either the &lt;code>Int&lt;/code> in a list or an empty list.&lt;/p>
&lt;p>I found myself repeating this patten:&lt;/p>
&lt;ul>
&lt;li>Model the operation that can fail with a function that returns &lt;code>Maybe&lt;/code>,&lt;/li>
&lt;li>Match on the &lt;code>Nothing&lt;/code> and return my failure type.&lt;/li>
&lt;/ul>
&lt;p>I was doing a lot of manually converting one type&amp;rsquo;s failure representation
to another type&amp;rsquo;s failure representation. This seemed to me like there was
something I could use to do this automatically, as I was expressing the same
thing over and over again.&lt;/p>
&lt;p>In the example above, both &lt;code>Maybe&lt;/code> and &lt;code>List&lt;/code> are monads. I&amp;rsquo;m converting
from one monad&amp;rsquo;s failure representation to another. After a bit of looking
around I found the &lt;a href="http://hackage.haskell.org/package/base-4.12.0.0/docs/Control-Monad-Fail.html">&lt;code>MonadFail&lt;/code> typeclass&lt;/a>. As &lt;code>Maybe&lt;/code> and &lt;code>List&lt;/code>
both are instances of &lt;code>MonadFail&lt;/code> we can redefine &lt;code>maybePos&lt;/code> to be generic
over &lt;code>MonadFail&lt;/code> and cut out the conversion between failure representations.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#a6e22e">maybePosM&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">MonadFail&lt;/span> m &lt;span style="color:#f92672">=&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Int&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> m &lt;span style="color:#66d9ef">Int&lt;/span>
&lt;span style="color:#a6e22e">maybePosM&lt;/span> x
&lt;span style="color:#f92672">|&lt;/span> x &lt;span style="color:#f92672">&amp;lt;&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span> &lt;span style="color:#f92672">=&lt;/span> fail &lt;span style="color:#e6db74">&amp;#34;woops&amp;#34;&lt;/span>
&lt;span style="color:#f92672">|&lt;/span> otherwise &lt;span style="color:#f92672">=&lt;/span> return x
&lt;span style="color:#a6e22e">thing&amp;#39;&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">Int&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> [&lt;span style="color:#66d9ef">Int&lt;/span>]
&lt;span style="color:#a6e22e">thing&amp;#39;&lt;/span> &lt;span style="color:#f92672">=&lt;/span> maybePosM
&lt;span style="color:#a6e22e">posIntoMaybe&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">Int&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Maybe&lt;/span> &lt;span style="color:#66d9ef">Int&lt;/span>
&lt;span style="color:#a6e22e">posIntoMaybe&lt;/span> &lt;span style="color:#f92672">=&lt;/span> maybePosM
&lt;span style="color:#a6e22e">posIntoIO&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">Int&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">IO&lt;/span> &lt;span style="color:#66d9ef">Int&lt;/span>
&lt;span style="color:#a6e22e">posIntoIO&lt;/span> &lt;span style="color:#f92672">=&lt;/span> maybePosM
&lt;/code>&lt;/pre>&lt;/div>&lt;p>This pattern showed a lot of promise, and I wanted to see if I could employ
it in my intcode computer code.&lt;/p>
&lt;h3 id="refactoring-the-intcode-computer">Refactoring the Intcode Computer&lt;/h3>
&lt;p>Recall the &lt;code>Program&lt;/code> type I&amp;rsquo;ve been using to model an intcode computer
thus far:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#66d9ef">data&lt;/span> &lt;span style="color:#66d9ef">Program&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">Program&lt;/span> {
input&lt;span style="color:#f92672">::&lt;/span>[&lt;span style="color:#66d9ef">Int&lt;/span>],
intCode&lt;span style="color:#f92672">::&lt;/span>[&lt;span style="color:#66d9ef">Int&lt;/span>],
status&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#66d9ef">Status&lt;/span>,
&lt;span style="color:#75715e">-- ip: Instruction Pointer&lt;/span>
ip&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#66d9ef">Int&lt;/span>,
&lt;span style="color:#75715e">-- rb: Relative Base&lt;/span>
rb&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#66d9ef">Int&lt;/span>,
output&lt;span style="color:#f92672">::&lt;/span>[&lt;span style="color:#66d9ef">Int&lt;/span>]
} &lt;span style="color:#66d9ef">deriving&lt;/span>(&lt;span style="color:#66d9ef">Show&lt;/span>, &lt;span style="color:#66d9ef">Eq&lt;/span>)
&lt;span style="color:#66d9ef">data&lt;/span> &lt;span style="color:#66d9ef">Status&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">Running&lt;/span> &lt;span style="color:#f92672">|&lt;/span> &lt;span style="color:#66d9ef">AwaitInput&lt;/span> &lt;span style="color:#f92672">|&lt;/span> &lt;span style="color:#66d9ef">Terminated&lt;/span> &lt;span style="color:#f92672">|&lt;/span> &lt;span style="color:#66d9ef">Crashed&lt;/span> &lt;span style="color:#66d9ef">deriving&lt;/span>(&lt;span style="color:#66d9ef">Show&lt;/span>, &lt;span style="color:#66d9ef">Eq&lt;/span>)
&lt;/code>&lt;/pre>&lt;/div>&lt;p>We think about where failure is represented in this type: in the &lt;code>Crashed&lt;/code>
variant of the sum type &lt;code>Status&lt;/code> under the status field. You could say that
&amp;ldquo;sense of failure&amp;rdquo; is buried deep within this type. If we want to handle
failure with Monads, we want to encode failure in a &amp;ldquo;container&amp;rdquo; type.&lt;/p>
&lt;p>I chose to refactor this by making what was &lt;code>Status&lt;/code> into a type that
had variants that could contain an intcode computer. The data from the &lt;code>Program&lt;/code>
type above, then got split into:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#66d9ef">data&lt;/span> &lt;span style="color:#66d9ef">Prog&lt;/span> a &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">Running&lt;/span> a &lt;span style="color:#f92672">|&lt;/span> &lt;span style="color:#66d9ef">AwaitInput&lt;/span> a &lt;span style="color:#f92672">|&lt;/span> &lt;span style="color:#66d9ef">End&lt;/span> a &lt;span style="color:#f92672">|&lt;/span> &lt;span style="color:#66d9ef">Crashed&lt;/span> &lt;span style="color:#66d9ef">String&lt;/span> &lt;span style="color:#66d9ef">deriving&lt;/span>(&lt;span style="color:#66d9ef">Show&lt;/span>, &lt;span style="color:#66d9ef">Eq&lt;/span>)
&lt;span style="color:#66d9ef">data&lt;/span> &lt;span style="color:#66d9ef">Intcode&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">Intcode&lt;/span> {
input&lt;span style="color:#f92672">::&lt;/span>[&lt;span style="color:#66d9ef">Int&lt;/span>],
code&lt;span style="color:#f92672">::&lt;/span>[&lt;span style="color:#66d9ef">Int&lt;/span>],
&lt;span style="color:#75715e">-- ip: Instruction Pointer&lt;/span>
ip&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#66d9ef">Int&lt;/span>,
&lt;span style="color:#75715e">-- rb: Relative Base&lt;/span>
rb&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#66d9ef">Int&lt;/span>,
output&lt;span style="color:#f92672">::&lt;/span>[&lt;span style="color:#66d9ef">Int&lt;/span>]
} &lt;span style="color:#66d9ef">deriving&lt;/span>(&lt;span style="color:#66d9ef">Show&lt;/span>, &lt;span style="color:#66d9ef">Eq&lt;/span>)
&lt;/code>&lt;/pre>&lt;/div>&lt;p>With &lt;code>Prog&lt;/code> being given implementations of &lt;code>Monad&lt;/code> and &lt;code>MonadFail&lt;/code> typeclasses:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#66d9ef">instance&lt;/span> &lt;span style="color:#66d9ef">Monad&lt;/span> &lt;span style="color:#66d9ef">Prog&lt;/span> &lt;span style="color:#66d9ef">where&lt;/span>
return &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">Running&lt;/span>
(&lt;span style="color:#66d9ef">Crashed&lt;/span> e) &lt;span style="color:#f92672">&amp;gt;&amp;gt;=&lt;/span> &lt;span style="color:#66d9ef">_&lt;/span> &lt;span style="color:#f92672">=&lt;/span> (&lt;span style="color:#66d9ef">Crashed&lt;/span> e)
(&lt;span style="color:#66d9ef">End&lt;/span> prog) &lt;span style="color:#f92672">&amp;gt;&amp;gt;=&lt;/span> k &lt;span style="color:#f92672">=&lt;/span> k prog
(&lt;span style="color:#66d9ef">Running&lt;/span> prog) &lt;span style="color:#f92672">&amp;gt;&amp;gt;=&lt;/span> k &lt;span style="color:#f92672">=&lt;/span> k prog
(&lt;span style="color:#66d9ef">AwaitInput&lt;/span> prog) &lt;span style="color:#f92672">&amp;gt;&amp;gt;=&lt;/span> k &lt;span style="color:#f92672">=&lt;/span> k prog
&lt;span style="color:#66d9ef">instance&lt;/span> &lt;span style="color:#66d9ef">MonadFail&lt;/span> &lt;span style="color:#66d9ef">Prog&lt;/span> &lt;span style="color:#66d9ef">where&lt;/span>
fail &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">Crashed&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>As the definition of the &lt;a href="https://hackage.haskell.org/package/base-4.12.0.0/docs/Control-Monad.html#t:Monad">monad typeclass&lt;/a> has the typeclass constraint:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#66d9ef">Applicative&lt;/span> m &lt;span style="color:#f92672">=&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Monad&lt;/span> m &lt;span style="color:#66d9ef">where&lt;/span>
&lt;span style="color:#f92672">...&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>and &lt;code>Applicative&lt;/code> in turn has a similar constraint for &lt;code>Functor&lt;/code>, I needed to also
make &lt;code>Prog&lt;/code> an instance of both the &lt;code>Applicative&lt;/code> and &lt;code>Functor&lt;/code> typeclasses:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#66d9ef">instance&lt;/span> &lt;span style="color:#66d9ef">Functor&lt;/span> &lt;span style="color:#66d9ef">Prog&lt;/span> &lt;span style="color:#66d9ef">where&lt;/span>
fmap &lt;span style="color:#66d9ef">_&lt;/span> (&lt;span style="color:#66d9ef">Crashed&lt;/span> e) &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">Crashed&lt;/span> e
fmap f (&lt;span style="color:#66d9ef">End&lt;/span> a) &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">End&lt;/span> (f a)
fmap f (&lt;span style="color:#66d9ef">Running&lt;/span> a) &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">Running&lt;/span> (f a)
fmap f (&lt;span style="color:#66d9ef">AwaitInput&lt;/span> a) &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">AwaitInput&lt;/span> (f a)
&lt;span style="color:#66d9ef">instance&lt;/span> &lt;span style="color:#66d9ef">Applicative&lt;/span> &lt;span style="color:#66d9ef">Prog&lt;/span> &lt;span style="color:#66d9ef">where&lt;/span>
pure &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">Running&lt;/span>
&lt;span style="color:#66d9ef">_&lt;/span> &lt;span style="color:#f92672">&amp;lt;*&amp;gt;&lt;/span> (&lt;span style="color:#66d9ef">Crashed&lt;/span> e) &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">Crashed&lt;/span> e
(&lt;span style="color:#66d9ef">End&lt;/span> f) &lt;span style="color:#f92672">&amp;lt;*&amp;gt;&lt;/span> prog &lt;span style="color:#f92672">=&lt;/span> fmap f prog
(&lt;span style="color:#66d9ef">Running&lt;/span> f) &lt;span style="color:#f92672">&amp;lt;*&amp;gt;&lt;/span> prog &lt;span style="color:#f92672">=&lt;/span> fmap f prog
(&lt;span style="color:#66d9ef">AwaitInput&lt;/span> f) &lt;span style="color:#f92672">&amp;lt;*&amp;gt;&lt;/span> prog &lt;span style="color:#f92672">=&lt;/span> fmap f prog
&lt;/code>&lt;/pre>&lt;/div>&lt;p>So what was previously represented by &lt;code>Program&lt;/code>, is now represented by &lt;code>Prog Intcode&lt;/code>,
where &lt;code>Prog&lt;/code> is a monad that can represent a program being in a number of states, or
crashed and &lt;code>Intcode&lt;/code> is the data relevant to an intcode program specifically. The
abstraction here is to separate the raw number crunching of the intcode computer from
our interpretation of the overall &amp;ldquo;status&amp;rdquo; of the program.&lt;/p>
&lt;p>Having made this monad, I refactored all the operations on the intcode which could fail
to return a type generic across &lt;code>MonadFail&lt;/code>, rather than returning &lt;code>Maybe&lt;/code>. E.g. my
function to safely lookup an index in a list and return &lt;code>0&lt;/code> if the index is beyond
the end of the list, &lt;code>(!!!)&lt;/code> went from:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">(&lt;span style="color:#f92672">!!!&lt;/span>) &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">Integral&lt;/span> a &lt;span style="color:#f92672">=&amp;gt;&lt;/span> [a] &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Int&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Maybe&lt;/span> a
&lt;span style="color:#66d9ef">infixl&lt;/span> &lt;span style="color:#ae81ff">9&lt;/span> &lt;span style="color:#f92672">!!!&lt;/span>
&lt;span style="color:#a6e22e">xs&lt;/span> &lt;span style="color:#f92672">!!!&lt;/span> i
&lt;span style="color:#f92672">|&lt;/span> i &lt;span style="color:#f92672">&amp;lt;&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">Nothing&lt;/span>
&lt;span style="color:#f92672">|&lt;/span> i &lt;span style="color:#f92672">&amp;gt;=&lt;/span> length xs &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">Just&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>
&lt;span style="color:#f92672">|&lt;/span> otherwise &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">Just&lt;/span> &lt;span style="color:#f92672">$&lt;/span> xs &lt;span style="color:#f92672">!!&lt;/span> i
&lt;/code>&lt;/pre>&lt;/div>&lt;p>to:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">(&lt;span style="color:#f92672">!!!&lt;/span>) &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">Integral&lt;/span> a &lt;span style="color:#f92672">=&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">MonadFail&lt;/span> m &lt;span style="color:#f92672">=&amp;gt;&lt;/span> [a] &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Int&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> m a
&lt;span style="color:#66d9ef">infixl&lt;/span> &lt;span style="color:#ae81ff">9&lt;/span> &lt;span style="color:#f92672">!!!&lt;/span>
&lt;span style="color:#a6e22e">xs&lt;/span> &lt;span style="color:#f92672">!!!&lt;/span> i
&lt;span style="color:#f92672">|&lt;/span> i &lt;span style="color:#f92672">&amp;lt;&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span> &lt;span style="color:#f92672">=&lt;/span> fail &lt;span style="color:#f92672">$&lt;/span> &lt;span style="color:#e6db74">&amp;#34;index &amp;#34;&lt;/span> &lt;span style="color:#f92672">++&lt;/span> show i &lt;span style="color:#f92672">++&lt;/span> &lt;span style="color:#e6db74">&amp;#34; less that zero&amp;#34;&lt;/span>
&lt;span style="color:#f92672">|&lt;/span> i &lt;span style="color:#f92672">&amp;gt;=&lt;/span> length xs &lt;span style="color:#f92672">=&lt;/span> return &lt;span style="color:#ae81ff">0&lt;/span>
&lt;span style="color:#f92672">|&lt;/span> otherwise &lt;span style="color:#f92672">=&lt;/span> return &lt;span style="color:#f92672">$&lt;/span> xs &lt;span style="color:#f92672">!!&lt;/span> i
&lt;/code>&lt;/pre>&lt;/div>&lt;p>I was then able to strip out all of the &lt;code>case&lt;/code> statements that were matching
&lt;code>Maybe&lt;/code> and returning a &amp;ldquo;crashed&amp;rdquo; program for &lt;code>Nothing&lt;/code> and use &lt;code>do&lt;/code> notation.&lt;/p>
&lt;p>The implementation of the old &lt;code>runStep&lt;/code> function, that moved the program on by
running a single instruction, called down through layers of functions to select
the right operation, try to perform it, matching on the &lt;code>Maybe&lt;/code> returned and
evolving the intcode state if the operation was successful. Now this logic
is condensed with the tedious boilerplate removed. The start of the equivalent
function in the refactored implementation looks like:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#a6e22e">runInstruction&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">Intcode&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Prog&lt;/span> &lt;span style="color:#66d9ef">Intcode&lt;/span>
&lt;span style="color:#a6e22e">runInstruction&lt;/span> ic &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">do&lt;/span>
opcodes &lt;span style="color:#f92672">&amp;lt;-&lt;/span> currentOpCode ic
&lt;span style="color:#66d9ef">case&lt;/span> opcodes &lt;span style="color:#66d9ef">of&lt;/span>
(&lt;span style="color:#66d9ef">One&lt;/span>, m1, m2, m3) &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">do&lt;/span>
newIc &lt;span style="color:#f92672">&amp;lt;-&lt;/span> op1 m1 m2 m3 (ip ic) (code ic)
return &lt;span style="color:#f92672">$&lt;/span> moveIp &lt;span style="color:#ae81ff">4&lt;/span> &lt;span style="color:#f92672">.&lt;/span> updateCode newIc &lt;span style="color:#f92672">$&lt;/span> ic
&lt;span style="color:#f92672">...&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>currentOpCode&lt;/code> &amp;amp; &lt;code>op1&lt;/code> both return a type generic over &lt;code>MonadFail&lt;/code>, so in the
case of failure will cause this function to bail with the &lt;code>Crashed&lt;/code> variant of
&lt;code>Prog&lt;/code>. There is one of these 3 line blocks for each of the different instructions
the intcode can have, and that&amp;rsquo;s it.&lt;/p>
&lt;p>I&amp;rsquo;m not sure how &amp;ldquo;idiomatic&amp;rdquo; using &lt;code>MonadFail&lt;/code> in this way is, it&amp;rsquo;s just
something I spotted that I could do. I see that the &lt;a href="http://hackage.haskell.org/package/listsafe-0.1.0.1/docs/Data-List-Safe.html">&lt;code>Data.List.Safe&lt;/code>&lt;/a>
uses &lt;code>MonadThrow&lt;/code> to represent failure, and looking around there seems
other ways of representing and dealing with errors, the &lt;a href="http://hackage.haskell.org/package/mtl-2.2.2/docs/Control-Monad-Except.html#t:ExceptT">&lt;code>ExceptT&lt;/code>&lt;/a>
monad transformer among them.&lt;/p>
&lt;h1 id="other-things-that-came-up">Other Things That Came Up&lt;/h1>
&lt;h2 id="recursion">Recursion&lt;/h2>
&lt;p>In &lt;a href="https://tarquin-the-brave.github.io/blog/posts/re-learning-haskell/">my last post&lt;/a> I said:&lt;/p>
&lt;blockquote>
&lt;p>I’m not sure why, but Haskell make recursion feel like a natural way to
solve problems. I use recursion in other languages, but it always feels
like I’ve done something a bit clever.&lt;/p>
&lt;/blockquote>
&lt;p>I think I know why now:&lt;/p>
&lt;blockquote>
&lt;p>Functional purity allows you to recurse with confidence.&lt;/p>
&lt;/blockquote>
&lt;p>It comes down to: how much information you have to hold in your head while
following the code.&lt;/p>
&lt;p>In procedural languages, where methods have side effects, or at least are
not guaranteed not to, you need to keep in mind all the state that
can be affect when following a method. When a method recurses,
you then have to consider all the state that the method can affect on
that recursion. You can&amp;rsquo;t treat each recursion symmetrically, because each
recursion adds to the number of things you need to consider.&lt;/p>
&lt;p>With functions&lt;sup id="fnref:2">&lt;a href="#fn:2" class="footnote-ref" role="doc-noteref">2&lt;/a>&lt;/sup>, you only need to consider their inputs.
And importantly you only need to consider their inputs as data, not as
&amp;ldquo;either representing data or a place to put data&amp;rdquo;&lt;sup id="fnref:3">&lt;a href="#fn:3" class="footnote-ref" role="doc-noteref">3&lt;/a>&lt;/sup>. When a function
recurses, you can leave all context that wasn&amp;rsquo;t passed directly to the
function behind when reasoning through the recursion. You can
descend into the recursion carrying with you only what you
carried into the last one.&lt;/p>
&lt;p>Also as functions return the same output given the same input, you
generally only need to reason through the recursion once.&lt;/p>
&lt;p>By this same reasoning, I&amp;rsquo;d argue that a fold is simpler&lt;sup id="fnref:4">&lt;a href="#fn:4" class="footnote-ref" role="doc-noteref">4&lt;/a>&lt;/sup> than
a for loop that iterates over a collection (for languages that support
both and you have the choice).&lt;/p>
&lt;p>When reasoning through a fold you only need to consider two values:
the accumulator; and the item taken from the collection. It&amp;rsquo;s almost
like being in a bubble, where only these two values matter.&lt;/p>
&lt;p>In a for loop however, you&amp;rsquo;re exposed to the context outside the loop.
You can&amp;rsquo;t forget about any variables in scope, as you might change them
while looping. You also have control flow to consider. You might hit
a &lt;code>break&lt;/code> or &lt;code>continue&lt;/code> on a particular loop which means you then have
to skip over the code blow it that you would have otherwise reasoned
through (a &lt;code>goto&lt;/code> in sheep&amp;rsquo;s clothing). Like with recursion in procedural
languages the number of things you need to consider grows as you iterate.
With functional purity that number of things to consider stays steady.&lt;/p>
&lt;h2 id="compiler-warnings">Compiler Warnings&lt;/h2>
&lt;p>I turned on a bunch of compiler warnings, as per the advise of &lt;a href="https://lexi-lambda.github.io/blog/2018/02/10/an-opinionated-guide-to-haskell-in-2018/">this
article&lt;/a>, by adding this to my &lt;code>~/.stack/config.yaml&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="color:#66d9ef">ghc-options&lt;/span>:
&lt;span style="color:#66d9ef">&amp;#34;$locals&amp;#34;: &lt;/span>-Wall -Wcompat -Wincomplete-record-updates -Wincomplete-uni-patterns -Wredundant-constraints
&lt;/code>&lt;/pre>&lt;/div>&lt;p>I had initially thought that I wanted to use Haskell as &amp;ldquo;out of the box&amp;rdquo;
as possible, and not &amp;ldquo;depend on&amp;rdquo; extra lints to tell me what to do, but
then remembered that&amp;rsquo;s a terrible argument.&lt;/p>
&lt;p>In reality, when people employ extra linting and static analysis they
don&amp;rsquo;t become dependent on it, they learn from it and get better at
writing better code first time, and continue to write better code when
the linting is turned off.&lt;/p>
&lt;p>When you work in a language with a strong type system and have a compiler
that kicks your ass when you get it wrong, you become better at writing
correct code first time in all languages.&lt;/p>
&lt;p>So I turned the compiler warnings on. It did make ghci a bit spammy.
I&amp;rsquo;ll see if there&amp;rsquo;s a nice way to turn the warnings off for ghci.&lt;/p>
&lt;h2 id="breaking-functions-into-lots-of-pieces">Breaking Functions Into Lots of Pieces&lt;/h2>
&lt;p>In a few of the Advent of Code problems, especially when I was eager to
get the problem done and move on, I found myself falling into a pattern
of: knowing the data I want; thinking procedurally about all the steps
between that and the data I have; writing a function for each of these
steps; and stringing them together to get the answer.&lt;/p>
&lt;p>This gets me to the answer, but the result is a load of free floating
functions non of which make any real sense on their own. The code ends
up being a bit of a mess, especially when those constituent steps are
not used anywhere else.&lt;/p>
&lt;p>Part of this can come down to whether either of the data I have or the
data I want are actually good representations of the problem. When data
is a good natural fit to a problem you tend not to need to do so many
complex transformations of that data. But I think it&amp;rsquo;s fair to expect
times when you need to describe the transformation of some data that&amp;rsquo;s
more complex than could be described in a one line function.&lt;/p>
&lt;p>I started using the &lt;code>where&lt;/code> keyword more often, and that appears to
have dealt with this problem I was having. With &lt;code>where&lt;/code> you can break
down a calculation into parts without exposing those parts as free
floating functions.&lt;/p>
&lt;p>E.g:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#a6e22e">foo&lt;/span> &lt;span style="color:#f92672">=&lt;/span> map &lt;span style="color:#f92672">.&lt;/span> bar baz
&lt;span style="color:#66d9ef">where&lt;/span>
bar &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">...&lt;/span>
baz &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">...&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>This keeps the readers attention in the block of text where the function
is defined, rather than having to jump around a file, or even into different
files.&lt;/p>
&lt;h2 id="modules--namespacing">Modules &amp;amp; Namespacing&lt;/h2>
&lt;p>In &lt;a href="https://tarquin-the-brave.github.io/blog/posts/re-learning-haskell/">my last post&lt;/a> I talked about: not knowing how to find out
what package to install to get a certain library; and not being totally
comfortable with the namespacing when modules are imported and suffering
from &amp;ldquo;where did that function come from?&amp;rdquo; syndrome.&lt;/p>
&lt;p>The first of these was me just being dumb as it turns out the
package containing a module is written in the top left hand corner
of the module documentation&amp;rsquo;s web page. Spot &lt;code>mtl-&lt;/code> in &lt;a href="https://hackage.haskell.org/package/mtl-2.2.2/docs/Control-Monad-State-Lazy.html">the
docs for &lt;code>Control.Monad.State.Lazy&lt;/code>&lt;/a>.&lt;/p>
&lt;p>On the second of these: I&amp;rsquo;ve got reasonably comfortable with either
doing a qualified import to preserve namespacing, or being explicit
about which functions I&amp;rsquo;m importing if I&amp;rsquo;m importing them into the
module&amp;rsquo;s namespace.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#66d9ef">import&lt;/span> &lt;span style="color:#66d9ef">qualified&lt;/span> Foo.Bar &lt;span style="color:#66d9ef">as&lt;/span> FB
&lt;span style="color:#66d9ef">import&lt;/span> Baz
( &lt;span style="color:#a6e22e">foo&lt;/span>
, &lt;span style="color:#a6e22e">fooBar&lt;/span>
, &lt;span style="color:#a6e22e">fooBarBaz&lt;/span>
)
&lt;/code>&lt;/pre>&lt;/div>&lt;p>I&amp;rsquo;ve found using a combination of these: qualified import and
explicitly listing the functions is a bit over the top.&lt;/p>
&lt;p>I also practiced a pattern of having a module which renames
functions from another module when the names of functions and
types didn&amp;rsquo;t make as much sense in the context I was using them,
or were just down right silly names in the first place.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#66d9ef">module&lt;/span> Sensible
( &lt;span style="color:#a6e22e">foo&lt;/span>
, &lt;span style="color:#a6e22e">bar&lt;/span>
, &lt;span style="color:#66d9ef">Baz&lt;/span> (&lt;span style="color:#f92672">..&lt;/span>)
, &lt;span style="color:#66d9ef">Silly&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">okName&lt;/span>
)
&lt;span style="color:#66d9ef">import&lt;/span> Very.Silly.Named.Module &lt;span style="color:#66d9ef">as&lt;/span> Silly
&lt;span style="color:#a6e22e">foo&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">Silly&lt;/span>&lt;span style="color:#f92672">.&lt;/span>longFooName
&lt;span style="color:#a6e22e">bar&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">Silly&lt;/span>&lt;span style="color:#f92672">.&lt;/span>otherBarName
&lt;span style="color:#66d9ef">type&lt;/span> &lt;span style="color:#66d9ef">Baz&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">Silly&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#66d9ef">BazBaz&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Using a combination of qualified imports and explicitly naming
functions I&amp;rsquo;m importing into the module&amp;rsquo;s namespace, I&amp;rsquo;ve found
I can completely prevent the &amp;ldquo;where did that function come from&amp;rdquo;
syndrome.&lt;/p>
&lt;p>In &lt;a href="https://tarquin-the-brave.github.io/blog/posts/re-learning-haskell/">my last post&lt;/a> I made a lot of comparisons between how Rust
does things and how I was finding things are done in Haskell.
I made a general point that Rust is more explicit. This is an example
of where Haskell can be more explicit. In Rust, a lot of functionality
is provided via traits. If a type implements a trait, you can call
the methods from that trait on that type by importing the trait. The
methods themselves don&amp;rsquo;t need to be explicitly imported. The result is
that you can read some code that deals with a type you know (or at least
know where to find the docs for), that then calls a method on that type
that doesn&amp;rsquo;t appear in the type&amp;rsquo;s documentation. You&amp;rsquo;re left wondering
&amp;ldquo;where did that method come from?&amp;quot;. This is the part where I&amp;rsquo;d use
a &amp;ldquo;go to definition&amp;rdquo;. Without that you&amp;rsquo;d need to search through the
traits that are imported in scope as any one of them might have been
implemented for the type and try to find the method. I try to avoid
this problem in Rust by keeping imports of traits as tightly scoped
with the code that uses them as I can so it&amp;rsquo;s as obvious as possible
where the method came from. This is probably one of the rare examples
where Rust is not &lt;a href="https://tarquin-the-brave.github.io/blog/posts/ide-read-code/">readable as text&lt;/a>, where for the most part
it is pretty good at being.&lt;/p>
&lt;h1 id="what-next">What Next?&lt;/h1>
&lt;p>As I said last time, I reckon I could press on and do the rest of the problems
with the tools I know. But I&amp;rsquo;m keen to level up my Haskell and not just grind
out solutions.&lt;/p>
&lt;p>I&amp;rsquo;m keen to read more into monad transformers and property based testing.&lt;/p>
&lt;p>I then want to loop back around and improve the performance of my solutions:
looking into strictness and more efficient data structures. I also want to
make types fit the data better: where they could be more generic making them
more generic and where they&amp;rsquo;re too generic, and possible values of the type
don&amp;rsquo;t represent possible values of data the type represents, choose, or define,
another type that&amp;rsquo;s better suited.&lt;/p>
&lt;p>&lt;em>As with &lt;a href="https://tarquin-the-brave.github.io/blog/posts/re-learning-haskell/">Part 1&lt;/a>, all my solutions are &lt;a href="https://github.com/tarquin-the-brave/aoc-19-haskell">mastered on Github&lt;/a>, but
are likely to have been refactored somewhat since this post was written.&lt;/em>&lt;/p>
&lt;p>&lt;a href="https://tarquin-the-brave.github.io/blog/posts/re-learning-haskell-3/">&lt;strong>Re-learning Haskell with Advent of Code - Part 3&lt;/strong>&lt;/a>&lt;/p>
&lt;section class="footnotes" role="doc-endnotes">
&lt;hr>
&lt;ol>
&lt;li id="fn:1" role="doc-endnote">
&lt;p>I wrote &lt;a href="https://tarquin-the-brave.github.io/blog/posts/dry-not-a-goal/">a blog post recently&lt;/a> about how removing repetition in code
isn&amp;rsquo;t the be all and end all, but is a good indicator that some abstractions
are needed. &lt;a href="#fnref:1" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:2" role="doc-endnote">
&lt;p>I&amp;rsquo;m careful to not call something a function if it isn&amp;rsquo;t a pure function.
The ship sailed a bit on that one as many languages call their inpure methods
&amp;ldquo;functions&amp;rdquo;, but I find the distinction useful, not least to help context
switch when moving between procedural and functional frames of mind. &lt;a href="#fnref:2" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:3" role="doc-endnote">
&lt;p>&lt;a href="https://www.youtube.com/watch?v=-6BsiVyC1kM">A great talk by Rich Hickey&lt;/a> &amp;ldquo;The Value of Values&amp;rdquo; talks
about PLOP &amp;ldquo;Place Oriented Programming&amp;rdquo;. &lt;a href="#fnref:3" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:4" role="doc-endnote">
&lt;p>&lt;a href="https://www.youtube.com/watch?v=oytL881p-nQ">Another great talk by Rich Hickey&lt;/a> &amp;ldquo;Simple Made Easy&amp;rdquo;
talks about what simplicity is and how we can think objectively about it
rather than it being a stand in for what people are most familiar with. &lt;a href="#fnref:4" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/section></description></item><item><title>DRY Shouldn't be a Goal in Itself</title><link>https://tarquin-the-brave.github.io/blog/posts/dry-not-a-goal/</link><pubDate>Sat, 18 Apr 2020 10:40:01 +0100</pubDate><guid>https://tarquin-the-brave.github.io/blog/posts/dry-not-a-goal/</guid><description>&lt;p>&lt;a href="https://en.wikipedia.org/wiki/Don%27t_repeat_yourself">DRY&lt;/a>, &amp;ldquo;Don&amp;rsquo;t Repeat Yourself&amp;rdquo;, is often described as a &amp;ldquo;principle&amp;rdquo; of
software engineering. I looked up what &amp;ldquo;principle&amp;rdquo; is defined to mean and
Google says:&lt;/p>
&lt;blockquote>
&lt;p>a fundamental truth or proposition that serves as the foundation
for a system of belief or behaviour or for a chain of reasoning.&lt;/p>
&lt;/blockquote>
&lt;p>Maybe in this case that&amp;rsquo;s a bit strong. I&amp;rsquo;d think in the case of a software
principle we&amp;rsquo;re talking more about an idea of how things should be, or a
guide&lt;sup id="fnref:1">&lt;a href="#fn:1" class="footnote-ref" role="doc-noteref">1&lt;/a>&lt;/sup> to decision making.&lt;/p>
&lt;p>But anyway. I find quite often, when seeing discussion about software, DRY
ends up being front and centre, the main focus of what someone wants to
achieve. People argue for DRY &amp;ldquo;at any cost&amp;rdquo;. Is it really worth eliminating
every ounce of repetition if the result is completely unreadable and
unmaintainable code? An answer to that could take us down the route of &amp;ldquo;DRY
done right&amp;rdquo;, &amp;ldquo;DRY done wrong&amp;rdquo;, and I&amp;rsquo;m sure there will be endless articles out
there that are titled as such. But I find that whenever you see discussion
around &amp;ldquo;principle X done right&amp;rdquo;, &amp;ldquo;principle X done wrong&amp;rdquo;, that serves as an
indicator that there&amp;rsquo;s something quite leaky about the principle. ⛲&lt;/p>
&lt;p>I think it&amp;rsquo;s better to think of DRY as an indicator that abstractions are good,
rather than something to shoot for in of itself.&lt;/p>
&lt;p>Like in Economics, &amp;ldquo;full employment&amp;rdquo; can be a sign that an economy is generally
healthy, but can&amp;rsquo;t be a goal above all else. We could employ everyone in the
postal service: we&amp;rsquo;d have full employment, but no food. I only did Economics
up to GCSE, so maybe there&amp;rsquo;s more to the story than that, but you get the
picture.&lt;/p>
&lt;p>As stupid as this comparison might be, I see this happening in software. DRY
seems to be an obsession for some developers, and then once achieved: &amp;ldquo;the
answer&amp;rdquo;.&lt;/p>
&lt;p>I wonder why this is. Perhaps because it&amp;rsquo;s easy, visible, and safe. No-one
disagrees in general that less repetition is better, so unless they know the
specifics of what you&amp;rsquo;re talking about they&amp;rsquo;re not going to disagree with you.&lt;/p>
&lt;p>I&amp;rsquo;ve seen the pursuit of DRY in absolute leave a trail of destruction in its
wake. I prefer to think of it as an indicator, or early warning signal for my
abstractions. If I see a fair amount of repetition in my code, I question if
my abstractions are quite right. If I seem to be able to express quite a lot
with very little code, and not a huge number of functions and modules, I see it
as good sign that the abstractions are about right.&lt;/p>
&lt;p>I could take verbose and repetitive code, and chop it up into loads of
functions and squirrel them away in modules &amp;ldquo;utils_1&amp;rdquo;, &amp;ldquo;utils_2&amp;rdquo;, &amp;amp;
&amp;ldquo;utils_3&amp;rdquo;, and I would have &amp;ldquo;achieved DRY&amp;rdquo;. But the code would be more all
over the place than when I started and I wouldn&amp;rsquo;t have addressed the underlying
cause of the problem: that the abstractions were just wrong.&lt;/p>
&lt;blockquote>
&lt;p>Dry can be a sign of good abstractions, but not a goal in itself.&lt;/p>
&lt;/blockquote>
&lt;p>So work on your abstractions, and the repetition will fall away as you get them
right.&lt;/p>
&lt;section class="footnotes" role="doc-endnotes">
&lt;hr>
&lt;ol>
&lt;li id="fn:1" role="doc-endnote">
&lt;p>As Captain Barbossa says: &amp;ldquo;The code is more what you&amp;rsquo;d
call guidelines than actual rules&amp;rdquo;. &lt;a href="#fnref:1" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/section></description></item><item><title>Re-Learning Haskell with Advent of Code - Part 1</title><link>https://tarquin-the-brave.github.io/blog/posts/re-learning-haskell/</link><pubDate>Sun, 29 Mar 2020 20:40:05 +0000</pubDate><guid>https://tarquin-the-brave.github.io/blog/posts/re-learning-haskell/</guid><description>&lt;p>A few years ago I learned myself a Haskell for greater good from a book &amp;ldquo;Learn
you a Haskell for greater good&amp;rdquo;&lt;sup id="fnref:1">&lt;a href="#fn:1" class="footnote-ref" role="doc-noteref">1&lt;/a>&lt;/sup> and the first few chapters of another book
&amp;ldquo;Haskell from first principles&amp;rdquo;&lt;sup id="fnref:2">&lt;a href="#fn:2" class="footnote-ref" role="doc-noteref">2&lt;/a>&lt;/sup>.&lt;/p>
&lt;p>It was fun to learn. I didn&amp;rsquo;t go onto use Haskell to build any real
applications, beyond coding up some exercises and mini programs to learn
things.&lt;/p>
&lt;p>I believe I got a lot from it. At the very least it&amp;rsquo;s joyful to solve problems
in Haskell. When I started writing Rust a year later I liked the strong type
system and the features inspired by functional languages: maps, folds, etc. It
gave me an appreciation of the benefits of immutability and pure functions. I
believe that&amp;rsquo;s fed into improving how I build things in other languages.&lt;/p>
&lt;p>A colleague told me about how they did Advent of Code&lt;sup id="fnref:3">&lt;a href="#fn:3" class="footnote-ref" role="doc-noteref">3&lt;/a>&lt;/sup> to learn Rust and a
wider group of colleagues have decided to do a couple of exercises every week,
to learn a variety of languages, and meet fortnightly to discuss approaches. I
saw this as a good opportunity to &amp;ldquo;pick up Haskell again&amp;rdquo;. So I did.&lt;/p>
&lt;p>&lt;em>This post, along with following parts, will be my log of my experiences and
the things I&amp;rsquo;m learning while going through this exercise. It&amp;rsquo;ll be littered
with wild theories, opinions, inefficient uses of code, hopefully some good
learnings, and sometimes things that are just plain wrong. I&amp;rsquo;m keen to hear
any thoughts people have or anything they can add or ask in comments. So don&amp;rsquo;t
be afraid to drop a comment or three!&lt;/em>&lt;/p>
&lt;h1 id="week-1">Week 1&lt;/h1>
&lt;h2 id="build-tooling">Build Tooling&lt;/h2>
&lt;p>First thing&amp;rsquo;s first. Build tooling. I didn&amp;rsquo;t really bother with this the last
time around. I spent most of the time playing in GHCi, the interactive Haskell
terminal, and importing most of the Haskell modules I wrote into that, rather
than compiling and running an executable.&lt;/p>
&lt;p>Over the last few years I&amp;rsquo;ve learned: first thing to do after cloning a
codebase: build it! And if you can&amp;rsquo;t rebuilt at the touch of a button, do the
work immediately to make sure you can. I&amp;rsquo;ve spent time faffing on with linking
issues with C++ applications. I&amp;rsquo;ve spent time faffing on with Python&amp;rsquo;s
dependency management, or lack thereof&lt;sup id="fnref:4">&lt;a href="#fn:4" class="footnote-ref" role="doc-noteref">4&lt;/a>&lt;/sup>. It&amp;rsquo;s not time well spent. It&amp;rsquo;s
time lost. I&amp;rsquo;ve been writing Rust at work for about a year and a half. Rust
has &lt;a href="https://doc.rust-lang.org/cargo/">cargo&lt;/a>. Cargo is phenomenal. It&amp;rsquo;s a great bit of tooling. I&amp;rsquo;ll
not lie to you: when facing technical decisions, especially around tooling, I
quite often find myself asking &amp;ldquo;WWCD?&amp;quot;, &amp;ldquo;What Would Cargo Do?&amp;quot;.&lt;/p>
&lt;p>I&amp;rsquo;m picking up a language, having build tooling that&amp;rsquo;s rock solid, and
available at the touch of a button is paramount. So before writing a line of
code, or even reading the first day&amp;rsquo;s challenge, I went looking for build
tooling.&lt;/p>
&lt;p>I did a bit of googling with phrases like &amp;ldquo;Haskell toolchain&amp;rdquo;, &amp;ldquo;Haskell build
tools comparison&amp;rdquo;, and found various resources ranging from blog posts to
official documentation. I found &lt;a href="https://lexi-lambda.github.io/blog/2018/02/10/an-opinionated-guide-to-haskell-in-2018/">this post&lt;/a> quite
informative. It purports to be &amp;ldquo;An opinionated guide&amp;rdquo;. That&amp;rsquo;s good.
Developers having opinions is good. Especially when you consider the
alternative: &lt;em>not having thoughts&lt;/em>. It&amp;rsquo;s a long document. I didn&amp;rsquo;t read
nearly half of it. But funnily enough the first section in this &amp;ldquo;guide to
Haskell&amp;rdquo;, was on build tooling. It touched on three options of cabal-install,
stack, and nix, and proceeded to do fairly good job of selling stack. Combined
with a friend telling me that &amp;ldquo;stack is the closest thing to cargo that Haskell
has got&amp;rdquo;, I was sold on stack, at least for the meantime. Nix is on my bucket
list, just not today.&lt;/p>
&lt;p>So I found and bookmarked the &lt;a href="https://docs.haskellstack.org/en/stable/README/">official documentation&lt;/a> and ran
&lt;code>stack new day1&lt;/code> to create a project for the problems in &amp;ldquo;day 1&amp;rdquo; of the Advent
of Code.&lt;/p>
&lt;h2 id="retracing-the-first-steps">Retracing the first steps&lt;/h2>
&lt;p>The problems on &lt;a href="https://adventofcode.com/2019/day/1">day 1&lt;/a> involved summing the result of applying a
function to list of integers, and then do the same with a different function.
The halves of this exercise are almost identical except for the function to
apply to each element of the list before summing the results. This sounds like
an opportunity for function currying.&lt;/p>
&lt;p>Using &lt;code>stack new&lt;/code> sets up a &lt;code>src/Lib.hs&lt;/code> and a &lt;code>app/Main.hs&lt;/code>. While not having
read up on the conventional use of these files, my guess is that &lt;code>Lib.hs&lt;/code> is
for any functionality that might become a library, keeping things as generic as
possible, and &lt;code>Main.hs&lt;/code> is for code specific to this application: where to read
the data from, error handling, etc. Although, especially for earlier problems,
this separation will be somewhat artificial. I&amp;rsquo;m not going to get too worried
about what&amp;rsquo;s in what file, but use it to get used to exporting and importing.&lt;/p>
&lt;p>I ended up with a &lt;code>Lib.hs&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#66d9ef">module&lt;/span> Lib
( &lt;span style="color:#a6e22e">tot_1&lt;/span>
, &lt;span style="color:#a6e22e">tot_2&lt;/span>
) &lt;span style="color:#66d9ef">where&lt;/span>
&lt;span style="color:#a6e22e">f&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">Integral&lt;/span> a &lt;span style="color:#f92672">=&amp;gt;&lt;/span> a &lt;span style="color:#f92672">-&amp;gt;&lt;/span> a
&lt;span style="color:#a6e22e">f&lt;/span> x &lt;span style="color:#f92672">=&lt;/span> x `div` &lt;span style="color:#ae81ff">3&lt;/span> &lt;span style="color:#f92672">-&lt;/span> &lt;span style="color:#ae81ff">2&lt;/span>
&lt;span style="color:#a6e22e">tot_1&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">Integral&lt;/span> a &lt;span style="color:#f92672">=&amp;gt;&lt;/span> [a] &lt;span style="color:#f92672">-&amp;gt;&lt;/span> a
&lt;span style="color:#a6e22e">tot_1&lt;/span> &lt;span style="color:#f92672">=&lt;/span> tot f
&lt;span style="color:#a6e22e">g&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">Integral&lt;/span> a &lt;span style="color:#f92672">=&amp;gt;&lt;/span> a &lt;span style="color:#f92672">-&amp;gt;&lt;/span> a
&lt;span style="color:#a6e22e">g&lt;/span> x
&lt;span style="color:#f92672">|&lt;/span> f x &lt;span style="color:#f92672">&amp;gt;=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span> &lt;span style="color:#f92672">=&lt;/span> f x &lt;span style="color:#f92672">+&lt;/span> g(f x)
&lt;span style="color:#f92672">|&lt;/span> otherwise &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>
&lt;span style="color:#a6e22e">tot_2&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">Integral&lt;/span> a &lt;span style="color:#f92672">=&amp;gt;&lt;/span> [a] &lt;span style="color:#f92672">-&amp;gt;&lt;/span> a
&lt;span style="color:#a6e22e">tot_2&lt;/span> &lt;span style="color:#f92672">=&lt;/span> tot g
&lt;span style="color:#a6e22e">tot&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">Integral&lt;/span> a &lt;span style="color:#f92672">=&amp;gt;&lt;/span> (a &lt;span style="color:#f92672">-&amp;gt;&lt;/span> a) &lt;span style="color:#f92672">-&amp;gt;&lt;/span> [a] &lt;span style="color:#f92672">-&amp;gt;&lt;/span> a
&lt;span style="color:#a6e22e">tot&lt;/span> f &lt;span style="color:#f92672">=&lt;/span> sum &lt;span style="color:#f92672">.&lt;/span> fmap f
&lt;/code>&lt;/pre>&lt;/div>&lt;p>, and a &lt;code>Main.hs&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#66d9ef">module&lt;/span> Main &lt;span style="color:#66d9ef">where&lt;/span>
&lt;span style="color:#66d9ef">import&lt;/span> Lib
&lt;span style="color:#66d9ef">import&lt;/span> Data.List
&lt;span style="color:#a6e22e">main&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">IO&lt;/span> ()
&lt;span style="color:#a6e22e">main&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">do&lt;/span>
contents &lt;span style="color:#f92672">&amp;lt;-&lt;/span> readFile &lt;span style="color:#e6db74">&amp;#34;inputs.txt&amp;#34;&lt;/span>
&lt;span style="color:#66d9ef">let&lt;/span> inputs &lt;span style="color:#f92672">=&lt;/span> fmap read &lt;span style="color:#f92672">.&lt;/span> lines &lt;span style="color:#f92672">$&lt;/span> contents
print &lt;span style="color:#f92672">.&lt;/span> &lt;span style="color:#66d9ef">Lib&lt;/span>&lt;span style="color:#f92672">.&lt;/span>tot_1 &lt;span style="color:#f92672">$&lt;/span> inputs
print &lt;span style="color:#f92672">.&lt;/span> &lt;span style="color:#66d9ef">Lib&lt;/span>&lt;span style="color:#f92672">.&lt;/span>tot_2 &lt;span style="color:#f92672">$&lt;/span> inputs
&lt;/code>&lt;/pre>&lt;/div>&lt;p>, having saved the inputs Advent of Code gave me to &lt;code>inputs.txt&lt;/code> (each person
gets given their own problem input).&lt;/p>
&lt;p>The function &lt;code>tot&lt;/code> takes a function and applies it to each element of a list
and sums the results. To fulfil each half of the problem I then only needed to
define the two functions to pass to &lt;code>tot&lt;/code>.&lt;/p>
&lt;p>This &lt;a href="https://adventofcode.com/2019/day/1">day 1 problem&lt;/a> gave a quick revision of:&lt;/p>
&lt;ul>
&lt;li>modules,&lt;/li>
&lt;li>do notation,&lt;/li>
&lt;li>functions composition (with &lt;code>.&lt;/code> &amp;amp; &lt;code>$&lt;/code>),&lt;/li>
&lt;li>function currying, and&lt;/li>
&lt;li>recursion.&lt;/li>
&lt;/ul>
&lt;p>Recursion ends up featuring heavily in my solutions to the first few days. I&amp;rsquo;m
not sure why, but Haskell make recursion feel like a natural way to solve
problems. I use recursion in other languages, but it always feels like I&amp;rsquo;ve
done something a bit clever.&lt;/p>
&lt;p>&lt;a href="https://adventofcode.com/2019/day/2">Day 2&lt;/a> asks you to write a basic Intcode computer which is then
extended and used in all odd day problems from day 5 onwards. I decided to
come back to this and went on to problems from days &lt;a href="https://adventofcode.com/2019/day/3">3&lt;/a>, &lt;a href="https://adventofcode.com/2019/day/4">4&lt;/a>,
&lt;a href="https://adventofcode.com/2019/day/6">6&lt;/a>, and &lt;a href="https://adventofcode.com/2019/day/8">8&lt;/a>.&lt;/p>
&lt;p>&lt;a href="https://adventofcode.com/2019/day/3">Day 3&lt;/a> involved drawing lines on a grid and working out where they
cross, my solution involved reminding myself of how to make use of:&lt;/p>
&lt;ul>
&lt;li>Defining my own types: type constructors, sum types, record syntax,&lt;/li>
&lt;li>Generating lists from infinite lists,&lt;/li>
&lt;li>&lt;code>filter&lt;/code>,&lt;/li>
&lt;li>&lt;code>foldl&lt;/code>, and&lt;/li>
&lt;li>Using lists as applicative functors,&lt;/li>
&lt;/ul>
&lt;p>without too much hassle. The solution wasn&amp;rsquo;t very efficient, but
it worked.&lt;/p>
&lt;h2 id="fun-with-folds">Fun With Folds&lt;/h2>
&lt;p>&lt;a href="https://adventofcode.com/2019/day/4">Day 4&lt;/a> introduced a simple problem of: work out the number of integers
between two numbers that:&lt;/p>
&lt;ul>
&lt;li>Have two adjacent digits that are the same, and&lt;/li>
&lt;li>Who&amp;rsquo;s digits never decrease.&lt;/li>
&lt;/ul>
&lt;p>In my solution I used function currying again. A function took a
function that applies a rule between two characters as an argument, and folded
over the digits in the numbers with &lt;code>foldl&lt;/code> to apply the rules.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#a6e22e">ruleX&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">Char&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Char&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Bool&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>In two respects, &lt;code>foldl&lt;/code> was an awkward fit:&lt;/p>
&lt;ol>
&lt;li>I didn&amp;rsquo;t care about the initial value,&lt;/li>
&lt;li>The rules can be confirmed as being broken or obeyed without having to iterate
through every element.&lt;/li>
&lt;/ol>
&lt;h3 id="no-initial-value">No Initial Value&lt;/h3>
&lt;p>The first of these points is equivalent to saying that I don&amp;rsquo;t care about applying
this fold to an empty list. Using &lt;code>foldl&lt;/code>, each time I applied a rule to the
string, I had to provide an initial character that wouldn&amp;rsquo;t cause the rule to
fail in any case. While I &amp;ldquo;got away with it&amp;rdquo; for this problem, I should find
an alternative pattern to use here to avoid a reasonably crass source of error.&lt;/p>
&lt;p>Funnily enough, I had this exact same problem when doing some work in Rust in
the week, and found &lt;a href="https://docs.rs/itertools/0.9.0/itertools/trait.Itertools.html#method.fold1">&lt;code>fold1&lt;/code>&lt;/a> from the &lt;a href="https://docs.rs/itertools/0.9.0/itertools/">itertools
crate&lt;/a> with type:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-rust" data-lang="rust">&lt;span style="color:#66d9ef">fn&lt;/span> &lt;span style="color:#a6e22e">fold1&lt;/span>&lt;span style="color:#f92672">&amp;lt;&lt;/span>F&lt;span style="color:#f92672">&amp;gt;&lt;/span>(self, f: &lt;span style="color:#a6e22e">F&lt;/span>) -&amp;gt; Option&lt;span style="color:#f92672">&amp;lt;&lt;/span>Self::Item&lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">where&lt;/span>
F: FnMut(Self::Item, Self::Item) -&amp;gt; &lt;span style="color:#a6e22e">Self&lt;/span>::Item,
Self: Sized,
&lt;/code>&lt;/pre>&lt;/div>&lt;p>If an empty list has passed in,you get a &lt;code>None&lt;/code>&lt;sup id="fnref:5">&lt;a href="#fn:5" class="footnote-ref" role="doc-noteref">5&lt;/a>&lt;/sup> back.&lt;/p>
&lt;p>Given how much Rust has borrowed from Haskell I was confident this will exist
in Haskell too.&lt;/p>
&lt;p>I found &lt;a href="https://hackage.haskell.org/package/base-4.12.0.0/docs/Prelude.html#v:foldl1">&lt;code>foldl1&lt;/code>&lt;/a> in Prelude.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#a6e22e">foldl1&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">Foldable&lt;/span> t &lt;span style="color:#f92672">=&amp;gt;&lt;/span> (a &lt;span style="color:#f92672">-&amp;gt;&lt;/span> a &lt;span style="color:#f92672">-&amp;gt;&lt;/span> a) &lt;span style="color:#f92672">-&amp;gt;&lt;/span> t a &lt;span style="color:#f92672">-&amp;gt;&lt;/span> a
&lt;/code>&lt;/pre>&lt;/div>&lt;p>It does a fold without needing an initial value but doesn&amp;rsquo;t handle empty lists.&lt;/p>
&lt;pre>&lt;code>$ stack ghci
...
*Main Lib&amp;gt; :t foldl1
foldl1 :: Foldable t =&amp;gt; (a -&amp;gt; a -&amp;gt; a) -&amp;gt; t a -&amp;gt; a
*Main Lib&amp;gt; foldl1 (+) [1,2,3]
6
*Main Lib&amp;gt; foldl1 (+) []
*** Exception: Prelude.foldl1: empty list
*Main Lib&amp;gt; :q
$
&lt;/code>&lt;/pre>&lt;p>I tried searching in &lt;a href="https://hoogle.haskell.org/">Hoogle&lt;/a> for a type like the &lt;code>fold1&lt;/code> from Rust:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#a6e22e">foldable&lt;/span> t &lt;span style="color:#f92672">=&amp;gt;&lt;/span> (a &lt;span style="color:#f92672">-&amp;gt;&lt;/span> a &lt;span style="color:#f92672">-&amp;gt;&lt;/span> a) &lt;span style="color:#f92672">-&amp;gt;&lt;/span> t a &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Maybe&lt;/span> a
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;a href="https://hackage.haskell.org/package/safe-0.3.18/docs/Safe-Foldable.html#v:foldl1May">&lt;code>foldl1May&lt;/code>&lt;/a> looks to be what I want. I&amp;rsquo;ll keep the &lt;code>safe&lt;/code> package
in mind when doing further problems. Coming from Rust I don&amp;rsquo;t have much of a
taste for these exceptions.&lt;/p>
&lt;pre>&lt;code>$ stack ghci
...
*Main Lib&amp;gt; :m + Safe.Foldable
*Main Lib Safe.Foldable&amp;gt; :t foldl1May
foldl1May :: Foldable t =&amp;gt; (a -&amp;gt; a -&amp;gt; a) -&amp;gt; t a -&amp;gt; Maybe a
*Main Lib Safe.Foldable&amp;gt; foldl1May (+) []
Nothing
*Main Lib Safe.Foldable&amp;gt; foldl1May (+) [1,2,3]
Just 6
*Main Lib Safe.Foldable&amp;gt; :q
$
&lt;/code>&lt;/pre>&lt;p>It&amp;rsquo;s good to know the nomenclature of:&lt;/p>
&lt;blockquote>
&lt;p>&amp;ldquo;Safe&amp;rdquo; means: &amp;ldquo;won&amp;rsquo;t throw an exception&amp;rdquo;&lt;/p>
&lt;/blockquote>
&lt;h3 id="bailing-early-from-a-fold">Bailing Early from a Fold&lt;/h3>
&lt;p>The second of these points, where we know the rule is either met or broken
before we&amp;rsquo;ve finished iterating over the digits of the number, basically
means that we&amp;rsquo;d like to quit iterating once we have a solid answer.&lt;/p>
&lt;p>In procedural code performing a &amp;ldquo;for loop&amp;rdquo;, a &amp;ldquo;break&amp;rdquo; statement would do
this job.&lt;/p>
&lt;p>The way I approached this was to wrap the accumulator in a &lt;code>Maybe&lt;/code> and have
the fold function &amp;ldquo;pass through&amp;rdquo; when the accumulator is &lt;code>Nothing&lt;/code>.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#a6e22e">foldFunction&lt;/span> &lt;span style="color:#f92672">::&lt;/span> (a &lt;span style="color:#f92672">-&amp;gt;&lt;/span> b &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Maybe&lt;/span> a) &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Maybe&lt;/span> a &lt;span style="color:#f92672">-&amp;gt;&lt;/span> b &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Maybe&lt;/span> a
&lt;span style="color:#a6e22e">foldFunction&lt;/span> &lt;span style="color:#66d9ef">_&lt;/span> &lt;span style="color:#66d9ef">Nothing&lt;/span> &lt;span style="color:#66d9ef">_&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">Nothing&lt;/span>
&lt;span style="color:#a6e22e">foldFunction&lt;/span> f (&lt;span style="color:#66d9ef">Just&lt;/span> acc) x &lt;span style="color:#f92672">=&lt;/span> f acc x
&lt;/code>&lt;/pre>&lt;/div>&lt;p>So as soon as &lt;code>f&lt;/code> produces a &lt;code>Nothing&lt;/code>, the fold will produce &lt;code>Nothing&lt;/code>.&lt;/p>
&lt;p>I used &lt;code>Maybe&lt;/code> because I didn&amp;rsquo;t care about the data being accumulated, I only
cared whether the fold got to the end of the list. If I cared about the data
in an &amp;ldquo;early exit&amp;rdquo; of the fold I could have used &lt;code>Either&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#a6e22e">foldFunction&amp;#39;&lt;/span> &lt;span style="color:#f92672">::&lt;/span> (a &lt;span style="color:#f92672">-&amp;gt;&lt;/span> c &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Either&lt;/span> a b) &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Either&lt;/span> a b &lt;span style="color:#f92672">-&amp;gt;&lt;/span> c &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Either&lt;/span> a b
&lt;span style="color:#a6e22e">foldFunction&amp;#39;&lt;/span> &lt;span style="color:#66d9ef">_&lt;/span> &lt;span style="color:#66d9ef">Left&lt;/span> x &lt;span style="color:#66d9ef">_&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">Left&lt;/span> x
&lt;span style="color:#a6e22e">foldFunction&amp;#39;&lt;/span> f (&lt;span style="color:#66d9ef">Right&lt;/span> acc) x &lt;span style="color:#f92672">=&lt;/span> f acc x
&lt;/code>&lt;/pre>&lt;/div>&lt;p>I was hoping the compiler would optimise out passing through &lt;code>Nothing&lt;/code> and bail
as soon as the accumulator becomes &lt;code>Nothing&lt;/code>. Then this pattern could be used
to fold over an infinite list&amp;hellip; sadly not. Say we want to quit with &lt;code>Nothing&lt;/code>
as soon as an element is found greater than &lt;code>10&lt;/code>:&lt;/p>
&lt;pre>&lt;code>*Main Lib&amp;gt; :t foldFunction
foldFunction :: (a -&amp;gt; b -&amp;gt; Maybe a) -&amp;gt; Maybe a -&amp;gt; b -&amp;gt; Maybe a
*Main Lib&amp;gt; foldl (foldFunction (\_ x-&amp;gt; if x &amp;gt; 10 then Nothing else Just x)) (Just 0) [0..10]
Just 10
*Main Lib&amp;gt; foldl (foldFunction (\_ x-&amp;gt; if x &amp;gt; 10 then Nothing else Just x)) (Just 0) [0..11]
Nothing
*Main Lib&amp;gt; foldl (foldFunction (\_ x-&amp;gt; if x &amp;gt; 10 then Nothing else Just x)) (Just 0) [0..]
^CInterrupted.
*Main Lib&amp;gt;
&lt;/code>&lt;/pre>&lt;p>UPDATE: I&amp;rsquo;ve been pointed at &lt;a href="https://hackage.haskell.org/package/base-4.12.0.0/docs/Control-Monad.html#v:foldM">&lt;code>foldM&lt;/code>&lt;/a> from &lt;a href="https://hackage.haskell.org/package/base-4.12.0.0/docs/Control-Monad.html">&lt;code>Control.Monad&lt;/code>&lt;/a>.
The above can be written as:&lt;/p>
&lt;pre>&lt;code>*Main Lib&amp;gt; :m + Control.Monad
*Main Lib Control.Monad&amp;gt; :t foldM
foldM :: (Foldable t, Monad m) =&amp;gt; (b -&amp;gt; a -&amp;gt; m b) -&amp;gt; b -&amp;gt; t a -&amp;gt; m b
*Main Lib Control.Monad&amp;gt; foldM (\_ x -&amp;gt; if x &amp;gt; 10 then Nothing else Just x) 0 [0..10]
Just 10
*Main Lib Control.Monad&amp;gt; foldM (\_ x -&amp;gt; if x &amp;gt; 10 then Nothing else Just x) 0 [0..11]
Nothing
*Main Lib Control.Monad&amp;gt; foldM (\_ x -&amp;gt; if x &amp;gt; 10 then Nothing else Just x) 0 [0..]
Nothing
*Main Lib Control.Monad&amp;gt;
&lt;/code>&lt;/pre>&lt;p>Interestingly &lt;a href="https://hackage.haskell.org/package/base-4.12.0.0/docs/Control-Monad.html#v:foldM">&lt;code>foldM&lt;/code>&lt;/a> has this &amp;ldquo;early exit&amp;rdquo;, as you can see it returned
&lt;code>Nothing&lt;/code> when ran on the infinite list &lt;code>[0..]&lt;/code>.&lt;/p>
&lt;p>In my case, I wasn&amp;rsquo;t actually bothered about the accumulator value whether the
fold bailed early or not. In that case I could have used &lt;a href="https://hackage.haskell.org/package/base-4.12.0.0/docs/Control-Monad.html#v:foldM_">&lt;code>foldM_&lt;/code>&lt;/a>.&lt;/p>
&lt;pre>&lt;code>*Main Lib Control.Monad&amp;gt; foldM_ (\_ x -&amp;gt; if x &amp;gt; 10 then Nothing else Just x) 0 [0..10]
Just ()
*Main Lib Control.Monad&amp;gt; foldM_ (\_ x -&amp;gt; if x &amp;gt; 10 then Nothing else Just x) 0 [0..11]
Nothing
*Main Lib Control.Monad&amp;gt; foldM_ (\_ x -&amp;gt; if x &amp;gt; 10 then Nothing else Just x) 0 [0..]
Nothing
*Main Lib Control.Monad&amp;gt;
&lt;/code>&lt;/pre>&lt;p>Looking at our &lt;code>foldFunction&lt;/code> above, it&amp;rsquo;s actually a reimplementation of &lt;code>&amp;gt;&amp;gt;=&lt;/code>
from the &lt;a href="http://hackage.haskell.org/package/base-4.12.0.0/docs/src/GHC.Base.html#line-854">implementation of the Monad typeclass for Maybe&lt;/a>.&lt;/p>
&lt;p>It&amp;rsquo;s interesting that &lt;code>foldM&lt;/code> was able to do this &amp;ldquo;early exit&amp;rdquo; but &lt;code>foldl&lt;/code>
wasn&amp;rsquo;t. I&amp;rsquo;ll have to look at the source code and see if I can work out why.&lt;/p>
&lt;p>Having a fold that can bail is a powerful pattern when combined with infinite
lists. I&amp;rsquo;ll remember this one.&lt;/p>
&lt;h2 id="trees">Trees&lt;/h2>
&lt;p>&lt;a href="https://adventofcode.com/2019/day/6">Day 6&lt;/a> was all about tree structures.&lt;/p>
&lt;p>The problem is presented as: &amp;ldquo;you&amp;rsquo;re given a bunch of data on which planetary bodies
orbit which&amp;rdquo;, with an implication of there being an orbiter and orbitee. In Physics
this would be the model for when one body is much more massive than the other.
We think of the Moon orbiting the Earth, when really they&amp;rsquo;re a binary pair orbiting
a common centre of mass. You&amp;rsquo;re then asked to count the total number of direct and
indirect orbits (orbiting something via orbiting something that&amp;rsquo;s orbiting it).
This problem was going to be about finding the data
structure that best describes the overall system and using it.&lt;/p>
&lt;p>My first thought was &amp;ldquo;Tree or DAG&lt;sup id="fnref:6">&lt;a href="#fn:6" class="footnote-ref" role="doc-noteref">6&lt;/a>&lt;/sup>?&amp;quot;. A generic Graph could be ruled out as:
C orbiting B, orbiting A, orbiting C, is nonsense. Try and draw it on a piece of
paper. To decide &amp;ldquo;Tree or DAG&amp;rdquo; I though about if a &amp;ldquo;diamond shape&amp;rdquo; made sense.
I.e. D orbiting C &amp;amp; B, which are both orbiting A. Trying to draw this on a piece
of paper showed that a &amp;ldquo;diamond shape&amp;rdquo; wouldn&amp;rsquo;t work in general, as in the model,
a body can&amp;rsquo;t orbit two other bodies. Tree it is!&lt;/p>
&lt;p>Any number of bodies can be orbiting a body, so we want a tree where a node can
point to any number of subtrees. &lt;a href="https://hackage.haskell.org/package/containers-0.6.2.1/docs/Data-Tree.html">&lt;code>Data.Tree&lt;/code>&lt;/a> fits the bill.&lt;/p>
&lt;p>The input data was a file listing all the orbits. So for B &amp;amp; C orbiting A, and D
orbiting C the input data would look like:&lt;/p>
&lt;pre>&lt;code>A)B
A)C
C)D
&lt;/code>&lt;/pre>&lt;p>&lt;code>)&lt;/code> means &amp;ldquo;is orbited by&amp;rdquo; so:&lt;/p>
&lt;blockquote>
&lt;p>A is orbited by B. A is orbited by C. C is orbited by D.&lt;/p>
&lt;/blockquote>
&lt;p>In the nomenclature of this problem, D is &amp;ldquo;indirectly orbiting&amp;rdquo; A. A could be the Sun,
B could be Venus, C could be the Earth, D would then be the Moon.&lt;/p>
&lt;p>From the giant input I was given, I didn&amp;rsquo;t know whether there was going to be more
than one &amp;ldquo;root&amp;rdquo;/&amp;ldquo;orbital centre&amp;rdquo;, so I&amp;rsquo;d need to use a &lt;a href="https://hackage.haskell.org/package/containers-0.6.2.1/docs/Data-Tree.html#t:Forest">forest&lt;/a>, which in
&lt;code>Data.Tree&lt;/code> is just a type alias for a list of trees.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#66d9ef">type&lt;/span> &lt;span style="color:#66d9ef">Forest&lt;/span> a &lt;span style="color:#f92672">=&lt;/span> [&lt;span style="color:#66d9ef">Tree&lt;/span> a]
&lt;/code>&lt;/pre>&lt;/div>&lt;p>In my solution I was able to put the input data into a forest with
&lt;a href="https://hackage.haskell.org/package/containers-0.6.2.1/docs/Data-Tree.html#v:unfoldForest">&lt;code>unfoldForest&lt;/code>&lt;/a>.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#a6e22e">unfoldForest&lt;/span> &lt;span style="color:#f92672">::&lt;/span> (b &lt;span style="color:#f92672">-&amp;gt;&lt;/span> (a, [b])) &lt;span style="color:#f92672">-&amp;gt;&lt;/span> [b] &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Forest&lt;/span> a
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>b&lt;/code> is the type of the &amp;ldquo;seed values&amp;rdquo;. A &amp;ldquo;seed value&amp;rdquo; is a value from which a node
can be generated. To build the &lt;code>Forest&lt;/code>: &lt;code>unfoldForest&lt;/code> (and similarly &lt;code>unfoldTree&lt;/code>),
take a function that takes a seed value and produces the node data and a list of
seed values for all subtrees from the node. &lt;code>unfoldForest&lt;/code> then takes a list of seed
values for the roots of the trees in the forest, whereas &lt;code>unfoldTree&lt;/code> take a single
seed value.&lt;/p>
&lt;p>I&amp;rsquo;d split the input data into a list of tuples of &lt;code>String&lt;/code>s where the first element
of the tuple was the orbitee and the second was the orbiter.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#a6e22e">parseOrbit&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">String&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> (&lt;span style="color:#66d9ef">String&lt;/span>, &lt;span style="color:#66d9ef">String&lt;/span>)
&lt;/code>&lt;/pre>&lt;/div>&lt;p>In this case, both types &lt;code>a&lt;/code> and &lt;code>b&lt;/code> in &lt;code>unfoldForest&lt;/code> will find the concrete
type of &lt;code>String&lt;/code>. Both the seed value and the node data will just be the name
of the body given in the data.&lt;/p>
&lt;p>First I needed to find what the initial seed values, the roots, were in the data.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#75715e">-- Which bodies do not orbit anything?&lt;/span>
&lt;span style="color:#a6e22e">roots&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">Eq&lt;/span> a &lt;span style="color:#f92672">=&amp;gt;&lt;/span> [(a,a)] &lt;span style="color:#f92672">-&amp;gt;&lt;/span> [a]
&lt;span style="color:#a6e22e">roots&lt;/span> orbits &lt;span style="color:#f92672">=&lt;/span> [x &lt;span style="color:#f92672">|&lt;/span> (x, y) &lt;span style="color:#f92672">&amp;lt;-&lt;/span> orbits, notElem x &lt;span style="color:#f92672">.&lt;/span> fmap snd &lt;span style="color:#f92672">$&lt;/span> orbits]
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Then, given the orbit data, I was able to describe the &amp;ldquo;unfold function&amp;rdquo;.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#75715e">-- Given the orbit data, what orbits a given body?&lt;/span>
&lt;span style="color:#a6e22e">forestBuilder&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">Eq&lt;/span> a &lt;span style="color:#f92672">=&amp;gt;&lt;/span> [(a,a)] &lt;span style="color:#f92672">-&amp;gt;&lt;/span> a &lt;span style="color:#f92672">-&amp;gt;&lt;/span> (a,[a])
&lt;span style="color:#a6e22e">forestBuilder&lt;/span> orbits body &lt;span style="color:#f92672">=&lt;/span> (body, [snd orbit &lt;span style="color:#f92672">|&lt;/span> orbit &lt;span style="color:#f92672">&amp;lt;-&lt;/span> orbits, body &lt;span style="color:#f92672">==&lt;/span> fst orbit])
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>forestBuilder orbits&lt;/code> would give our &amp;ldquo;unfold function&amp;rdquo;.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#a6e22e">orbits&lt;/span> &lt;span style="color:#f92672">::&lt;/span> [(&lt;span style="color:#66d9ef">String&lt;/span>, &lt;span style="color:#66d9ef">String&lt;/span>)]
&lt;span style="color:#a6e22e">unfoldFunction&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">String&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> (&lt;span style="color:#66d9ef">String&lt;/span>, [&lt;span style="color:#66d9ef">String&lt;/span>])
&lt;span style="color:#a6e22e">unfoldFunction&lt;/span> &lt;span style="color:#f92672">=&lt;/span> forestBuilder orbits
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Stringing that together, we can load the input data into a forest:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#a6e22e">main&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">do&lt;/span>
contents &lt;span style="color:#f92672">&amp;lt;-&lt;/span> fmap lines &lt;span style="color:#f92672">.&lt;/span> readFile &lt;span style="color:#f92672">$&lt;/span> &lt;span style="color:#e6db74">&amp;#34;input.txt&amp;#34;&lt;/span>
&lt;span style="color:#66d9ef">let&lt;/span> orbits &lt;span style="color:#f92672">=&lt;/span> fmap parseOrbit contents
&lt;span style="color:#66d9ef">let&lt;/span> myForest &lt;span style="color:#f92672">=&lt;/span> unfoldForest (forestBuilder orbits) (roots orbits)
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Now the data is loaded into a &lt;code>Forest&lt;/code>, I want to walk through the forest and
count how many steps from the root each node is. Summing all those will give
us the number of direct and indirect orbits.&lt;/p>
&lt;p>I was hoping to, symmetrically, use &lt;a href="https://hackage.haskell.org/package/containers-0.6.2.1/docs/Data-Tree.html#g:3">&lt;code>foldTree&lt;/code>&lt;/a> to get the answer.&lt;/p>
&lt;p>I couldn&amp;rsquo;t see how to do it with &lt;code>foldTree&lt;/code>. I had &lt;code>Tree String&lt;/code> where the
string data was wholly uninteresting when counting the number of orbits
as I wanted to sum the depths of each node. The type signature of
&lt;code>foldTree&lt;/code> appears to want a function that uses the node values:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#a6e22e">foldTree&lt;/span> &lt;span style="color:#f92672">::&lt;/span> (a &lt;span style="color:#f92672">-&amp;gt;&lt;/span> [b] &lt;span style="color:#f92672">-&amp;gt;&lt;/span> b) &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Tree&lt;/span> a &lt;span style="color:#f92672">-&amp;gt;&lt;/span> b
&lt;/code>&lt;/pre>&lt;/div>&lt;p>I ended up splitting the &lt;code>Tree&lt;/code> into its &amp;ldquo;levels&amp;rdquo; with &lt;a href="https://hackage.haskell.org/package/containers-0.6.2.1/docs/Data-Tree.html#v:levels">&lt;code>levels&lt;/code>&lt;/a>
and then folding over that.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#a6e22e">levels&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">Tree&lt;/span> a &lt;span style="color:#f92672">-&amp;gt;&lt;/span> [[a]]
&lt;span style="color:#a6e22e">sumDepthsTree&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">Integral&lt;/span> b &lt;span style="color:#f92672">=&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">Tree&lt;/span> a &lt;span style="color:#f92672">-&amp;gt;&lt;/span> b
&lt;span style="color:#a6e22e">sumDepthsTree&lt;/span> &lt;span style="color:#f92672">=&lt;/span> snd &lt;span style="color:#f92672">.&lt;/span> foldl foldFunc (&lt;span style="color:#ae81ff">0&lt;/span>, &lt;span style="color:#ae81ff">0&lt;/span>) &lt;span style="color:#f92672">.&lt;/span> levels
&lt;span style="color:#a6e22e">foldFunc&lt;/span> &lt;span style="color:#f92672">::&lt;/span> &lt;span style="color:#66d9ef">Integral&lt;/span> a &lt;span style="color:#f92672">=&amp;gt;&lt;/span> (a,a) &lt;span style="color:#f92672">-&amp;gt;&lt;/span> [b] &lt;span style="color:#f92672">-&amp;gt;&lt;/span> (a,a)
&lt;span style="color:#a6e22e">foldFunc&lt;/span> (depth, acc) x &lt;span style="color:#f92672">=&lt;/span> (depth &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>, acc &lt;span style="color:#f92672">+&lt;/span> depth &lt;span style="color:#f92672">*&lt;/span> genericLength x)
&lt;/code>&lt;/pre>&lt;/div>&lt;p>I used a tuple accumulator to record the depth (i.e. the index within &lt;code>levels mytree&lt;/code> and the accumulating sum of the depths).&lt;/p>
&lt;p>That was enough to give me the answer to the first part of &lt;a href="https://adventofcode.com/2019/day/6">Day 6&lt;/a>. In
writing this I&amp;rsquo;ve just realised there&amp;rsquo;s a second half to the problem that I
missed before which looks like it&amp;rsquo;s asking you to calculate how many steps it
takes to get from one tree node to another. I&amp;rsquo;ll come back to this at some
point and add to my solution.&lt;/p>
&lt;h2 id="no-editor-integration-yet">No Editor Integration Yet&lt;/h2>
&lt;p>Interestingly, I didn&amp;rsquo;t setup any editor integration for Haskell in this first
week.&lt;/p>
&lt;p>While my applications are only being split between &lt;code>src/Lib.hs&lt;/code> &amp;amp;
&lt;code>app/Main.hs&lt;/code>, and I can search on &lt;a href="https://hoogle.haskell.org/">Hoogle&lt;/a>, I&amp;rsquo;ve not felt like I need
it.&lt;/p>
&lt;p>The syntax is fairly minimal, so I haven&amp;rsquo;t needed an editor to write code for
me, and it is readable as text. NeoVim gives me Haskell syntax highlighting
out of the box and I&amp;rsquo;m yet to need any of the IDE level functionality.&lt;/p>
&lt;p>I&amp;rsquo;ve blogged before about how &lt;a href="https://tarquin-the-brave.github.io/blog/posts/ide-read-code/">you shouldn&amp;rsquo;t need an IDE to read
code&lt;/a> as code should be &amp;ldquo;readable as text&amp;rdquo;, and I&amp;rsquo;m pleased that
Haskell is living up to that.&lt;/p>
&lt;p>I&amp;rsquo;ll keep rolling with syntax highlighting and nothing else for now. If I need
to get some better integration I&amp;rsquo;ll look at installing a Haskell language
server&lt;sup id="fnref:7">&lt;a href="#fn:7" class="footnote-ref" role="doc-noteref">7&lt;/a>&lt;/sup> and hooking NeoVim&amp;rsquo;s &lt;a href="https://github.com/autozimu/LanguageClient-neovim">language server
client&lt;/a> to it.&lt;/p>
&lt;h2 id="packaging-and-modules">Packaging and Modules&lt;/h2>
&lt;p>The simplest way to import functions from a module is to do:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#66d9ef">import&lt;/span> Lib
&lt;span style="color:#66d9ef">import&lt;/span> Data.Sequence
&lt;/code>&lt;/pre>&lt;/div>&lt;p>This pulls in the functions exported by those modules into the current
namespace.&lt;/p>
&lt;p>Importing like this makes code harder to &amp;ldquo;read as text&amp;rdquo; as when you see a
function, where it&amp;rsquo;s come from is not explicit in code. You&amp;rsquo;d have to look
through what each module you import exports to find the function you&amp;rsquo;re using.&lt;/p>
&lt;p>This can be fixed by importing only specific functions:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#66d9ef">import&lt;/span> Lib (&lt;span style="color:#a6e22e">someFunc&lt;/span>)
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Now only the &lt;code>someFunc&lt;/code> function will be imported from &lt;code>Lib&lt;/code>.&lt;/p>
&lt;p>Collisions between functions imported from different libraries and Prelude can
be resolved with qualified imports:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#66d9ef">import&lt;/span> quailfied &lt;span style="color:#66d9ef">Lib&lt;/span> as &lt;span style="color:#66d9ef">L&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Then every function from &lt;code>Lib&lt;/code> is callable as &lt;code>L.someFunc&lt;/code>.&lt;/p>
&lt;p>These can be combined to do qualified imports and be explicit about the
functions imported:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-haskell" data-lang="haskell">&lt;span style="color:#66d9ef">import&lt;/span> &lt;span style="color:#66d9ef">qualified&lt;/span> Lib &lt;span style="color:#66d9ef">as&lt;/span> L (someFunc)
&lt;/code>&lt;/pre>&lt;/div>&lt;p>, again resulting in &lt;code>someFunc&lt;/code> being callable as &lt;code>L.someFunc&lt;/code>.&lt;/p>
&lt;p>In order to keep my code as explicit as possible, and thus as &amp;ldquo;readable as
code&amp;rdquo; as possible, I&amp;rsquo;m going to use this as a convention from now on. I&amp;rsquo;ll
also try to read some open source Haskell to see if the wider community has a
convention on this.&lt;/p>
&lt;p>This may end up being laborious. In Rust, importing is &lt;em>explicit&lt;/em> in this way,
but a large amount of functionality is held in methods implemented on
structures and in traits. You only have to import the &lt;code>struct&lt;/code> or &lt;code>trait&lt;/code> to
get the methods. In Haskell, as everything is a function, I&amp;rsquo;ll need to import
each function explicitly.&lt;/p>
&lt;p>If I end up giving up on this as a convention I&amp;rsquo;ll look into integrating a
Haskell language server&lt;sup id="fnref:7">&lt;a href="#fn:7" class="footnote-ref" role="doc-noteref">7&lt;/a>&lt;/sup> into my editor to give me the &amp;ldquo;go to definition&amp;rdquo;
and all those goodies.&lt;/p>
&lt;h2 id="summary">Summary&lt;/h2>
&lt;p>Doing some of the first few &lt;a href="https://adventofcode.com/">Advent of Code&lt;/a> problems was good for
revising and refining some of the basics. I reckon I could churn through all
of the problems using the basic tools I know how to use: list manipulation,
recursion, functors, applicative functors, etc. But, I want to go away and do
some wider reading before continuing so I can really level up my Haskell.&lt;/p>
&lt;p>My general feelings about Haskell thus far, learning it for the second time:&lt;/p>
&lt;ul>
&lt;li>I&amp;rsquo;m enjoying the purity and clean syntax.&lt;/li>
&lt;li>I&amp;rsquo;m enjoying using the word &amp;ldquo;function&amp;rdquo; without feeling a little guilty.&lt;/li>
&lt;li>Compared to Rust, Haskell is more implicit. It appears there&amp;rsquo;s ways of being
totally explicit about things and I&amp;rsquo;ll look to do that. Maybe with a bit
more experience I&amp;rsquo;ll relax a little bit.&lt;/li>
&lt;li>I haven&amp;rsquo;t fully learned how the packaging works yet, I&amp;rsquo;ll feel more
comfortable when I have. One thing I don&amp;rsquo;t know is how you find out what
&amp;ldquo;package&amp;rdquo; a module is found in.&lt;/li>
&lt;li>It seems to be the way to search for &amp;ldquo;I need a thing that does this&amp;rdquo; is to
know what type signature you&amp;rsquo;re looking for is, and type that into the search
bar on &lt;a href="https://hoogle.haskell.org/">Hoogle&lt;/a>.&lt;/li>
&lt;li>There seems to be a lot of different ways to do the same thing, and I&amp;rsquo;m not
sure yet where to find advice on what good approaches are.&lt;/li>
&lt;/ul>
&lt;p>I&amp;rsquo;ll go do some reading, then come back to these problems.&lt;/p>
&lt;p>&lt;a href="https://tarquin-the-brave.github.io/blog/posts/re-learning-haskell-2/">&lt;strong>Re-learning Haskell with Advent Of Code - Part 2&lt;/strong>&lt;/a>&lt;/p>
&lt;section class="footnotes" role="doc-endnotes">
&lt;hr>
&lt;ol>
&lt;li id="fn:1" role="doc-endnote">
&lt;p>Learn you a Haskell for greater good. &lt;a href="http://learnyouahaskell.com/chapters">http://learnyouahaskell.com/chapters&lt;/a> &lt;a href="#fnref:1" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:2" role="doc-endnote">
&lt;p>Haskell from first principles. &lt;a href="https://haskellbook.com/">https://haskellbook.com/&lt;/a> &lt;a href="#fnref:2" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:3" role="doc-endnote">
&lt;p>Advent of code provided a coding challenge on each day of December. &lt;a href="#fnref:3" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:4" role="doc-endnote">
&lt;p>&lt;a href="https://python-poetry.org/">Poetry&lt;/a> does quite a good job of Python dependency management.
It&amp;rsquo;s not totally watertight, but it&amp;rsquo;s a huge improvement on &lt;a href="https://pypi.org/project/pip/">pip&lt;/a> &amp;amp; &lt;a href="https://pipenv-fork.readthedocs.io/en/latest/">Pipenv&lt;/a>
to which my derision is directed. And Poetry has a very pretty website. &lt;a href="#fnref:4" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:5" role="doc-endnote">
&lt;p>Rust&amp;rsquo;s &lt;code>Option&amp;lt;T&amp;gt;&lt;/code> (with variants &lt;code>Some&amp;lt;T&amp;gt;&lt;/code> &amp;amp; &lt;code>None&lt;/code>) enum is equivalent to Haskell&amp;rsquo;s &lt;code>Maybe T&lt;/code>
with &lt;code>Just T&lt;/code> and &lt;code>Nothing&lt;/code>. &lt;a href="#fnref:5" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:6" role="doc-endnote">
&lt;p>DAG: Direct Acyclic Graph: &lt;a href="https://en.wikipedia.org/wiki/Directed_acyclic_graph">https://en.wikipedia.org/wiki/Directed_acyclic_graph&lt;/a> &lt;a href="#fnref:6" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:7" role="doc-endnote">
&lt;p>I&amp;rsquo;ve found &lt;a href="https://github.com/haskell/haskell-language-server">Haskell language server&lt;/a>, but as the README says, it&amp;rsquo;s in &amp;ldquo;early stages&amp;rdquo;. &lt;a href="#fnref:7" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/section></description></item><item><title>Itertools - A Force for Good?</title><link>https://tarquin-the-brave.github.io/blog/posts/iterttools/</link><pubDate>Sat, 28 Mar 2020 12:52:30 +0000</pubDate><guid>https://tarquin-the-brave.github.io/blog/posts/iterttools/</guid><description>&lt;p>Itertools are a way of bringing along a bunch of list manipulating goodies from
functional languages into procedural languages. I&amp;rsquo;ve encountered it as a
&lt;a href="https://docs.python.org/3.8/library/itertools.html">Python library&lt;/a> and a &lt;a href="https://docs.rs/itertools/0.9.0/itertools/trait.Itertools.html">Rust crate&lt;/a>. A quick bit
of google&amp;rsquo;ing shows some evidence of this existing in other languages.&lt;/p>
&lt;p>I used to write Python a lot. Now I write mostly Rust. I used to err on the
side of not using &lt;code>itertools&lt;/code> in Python. I&amp;rsquo;m more than happy to read or write
Rust code using &lt;code>itertools&lt;/code>. The reasons why are about audience buy in, how
effectively are you communicating an idea, and ultimately what effect does it
have on people&amp;rsquo;s ability to reason about your code.&lt;/p>
&lt;p>For a Rust developer, coming across the &lt;a href="https://docs.rs/itertools/0.9.0/itertools/trait.Itertools.html">Itertools crate&lt;/a> doesn&amp;rsquo;t
require a big leap of understanding. The &lt;code>Itertools&lt;/code> trait is merely an
extension to the &lt;a href="https://doc.rust-lang.org/std/iter/trait.Iterator.html">&lt;code>Iterator&lt;/code> trait&lt;/a> from the standard library which
has methods for the likes of &lt;code>map&lt;/code>, &lt;code>fold&lt;/code>, &lt;code>filter&lt;/code>, &lt;code>chain&lt;/code>, etc. These
concepts from functional languages are already first class citizens in Rust.
You don&amp;rsquo;t need the reader to cross that conceptual bridge of &amp;ldquo;what&amp;rsquo;s wrong with
a for loop?&amp;quot;, they&amp;rsquo;re already across with you. Rust is explicit about how
values are passed to functions (by reference/by value, mutably/immutably), and
imposes borrowing rules. This means you can iterate with confidence. Also,
Rust is strongly typed and has fantastic documentation as a core tenet of the
language. This mean that even if there are some concepts introduced that you
don&amp;rsquo;t quite understand, or you don&amp;rsquo;t quite follow an example of a method from
the documentation: you can trust the type, and the compiler will tell you if
you&amp;rsquo;ve misunderstood. If you&amp;rsquo;re reading code, and your not all that familiar
with the concept behind a method, you can can still reason about how data is
being manipulated by reading the type declaration of the function.&lt;/p>
&lt;p>In Python, on the other hand, using &lt;a href="https://docs.python.org/3.8/library/itertools.html">&lt;code>itertools&lt;/code>&lt;/a> and
&lt;a href="https://docs.python.org/3/library/functools.html">&lt;code>functools&lt;/code>&lt;/a> introduces functional concepts&lt;sup id="fnref:1">&lt;a href="#fn:1" class="footnote-ref" role="doc-noteref">1&lt;/a>&lt;/sup>, which are a
whole new dimension to the language. The nature of the language (duck-typed,
implicit about how values are passed, and runtime evaluated) doesn&amp;rsquo;t give the
same safety net and leg up to those not already very familiar with the concepts
at play and the pitfalls of their implementation in Python. It&amp;rsquo;ll depend a
little on what the particular community who you share a codebase with are like,
but there&amp;rsquo;s likely to be a reasonable proportion of Python developers who don&amp;rsquo;t
necessarily know what you&amp;rsquo;ve done. For them: you&amp;rsquo;ve taken something that could
have been expressed in a few lines, and tucked it away behind a word they
haven&amp;rsquo;t seen before. And then when they do learn what that method is doing,
it&amp;rsquo;s not like they can abstract over that forever more.&lt;/p>
&lt;p>Functional languages can have all this wonderful functionality abstracted away
into single words (&lt;code>fold&lt;/code>, &lt;code>intercalate&lt;/code>, &amp;hellip;) because data is immutable and
functions don&amp;rsquo;t have side effects. Once you&amp;rsquo;ve learned how a particular
function works, you can let it do its thing. Maybe you pop back to glance at
the type signature (if it has one) from time to time, but mostly you know: it
does a thing, you can abstract over it with confidence.&lt;/p>
&lt;p>Rust does quite a special thing of allowing mutation, but provide a mechanism
where that mutation is explicit and the type system provides enough confidence
that you can make abstractions safely.&lt;/p>
&lt;p>An example that a friend sent me recently, which isn&amp;rsquo;t specifically about
&lt;code>itertools&lt;/code> or &lt;code>functools&lt;/code> but is an example of where these lower level details
that are hidden from the syntax really can catch you out. Lambda
functions create anonymous functions in-line, and are equivalent to
defining a function elsewhere and calling it.&lt;/p>
&lt;pre>&lt;code>$ python3
Python 3.6.9 (default, Nov 7 2019, 10:44:02)
[GCC 8.3.0] on linux
Type &amp;quot;help&amp;quot;, &amp;quot;copyright&amp;quot;, &amp;quot;credits&amp;quot; or &amp;quot;license&amp;quot; for more information.
&amp;gt;&amp;gt;&amp;gt; x = 4
&amp;gt;&amp;gt;&amp;gt; x
4
&amp;gt;&amp;gt;&amp;gt; x = lambda: 4
&amp;gt;&amp;gt;&amp;gt; x
&amp;lt;function &amp;lt;lambda&amp;gt; at 0x7f6b8665abf8&amp;gt;
&amp;gt;&amp;gt;&amp;gt; x()
4
&amp;gt;&amp;gt;&amp;gt;
&lt;/code>&lt;/pre>&lt;p>Assign an anonymous function to &lt;code>x&lt;/code> and then call it. Happy with that. Last
week, a friend of mine sent me this:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">[x() &lt;span style="color:#66d9ef">for&lt;/span> x &lt;span style="color:#f92672">in&lt;/span> [&lt;span style="color:#66d9ef">lambda&lt;/span>: i &lt;span style="color:#66d9ef">for&lt;/span> i &lt;span style="color:#f92672">in&lt;/span> range(&lt;span style="color:#ae81ff">0&lt;/span>,&lt;span style="color:#ae81ff">3&lt;/span>)]]
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Let&amp;rsquo;s see what that does:&lt;/p>
&lt;pre>&lt;code>&amp;gt;&amp;gt;&amp;gt; [x() for x in [lambda: i for i in range(0,3)]]
[2, 2, 2]
&lt;/code>&lt;/pre>&lt;p>Wat? Let&amp;rsquo;s try building up to that:&lt;/p>
&lt;pre>&lt;code>&amp;gt;&amp;gt;&amp;gt; [i for i in range(0,3)]
[0, 1, 2]
&amp;gt;&amp;gt;&amp;gt; [x for x in [i for i in range(0,3)]]
[0, 1, 2]
&amp;gt;&amp;gt;&amp;gt; [x for x in [lambda: i for i in range(0,3)]]
[&amp;lt;function &amp;lt;listcomp&amp;gt;.&amp;lt;lambda&amp;gt; at 0x7f6b8665ad90&amp;gt;, &amp;lt;function &amp;lt;listcomp&amp;gt;.&amp;lt;lambda&amp;gt; at 0x7f6b8665ae18&amp;gt;, &amp;lt;function &amp;lt;listcomp&amp;gt;.&amp;lt;lambda&amp;gt; at 0x7f6b8665aea0&amp;gt;]
&amp;gt;&amp;gt;&amp;gt; [x() for x in [lambda: i for i in range(0,3)]]
[2, 2, 2]
&amp;gt;&amp;gt;&amp;gt;
&lt;/code>&lt;/pre>&lt;p>Wat?&lt;/p>
&lt;p>When I worked in Python a lot I would see this sort of thing happen all the
time. Either you couldn&amp;rsquo;t understand why your code wasn&amp;rsquo;t doing the simple
thing you were expressing, or worse, committed code was silently doing the
wrong thing causing an error at the opposite end of the application. To figure
out what&amp;rsquo;s going on you have to context switch out of the &amp;ldquo;higher level&amp;rdquo; world
you&amp;rsquo;ve been happily reading and writing code in, remind yourself about how each
thing works behind the scenes and attempt to reason it through.&lt;/p>
&lt;p>This is why I think Python is a bit self defeating. To be great at Python, to
read Python and understand what it&amp;rsquo;s really doing, to write Python that works
and is performant, you need an understanding of what&amp;rsquo;s going on behind the
scenes. But the whole point of Python is that it&amp;rsquo;s a higher level language.
The main beauty of it for me, is that someone who doesn&amp;rsquo;t know any programming
languages can read it and have a decent guess at what&amp;rsquo;s going on. It&amp;rsquo;s code in
plain English. But to get good you need to learn about what&amp;rsquo;s going on behind
the scenes. Python isn&amp;rsquo;t going to teach you those things. You&amp;rsquo;d need to learn
those things in another, supposedly &amp;ldquo;lower level&amp;rdquo;, language and bring those
learnings back into your Python.&lt;/p>
&lt;p>Because you have to keep these lower level details in your mind when working
with Python, with mutability and how values are passed being implicit, you
can&amp;rsquo;t abstract with confidence. These functional goodies from &lt;code>itertools&lt;/code> and
&lt;code>functools&lt;/code> lose their power and run the risk of becoming more &amp;ldquo;complexity
hiding&amp;rdquo; than good abstractions.&lt;/p>
&lt;p>Were I to go back to writing Python regularly I would probably look to make use
of &lt;code>itertools&lt;/code> &amp;amp; &lt;code>functools&lt;/code> as I reckon I&amp;rsquo;d probably write more bugs if I were
to write it out in loops manually. But I&amp;rsquo;d only do it with buy in from
everyone I was working on that Python project with, and I&amp;rsquo;d keep some notes
around about what the methods I&amp;rsquo;m using are doing under the covers for the time
when I inevitably trip up.&lt;/p>
&lt;p>So are &amp;ldquo;Itertools&amp;rdquo; a force for good in the world. Yes, provided the language
can provide the guarantees that make the abstractions safe and powerful.&lt;/p>
&lt;section class="footnotes" role="doc-endnotes">
&lt;hr>
&lt;ol>
&lt;li id="fn:1" role="doc-endnote">
&lt;p>A &lt;a href="https://skerritt.blog/learn-functional-python-in-10-minutes/">blog post&lt;/a> that gives a quick run through of using
functional concepts in Python. It&amp;rsquo;s much more approachable
than the &lt;a href="https://docs.python.org/3/howto/functional.html">official docs&lt;/a> I like how the author presents
it as &amp;ldquo;here are some things you &lt;em>can&lt;/em> do, I&amp;rsquo;m not saying you
&lt;em>should&lt;/em> use any of them&amp;rdquo;. And they cover how functional
patterns are considered &amp;ldquo;not Pythonic&amp;rdquo; by some&amp;hellip; Not that
someone waving a magic word like &lt;em>Pythonic&lt;/em> in your face should
ever stop you from doing anything. &lt;a href="#fnref:1" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/section></description></item><item><title>Rust - Converting between file formats - JSON, YAML, &amp; TOML</title><link>https://tarquin-the-brave.github.io/blog/posts/rust-serde/</link><pubDate>Thu, 26 Mar 2020 21:00:00 +0000</pubDate><guid>https://tarquin-the-brave.github.io/blog/posts/rust-serde/</guid><description>&lt;p>Rust&amp;rsquo;s &lt;a href="https://crates.io/crates/serde">&lt;code>serde&lt;/code> library&lt;/a> is a generic serialize-deserialize framework
that has been implemented for &lt;a href="https://docs.serde.rs/serde/#data-formats">many file formats&lt;/a>. It&amp;rsquo;s an incredibly
powerful framework and well worth giving &lt;a href="https://docs.serde.rs/serde/">the documentation&lt;/a> a read.&lt;/p>
&lt;p>It can deserialize a file format into a strongly typed rust data structure, so
that the data in code has no affiliation to the data format it was read from,
then can be serialized into another file format.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-rust" data-lang="rust">&lt;span style="color:#75715e">#![allow(unused_variables)]&lt;/span>
&lt;span style="color:#66d9ef">use&lt;/span> serde_derive::{Deserialize, Serialize};
&lt;span style="color:#75715e">#[derive(Serialize, Deserialize, Debug, Clone, PartialEq)]&lt;/span>
&lt;span style="color:#75715e">#[serde(rename_all = &lt;/span>&lt;span style="color:#e6db74">&amp;#34;camelCase&amp;#34;&lt;/span>&lt;span style="color:#75715e">, deny_unknown_fields)]&lt;/span>
&lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">MyData&lt;/span> {
field_one: &lt;span style="color:#66d9ef">usize&lt;/span>,
field_two: String,
field_three: &lt;span style="color:#66d9ef">bool&lt;/span>,
some_data: &lt;span style="color:#a6e22e">std&lt;/span>::collections::HashMap&lt;span style="color:#f92672">&amp;lt;&lt;/span>String, &lt;span style="color:#66d9ef">usize&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span>,
}
&lt;span style="color:#66d9ef">fn&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>() -&amp;gt; &lt;span style="color:#a6e22e">anyhow&lt;/span>::Result&lt;span style="color:#f92672">&amp;lt;&lt;/span>()&lt;span style="color:#f92672">&amp;gt;&lt;/span> {
&lt;span style="color:#66d9ef">let&lt;/span> my_data_yaml &lt;span style="color:#f92672">=&lt;/span> r&lt;span style="color:#960050;background-color:#1e0010">#&amp;#34;&lt;/span>
fieldOne: &lt;span style="color:#ae81ff">7&lt;/span>
fieldTwo: &lt;span style="color:#e6db74">&amp;#34;lorem&amp;#34;&lt;/span>
fieldThree: &lt;span style="color:#a6e22e">true&lt;/span>
someData:
&lt;span style="color:#a6e22e">x&lt;/span>: &lt;span style="color:#ae81ff">1&lt;/span>
y: &lt;span style="color:#ae81ff">2&lt;/span>
z: &lt;span style="color:#ae81ff">3&lt;/span>
&lt;span style="color:#960050;background-color:#1e0010">&amp;#34;#&lt;/span>;
&lt;span style="color:#66d9ef">let&lt;/span> my_data_toml &lt;span style="color:#f92672">=&lt;/span> r&lt;span style="color:#960050;background-color:#1e0010">#&amp;#34;&lt;/span>
fieldOne &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">7&lt;/span>
fieldTwo &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#34;lorem&amp;#34;&lt;/span>
fieldThree &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">true&lt;/span>
[someData]
x &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>
y &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">2&lt;/span>
z &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">3&lt;/span>
&lt;span style="color:#960050;background-color:#1e0010">&amp;#34;#&lt;/span>;
&lt;span style="color:#66d9ef">let&lt;/span> my_data_json &lt;span style="color:#f92672">=&lt;/span> r&lt;span style="color:#960050;background-color:#1e0010">#&amp;#34;&lt;/span>
{
&lt;span style="color:#e6db74">&amp;#34;fieldOne&amp;#34;&lt;/span>: &lt;span style="color:#ae81ff">7&lt;/span>,
&lt;span style="color:#e6db74">&amp;#34;fieldTwo&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;lorem&amp;#34;&lt;/span>,
&lt;span style="color:#e6db74">&amp;#34;fieldThree&amp;#34;&lt;/span>: &lt;span style="color:#a6e22e">true&lt;/span>,
&lt;span style="color:#e6db74">&amp;#34;someData&amp;#34;&lt;/span>: {
&lt;span style="color:#e6db74">&amp;#34;x&amp;#34;&lt;/span>: &lt;span style="color:#ae81ff">1&lt;/span>,
&lt;span style="color:#e6db74">&amp;#34;y&amp;#34;&lt;/span>: &lt;span style="color:#ae81ff">2&lt;/span>,
&lt;span style="color:#e6db74">&amp;#34;z&amp;#34;&lt;/span>: &lt;span style="color:#ae81ff">3&lt;/span>
}
}
&lt;span style="color:#960050;background-color:#1e0010">&amp;#34;#&lt;/span>;
&lt;span style="color:#66d9ef">let&lt;/span> deserialized_yaml &lt;span style="color:#f92672">=&lt;/span> serde_yaml::from_str::&lt;span style="color:#f92672">&amp;lt;&lt;/span>MyData&lt;span style="color:#f92672">&amp;gt;&lt;/span>(my_data_yaml);
&lt;span style="color:#66d9ef">let&lt;/span> deserialized_toml &lt;span style="color:#f92672">=&lt;/span> toml::from_str::&lt;span style="color:#f92672">&amp;lt;&lt;/span>MyData&lt;span style="color:#f92672">&amp;gt;&lt;/span>(my_data_toml);
&lt;span style="color:#66d9ef">let&lt;/span> deserialized_json &lt;span style="color:#f92672">=&lt;/span> serde_json::from_str::&lt;span style="color:#f92672">&amp;lt;&lt;/span>MyData&lt;span style="color:#f92672">&amp;gt;&lt;/span>(my_data_json);
assert&lt;span style="color:#f92672">!&lt;/span>(deserialized_yaml.is_ok());
assert&lt;span style="color:#f92672">!&lt;/span>(deserialized_toml.is_ok());
assert&lt;span style="color:#f92672">!&lt;/span>(deserialized_json.is_ok());
&lt;span style="color:#66d9ef">let&lt;/span> deserialized_toml_copy &lt;span style="color:#f92672">=&lt;/span> deserialized_toml.clone();
assert_eq&lt;span style="color:#f92672">!&lt;/span>(deserialized_yaml&lt;span style="color:#f92672">?&lt;/span>, deserialized_toml&lt;span style="color:#f92672">?&lt;/span>);
assert_eq&lt;span style="color:#f92672">!&lt;/span>(deserialized_toml_copy&lt;span style="color:#f92672">?&lt;/span>, deserialized_json&lt;span style="color:#f92672">?&lt;/span>);
&lt;span style="color:#66d9ef">let&lt;/span> my_data_yaml_missing_field &lt;span style="color:#f92672">=&lt;/span> r&lt;span style="color:#960050;background-color:#1e0010">#&amp;#34;&lt;/span>
fieldOne: &lt;span style="color:#ae81ff">7&lt;/span>
fieldTwo: &lt;span style="color:#e6db74">&amp;#34;lorem&amp;#34;&lt;/span>
someData:
&lt;span style="color:#a6e22e">x&lt;/span>: &lt;span style="color:#ae81ff">1&lt;/span>
y: &lt;span style="color:#ae81ff">2&lt;/span>
z: &lt;span style="color:#ae81ff">3&lt;/span>
&lt;span style="color:#960050;background-color:#1e0010">&amp;#34;#&lt;/span>;
&lt;span style="color:#66d9ef">let&lt;/span> my_data_yaml_extra_field &lt;span style="color:#f92672">=&lt;/span> r&lt;span style="color:#960050;background-color:#1e0010">#&amp;#34;&lt;/span>
fieldOne: &lt;span style="color:#ae81ff">7&lt;/span>
fieldTwo: &lt;span style="color:#e6db74">&amp;#34;lorem&amp;#34;&lt;/span>
fieldThree: &lt;span style="color:#a6e22e">true&lt;/span>
someData:
&lt;span style="color:#a6e22e">x&lt;/span>: &lt;span style="color:#ae81ff">1&lt;/span>
y: &lt;span style="color:#ae81ff">2&lt;/span>
z: &lt;span style="color:#ae81ff">3&lt;/span>
out_of_schema_data: &lt;span style="color:#ae81ff">42&lt;/span>
&lt;span style="color:#960050;background-color:#1e0010">&amp;#34;#&lt;/span>;
&lt;span style="color:#66d9ef">let&lt;/span> data_missing_field &lt;span style="color:#f92672">=&lt;/span> serde_yaml::from_str::&lt;span style="color:#f92672">&amp;lt;&lt;/span>MyData&lt;span style="color:#f92672">&amp;gt;&lt;/span>(my_data_yaml_missing_field);
&lt;span style="color:#66d9ef">let&lt;/span> data_extra_field &lt;span style="color:#f92672">=&lt;/span> serde_yaml::from_str::&lt;span style="color:#f92672">&amp;lt;&lt;/span>MyData&lt;span style="color:#f92672">&amp;gt;&lt;/span>(my_data_yaml_extra_field);
assert&lt;span style="color:#f92672">!&lt;/span>(data_missing_field.is_err());
&lt;span style="color:#75715e">// Because MyData is decorated with `deny_unknown_fields`, adding extra fields
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// will cause parsing to fail.
&lt;/span>&lt;span style="color:#75715e">&lt;/span> assert&lt;span style="color:#f92672">!&lt;/span>(data_extra_field.is_err());
Ok(())
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>You can also read data into a type that can represent any data in a particular
format, if you don&amp;rsquo;t want to or can&amp;rsquo;t strongly define the contents:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-rust" data-lang="rust">&lt;span style="color:#66d9ef">let&lt;/span> yaml_data &lt;span style="color:#f92672">=&lt;/span> serde_yaml::from_str::&lt;span style="color:#f92672">&amp;lt;&lt;/span>serde_yaml::Value&lt;span style="color:#f92672">&amp;gt;&lt;/span>(my_data_yaml)&lt;span style="color:#f92672">?&lt;/span>;
&lt;span style="color:#66d9ef">let&lt;/span> toml_data &lt;span style="color:#f92672">=&lt;/span> toml::from_str::&lt;span style="color:#f92672">&amp;lt;&lt;/span>toml::Value&lt;span style="color:#f92672">&amp;gt;&lt;/span>(my_data_toml)&lt;span style="color:#f92672">?&lt;/span>;
&lt;span style="color:#66d9ef">let&lt;/span> json_data &lt;span style="color:#f92672">=&lt;/span> serde_json::from_str::&lt;span style="color:#f92672">&amp;lt;&lt;/span>serde_json::Value&lt;span style="color:#f92672">&amp;gt;&lt;/span>(my_data_json)&lt;span style="color:#f92672">?&lt;/span>;
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Recently I&amp;rsquo;ve found that it&amp;rsquo;s even able to deserialize a type that&amp;rsquo;s supposed
to represent one format straight into another, and conversely can serialize a
type for a certain format into another. For JSON, YAML, and TOML formats there
are the types &lt;a href="https://docs.serde.rs/serde_json/enum.Value.html">&lt;code>serde_json::Value&lt;/code>&lt;/a>, &lt;a href="https://docs.rs/serde_yaml/0.8.11/serde_yaml/enum.Value.html">&lt;code>serde_yaml::Value&lt;/code>&lt;/a>, and
&lt;a href="https://docs.rs/toml/0.5.6/toml/value/enum.Value.html">&lt;code>toml::Value&lt;/code>&lt;/a> which represent any data in their respective formats and
can used to deserialize data when we can&amp;rsquo;t or don&amp;rsquo;t want to define the precise
structure of the data. It turns out you can read a file format straight into
one of these other types.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-rust" data-lang="rust">&lt;span style="color:#66d9ef">let&lt;/span> toml_from_yaml &lt;span style="color:#f92672">=&lt;/span> serde_yaml::from_str::&lt;span style="color:#f92672">&amp;lt;&lt;/span>toml::Value&lt;span style="color:#f92672">&amp;gt;&lt;/span>(my_data_yaml)&lt;span style="color:#f92672">?&lt;/span>;
&lt;/code>&lt;/pre>&lt;/div>&lt;p>It might be that this conversion fails and the data is not readable into the
other format&amp;rsquo;s &lt;code>Value&lt;/code>, and you&amp;rsquo;ll get a &lt;code>Err&lt;/code>. E.g:
&lt;a href="https://docs.rs/serde_yaml/0.8.11/src/serde_yaml/mapping.rs.html#10-12">&lt;code>serde_yaml::Mapping&lt;/code>&lt;/a> allows keys of any variant of &lt;a href="https://docs.rs/serde_yaml/0.8.11/serde_yaml/enum.Value.html">&lt;code>Value&lt;/code>&lt;/a>,
however &lt;a href="https://docs.serde.rs/serde_json/map/struct.Map.html">&lt;code>serde_json:🗺:Map&lt;/code>&lt;/a> is only implemented with &lt;code>String&lt;/code> as a key
type:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-rust" data-lang="rust">&lt;span style="color:#66d9ef">let&lt;/span> some_yaml &lt;span style="color:#f92672">=&lt;/span> r&lt;span style="color:#960050;background-color:#1e0010">#&amp;#34;&lt;/span>
[&lt;span style="color:#ae81ff">5&lt;/span>,&lt;span style="color:#ae81ff">6&lt;/span>]: &lt;span style="color:#a6e22e">true&lt;/span>
&lt;span style="color:#960050;background-color:#1e0010">&amp;#34;#&lt;/span>;
&lt;span style="color:#66d9ef">let&lt;/span> try_yaml &lt;span style="color:#f92672">=&lt;/span> serde_yaml::from_str::&lt;span style="color:#f92672">&amp;lt;&lt;/span>serde_yaml::Value&lt;span style="color:#f92672">&amp;gt;&lt;/span>(some_yaml);
&lt;span style="color:#66d9ef">let&lt;/span> try_json &lt;span style="color:#f92672">=&lt;/span> serde_yaml::from_str::&lt;span style="color:#f92672">&amp;lt;&lt;/span>serde_json::Value&lt;span style="color:#f92672">&amp;gt;&lt;/span>(some_yaml);
assert&lt;span style="color:#f92672">!&lt;/span>(try_yaml.is_ok());
assert&lt;span style="color:#f92672">!&lt;/span>(try_json.is_err());
&lt;/code>&lt;/pre>&lt;/div>&lt;p>This actually has real practical implication. JSON, for example, is far less
human friendly than either YAML or TOML. There are libraries, packed with
useful functionality that intend to receive data in a certain format. Serde&amp;rsquo;s
design decouples this. &lt;a href="https://json-schema.org/">JSON Schema&lt;/a> is an example. It&amp;rsquo;s a richly
featured schema implementation. But usually you have to write your schemas in
JSON. &lt;a href="https://jsonschema.net/home">JSON Schema Tool&lt;/a> is an online tool that will generate a inferred
schema from some example JSON. Using the example given when you visit the
page: this JSON:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-json" data-lang="json">{
&lt;span style="color:#f92672">&amp;#34;checked&amp;#34;&lt;/span>: &lt;span style="color:#66d9ef">false&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;dimensions&amp;#34;&lt;/span>: {
&lt;span style="color:#f92672">&amp;#34;width&amp;#34;&lt;/span>: &lt;span style="color:#ae81ff">5&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;height&amp;#34;&lt;/span>: &lt;span style="color:#ae81ff">10&lt;/span>
},
&lt;span style="color:#f92672">&amp;#34;id&amp;#34;&lt;/span>: &lt;span style="color:#ae81ff">1&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;name&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;A green door&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;price&amp;#34;&lt;/span>: &lt;span style="color:#ae81ff">12.5&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;tags&amp;#34;&lt;/span>: [
&lt;span style="color:#e6db74">&amp;#34;home&amp;#34;&lt;/span>,
&lt;span style="color:#e6db74">&amp;#34;green&amp;#34;&lt;/span>
]
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>, generates this schema:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-json" data-lang="json">{
&lt;span style="color:#f92672">&amp;#34;$schema&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;http://json-schema.org/draft-07/schema&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;$id&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;http://example.com/root.json&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;type&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;object&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;title&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;The Root Schema&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;description&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;The root schema is the schema that comprises the entire JSON document.&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;default&amp;#34;&lt;/span>: {},
&lt;span style="color:#f92672">&amp;#34;required&amp;#34;&lt;/span>: [
&lt;span style="color:#e6db74">&amp;#34;checked&amp;#34;&lt;/span>,
&lt;span style="color:#e6db74">&amp;#34;dimensions&amp;#34;&lt;/span>,
&lt;span style="color:#e6db74">&amp;#34;id&amp;#34;&lt;/span>,
&lt;span style="color:#e6db74">&amp;#34;name&amp;#34;&lt;/span>,
&lt;span style="color:#e6db74">&amp;#34;price&amp;#34;&lt;/span>,
&lt;span style="color:#e6db74">&amp;#34;tags&amp;#34;&lt;/span>
],
&lt;span style="color:#f92672">&amp;#34;properties&amp;#34;&lt;/span>: {
&lt;span style="color:#f92672">&amp;#34;checked&amp;#34;&lt;/span>: {
&lt;span style="color:#f92672">&amp;#34;$id&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;#/properties/checked&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;type&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;boolean&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;title&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;The Checked Schema&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;description&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;An explanation about the purpose of this instance.&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;default&amp;#34;&lt;/span>: &lt;span style="color:#66d9ef">false&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;examples&amp;#34;&lt;/span>: [
&lt;span style="color:#66d9ef">false&lt;/span>
]
},
&lt;span style="color:#f92672">&amp;#34;dimensions&amp;#34;&lt;/span>: {
&lt;span style="color:#f92672">&amp;#34;$id&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;#/properties/dimensions&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;type&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;object&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;title&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;The Dimensions Schema&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;description&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;An explanation about the purpose of this instance.&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;default&amp;#34;&lt;/span>: {},
&lt;span style="color:#f92672">&amp;#34;examples&amp;#34;&lt;/span>: [
{
&lt;span style="color:#f92672">&amp;#34;height&amp;#34;&lt;/span>: &lt;span style="color:#ae81ff">10.0&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;width&amp;#34;&lt;/span>: &lt;span style="color:#ae81ff">5.0&lt;/span>
}
],
&lt;span style="color:#f92672">&amp;#34;required&amp;#34;&lt;/span>: [
&lt;span style="color:#e6db74">&amp;#34;width&amp;#34;&lt;/span>,
&lt;span style="color:#e6db74">&amp;#34;height&amp;#34;&lt;/span>
],
&lt;span style="color:#f92672">&amp;#34;properties&amp;#34;&lt;/span>: {
&lt;span style="color:#f92672">&amp;#34;width&amp;#34;&lt;/span>: {
&lt;span style="color:#f92672">&amp;#34;$id&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;#/properties/dimensions/properties/width&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;type&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;integer&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;title&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;The Width Schema&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;description&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;An explanation about the purpose of this instance.&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;default&amp;#34;&lt;/span>: &lt;span style="color:#ae81ff">0&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;examples&amp;#34;&lt;/span>: [
&lt;span style="color:#ae81ff">5&lt;/span>
]
},
&lt;span style="color:#f92672">&amp;#34;height&amp;#34;&lt;/span>: {
&lt;span style="color:#f92672">&amp;#34;$id&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;#/properties/dimensions/properties/height&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;type&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;integer&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;title&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;The Height Schema&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;description&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;An explanation about the purpose of this instance.&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;default&amp;#34;&lt;/span>: &lt;span style="color:#ae81ff">0&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;examples&amp;#34;&lt;/span>: [
&lt;span style="color:#ae81ff">10&lt;/span>
]
}
}
},
&lt;span style="color:#f92672">&amp;#34;id&amp;#34;&lt;/span>: {
&lt;span style="color:#f92672">&amp;#34;$id&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;#/properties/id&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;type&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;integer&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;title&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;The Id Schema&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;description&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;An explanation about the purpose of this instance.&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;default&amp;#34;&lt;/span>: &lt;span style="color:#ae81ff">0&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;examples&amp;#34;&lt;/span>: [
&lt;span style="color:#ae81ff">1&lt;/span>
]
},
&lt;span style="color:#f92672">&amp;#34;name&amp;#34;&lt;/span>: {
&lt;span style="color:#f92672">&amp;#34;$id&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;#/properties/name&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;type&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;string&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;title&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;The Name Schema&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;description&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;An explanation about the purpose of this instance.&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;default&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;examples&amp;#34;&lt;/span>: [
&lt;span style="color:#e6db74">&amp;#34;A green door&amp;#34;&lt;/span>
]
},
&lt;span style="color:#f92672">&amp;#34;price&amp;#34;&lt;/span>: {
&lt;span style="color:#f92672">&amp;#34;$id&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;#/properties/price&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;type&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;number&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;title&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;The Price Schema&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;description&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;An explanation about the purpose of this instance.&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;default&amp;#34;&lt;/span>: &lt;span style="color:#ae81ff">0&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;examples&amp;#34;&lt;/span>: [
&lt;span style="color:#ae81ff">12.5&lt;/span>
]
},
&lt;span style="color:#f92672">&amp;#34;tags&amp;#34;&lt;/span>: {
&lt;span style="color:#f92672">&amp;#34;$id&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;#/properties/tags&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;type&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;array&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;title&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;The Tags Schema&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;description&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;An explanation about the purpose of this instance.&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;default&amp;#34;&lt;/span>: [],
&lt;span style="color:#f92672">&amp;#34;examples&amp;#34;&lt;/span>: [
[
&lt;span style="color:#e6db74">&amp;#34;home&amp;#34;&lt;/span>,
&lt;span style="color:#e6db74">&amp;#34;green&amp;#34;&lt;/span>
]
],
&lt;span style="color:#f92672">&amp;#34;items&amp;#34;&lt;/span>: {
&lt;span style="color:#f92672">&amp;#34;$id&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;#/properties/tags/items&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;type&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;string&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;title&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;The Items Schema&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;description&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;An explanation about the purpose of this instance.&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;default&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;examples&amp;#34;&lt;/span>: [
&lt;span style="color:#e6db74">&amp;#34;home&amp;#34;&lt;/span>,
&lt;span style="color:#e6db74">&amp;#34;green&amp;#34;&lt;/span>
]
}
}
}
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>You could imagine that you might want to expand that schema even further with
defauts, examples and other rules constraining the values of some fields.&lt;/p>
&lt;p>Rust has a library &lt;a href="https://docs.rs/schemars/0.7.0/schemars/">&lt;code>schemars&lt;/code>&lt;/a> that implements JSON Schema. While the
documentation goes through examples of &lt;a href="https://docs.rs/schemars/0.7.0/schemars/#serde-compatibility">defining schemas in code&lt;/a>, and
serializing with &lt;code>serde_json&lt;/code>, you can read a &lt;a href="https://docs.rs/schemars/0.7.0/schemars/schema/struct.SchemaObject.html">&lt;code>SchemaObject&lt;/code>&lt;/a> straight
from YAML, or TOML. So your application can leverage the functionality of the
&lt;code>SchemaObject&lt;/code> and the &lt;code>schemars&lt;/code> library while getting users write schemas in
a more human readable form.&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-rust" data-lang="rust">&lt;span style="color:#66d9ef">let&lt;/span> json_schema &lt;span style="color:#f92672">=&lt;/span> serde_json::from_str::&lt;span style="color:#f92672">&amp;lt;&lt;/span>schemars::schema::RootSchema&lt;span style="color:#f92672">&amp;gt;&lt;/span>(
&lt;span style="color:#f92672">&amp;amp;&lt;/span>std::fs::read_to_string(&lt;span style="color:#e6db74">&amp;#34;example.schema.json&amp;#34;&lt;/span>)&lt;span style="color:#f92672">?&lt;/span>,
)&lt;span style="color:#f92672">?&lt;/span>;
&lt;span style="color:#66d9ef">let&lt;/span> json_schema_from_yaml &lt;span style="color:#f92672">=&lt;/span> serde_yaml::from_str::&lt;span style="color:#f92672">&amp;lt;&lt;/span>schemars::schema::RootSchema&lt;span style="color:#f92672">&amp;gt;&lt;/span>(
&lt;span style="color:#f92672">&amp;amp;&lt;/span>std::fs::read_to_string(&lt;span style="color:#e6db74">&amp;#34;example.schema.yaml&amp;#34;&lt;/span>)&lt;span style="color:#f92672">?&lt;/span>,
)&lt;span style="color:#f92672">?&lt;/span>;
&lt;/code>&lt;/pre>&lt;/div>&lt;p>The same JSON Schema from above is much more readable when written in YAML:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="color:#66d9ef">$schema&lt;/span>: http://json-schema.org/draft&lt;span style="color:#ae81ff">-07&lt;/span>/schema
&lt;span style="color:#66d9ef">$id&lt;/span>: http://example.com/root.json
&lt;span style="color:#66d9ef">type&lt;/span>: object
&lt;span style="color:#66d9ef">title&lt;/span>: The Root Schema
&lt;span style="color:#66d9ef">description&lt;/span>: The root schema is the schema that comprises the entire JSON document.
&lt;span style="color:#66d9ef">default&lt;/span>: {}
&lt;span style="color:#66d9ef">required&lt;/span>:
- checked
- dimensions
- id
- name
- price
- tags
&lt;span style="color:#66d9ef">properties&lt;/span>:
&lt;span style="color:#66d9ef">checked&lt;/span>:
&lt;span style="color:#66d9ef">$id&lt;/span>: &lt;span style="color:#e6db74">&amp;#39;#/properties/checked&amp;#39;&lt;/span>
&lt;span style="color:#66d9ef">type&lt;/span>: boolean
&lt;span style="color:#66d9ef">title&lt;/span>: The Checked Schema
&lt;span style="color:#66d9ef">description&lt;/span>: An explanation about the purpose of this instance.
&lt;span style="color:#66d9ef">default&lt;/span>: &lt;span style="color:#66d9ef">false&lt;/span>
&lt;span style="color:#66d9ef">examples&lt;/span>:
- &lt;span style="color:#66d9ef">false&lt;/span>
&lt;span style="color:#66d9ef">dimensions&lt;/span>:
&lt;span style="color:#66d9ef">$id&lt;/span>: &lt;span style="color:#e6db74">&amp;#39;#/properties/dimensions&amp;#39;&lt;/span>
&lt;span style="color:#66d9ef">type&lt;/span>: object
&lt;span style="color:#66d9ef">title&lt;/span>: The Dimensions Schema
&lt;span style="color:#66d9ef">description&lt;/span>: An explanation about the purpose of this instance.
&lt;span style="color:#66d9ef">default&lt;/span>: {}
&lt;span style="color:#66d9ef">examples&lt;/span>:
- &lt;span style="color:#66d9ef">height&lt;/span>: &lt;span style="color:#ae81ff">10&lt;/span>
&lt;span style="color:#66d9ef">width&lt;/span>: &lt;span style="color:#ae81ff">5&lt;/span>
&lt;span style="color:#66d9ef">required&lt;/span>:
- width
- height
&lt;span style="color:#66d9ef">properties&lt;/span>:
&lt;span style="color:#66d9ef">width&lt;/span>:
&lt;span style="color:#66d9ef">$id&lt;/span>: &lt;span style="color:#e6db74">&amp;#39;#/properties/dimensions/properties/width&amp;#39;&lt;/span>
&lt;span style="color:#66d9ef">type&lt;/span>: integer
&lt;span style="color:#66d9ef">title&lt;/span>: The Width Schema
&lt;span style="color:#66d9ef">description&lt;/span>: An explanation about the purpose of this instance.
&lt;span style="color:#66d9ef">default&lt;/span>: &lt;span style="color:#ae81ff">0&lt;/span>
&lt;span style="color:#66d9ef">examples&lt;/span>:
- &lt;span style="color:#ae81ff">5&lt;/span>
&lt;span style="color:#66d9ef">height&lt;/span>:
&lt;span style="color:#66d9ef">$id&lt;/span>: &lt;span style="color:#e6db74">&amp;#39;#/properties/dimensions/properties/height&amp;#39;&lt;/span>
&lt;span style="color:#66d9ef">type&lt;/span>: integer
&lt;span style="color:#66d9ef">title&lt;/span>: The Height Schema
&lt;span style="color:#66d9ef">description&lt;/span>: An explanation about the purpose of this instance.
&lt;span style="color:#66d9ef">default&lt;/span>: &lt;span style="color:#ae81ff">0&lt;/span>
&lt;span style="color:#66d9ef">examples&lt;/span>:
- &lt;span style="color:#ae81ff">10&lt;/span>
&lt;span style="color:#66d9ef">id&lt;/span>:
&lt;span style="color:#66d9ef">$id&lt;/span>: &lt;span style="color:#e6db74">&amp;#39;#/properties/id&amp;#39;&lt;/span>
&lt;span style="color:#66d9ef">type&lt;/span>: integer
&lt;span style="color:#66d9ef">title&lt;/span>: The Id Schema
&lt;span style="color:#66d9ef">description&lt;/span>: An explanation about the purpose of this instance.
&lt;span style="color:#66d9ef">default&lt;/span>: &lt;span style="color:#ae81ff">0&lt;/span>
&lt;span style="color:#66d9ef">examples&lt;/span>:
- &lt;span style="color:#ae81ff">1&lt;/span>
&lt;span style="color:#66d9ef">name&lt;/span>:
&lt;span style="color:#66d9ef">$id&lt;/span>: &lt;span style="color:#e6db74">&amp;#39;#/properties/name&amp;#39;&lt;/span>
&lt;span style="color:#66d9ef">type&lt;/span>: string
&lt;span style="color:#66d9ef">title&lt;/span>: The Name Schema
&lt;span style="color:#66d9ef">description&lt;/span>: An explanation about the purpose of this instance.
&lt;span style="color:#66d9ef">default&lt;/span>: &lt;span style="color:#e6db74">&amp;#39;&amp;#39;&lt;/span>
&lt;span style="color:#66d9ef">examples&lt;/span>:
- A green door
&lt;span style="color:#66d9ef">price&lt;/span>:
&lt;span style="color:#66d9ef">$id&lt;/span>: &lt;span style="color:#e6db74">&amp;#39;#/properties/price&amp;#39;&lt;/span>
&lt;span style="color:#66d9ef">type&lt;/span>: number
&lt;span style="color:#66d9ef">title&lt;/span>: The Price Schema
&lt;span style="color:#66d9ef">description&lt;/span>: An explanation about the purpose of this instance.
&lt;span style="color:#66d9ef">default&lt;/span>: &lt;span style="color:#ae81ff">0&lt;/span>
&lt;span style="color:#66d9ef">examples&lt;/span>:
- &lt;span style="color:#ae81ff">12.5&lt;/span>
&lt;span style="color:#66d9ef">tags&lt;/span>:
&lt;span style="color:#66d9ef">$id&lt;/span>: &lt;span style="color:#e6db74">&amp;#39;#/properties/tags&amp;#39;&lt;/span>
&lt;span style="color:#66d9ef">type&lt;/span>: array
&lt;span style="color:#66d9ef">title&lt;/span>: The Tags Schema
&lt;span style="color:#66d9ef">description&lt;/span>: An explanation about the purpose of this instance.
&lt;span style="color:#66d9ef">default&lt;/span>: []
&lt;span style="color:#66d9ef">examples&lt;/span>:
- - home
- green
&lt;span style="color:#66d9ef">items&lt;/span>:
&lt;span style="color:#66d9ef">$id&lt;/span>: &lt;span style="color:#e6db74">&amp;#39;#/properties/tags/items&amp;#39;&lt;/span>
&lt;span style="color:#66d9ef">type&lt;/span>: string
&lt;span style="color:#66d9ef">title&lt;/span>: The Items Schema
&lt;span style="color:#66d9ef">description&lt;/span>: An explanation about the purpose of this instance.
&lt;span style="color:#66d9ef">default&lt;/span>: &lt;span style="color:#e6db74">&amp;#39;&amp;#39;&lt;/span>
&lt;span style="color:#66d9ef">examples&lt;/span>:
- home
- green
&lt;/code>&lt;/pre>&lt;/div>&lt;p>I learned that &lt;a href="https://crates.io/crates/serde">serde&lt;/a> could do this cross-format parsing by reading the
source code of the &lt;a href="https://github.com/yoshihitoh/refmt">refmt&lt;/a> project.&lt;/p>
&lt;p>Examples from this post are &lt;a href="https://github.com/tarquin-the-brave/serde-cross-format">mastered in github&lt;/a>.&lt;/p></description></item><item><title>Language Servers Are Cool</title><link>https://tarquin-the-brave.github.io/blog/posts/language-servers-are-cool/</link><pubDate>Sun, 01 Mar 2020 14:56:43 +0000</pubDate><guid>https://tarquin-the-brave.github.io/blog/posts/language-servers-are-cool/</guid><description>&lt;p>In slight contrast to my previous post where I espoused the
virtue of code being text and not relying on developer tooling
to interact with it: language servers are cool.&lt;/p>
&lt;p>They decouple the back end of gaining semantic understanding
of code in a particular language from the editor implementation.
A &lt;a href="https://langserver.org/">language server for each language&lt;/a> can be
written, and the editor only needs to integrate the &lt;a href="https://microsoft.github.io/language-server-protocol/">language
server protocol&lt;/a> once, to get a host of IDE style features
for each language.&lt;/p>
&lt;p>This is the sort of solution we need to get rid of editor lock
in, and allow text editors to compete to be the best at editing
text. With language servers, adding language support for an
editor is cheap. Hopefully now developers will start choosing
text editors on the grounds of how good they are at editing text,
rather than the shopping list of languages they support.&lt;/p>
&lt;p>I&amp;rsquo;ve used &lt;a href="https://rls.booyaa.wtf/#neovim">rls&lt;/a> for rust, and &lt;a href="https://github.com/autozimu/LanguageClient-neovim/wiki/Clangd">clangd&lt;/a> for C++ with the
&lt;a href="https://github.com/autozimu/LanguageClient-neovim/">languageClient-neovim&lt;/a> for neovim. I&amp;rsquo;ve been the envy of
colleagues who use Vim-like editors for the impressive language
support, and the envy of colleagues who use IDEs for the superior
text editing&amp;hellip; Not really. They don&amp;rsquo;t see why I can&amp;rsquo;t just
install their IDE and be done with it. Anyway,language servers
are a great bit of technology.&lt;/p></description></item><item><title>You Shouldn't Need an IDE to Read Code</title><link>https://tarquin-the-brave.github.io/blog/posts/ide-read-code/</link><pubDate>Sat, 29 Feb 2020 22:30:09 +0000</pubDate><guid>https://tarquin-the-brave.github.io/blog/posts/ide-read-code/</guid><description>&lt;p>This is important.&lt;/p>
&lt;p>Code is &lt;em>read&lt;/em> far more often than it&amp;rsquo;s &lt;em>written&lt;/em>.&lt;/p>
&lt;p>Primarily, it&amp;rsquo;s read through a web GUI.&lt;/p>
&lt;p>You want to read the source code of a library you&amp;rsquo;re using. Say it&amp;rsquo;s in
Github, you&amp;rsquo;re going to start looking at it through the Github GUI. If you want
to take a deeper look, you might clone the repo and open it in you&amp;rsquo;re editor,
but the vast majority of library code you read will be through a GUI.&lt;/p>
&lt;p>The default medium for reading the changes in a pull request is through a GUI.
Sure, you can pull the branch and open the code up in your editor. When I&amp;rsquo;m
reviewing big changes I do just that. But I shouldn&amp;rsquo;t be required to.&lt;/p>
&lt;p>I&amp;rsquo;ve reviewed code before where I&amp;rsquo;ve made a comment along the line of &amp;ldquo;this
line of code doesn&amp;rsquo;t explain what it&amp;rsquo;s doing&amp;rdquo;, where I&amp;rsquo;ve suggested type
hinting, or renaming things to reflect what&amp;rsquo;s happening, or refactoring the
aggregations that data flows between each line of code so it would make more
sense in the context of the function. Frustratingly, my comments have received
responses that essentially say: &amp;ldquo;if you were using my editor, it makes perfect
sense&amp;rdquo;.&lt;/p>
&lt;p>My recent concrete example is reviewing code in rust. Rust lets you optionally
type hint in various places, e.g. to specify variable &lt;code>x&lt;/code> as type
&lt;code>SpecificType&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-rust" data-lang="rust">&lt;span style="color:#66d9ef">let&lt;/span> x: &lt;span style="color:#a6e22e">SpecificType&lt;/span> &lt;span style="color:#f92672">=&lt;/span> get_a_value();
&lt;/code>&lt;/pre>&lt;/div>&lt;p>There are times where usually optional type declarations are necessary for
compilation because the compiler can&amp;rsquo;t infer the types in your code, but for
the most part, these type hints are optional and can be used by the writer of
the code to check their work or by the reader of the code to understand what&amp;rsquo;s
happening at a type level.&lt;/p>
&lt;p>In rust, types matter. When you&amp;rsquo;re writing and reviewing rust code, you&amp;rsquo;re
thinking about types. I recently suggested adding some type hinting to some
rust code to make it more readable. I was told, in response, that the type
hinting was unnecessary, and if I was only using the same editor&lt;sup id="fnref:1">&lt;a href="#fn:1" class="footnote-ref" role="doc-noteref">1&lt;/a>&lt;/sup> I could
hover my mouse over the line of code and see the information I need.&lt;/p>
&lt;p>I take issue with both of these statements:&lt;/p>
&lt;ul>
&lt;li>Yes, the code will compile without the type hinting, but code is not there to
satiate compilers, it&amp;rsquo;s there to communicate ideas between people. And,&lt;/li>
&lt;li>What if I don&amp;rsquo;t? Am I required a specific editor with a specific setup in
order to read your code? A community of developers being locked into specific
tooling is not good. Even if I was using the same editor setup that gives me
all the IDE features, the web GUI I&amp;rsquo;m likely to review code through doesn&amp;rsquo;t.&lt;/li>
&lt;/ul>
&lt;p>Editor lock-in is a problem. I&amp;rsquo;ve not developed in Java, but I&amp;rsquo;ve been told
it&amp;rsquo;s very difficult to use without an IDE setup for it.&lt;/p>
&lt;p>Everyone has their dev environment setup in a way that suits them. Code is
there to communicate ideas between developers. Requiring someone installing a
bunch of tooling to be able to read your code is mad.&lt;/p>
&lt;p>Maybe I&amp;rsquo;m biased. I use Vim (neovim). I use some IDE like plugins, but mostly
treat code as text, because that&amp;rsquo;s what it is. And Vim is the best text editor
I&amp;rsquo;ve ever used. Setting up the developer features that IDEs give you out of the
box is possible, but takes time to set up and tune. So I tend not to have much
in the way of these features, especially for languages that I don&amp;rsquo;t write in
every day. So maybe I&amp;rsquo;m just trying to avoid the self imposed faff of setting
up my editor so I can read code in the same way someone else does.&lt;/p>
&lt;p>But I don&amp;rsquo;t think so. We don&amp;rsquo;t predominantly read code through editors. We want
to avoid entangling simple tasks like reading code with a load of extra
requirements. These developer tools are useful, but we shouldn&amp;rsquo;t become
reliant on them. Code is text. It should only require a vanilla text editor
to write, and only require something that can render text to read.&lt;/p>
&lt;section class="footnotes" role="doc-endnotes">
&lt;hr>
&lt;ol>
&lt;li id="fn:1" role="doc-endnote">
&lt;p>VSCode appears to be the senior editor for rust. I don&amp;rsquo;t have a problem
with this. By the looks of it, it&amp;rsquo;s a fine GUI based editor and everyone
I know who uses it loves it. It seems its struck a great balance between
having great functionality out of the box, while being easily tuneable and
feel sharp. If I hadn&amp;rsquo;t drank the Vim coolaid, I imagine I&amp;rsquo;d be using it. &lt;a href="#fnref:1" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/section></description></item><item><title>Testing Microservices with Mockserver</title><link>https://tarquin-the-brave.github.io/blog/posts/mockserver-dc/</link><pubDate>Tue, 25 Feb 2020 10:07:46 +0000</pubDate><guid>https://tarquin-the-brave.github.io/blog/posts/mockserver-dc/</guid><description>&lt;p>&lt;a href="http://www.mock-server.com/">Mockserver&lt;/a> is a great piece of tooling that takes a huge amount
of heavy lifting away from testing microservices.&lt;/p>
&lt;p>There&amp;rsquo;s no need to mock out downstream dependencies or client APIs. There&amp;rsquo;s no
need to write complex test code to synchronously handle the mechanics of
requests going back and forward while also trying to embody some comprehensible
declaration of the designed behaviour. It does about as much of the mechanics
of testing for you as it&amp;rsquo;s possible for it to do.&lt;/p>
&lt;p>In all honesty, it was my favourite piece of technology I came across in 2019.&lt;/p>
&lt;p>In this post I&amp;rsquo;ll walk through a patten I&amp;rsquo;ve used a few times to quickly get
rather effective testing of a microservice that drives its API.&lt;/p>
&lt;h1 id="test-setup">Test Setup&lt;/h1>
&lt;p>The test deployment has three elements:&lt;/p>
&lt;ul>
&lt;li>Your microservice,&lt;/li>
&lt;li>A test driver containing/running your test code, and&lt;/li>
&lt;li>A &lt;a href="http://www.mock-server.com/">mockserver&lt;/a> instance.&lt;/li>
&lt;/ul>
&lt;p>I&amp;rsquo;ve used &lt;a href="https://docs.docker.com/compose/">docker-compose&lt;/a> to run the containers and manage the routing
between them, but any container runtime&lt;sup id="fnref:1">&lt;a href="#fn:1" class="footnote-ref" role="doc-noteref">1&lt;/a>&lt;/sup> would do the job.&lt;/p>
&lt;p>&lt;a href="https://mermaid-js.github.io/mermaid-live-editor/#/edit/eyJjb2RlIjoiZ3JhcGggQlRcbnN1YmdyYXBoIGRvY2tlci1jb21wb3NlXG50ZXN0LXJ1bm5lci0tPnxcInRlc3QtcnVubmVycHJvZ3JhbXMgbW9ja3NlcnZlclwifG1vY2tzZXJ2ZXJcbm1vY2tzZXJ2ZXItLS18XCJtb2Nrc2VydmVyIG1vY2tzIG91dCB0aGUgbWljcm9zZXJ2aWNlIGRlcGVuZGVuY2llcyBhbmQgcmVjb3JkcyBtZXNzYWdlc1wifGEobWljcm9zZXJ2aWNlKVxudGVzdC1ydW5uZXItLT58XCJ0ZXN0LXJ1bm5lciBraWNrcyBtaWNyb3NlcnZpY2UgQVBJIHRvIHN0YXJ0IHRlc3RcInxhKG1pY3Jvc2VydmljZSlcbmVuZFxuXHRcdCIsIm1lcm1haWQiOnsidGhlbWUiOiJkZWZhdWx0In0sInVwZGF0ZUVkaXRvciI6ZmFsc2V9">&lt;img src="https://mermaid.ink/img/eyJjb2RlIjoiZ3JhcGggQlRcbnN1YmdyYXBoIGRvY2tlci1jb21wb3NlXG50ZXN0LXJ1bm5lci0tPnxcInRlc3QtcnVubmVycHJvZ3JhbXMgbW9ja3NlcnZlclwifG1vY2tzZXJ2ZXJcbm1vY2tzZXJ2ZXItLS18XCJtb2Nrc2VydmVyIG1vY2tzIG91dCB0aGUgbWljcm9zZXJ2aWNlIGRlcGVuZGVuY2llcyBhbmQgcmVjb3JkcyBtZXNzYWdlc1wifGEobWljcm9zZXJ2aWNlKVxudGVzdC1ydW5uZXItLT58XCJ0ZXN0LXJ1bm5lciBraWNrcyBtaWNyb3NlcnZpY2UgQVBJIHRvIHN0YXJ0IHRlc3RcInxhKG1pY3Jvc2VydmljZSlcbmVuZFxuXHRcdCIsIm1lcm1haWQiOnsidGhlbWUiOiJkZWZhdWx0In0sInVwZGF0ZUVkaXRvciI6ZmFsc2V9" alt="">&lt;/a>&lt;/p>
&lt;h2 id="mockserver">Mockserver&lt;/h2>
&lt;p>The key element here is &lt;a href="http://www.mock-server.com/">mockserver&lt;/a>. It looks after the mechanics
of mocking out the dependencies of a service. It&amp;rsquo;s controlled by your test
code over its API. You tell it what messages to expect an how to respond to
them ahead of time. It records what messages have come and gone during the
test. Your tests can send a request to verify the expectations have been met
or partially met.&lt;/p>
&lt;p>The result is that each test case ends up looking like:&lt;/p>
&lt;ul>
&lt;li>A bunch of requests to &lt;a href="http://www.mock-server.com/">mockserver&lt;/a>, via the client you&amp;rsquo;ve
chosen, or generated from the &lt;a href="https://app.swaggerhub.com/apis/jamesdbloom/mock-server-openapi/5.0.x">openAPI spec&lt;/a>, to establish the
requests that you expect to see and how to respond to each,&lt;/li>
&lt;li>A call to an endpoint on your microservice&amp;rsquo;s API, and&lt;/li>
&lt;li>A call to &lt;a href="http://www.mock-server.com/">mockserver&lt;/a> to verify that the expected messages were
received.&lt;/li>
&lt;/ul>
&lt;p>Mockserver takes away the need to define in the test code all the mechanics
around what messages should be where, when. You define what to expect upfront,
&lt;a href="http://www.mock-server.com/">mockserver&lt;/a> records if there&amp;rsquo;s anything the matter with the
messages, and at the end, you can ask it whether the expectations were met.&lt;/p>
&lt;h2 id="the-test-runner">The Test Runner&lt;/h2>
&lt;p>We run the test code in its own container to make it easy to control the
environment and to make networking easier when we introduce
&lt;a href="https://docs.docker.com/compose/">docker-compose&lt;/a> to manage the setup.&lt;/p>
&lt;p>We define a &lt;code>Dockerfile&lt;/code> for our test runner that builds a container with the
test code and its dependencies. docker-compose can then rebuild the test
container and run the tests in one &lt;a href="#running-the-tests">command&lt;/a>.&lt;/p>
&lt;p>A result of using &lt;a href="http://www.mock-server.com/">mockserver&lt;/a>, and this test setup, is that the
test code is fairly minimal and there&amp;rsquo;s no real &amp;ldquo;test framework&amp;rdquo; required.
Once you have a &lt;a href="http://www.mock-server.com/">mockserver&lt;/a> client library&lt;sup id="fnref:2">&lt;a href="#fn:2" class="footnote-ref" role="doc-noteref">2&lt;/a>&lt;/sup>, and a client
library for your microservice (or decide that defining the requests to kick off
a test on the fly) there&amp;rsquo;s not much more to the tests.&lt;/p>
&lt;p>I&amp;rsquo;ve written the code for this test runner in Python using &lt;a href="https://docs.pytest.org/en/latest/">pytest&lt;/a>.
It worked quite well. But, as the test code only makes a series of requests,
it&amp;rsquo;s not important.&lt;/p>
&lt;h2 id="your-microservice">Your Microservice&lt;/h2>
&lt;p>Configure your microservice with &lt;a href="http://www.mock-server.com/">mockserver&lt;/a> as the target for all
downstream traffic.&lt;/p>
&lt;p>The URL of &lt;a href="http://www.mock-server.com/">mockserver&lt;/a> corresponds to the service name and the
port it exposes, defined in the &lt;a href="#docker-compose-example">docker-compose file&lt;/a>.&lt;/p>
&lt;h1 id="docker-compose-example">Docker Compose Example&lt;/h1>
&lt;p>We have a docker-compose file: &lt;code>docker-compose.yml&lt;/code>&lt;/p>
&lt;script type="application/javascript" src="https://gist.github.com/tarquin-the-brave/7a2d813015d049fbe40e3723b0795be4.js?file=docker-compose.yml">&lt;/script>
&lt;p>In this example, under &lt;code>services:&lt;/code> there&amp;rsquo;s an entry for each of the containers
in this setup.&lt;/p>
&lt;p>Docker compose will route the containers together by giving them a domain name
for the name under &lt;code>services:&lt;/code>, e.g. the microservice can route to the
&lt;a href="http://www.mock-server.com/">mockserver&lt;/a> by sending requests to the domain name &lt;code>mockdeps&lt;/code>. The
test runner routes to the microservice by sending requests to the domain name
&lt;code>microservice&lt;/code>.&lt;/p>
&lt;h2 id="the-test-runner-1">The Test Runner&lt;/h2>
&lt;p>&lt;code>test:&lt;/code>&lt;/p>
&lt;p>In our example the &lt;code>Dockerfile&lt;/code> defining the test runner container is found
under directory &lt;code>fv/&lt;/code>, along with the test code and everything else needed to
build the test runner.&lt;/p>
&lt;p>We define the command to run the tests and allow for arguments to the test
command with &lt;code>${TEST_ARGS}&lt;/code>.&lt;/p>
&lt;h2 id="your-microservice-1">Your Microservice&lt;/h2>
&lt;p>&lt;code>microservice:&lt;/code>&lt;/p>
&lt;p>For this example:&lt;/p>
&lt;ul>
&lt;li>We allow the image to test to be configured by a variable, defaulting to
&lt;code>x:latest&lt;/code>.&lt;/li>
&lt;li>We set the &lt;code>LOG_LEVEL&lt;/code> environment variable in the microservice container.&lt;/li>
&lt;li>We mount in a config file with necessary config, listing the downstream
dependencies that we&amp;rsquo;re mocking out with &lt;a href="http://www.mock-server.com/">mockserver&lt;/a> as being at
&lt;code>mockdeps:12345&lt;/code>.&lt;/li>
&lt;/ul>
&lt;p>If we wanted to automate rebuilding the microservice for testing, we could
define a &lt;code>Dockerfile&lt;/code> for the microservice that can build it from source,
perhaps using the &lt;a href="https://docs.docker.com/develop/develop-images/multistage-build/">multistage builder pattern&lt;/a>, and include and entry
like the one for &lt;a href="#the-test-runner-2">the test runner&lt;/a> rather than specifying a
tag for an already built image.&lt;/p>
&lt;h2 id="mockserver-1">Mockserver&lt;/h2>
&lt;p>&lt;code>mockdeps:&lt;/code>&lt;/p>
&lt;p>The &lt;a href="http://www.mock-server.com/">mockserver&lt;/a> entry exposes a port and passes that as an
argument to &lt;a href="http://www.mock-server.com/">mockserver&lt;/a>.&lt;/p>
&lt;p>You can copy this section verbatim, updating the &lt;a href="https://hub.docker.com/r/jamesdbloom/mockserver/tags">mockserver version&lt;/a>.&lt;/p>
&lt;h1 id="running-the-tests">Running The Tests&lt;/h1>
&lt;p>With this setup, and our microservice container built (and tagged as &lt;code>x:test&lt;/code>),
we can spin up the microservice and the mockserver with:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ IMAGE&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;x:test&amp;#34;&lt;/span> docker-compose up -d mockdeps microservice
&lt;/code>&lt;/pre>&lt;/div>&lt;p>To run the tests:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ docker-compose up --build test
...
&lt;/code>&lt;/pre>&lt;/div>&lt;p>The &lt;code>--build&lt;/code> parameter ensures &lt;a href="#the-test-runner">the test runner&lt;/a> is rebuilt,
so if we&amp;rsquo;ve edited our test code, the new test code will be run.&lt;/p>
&lt;p>To pass arguments to our command that runs the tests, e.g. to only run a
specific test:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ TEST_ARGS&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;-t specific_test_1&amp;#34;&lt;/span> docker-compose up --build test
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Perhaps we&amp;rsquo;ve forgotten the CLI of the tool that runs our tests:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ TEST_ARGS&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;--help&amp;#34;&lt;/span> docker-compose up --build test
&lt;/code>&lt;/pre>&lt;/div>&lt;p>To tear down the whole test setup:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ docker-compose down
&lt;/code>&lt;/pre>&lt;/div>&lt;h1 id="summary">Summary&lt;/h1>
&lt;p>So it&amp;rsquo;s as simple as that. Don&amp;rsquo;t write complicated request handling test code,
and code that painstakingly mocks out all downstream dependencies, let
&lt;a href="http://www.mock-server.com/">mockserver&lt;/a> do that heavy lifting for you. Using
&lt;a href="https://docs.docker.com/compose/">docker-compose&lt;/a> you can rebuild your tests (and perhaps also your
microservice) and run the tests with a couple of commands. Iterate fast and
test your microservice by driving its API. At the end of the day, it&amp;rsquo;s the API
that matters.&lt;/p>
&lt;section class="footnotes" role="doc-endnotes">
&lt;hr>
&lt;ol>
&lt;li id="fn:1" role="doc-endnote">
&lt;p>You could do this in &lt;a href="https://kubernetes.io/">kubernetes&lt;/a>. There are
miniature kubernetes implementations that you can install on your dev machine
or run in CI: &lt;a href="https://github.com/kubernetes/minikube">minikube&lt;/a>,
&lt;a href="https://k3s.io/">k3s&lt;/a>, &lt;a href="https://microk8s.io/">microk8s&lt;/a>. You could put the
&lt;a href="#test-setup">elements&lt;/a> in
&lt;a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/">Pods&lt;/a> or
&lt;a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/">Deployments&lt;/a>
and route them to each other via
&lt;a href="https://kubernetes.io/docs/concepts/services-networking/service/">Services&lt;/a>.
None of the test code would have to change. To me that seemed more effort
than writing a short docker-compose file for this small setup. Mockserver
published &lt;a href="http://www.mock-server.com/where/kubernetes.html">a helm chart&lt;/a>
which could be useful. Mockserver could be used in a larger test setup on a
persistent kubernetes cluster. &lt;a href="#fnref:1" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:2" role="doc-endnote">
&lt;p>There&amp;rsquo;s plenty of client libraries out there for mockserver. &lt;a href="https://pypi.org/search/?q=mockserver">Python has
a few&lt;/a>, I used a couple and they
didn&amp;rsquo;t actually work, so I had to patch them. I&amp;rsquo;d recommending generating
you&amp;rsquo;re own from mockserver&amp;rsquo;s &lt;a href="https://app.swaggerhub.com/apis/jamesdbloom/mock-server-openapi/5.0.x">openAPI
spec&lt;/a>
using &lt;a href="https://github.com/OpenAPITools/openapi-generator">openAPI Generator&lt;/a>. &lt;a href="#fnref:2" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/section></description></item></channel></rss>